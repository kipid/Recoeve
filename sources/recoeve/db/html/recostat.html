<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"/>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=3, user-scalable=yes"/>
<link rel="icon" type="image/x-icon" href="/CDN/favicon.ico">
<meta name="google-adsense-account" content="ca-pub-9843810906985249">
<title>Recostat</title>
<script src="/CDN/jquery.js"></script>
<script src="/prepare.js"></script>
<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
<script>
(function (m, $, undefined) {
m.myIndex="{--myIndex--}";
m.myId="{--myId--}";

m.searchVars=m.getSearchVars(window.location.search);
m.currentURI=m.searchVars?.uri?.val||"";
m.pathName=window.location.pathname;

m.lang=null;
if (!!m.searchVars.lang) {
	m.lang=m.searchVars.lang.val;
	m.docCookies.setItem("lang", m.lang, Infinity, "/", false, true);
}
else if (m.docCookies.hasItem("lang")) {
	m.lang=m.docCookies.getItem("lang");
}
})(window.m, jQuery);
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9843810906985249" crossorigin="anonymous"></script>
<style>
body {margin:0; padding:0; overflow-wrap:break-word; word-wrap:break-word; word-break:break-word; background:rgb(150,150,150)}

div, form, input, textarea {-webkit-box-sizing:border-box; -moz-box-sizing:border-box; box-sizing:border-box; max-width:100%}
data {display:none}
.none {display:none}
.center {text-align:center}
.right {text-align:right}
.fLeft {float:left}
.fRight {float:right}
.cBoth {clear:both}
img {min-width:1em; min-height:1em; max-width:100%}

.button {display:inline-block; cursor:pointer; padding:.2em .5em; border:.15em solid rgb(50,50,50); background:rgb(110,110,110);}
.button.to-be-executed {display:block; max-width:15em; margin:10em auto}
.button.disabled {pointer-events:none; background:rgb(25,25,25); color:rgb(120,120,120)}
.button.left {float:left; margin-right:.5em}
.button:active {background:rgb(0,80,80)}
.button.enabled {background:rgb(50,130,50)}
.button.enabled:active {background:rgb(70,70,70)}

a {text-decoration:none}
a:link {color:rgb(60,60,160)} .dark a:link {color:rgb(190,190,235)}
a:visited {color:rgb(40,40,140)} .dark a:visited {color:rgb(170,170,215)}
a:active {color:rgb(0,100,100)} .dark a:active {color:rgb(100,215,215)}
a:hover {color:rgb(40,140,40)} .dark a:hover {color:rgb(170,215,170); text-decoration:underline}

::-webkit-scrollbar {width:7px; height:7px}
::-webkit-scrollbar-track {-webkit-border-radius:5px; border-radius:5px}
::-webkit-scrollbar-thumb {-webkit-border-radius:5px; border-radius:5px; background:rgb(0,120,120); -webkit-box-shadow:inset 0 0 3px rgb(0,0,0)}
::-webkit-scrollbar-corner {background:transparent}

#right-top-log-in .button {display:inline-block; float:right}
#choose-lang-list {display:inline-block; padding:.5em; line-height:1.5; float:right}

#container {line-height:1.6; font-family:'Malgun Gothic', '맑은 고딕', 나눔고딕, NanumGothic, 'MS Mincho', Tahoma, Sans-serif; background:rgb(250,250,250); color:black; font-size:15px}
	#container.dark {background:rgb(75,75,75); color:white}

#cat-fs-container {
	position:relative;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#cat-fs-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#cat-fs-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#cat-fs-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#cat-fs-list .list-item .list-index {display:none}
#cat-fs-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#cat-fs-list .list-item .cat {font-size:.9em;}
#cat-fs-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#cat-fs-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}

.exit {
	z-index:100;
	position:absolute; display:inline-block;
	right:0; top:0;
	margin:0;
	width:1.8em; height:1.8em; line-height:1.0;
	text-align:center;
	/*border-radius:.4em;*/
	cursor:pointer;
	border:.15em rgb(80, 80, 80) solid;
	background-color:rgb(30,30,30); color:white;
}
.exit>svg {
	width:100%; height:100%;
	font-size:1.8em; line-height:1.0;
}

#new-reco {background:rgba(0,0,0,0.8); color:white} .bright #new-reco {background:rgba(255,255,255,0.8); color:black}
#new-reco form {position:relative; width:70em; max-width:100%; margin:1em auto; padding:1em; background:black; border:.2em solid rgb(120,120,130); text-align:left}
#new-reco label {display:inline-block; font-weight:bold; margin:.9em 0 .4em}
#new-reco label:first-child {margin-top:0}
#new-reco label>.desc {font-size:.8em}
#new-reco input, #new-reco textarea {display:block; max-width:100%; width:100%; resize:vertical; font:inherit; font-weight:bold; overflow-x:hidden; overflow-y:auto; padding:.2em .3em; background:white; color:rgb(50,50,50)}
textarea.single-line {min-height:2.2em; height:2.2em}
textarea.multi-line {font-size:.9em; min-height:10em}
#new-reco input#input-val {display:inline-block; width:8.5em}
#new-reco .def-title {margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-title.selected {border-color:rgb(255,180,180)}
#new-reco .def-cat {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-cat.selected {border-color:rgb(255,180,180)}
#new-reco #add-cat {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em;}
#input-val-stars {margin:0 .5em -.4em 0}
#new-reco .buttons {margin-top:1em; text-align:right}
#new-reco #error-msg {margin:0}

#new-reco .def-cat, #multireco-cats-container .def-cat {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-cat.selected, #multireco-cats-container .def-cat.selected {border-color:rgb(255,180,180)}
#delete-cat, #multireco-delete-cat {background:#ff7600}
#new-reco .def-cmd {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}

#javascript-disable {font-size:3em}

.numbers-of-recos {margin:1em 0; padding:.5em; width:100%}

.multireco {display:flex; justify-content:space-evenly; flex-wrap:wrap}
.reco {margin:0 0 1em; border-top:.15em solid rgb(100,100,100); border-bottom:.15em solid rgb(100,100,100); background:black}
	.bright .reco {border-color:black; background:rgb(230,230,230)}
	.pink .reco {border-color:wheat; background:rgb(35,0,97)}
.reco.deleted {border:.5em solid rgb(168 50 0)}
.multireco .reco {width:49%}
.edit.fRight {float:right; padding:.1em .5em; background:gray; text-align:center; font-weight:bold}
.reco .SNS-img {margin:0; float:left; width:27px; height:27px; border:2px gray solid; border-left:0; cursor:pointer}
.reco .SNS-img:first-child {border-left:2px gray solid}
.reco>.textURI, .reco>.YTVideoId {display:none}
.reco>.uri {font-size:.7em; border:2px solid rgb(100,100,150); border-bottom:0; padding:.2em .5em}
.multireco .reco>.uri {font-size:.7em}
.reco>.title {font-size:1.1em; border:2px solid rgb(150,100,100); padding:.2em .5em}
.multireco .reco>.title {clear:both; font-size:0.9em}
.reco>.cats {font-size:.8em; border:2px solid rgb(100,150,100); border-top:0; padding:.2em .5em}
.multireco .reco>.cats {font-size:.7em}
.reco>.cats>a {color:rgb(130,170,130)}
.reco>.cats>a.currentCat {color:rgb(140,180,140); font-weight:bold; text-decoration:none}
.reco>.desc {margin:.5em 0; padding:.5em}
.reco>.desc .value {padding-bottom:1em}
.reco>.cmt {margin:.5em 0; padding:.5em; background:rgb(30,30,30); border-left:.3em solid rgb(10,80,80)}
.multireco .reco>.desc, .multireco .reco>.cmt {font-size:.6em; margin:.5em 0; padding:.5em 0}
	.bright .reco>.cmt {background:rgb(200,200,200)}
	.pink .reco>.cmt {background:rgb(75,47,47)}
.stars-container {float:left; position:relative; display:inline-block; cursor:text}
.stars-container>div.bar {position:absolute; top:1px; bottom:1px; background:rgb(232,242,80)}
.stars-container>svg.out-stars {position:absolute; left:0; top:0; width:100%; height:100%}
.stars-container>svg.out-stars>polygon {fill:rgb(50,50,50);stroke-width:0;fill-rule:evenodd}
.reco>.val {margin:.5em 0 .3em}
.reco>.val>.str, .reco>.my-point>.str {float:left; font-size:.7em; border:.15em solid white; padding:.1em .5em; margin:0 .2em; vertical-align:top}
	.bright .reco>.val>.str, .bright .reco>.my-point>.str {border-color:black}
.reco .tFirst, .reco .tLast {display:inline-block; float:right; margin:.2em 1em; font-size:.8em}
.multireco .reco .tFirst, .multireco .reco .tLast {font-size:.5em}
.reco .result {font-size:.7em; padding:.5em}

.loading {text-align:center}
.loading .outerCircle {background-color:transparent; border:8px solid rgba(97,82,72,0.9); opacity:.9; border-right:5px solid transparent; border-left:5px solid transparent; border-radius:100px; width:110px; height:110px; margin:5em auto 0; -moz-animation:spinPulse 5s infinite ease-in-out; -webkit-animation:spinPulse 5s infinite ease-in-out}
.loading .innerCircle {background-color:transparent; border:5px solid rgba(189,215,60,0.6); opacity:.9; border-left:5px solid transparent; border-right:5px solid transparent; border-radius:100px; top:-100px; width:90px; height:90px; margin:0 auto 20em; position:relative; -moz-animation:spinoffPulse 3s infinite linear; -webkit-animation:spinoffPulse 3s infinite linear}
@-moz-keyframes spinPulse {
0% {-moz-transform:rotate(160deg); opacity:0; box-shadow:0 0 1px #bdd73c}
50% {-moz-transform:rotate(145deg); opacity:1}
100% {-moz-transform:rotate(-320deg); opacity:0}
}
@-moz-keyframes spinoffPulse {
0% {-moz-transform:rotate(0deg)}
100% {-moz-transform:rotate(360deg);  }
}
@-webkit-keyframes spinPulse {
0% {-webkit-transform:rotate(160deg); opacity:0; box-shadow:0 0 1px #bdd73c}
50% {-webkit-transform:rotate(145deg); opacity:1}
100% {-webkit-transform:rotate(-320deg); opacity:0}
}
@-webkit-keyframes spinoffPulse {
0% {-webkit-transform:rotate(0deg)}
100% {-webkit-transform:rotate(360deg)}
}

.lyricsC {}
.lyricsArrow {width:0; height:0; padding:0; margin:0 auto; border-color:transparent transparent rgb(0,30,0); border-style:solid; border-width:0.5em}
.lyrics {border:0.3em solid rgb(0,30,0); padding:1em .5em; margin-top:-1px}

.rC {margin:.5em 0}
.rC.fixed {position:fixed; z-index:10000; top:0; left:0; width:100%; max-width:100%; margin:0; padding:1px; background:black; border-bottom:.15em solid white}
	.bright .rC.fixed {background:white; border-color:black}
.rC>.rSC {position:relative; height:0; padding-bottom:63%}
.rC.soundcloud>.rSC {padding-bottom:20%}
.rC.instagram>.rSC {padding-bottom:165%; overflow:auto}
.rC.tiktok>.rSC {height:895px; padding-bottom:0; overflow-x:hidden; overflow-y:scroll}
.rC.eveElse>.rSC {padding-bottom:80%}
.rC>.rSC>* {position:absolute; width:100%; height:100%; max-width:100%; max-height:100%; left:0; top:0; overflow-x:hidden; overflow-y:hidden}
.rC>.rSC>.center {position:absolute; text-align:center; width:100%; height:100%; max-width:100%; max-height:100%; left:0; top:0; overflow-x:hidden; overflow-y:hidden}
.rC>.rSC>.center>iframe {position:absolute; width:100%; height:100%; max-width:100%; min-height:100%; left:0; top:0; overflow-x:hidden; overflow-y:auto}
.rC>.rSC>.center>img {display:inline-block; max-width:100%; max-height:100%}
.rC>.pc {text-align:center; font-size:10px} /* position change */

@media all and (min-width:701px) {
	.rC.fixed {width:50%; border-right:.15em solid white}
	.rC.instagram.fixed, .rC.eveElse.fixed, .rC.tiktok.fixed {width:360px}
	.rC.tiktok>.rSC {width:100%; height:895px; padding-bottom:0}
	.lyrics {text-align:right}
	::-webkit-scrollbar {width:11px; height:11px}
}
</style>
</head>
<body>
<data id="data-myCatList">{--myCatList--}</data>
<div id="container" class="dark">
<div id="javascript-disable">
	Your javascript on this page is disabled. Please enable javascipt to see this page properly.
</div><!-- div#javascript-disable -->
<div id="right-top-log-in">
	<div class="button" id="my-id"></div>
	<div class="button" id="choose-lang">▼ Language/언어/語言</div>
</div><!-- div#right-top-log-in -->
<div class="cBoth"></div>
<data id="data-lang">en	ko	zh	ja	de	fr	es	hi	ar	ru
English/영어/英語/en	Korean/한국어/韓語/ko	Chinese/중국어(번체)/中文/zh	Japanese/일본어/日語/ja	deutsche Sprache/독일어/Deutsch/de	Français/French/프랑스어/佛語/fr	Español/Spanish/스페인어/西班牙語/es	हिन्दी/Hindi/힌디어/印地语/hi	اللغة العربية/ar	Русский/Russian/러시아어/俄語/ru</data>
<div id="choose-lang-list" style="border:solid 1px gray; display:none"></div>
<div class="cBoth"></div>
<div id="new-reco">
<form>
	<label for="input-uri">URI <span class="desc">([--required--])</span></label>
		<textarea id="input-uri" class="single-line" name="input-uri" placeholder="Uniform Resource Indentifier: like http-URL" type="text" tabindex="1"></textarea>
	<label for="title">[--Title--]</label>
		<div id="def-titles"></div>
		<textarea class="single-line" id="input-title" name="title" placeholder="[--placeholder Title--]" type="text" tabindex="2"></textarea>
	<label for="cats">[--Categories--]</label>
		<div id="def-cats"><div class="def-cat replace-cat">[--Indifferent--]</div> <div class="def-cat replace-cat">[--Later--]</div> <div id="add-cat" class="def-cat add-txt">;</div> <div id="sub-cat" class="def-cat add-txt">--</div> <div id="delete-cat" class="def-cat delete-cat">[--Delete--]</div></div>
		<textarea class="single-line" id="input-cats" name="cats" placeholder="[--placeholder Category--]" type="text" tabindex="3"></textarea>
		<div id="cat-fs-container" class="fs-container" style="display:none">
			<div id="cat-fs-list" class="fs-list"></div>
			<div class="exit" onclick="$(this).parent().hide()"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
		</div>
		<div id="show-URI"></div>
	<div style="margin:.5em 0">
		<label for="input-val" style="margin:.1em .5em">[--Points--]</label>
		<div id="input-val-stars"></div>
		<span class="upDown" id="input-val-down">&lt;</span>
		<span class="upDown" id="input-val-up">&gt;</span>
		<input id="input-val" name="val" placeholder="(ex: 7.5/10)" type="text" tabindex="4"/>
	</div>
	<div id="error-msg" class="cBoth"></div>
	<div class="buttons">
		<div class="button" id="button-reco" tabindex="7">[--Reco--]</div>
		<div class="button" id="button-edit" tabindex="8">[--Edit--]</div>
		<div class="button" id="button-del" tabindex="9" style="background:#ff7600">[--Del--]</div>
		<div class="button left" id="button-close" tabindex="5" onclick="m.closeNewReco()">[--Close--]</div>
		<div class="button left" id="button-back" tabindex="6">[--Back--]</div>
		<div class="cBoth"></div>
	</div>
	<label for="desc">[--Description--]</label>
		<div id="def-cmds"><div class="def-cmd">#related</div> <div class="def-cmd">#lyrics</div></div>
		<div id="def-descs"></div>
		<textarea class="multi-line" id="input-desc" name="desc" placeholder="[--placeholder Description--]" tabindex="10"></textarea>
	<label for="cmt">[--Comment--]</label>
		<textarea class="multi-line" id="input-cmt" name="cmt" placeholder="[--placeholder Comment--]" tabindex="11"></textarea>
	<div id="my-reco"></div>
	<div id="contents"></div>
</form>
<div id="my-reco"></div>
</div><!-- div#new-reco -->
</div><!-- div#container -->
</body>
<div id="scripts"></div>
<script>
(function(m, $, undefined) {
$("#javascript-disable").hide();
m.kakaoTries=0;
m.kakaoInitDo=function () {
	if (typeof Kakao!=='undefined'||m.kakaoTries++>15) {
		clearInterval(m.kakaoInit);
		if (!Kakao.isInitialized()) {
			Kakao.init('f076e37310bc101c5c50c9e2714b59ca');
		}
	}
};
m.kakaoInit=setInterval(m.kakaoInitDo, 2048);



/* Prerequisite */
//////////////////
// Variables
//////////////////
$data_myCatList=$("#data-myCatList");

$new_reco=$("#new-reco");
$input_uri=$("#input-uri");
$input_uri[0].value=m.currentURI;
$show_URI=$("#show-URI");
$def_titles=$("#def-titles");
$input_title=$("#input-title");
$def_cats=$("#def-cats");
$input_cats=$("#input-cats");
$input_desc=$("#input-desc");
$input_cmt=$("#input-cmt");
$input_val=$("#input-val");

$error=$("#error-msg");

$button_reco=$("#button-reco");
$button_edit=$("#button-edit");
$button_del=$("#button-del");
$button_back=$("#button-back");
$button_close=$("#button-close");

$cat_fs_container=$("#cat-fs-container");
$cat_fs_list=$("#cat-fs-list");

$window=$(window);
$html=$("html");
$body=$("body");
$.fn.exists=function() { return this.length!==0; };

$("title").html(m.userId+" on Recoeve.net");

m.myCatList=[];
m.myRecos={};

m.fsCat=[];
m.fsCat[0]=m.fsCat[1]=[];
m.fsCat[0].k=m.fsCat[1].k=-1;
m.fsCat.fullList=[];
m.fsCat.desc=false;
m.fsCat.$fs=$input_cats;
m.fsCat.$fsl=$cat_fs_list;

m.ptnURI=[];
m.ptnURL=/^https?:\/\/\S+/i;
m.ptnTag=/^<\w+[\s\S]+>$/i;
m.ptnVal=/^([0-9]+(?:\.[0-9]+)?)\/([0-9]+(?:\.[0-9]+)?)$/;

m.fullPts=10;



/* Fuzzy search */
////////////////////////////////////////////////////
// Hangul (Korean) split and map to English
// KE : Korean Expanded
////////////////////////////////////////////////////
m.jamoKE = ["ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄷㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
m.jamo = ["ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄸ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅃ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

m.mapKE = {"q":"ㅂ", "Q":"ㅃ", "w":"ㅈ", "W":"ㅉ", "e":"ㄷ", "E":"ㄸ", "r":"ㄱ", "R":"ㄲ", "t":"ㅅ", "T":"ㅆ", "y":"ㅛ", "Y":"ㅛ", "u":"ㅕ", "U":"ㅕ", "i":"ㅑ", "I":"ㅑ", "o":"ㅐ", "O":"ㅒ", "p":"ㅔ", "P":"ㅖ", "a":"ㅁ", "A":"ㅁ", "s":"ㄴ", "S":"ㄴ", "d":"ㅇ", "D":"ㅇ", "f":"ㄹ", "F":"ㄹ", "g":"ㅎ", "G":"ㅎ", "h":"ㅗ", "H":"ㅗ", "j":"ㅓ", "J":"ㅓ", "k":"ㅏ", "K":"ㅏ", "l":"ㅣ", "L":"ㅣ", "z":"ㅋ", "Z":"ㅋ", "x":"ㅌ", "X":"ㅌ", "c":"ㅊ", "C":"ㅊ", "v":"ㅍ", "V":"ㅍ", "b":"ㅠ", "B":"ㅠ", "n":"ㅜ", "N":"ㅜ", "m":"ㅡ", "M":"ㅡ"};
for (var p in m.mapKE) {
	m.mapKE[m.mapKE[p]]=p;
}

m.rChoKE = ["ㄱ", "ㄱㄱ", "ㄴ", "ㄷ", "ㄷㄷ", "ㄹ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
m.rCho = ["ㄱ", "ㄲ", "ㄴ", "ㄷ", "ㄸ", "ㄹ", "ㅁ", "ㅂ", "ㅃ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

m.rJungKE = ["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
m.rJung = ["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

m.rJongKE = ["", "ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
m.rJong = ["", "ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

m.splitHangul=function(str) {
	var res=[];
	res.originalStr=str;
	res.splitted3="";
	res.splitted="";
	res.pCho=[]; // position of word-start or 초성
	var p=0;
	res.pCho[p]=true;
	var cho, jung, jong;
	for (var i=0;i<str.length;i++) {
		var c=str.charAt(i)
		var n=str.charCodeAt(i);
		if (n>=0x3131&&n<=0x3163) {
			n-=0x3131;
			res[i]={"char":c, "splitted3":c, "splitted":m.jamoKE[n]};
			res.pCho[p]=true;
		} else if (n>=0xAC00&&n<=0xD7A3) {
			n-=0xAC00;
			jong=n%28;
			jung=( (n-jong)/28 )%21;
			cho=( ((n-jong)/28)-jung )/21;
			res[i]={"char":c
				, "splitted3":m.rCho[cho]+m.rJung[jung]+m.rJong[jong]
				, "splitted":m.rChoKE[cho]+m.rJungKE[jung]+m.rJongKE[jong]};
			res.pCho[p]=true;
		} else {
			res[i]={"char":c, "splitted3":c, "splitted":c};
			if (i>0&&/[^a-zA-Z0-9]$/.test(res[i-1].splitted)&&/[a-zA-Z0-9]/.test(c)) {
				res.pCho[p]=true;
			}
		}
		p+=res[i].splitted.length;
		res.splitted3+=res[i].splitted3;
		res.splitted+=res[i].splitted;
	}
	return res;
};



////////////////////////////////////////////////////
// Fuzzy search prepare
////////////////////////////////////////////////////
m.fsCat[0].ptnSH=m.fsCat[1].ptnSH=m.splitHangul("$!@#");

/* CatList */
////////////////////////////////////////////////////
// CatList rendering
////////////////////////////////////////////////////
m.getDepthOfTabs=function (str) {
	let n=0;
	while (n<str.length&&str.charAt(n)==='\t') { n++; }
	return n;
};
m.getSuperCat=function (cat) {
	if (cat&&cat.constructor===String) {
		let i=cat.lastIndexOf("--");
		if (i!=-1) {
			return cat.substring(0,i);
		}
	}
	return null;
};
m.strCatListToJSON=function (strCatList, catList) {
	let list=strCatList.trim().split("\n");
	if (strCatList.length===0) {
		list=[];
	}
	list.unshift(""); // cat=uncategorized : empty cat.
	if (catList===undefined||catList===null) {
		if (!!m.catList) {
			catList=m.catList;
		}
		else {
			catList=m.catList=[];
		}
	}
	let superCats=[];
	if (strCatList.trim()==="") {
		catList[""]=catList[0]={i:0, cat:"", baseCat:"", depth:0};
	}
	else {
		for (let i=0;i<list.length;i++) {
			let baseCat=list[i].trim();
			let depth=m.getDepthOfTabs(list[i]);
			superCats.splice(depth, superCats.length-depth, baseCat);
			let cat=superCats.join("--");
			catList[i]=catList[cat]={i, cat, baseCat, depth};
		}
	}
};

if (m.myIndex) {
	m.strCatListToJSON(m.unescapeHTML($data_myCatList.html()), m.myCatList);
}

//////////////////////////////////////
// Fuzzy search on Cat
//////////////////////////////////////
m.putCatToFSFullList=function (i, cat) {
	if (m.fsCat.fullList[cat]) {
		m.fsCat.fullList[cat].i=i;
		m.fsCat.fullList[i]=m.fsCat.fullList[cat];
	}
	else {
		m.fsCat.fullList[i]=m.fsCat.fullList[cat]={i:i, txt:m.splitHangul(cat), cat:cat, html:m.escapeHTML(cat)};
	}
};
m.updateCatFS=function() {
	m.fsCat.fullList.splice(0, m.fsCat.fullList.length);
	m.strCatListToJSON(m.unescapeHTML($data_myCatList.html()), m.myCatList);
	let l=m.myCatList.length;
	for (let i=l-1;i>=0;i--) {
		m.putCatToFSFullList(l-1-i, m.myCatList[i].cat);
	}
};
m.updateCatFS();
m.completeCat=function (elem, cat) {
	let $elem=$(elem);
	let fs=m.fsCat;
	fs.$fsLis.removeClass("selected");
	$elem.addClass("selected");
	let k=fs.k; // index of cat on sEnd.
	fs.listOfCats[k]=fs.fullList[cat].cat;
	fs.$fs[0].value=fs.listOfCats.join(";");
	let sStart=0;
	for (let i=0;i<k;i++) {
		sStart+=fs.listOfCats[i].length+1;
	}
	let sEnd=sStart+fs.listOfCats[k].length;
	fs.$fs.focus();
	fs.$fs[0].setSelectionRange(sEnd,sEnd);
};
m.doFSCat=function (fs) {
	let catsTxt=fs.$fs[0].value;
	fs.$fs.focus();
	let sEnd=fs.$fs[0].selectionEnd;
	fs.listOfCats=catsTxt.split(";");
	let l=catsTxt.length;
	let lastK=fs.k;
	fs.k=0;
	for (let i=fs.listOfCats.length-1;i>=0;i--) {
		l-=fs.listOfCats[i].length+1;
		if (l<sEnd) {
			fs.k=i;
			break;
		}
	} // Picking cat index k of the current selectionEnd.
	let fsCatSH=m.splitHangul(fs.listOfCats[fs.k].trim());
	let res=m.fuzzySearch(fsCatSH, fs);
	let str="";
	if (fs===m.fsCat) {
		for (let i=0;i<res.length;i++) {
			let fsSortedI=res[res.sorted[i]];
			str+=`<div class="list-item" onclick="m.completeCat(this,'${fs.fullList[fsSortedI.i].cat}')"><div class="list-index">${i}</div>${fs.fullList[fsSortedI.i].html}${(fsSortedI.highlight!==undefined?`<div class="highlighted"><span class="maxMatchScore">${fsSortedI.maxMatchScore}</span> :: ${fsSortedI.highlight}</div>`:'')}</div>`;
		}
	}
	fs.$fsl.html(str);
	fs.$fsLis=fs.$fsl.find(".list-item");
};
m.fsCatOn=function () {
	let now=Date.now();
	let passed=now-m.previous;
	if (passed>m.wait) {
		m.previous=now;
		m.doFSCat(m.fsCat);
	}
	else {
		$input_cats.off("input.fs keyup.fs cut.fs paste.fs click.fs");
		setTimeout(function () {
			$input_cats[0].value=$input_cats[0].value.replace(/[\"\'\`]+/ig,"");
			$input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsCatOn);
			m.previous=Date.now();
			m.doFSCat(m.fsCat);
		}, m.wait*1.1-passed);
	}
};
m.fsCatsOnTimeout=function () {
	$input_cats.off("input.fs keyup.fs cut.fs paste.fs click.fs");
	$input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsCatOn);
};
m.fsCatsOnTimeout();
m.onKeydownInFS=function (e, fs) {
	clearTimeout(m.setTimeoutTargetOn);
	e.stopPropagation();
	let $fsl=fs.$fsl;
	let $fs_container=fs.$fs_container;
	let $target=$(e.target);
	let catsTxt=$target[0].value;
	$target.focus();
	let sEnd=$target[0].selectionEnd;
	fs.listOfCats=catsTxt.split(";");
	let l=catsTxt.length;
	let lastK=fs.k;
	fs.k=0;
	for (let i=fs.listOfCats.length-1;i>=0;i--) {
		l-=fs.listOfCats[i].length+1;
		if (l<sEnd) {
			fs.k=i;
			break;
		}
	} // Picking cat index k of the current selectionEnd.
	let $lis=$fsl.find(".list-item");
	let $liSelected=$fsl.find(".list-item.selected").eq(0);
	switch (e.keyCode) {
		case 9: // Tab=9
			e.preventDefault();
			$target.off("input.fs keyup.fs cut.fs paste.fs click.fs");
			$lis.eq(0)?.trigger("click");
			break;
		case 27: // ESC=27
			e.preventDefault();
			$fs_container.hide();
			break;
		case 38: // up=38
		case 40: // down=40
			e.preventDefault();
			$target.off("input.fs keyup.fs cut.fs paste.fs click.fs");
			let $liTo=null;
			if ($liSelected.exists()) {
				if (e.keyCode===38) {
					$liTo=$liSelected.prev();
				}
				else {
					$liTo=$liSelected.next();
				}
				if ($liTo.exists()) {
					$liTo.eq(0).trigger("click");
					if ($liTo.offset().top<$fsl.offset().top+2) { // $liTo at upside of scroll.
						$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top-$fsl.offset().top-2);
					}
					else if ($liTo.offset().top+$liTo.outerHeight()>$fsl.offset().top+$fsl.height()+2) { // $liTo at downside of scroll.
						$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top+$liTo.outerHeight()-$fsl.offset().top-$fsl.height()-2);
					}
				}
			}
			else {
				if ($lis.exists()) {
					if (e.keyCode===38) {
						$liTo=$lis.last();
						$fsl.scrollTop($fsl[0].scrollHeight);
					}
					else {
						$liTo=$lis.first();
						$fsl.scrollTop(0);
					}
					$liTo.eq(0).trigger("click");
				}
			}
			break;
	}
	m.setTimeoutTargetOn=setTimeout(function () {
		m.fsCatsOnTimeout();
	}, m.wait);
};
$input_cats.on("keydown.fs", function (e) {
	m.onKeydownInFS(e, m.fsCat);
});
if (m.myIndex) {
	let l=m.myCatList.length;
	for (let i=l-1;i>=0;i--) {
		let cat=m.myCatList[i].cat;
		m.fsCat.fullList[l-1-i]={i:l-1-i, txt:m.splitHangul(cat), cat:cat, html:m.escapeHTML(cat)};
	}
}
$input_cats.trigger("keyup.fs");
$input_cats.on("focus", function() {
	$cat_fs_container.show();
});



////////////////////////////////////////////////////
// desc and cmt rendering
////////////////////////////////////////////////////
m.ptnDescCmt=/^#(\S+)/mg; // \w=[A-Za-z0-9_]
m.renderStrDescCmt=function (str) {
	let res=[];
	str=str.trim();
	let key="#";
	let i=0;
	let start=0;
	let exec;
	while ((exec=m.ptnDescCmt.exec(str))!==null) {
		res[i++]=key;
		res[key]=str.substring(start, exec.index).trim();
		start=m.ptnDescCmt.lastIndex;
		key=exec[1];
	}
	res[i++]=key;
	res[key]=str.substring(start).trim();
	return res;
};
m.recoHTML=async function (r, inListPlay, inRange, inRecom) {
	let res="";
	if (r?.has) {
		res+=`<div class="reco${inRange&&!r.deleted?'':' none'}"${inListPlay?``:` id="reco${inRecom?`m-${m.recoms[m.currentCat][r.uri]?.index}"`:`-${r.index}"`}`}><img class="SNS-img" src="/CDN/link.png" onclick="m.shareSNS(this, 'link')"><img class="SNS-img" src="/CDN/icon-Twitter.png" onclick="m.shareSNS(this, 'twitter')"><img class="SNS-img" src="/CDN/icon-Facebook.png" onclick="m.shareSNS(this, 'facebook')"><img class="SNS-img" src="/CDN/icon-Kakao.png" onclick="m.shareSNS(this, 'kakao')"/><img class="SNS-img" src="/CDN/icon-Whatsapp.png" onclick="m.shareSNS(this, 'whatsapp')"/>
	${m.myIndex?`<div class="button edit fRight${r.deleted?" deleted":""}" onclick="m.editOrRecoToMine(this)">[--Edit--]</div>`:''}
	<div class="textURI">${m.escapeHTML(r.uri)}</div>
	<div class="uri cBoth">${m.uriToA(r.uri)}</div>
	<div class="title">${m.escapeHTML(r.title)}</div>
	<div class="cats">${m.catsToA(r.cats)}</div>`
	if (!inListPlay) {
		let uriRendered=await uriRendering(r.uri, false, inListPlay);
		res+=String(uriRendered.html);
	}
	res+=`<div class="cBoth"></div>`;
		if (r.val?.str) {
			res+=`<div class="val">${m.stars(r.val.val)} <span class="str">${m.escapeHTML(r.val.str)}</span></div>`;
		}
		else {
			res+=`<div class="val">${m.stars(0)} <span class="str"> </span></div>`;
		}
		res+=`<div class="cBoth"></div>`;
		if (m.myIndex&&r.val?.str) {
			res+=`<div class="my-point">${m.stars(r.val.val)} <span class="upDown down">&lt;</span> <span class="upDown up">&gt;</span> <span class="str">${m.escapeHTML(r.val.str)}</span></div>`;
		}
		else {
			res+=`<div class="my-point">${m.stars(0)} <span class="upDown down">&lt;</span> <span class="upDown up">&gt;</span> <span class="str"> </span></div>`;
		}
		res+=`<div class="cBoth"></div><div class="result"></div>`;
		if (r.desc) {
			let descR=r.descR;
			res+=`<div class="desc">`;
			for (let l=0;l<descR.length;l++) {
				let key=m.escapeHTML( descR[l] );
				let value=m.escapeHTML( descR[descR[l]] );
				switch (key.toLowerCase()) {
				case "#": case "":
					res+=`<div class="value">${value.replace(/\n/g,"<br>")}</div>`;
					break;
				case "lyrics": case "lyric": case "가사":
					res+=`<div class="value">
<div class="center"><div class="button" onclick="m.slideToggle(this)">▼ [--Toggle lyrics--]</div></div>
<div class="lyricsC" style="display:none">
	<div class="lyricsArrow"></div>
	<div class="lyrics">${value.replace(/\n/g,"<br>")}</div>
	<div class="right"><div class="button" onclick="m.slideUp(this)">▲ [--Hide lyrics--]</div></div>
</div>
</div>`;
					break;
				case "related":
					res+=`<div class="value"><span class="key">#${key}</span>:`;
					let relateds=value.split("\n");
					for (let p=0;p<relateds.length;p++) {
						res+='<br>';
						let uriRenderedInRelated=await uriRendering(m.formatURI(relateds[p]), true);
						res+=String(uriRenderedInRelated.html);
					}
					res+=`</div>`;
					break;
				default :
					res+=`<div class="value"><span class="key">#${key}:</span><br>${value.replace(/\n/g,"<br>")}</div>`;
				}
			}
			res+=`</div>`;
		}
		res+=(r.cmt&&r.cmt.length!==0?(`<div class="cmt">${m.escapeHTML(r.cmt).replace(/\n/g,"<br>")}</div>`):"");
		res+=`<div class="tFirst">Firstly Recoed at ${m.toLocalTime(r.tFirst)}</div><div class="cBoth"></div>`;
		if (r.tFirst!==r.tLast) {
			res+=`<div class="tLast">Lastly Editted at ${m.toLocalTime(r.tLast)}</div><div class="cBoth"></div>`;
		}
		res+=`</div>`;
	}
	else {
		res+=`<div class="reco">No Reco</div>`;
	}
	return res;
};
m.reco_pointChange_do=function (args, err) {
	if (err) {
		m.delayedLogOut(err, 60*60*24, args.$result);
		return;
	}
	let fs=m.fsGo;
	let uri=args.uri;
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).fail(function (resp) {
		if (args.inRecoms) {
			args.$result?.html(`[--Reco failed. You may not be logged-in.--]: ${m.escapeHTML(resp)}`);
		}
		else {
			args.$result?.html(`[--Failed change. You may not be logged-in.--]: ${m.escapeHTML(resp)}`);
		}
	}).done(async function (resp) {
		let res=await m.strToJSON(resp);
		let result=String(res[1]?.result);
		if (result?.substring(0,7)==="changed") {
			m.myRecos[uri].val=m.val(args.valStr);
			m.myRecos[uri].cats=args.cats;
			args.$result?.html(m.escapeHTML(res[1].result));
		}
		else if (result==="recoed") {
			let r=m.myRecos[uri];
			if (!r) {r=m.myRecos[uri]={};}
			r.has=true;
			r.val=m.val(args.valStr);
			if (r.defTitles&&r.defTitles[0]&&r.defTitles[0][0]) {
				r.title=r.defTitles[0][0];
			}
			else {
				r.title="";
			}
			r.cats=args.cats;
			if (r.defDescs&&r.defDescs[0]&&r.defDescs[0][0]) {
				r.desc=r.defDescs[0][0];
			}
			else {
				r.desc="";
			}
			r.descR=m.renderStrDescCmt(r.desc);
			m.putCats_UriToLists(r.cats, uri);
			m.refresh(r.cats, "recoed", uri);
		}
		else {
			m.delayedLogOut(result, 60*60*24, args.$result);
		}
	});
};
m.recoByOnlyStars=function ($str, uri, $result, inRecoms) {
	if (!m.myIndex) {
		m.delayedLogOut("Not logged-in.", 7, $result);
		return;
	}
	let valStr=$str.html();
	if (m.myPage) {
		if (valStr!==m.myRecos[uri]?.val?.str) {
			let strHeads="do\turi\tval";
			let strContents=`change\t${m.encloseStr(uri)}\t${m.encloseStr(valStr)}`;
			let cats="";
			let catsChanged=true;
			if (m.recoMode==="multireco") {
				cats=m.formatCats($multireco_input_cats[0].value);
				if (m.myRecos[uri]?.cats&&!m.catsContainsAllAnotCats(m.myRecos[uri].cats, cats)) {
					cats=m.formatCats(m.myRecos[uri].cats);
					catsChanged=false;
				} else {
					m.delCats_UriFromLists(m.myRecos[uri].cats, uri);
					m.putCats_UriToLists(cats, uri);
				}
			}
			else if (m.myRecos[uri]?.cats) {
				cats=m.formatCats(m.myRecos[uri].cats);
				catsChanged=false;
			}
			else {
				cats=m.formatCats(m.currentCat);
			}
			if (catsChanged) {
				strHeads+="\tcats";
				strContents+=`\t${m.encloseStr(cats)}`;
			}
			$result.html(`[--Changing your points.--]${catsChanged?` The cats on this URI is changed to ${m.escapeHTML(cats)}.`:""}`);
			m.rmb_me(m.reco_pointChange_do, {strHeads, strContents, uri, valStr, $result, inRecoms, cats});
		}
	}
	else {
		if (m.myRecos[uri]?.has) {
			if (m.myRecos[uri]?.val?.str!==valStr) {
				let strHeads="do\turi\tval";
				let strContents=`change\t${m.encloseStr(uri)}\t${m.encloseStr(valStr)}`;
				let cats="";
				let catsChanged=true;
				if (m.recoMode==="multireco") {
					cats=m.formatCats($multireco_input_cats[0].value);
					if (m.myRecos[uri]?.cats&&!m.catsContainsAllAnotCats(m.myRecos[uri].cats, cats)) {
						cats=m.formatCats(m.myRecos[uri].cats);
						catsChanged=false;
					}
				}
				else if (m.myRecos[uri]?.cats) {
					cats=m.formatCats(m.myRecos[uri].cats);
					catsChanged=false;
				}
				else {
					cats=m.formatCats(m.currentCat);
				}
				if (catsChanged) {
					strHeads+="\tcats";
					strContents+=`\t${m.encloseStr(cats)}`;
				}
				$result.html(`[--Changing your points.--]${catsChanged?` The cats on this URI is changed to ${m.escapeHTML(cats)}.`:""}`);
				m.rmb_me(m.reco_pointChange_do, {strHeads, strContents, uri, valStr, $result, inRecoms, cats});
			}
		}
		else {
			let strHeads="do\turi\tval";
			let strContents=`reco\t${m.encloseStr(uri)}\t${m.encloseStr(valStr)}`;
			let cats="";
			if (m.recoMode==="multireco") {
				cats=m.formatCats($multireco_input_cats[0].value);
			}
			else {
				cats=m.formatCats(m.currentCat);
			}
			strHeads+="\tcats";
			strContents+=`\t${m.encloseStr(cats)}`;
			let strRecoDo=strHeads+"\n"+strContents;
			$result.html("[--Recoing to your recoeve.net.--]");
			m.rmb_me(m.reco_do, {strRecoDo, uri, $result}, true);
		}
	}
};
m.starsOnClick=function (e) {
	let $target=$(e.target);
	let $reco=$target.parents(".reco");
	if (!$target.hasClass("stars-container")) {
		$target=$target.parents(".stars-container");
	}
	let uri=m.unescapeHTML($reco.find(".textURI").html());
	clearTimeout(m.timeout[uri]);
	let $result=$reco.find(".result");
	$result.html("");
	let $bar=$target.find(".bar");
	let barW=$bar.width();
	let $str=$target.siblings(".str");
	let w=e.clientX-$bar.offset().left+$window.scrollLeft();
	if (w<-15) {
		w=-1;
	}
	else if (w<0) {
		w=0;
	}
	else if (w>m.starsWidth) {
		w=m.starsWidth;
	}
	if (w!==barW) {
		barW=w;
		if (w<0) {
			$str.html("");
			w=0;
		}
		else {
			$str.html(m.escapeHTML((w/m.starsWidth*m.fullPts).toFixed(1)+"/"+m.fullPts));
		}
		$bar.css({width:w});
	}
	m.timeout[uri]=setTimeout(function () {
		m.recoByOnlyStars($str, uri, $result, $reco.hasClass("recom"));
	}, 2048);
};
m.starsOnTouchMove=function (e) {
	let $target=$(e.target);
	if (!$target.hasClass("stars-container")) {
		$target=$target.parents(".stars-container");
	}
	let $reco=$target.parents(".reco");
	let uri=m.unescapeHTML($reco.find(".textURI").html());
	clearTimeout(m.timeout[uri]);
	let $result=$reco.find(".result");
	$result.html("");
	let $bar=$target.find(".bar");
	let barW=$bar.width();
	let $str=$target.siblings(".str");
	$html.on("mousemove.mdInStars touchmove.mdInStars", function (e) {
		window.getSelection().removeAllRanges();
		e.preventDefault();
		e.stopPropagation();
		let x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
		let w=x-$bar.offset().left+$window.scrollLeft();
		if (w<-15) {
			w=-1;
		}
		else if (w<0) {
			w=0;
		}
		else if (w>m.starsWidth) {
			w=m.starsWidth;
		}
		if (w!==barW) {
			barW=w;
			if (w<0) {
				$str.html("");
				w=0;
			}
			else {
				$str.html((w/m.starsWidth*m.fullPts).toFixed(1)+"/"+m.fullPts);
			}
			$bar.css({width:w});
		}
	});
	return {$str, uri, $result, $reco};
};
m.starsOnUps=function (e) {
	let $target=$(e.target);
	let $reco=$target.parents(".reco");
	let uri=m.unescapeHTML($reco.find(".textURI").html());
	clearTimeout(m.timeout[uri]);
	let $result=$reco.find(".result");
	$result.html("");
	let $str=$target.siblings(".str");
	let $star=$reco.find(".my-point>.stars-container");
	let val=m.val($str.html());
	if (val.valid) {
		if (val.val===-1) {
			$str.html("10.0/10");
		}
		else {
			val.num+=0.1;
			if (val.num>val.divisor) {
				val.num=val.divisor;
			}
			$str.html(`${val.num.toFixed(1)}/${val.divisor}`);
		}
	} else {
		$str.html("10.0/10");
	}
	val=m.val($str.html());
	$star.find(".bar").css({width:m.starsWidth*val.val});
	m.timeout[uri]=setTimeout(function () {
		m.recoByOnlyStars($str, uri, $result, $reco.hasClass("recom"));
	}, 2048);
};
m.starsOnDowns=function (e) {
	let $target=$(e.target);
	let $reco=$target.parents(".reco");
	let uri=m.unescapeHTML($reco.find(".textURI").html());
	clearTimeout(m.timeout[uri]);
	let $result=$reco.find(".result");
	$result.html("");
	let $str=$target.siblings(".str");
	let $star=$reco.find(".my-point>.stars-container");
	let val=m.val($str.html());
	if (val.valid) {
		if (val.val===-1) {
			$str.html("0.0/10");
		}
		else {
			val.num-=0.1;
			if (val.num<0) {
				val.num=0;
			}
			$str.html(`${val.num.toFixed(1)}/${val.divisor}`);
		}
	} else {
		$str.html("0.0/10");
	}
	val=m.val($str.html());
	$star.find(".bar").css({width:m.starsWidth*val.val});
	m.timeout[uri]=setTimeout(function () {
		m.recoByOnlyStars($str, uri, $result, $reco.hasClass("recom"));
	}, 2048);
};
m.reNewAndReOn=function () {
	m.$delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
	$window.off("scroll.delayedLoad");
	$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
	$window.trigger("scroll.delayedLoad");
	m.$fdList=$("#right-top-log-in, #change-style, #foot, #head, #headPlay, #playlist-container, #numbers-of-recos, .reco, .to-be-executed");
	let $stars=$(".my-point>.stars-container");
	$stars.off("click.mdInStars");
	$stars.on("click.mdInStars", m.starsOnClick);
	$stars.off("mousedown.mdInStars touchstart.mdInStars");
	$html.off("mouseup.mdInStars touchend.mdInStars mousemove.mdInStars touchmove.mdInStars");
	$stars.on("mousedown.mdInStars touchstart.mdInStars", function (e) {
		let {$str, uri, $result, $reco}=m.starsOnTouchMove(e);
		$html.on("mouseup.mdInStars touchend.mdInStars", function (e) {
			$html.off("mouseup.mdInStars touchend.mdInStars mousemove.mdInStars touchmove.mdInStars");
			m.timeout[uri]=setTimeout(function () {
				m.recoByOnlyStars($str, uri, $result, $reco.hasClass("recom"));
			}, 2048);
		});
	});
	let $ups=$(".my-point>.up");
	let $downs=$(".my-point>.down");
	$ups.off("click.ud");
	$downs.off("click.ud");
	$ups.on("click.ud", m.starsOnUps);
	$downs.on("click.ud", m.starsOnDowns);
};



/* Points */
////////////////////////////////////////////////////
// val, points, stars
////////////////////////////////////////////////////
m.val=function (val) {
	let res={valid:false, str:"", val:-1};
	if (val===null||val===undefined) {
		return res;
	}
	else if (val?.constructor!==String) {
		return res;
	}
	res.str=val;
	if (val.length===0) {
		res.valid=true;
		res.val=-1;
	}
	else {
		let exec=m.ptnVal.exec(val);
		if (exec!==null) {
			res.num=Number(exec[1]);
			res.divisor=Number(exec[2]);
			res.valid=(res.num>=0&&res.num<=res.divisor);
			if (res.valid) {
				res.val=res.num/res.divisor;
			}
			else {
				res.val=-1;
			}
		}
	}
	return res;
};
{
	let r=12; // outer radius of star
	let r0=6; // inner radius of star
	let pad=1; // padding of star
	let pad0=9; // left/right pad
	let thetas=[];
	let coss=[];
	let sins=[];
	for (let i=0;i<10;i++) {
		thetas.push(-Math.PI/2+2*Math.PI/10*i);
		coss.push(Math.cos(thetas[i]));
		sins.push(Math.sin(thetas[i]));
	}
	let str=`${pad0},0 `;
	let yc=pad+r;
	let xc=pad0+pad+r;
	for (let k=0;k<5;k++,xc+=2*r+pad) {
		str+=`${xc},0 `;
		for (let i=0;i<10;i++) {
			let rp=(i%2==0)?r:r0;
			str+=`${(xc+rp*coss[i]).toFixed(1)},${(yc+rp*sins[i]).toFixed(1)} `;
		}
		str+=`${xc},${pad} ${xc},0 `;
	}
	xc-=r;
	yc+=r*sins[4]+pad;
	str+=`${xc},0 ${xc},${yc.toFixed(1)} ${pad0},${yc.toFixed(1)}`;
	m.starsWidth=xc-pad0-2;
	m.stars=function (val) {
		if (val<0) { val=0; }
		else if (val>1) { val=1; }
		return `<div class="stars-container" style="width:${xc+pad0}px; height:${yc.toFixed(1)}px"><div class="bar" style="left:${pad0+1}px; width:${(m.starsWidth*val).toFixed(1)}px"></div><svg class="out-stars"><polygon points="${str}"/></svg></div>`;
	}
}



////////////////////////////////////////////////////
// Show recos
////////////////////////////////////////////////////
m.recoDowned=function (urisStr, recos) {
	let uris=urisStr.trim().split("\n");
	for (k=0;k<uris.length;k++) {
		let uri=uris[k];
		let r=recos[uri];
		if (!r) { r=recos[uri]={}; }
		r.down=true; // User's or My reco on the uri is downloaded.
	}
};
m.recoToEve=async function (resp, recos, cat, uris) {
return new Promise(async function (resolve, reject) {
	resp=await m.strToJSON(resp);
	for (let k=1;k<resp.length;k++) {
		let respK=await resp[k];
		let uri=String(respK.uri);
		let r=recos[uri];
		if (!r) { r=recos[uri]={}; }
		r.has=true; // User has a reco on the uri.
		for (let prop in respK) {
			if (isNaN(prop)) {
				prop=String(prop);
				r[prop]=String(respK[prop]);
			}
		}
		r.deleted=false;
		if (r.desc!==undefined) {
			r.descR=m.renderStrDescCmt(String(r.desc)); // R for rendered.
		}
		else {
			r.descR=m.renderStrDescCmt("");
		}
		if (r.cmt!==undefined) {
			r.cmtR=m.renderStrDescCmt(String(r.cmt)); // R for rendered.
		}
		else {
			r.cmtR=m.renderStrDescCmt("");
		}
		r.val=m.val(String(r.val));
	}
	return resolve();
});
};



////////////////////////////////////////////////////
// New Reco or Edit
////////////////////////////////////////////////////
m.getUTF8Length=function (s) {
	let len=0;
	for (let i=0;i<s.length;i++) {
		let code=s.charCodeAt(i);
		if (code<=0x7f) {
			len+=1;
		}
		else if (code<=0x7ff) {
			len+=2;
		}
		else if (code>=0xd800&&code<=0xdfff) {
			// Surrogate pair: These take 4 bytes in UTF-8 and 2 chars in UCS-2
			// (Assume next char is the other [valid] half and just skip it)
			len+=4; i++;
		}
		else if (code<0xffff) {
			len+=3;
		}
		else {
			len+=4;
		}
	}
	return len;
};
m.formatURI=function (uri) {
	if (!!uri&&uri.constructor===String) {
		uri=uri.trim().replace(/[\t\n]/g," ");
		let exec=m.ptnTag.exec(uri);
		if (exec!==null) {
			try {
				let $uri=$(uri);
				let src=$uri.attr("src");
				if (src) {
					uri=src;
				}
				else {
					src=$uri.find("[src]").attr("src");
					if (src) { uri=src; }
				}
			} catch (err) {
				console.log(err);
			}
		}
		return m.unescapeHTML(uri).trim();
	}
	return "";
};
m.formatTitle=function (title) {
	return title.trim().replace(/[\t\r\n]/g," ");
};
m.formatCats=function (cats) {
	if (!cats||cats.constructor!==String||cats.trim().length===0) {
		return "";
	}
	cats=cats.trim().replace(/[\t\r\n]/g," ");
	let list=cats.split(";");
	for (let i=0;i<list.length;i++) {
		let levels=list[i].split("--");
		for (let j=0;j<levels.length;j++) {
			levels[j]=levels[j].replace(/^[\s-]+/,"").replace(/[\s-]+$/,"");
		}
		list[i]="";
		let k=0;
		for (;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]=levels[k];
				break;
			}
		}
		for (k++;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]+="--"+levels[k];
			}
		}
	}
	let catsMap={};
	catsMap[list[0]]=true;
	cats=list[0];
	for (let i=1;i<list.length;i++) {
		if (catsMap[list[i]]) {
		}
		else {
			catsMap[list[i]]=true;
			cats+=";"+list[i];
		}
	}
	return cats;
};

m.myRecos[""]={
	has:false, down:true, h1:"Empty URI.", defs:true
	, title:"", cats:"", desc:"", cmt:"", val:m.val("")
	, defTitles:[[""]], defCats:[[""]], defDescs:[[""]]
};
m.showMyReco=async function (r) {
	if (r.has) {
		if (r.deleted) {
			$button_reco.show();
			$button_edit.hide();
			$button_del.hide();
			$button_back.show();
		}
		else {
			$button_reco.hide();
			$button_edit.show();
			$button_del.show();
			$button_back.show();
		}
	}
	else {
		$button_reco.show();
		$button_edit.hide();
		$button_del.hide();
		$button_back.hide();
	}
	let $mR=$("#my-reco");
	let recoHTML=await m.recoHTML(r, true, true);
	$mR.html(String(recoHTML)); // need to be edit.
	if (r.has) {
		let $edit=$mR.find(".button.edit").remove();
		$edit.on("click", function (e) {
			$input_title[0].value=r.title;
			$input_cats[0].value=r.cats;
			$input_desc[0].value=r.desc;
			$input_cmt[0].value=r.cmt;
			$input_val[0].value=r.val.str;
			$input_val.trigger("keyup");
		});
	}
};
m.fillRecoInNewReco=function (r, fillDefs) {
	m.localStorage.clear();
	if (r.has) {
		$input_title[0].value=r.title;
		$input_cats[0].value=r.cats;
		$input_desc[0].value=r.desc;
		$input_cmt[0].value=r.cmt;
		$input_val[0].value=r.val.str;
		$input_val.trigger("keyup");
	}
	else if (fillDefs) {
		if (r.defTitles[0]&&r.defTitles[0][0]) {
			$input_title[0].value=r.defTitles[0][0];
		}
		$input_cats[0].value=m.currentCat;
		if (r.defDescs[0]&&r.defDescs[0][0]) {
			$input_desc[0].value=r.defDescs[0][0];
		}
	}
	if (r.has) {
		if (r.deleted) {
			$button_reco.show();
			$button_edit.hide();
			$button_del.hide();
			$button_back.show();
		}
		else {
			$button_reco.hide();
			$button_edit.show();
			$button_del.show();
			$button_back.show();
		}
	}
	else {
		$button_reco.show();
		$button_edit.hide();
		$button_del.hide();
		$button_back.hide();
	}
};
m.emptifyRecoInNewReco=function () {
	$input_uri[0].value="";
	$input_title[0].value="";
	$input_cats[0].value="";
	$input_desc[0].value="";
	$input_cmt[0].value="";
	$input_val[0].value="";
	$input_val.trigger("keyup");
	m.getAndShowDefsAndRecoInNewReco(true);
	m.reNewAndReOn();
};
m.showDefs=async function (r) {
	let defTitles=r.defTitles;
	let defTitlesHTML="";
	if (!r.h1) {
		r.h1=await m.getH1(r.uri);
	}
	defTitlesHTML+=`<div class="def-title def-h1">${m.escapeHTML(String(r.h1))}</div>`;
	for (let i=0;i<defTitles.length;i++) {
		let title=defTitles[i][0].trim();
		if (title.length!==0) {
			defTitlesHTML+=`<div class="def-title">${m.escapeHTML(title)}</div>`;
		}
	}
	$def_titles.html(defTitlesHTML);
	let $defTitles=$def_titles.find(".def-title");
	$defTitles.on("click", function (e) {
		$defTitles.removeClass("selected");
		let $this=$(this);
		$this.addClass("selected");
		$input_title[0].value=m.unescapeHTML($this.html());
	});

	let defCats=r.defCats;
	let defCatsHTML=`<div class="def-cat replace-cat">[--Indifferent--]</div> <div class="def-cat replace-cat">[--Later--]</div> <div id="add-cat" class="def-cat add-txt">;</div> <div id="sub-cat" class="def-cat add-txt">--</div> <div id="delete-cat" class="def-cat delete-cat">[--Delete--]</div><br>`;
	for (let i=0;i<defCats.length;i++) {
		let cat=defCats[i][0].trim();
		if (cat.length!==0) {
			defCatsHTML+=`<div class="def-cat replace-cat">${m.escapeHTML(cat)}</div> `;
		}
	}
	$def_cats.html(defCatsHTML);
	let $defCats=$def_cats.find(".def-cat");
	let $replaceCats=$def_cats.find(".replace-cat");
	$replaceCats.on("click", function (e) {
		let $this=$(this);
		let fs=m.fsCat;
		$defCats.removeClass("selected");
		$this.addClass("selected");
		let k=fs.k;
		fs.listOfCats[k]=m.unescapeHTML($this.html()).trim();
		fs.$fs[0].value=fs.listOfCats.join(";");
		let sStart=0;
		for (let i=0;i<k;i++) {
			sStart+=fs.listOfCats[i].length+1;
		}
		let sEnd=sStart+fs.listOfCats[k].length;
		fs.$fs.focus();
		fs.$fs[0].setSelectionRange(sEnd,sEnd);
	});
	let $addTxts=$def_cats.find(".add-txt");
	$addTxts.on("click", function (e) {
		let $this=$(this);
		$defCats.removeClass("selected");
		$this.addClass("selected");
		let sStart=$input_cats[0].selectionStart;
		let sEnd=$input_cats[0].selectionEnd;
		let inputValue=$input_cats[0].value;
		let inserted=m.unescapeHTML($this.html());
		$input_cats[0].value=`${inputValue.substring(0,sStart)}${inserted}${inputValue.substring(sEnd)}`;
		let l=$input_cats[0].value.length;
		$input_cats.focus();
		sEnd=sStart+inserted.length;
		$input_cats[0].setSelectionRange(sEnd,sEnd);
		$input_cats.trigger("keyup.fs");
	});
	let $deleteCat=$def_cats.find(".delete-cat");
	$deleteCat.on("click", function (e) {
		let $this=$(this);
		let fs=m.fsCat;
		$defCats.removeClass("selected");
		$this.addClass("selected");
		let k=fs.k;
		fs.listOfCats.splice(k, 1);
		fs.$fs[0].value=fs.listOfCats.join(";");
		let sStart=0;
		for (let i=0;i<k;i++) {
			sStart+=fs.listOfCats[i].length+1;
		}
		let sEnd=fs.listOfCats.length===k?sStart-1:sStart;
		fs.$fs.focus();
		fs.$fs[0].setSelectionRange(sEnd,sEnd);
		$input_cats.trigger("keyup.fs");
	});

	let defDescs=r.defDescs;
	let defDescsHTML="";
	for (let i=0;i<defDescs.length;i++) {
		let desc=defDescs[i][0].trim();
		if (desc.length!==0) {
			if (desc.length<30) {
				defDescsHTML+=`<div class="def-desc">${m.escapeHTML(desc)}<data class="none">${m.escapeHTML(desc)}</data></div>`;
			}
			else {
				defDescsHTML+=`<div class="def-desc">${m.escapeHTML(desc.substring(0,15))} ... ${m.escapeHTML(desc.substring(desc.length-15))}<data class="none">${m.escapeHTML(desc)}</data></div>`;
			}
		}
	}
	$def_descs.html(defDescsHTML);
	let $defDesc=$def_descs.find(".def-desc");
	$defDesc.on("click", function (e) {
		$defDesc.removeClass("selected");
		let $this=$(this);
		$this.addClass("selected");
		$input_desc[0].value=m.unescapeHTML($this.find("data.none").html());
	});
};
$def_cmd=$("#def-cmds").find(".def-cmd");
$def_cmd.on("click", function (e) {
	$input_desc.focus();
	let sStart=$input_desc[0].selectionStart;
	let sEnd=$input_desc[0].selectionEnd;
	let inputValue=$input_desc[0].value;
	let inserted=m.unescapeHTML($(this).html());
	$input_desc[0].value=`${inputValue.substring(0,sStart)}${inserted}${inputValue.substring(sEnd)}`;
	$input_desc.focus();
	sEnd=sStart+inserted.length;
	$input_desc[0].setSelectionRange(sEnd,sEnd);
});
m.getAndFillRecoInNewReco=function (r, fillDefs) {
	return new Promise(function (resolve, reject) {
		if (r.down) {
			m.fillRecoInNewReco(r, fillDefs);
			resolve();
		}
		else {
			let getRecosStr="uri"+"\n"+r.uri;
			$.ajax({
				type:"POST", url:`/user/${m.myId}/get-Recos`, data:getRecosStr
				, dataType:"text"
			}).done(async function (resp) { // User reco 가 없으면 head 만 보냄.
				m.recoDowned(r.uri, m.myRecos);
				await m.recoToEve(resp, m.myRecos);
				m.fillRecoInNewReco(r, fillDefs);
				resolve();
			});
		}
	});
};
m.getAndFillDefsInNewReco=function (r, fillDefs) {
	return new Promise(function (resolve, reject) {
		if (r.defs) {
			m.showDefs(r, fillDefs);
			resolve();
		}
		else {
			m.showDefs({defTitles:[[""]], defCats:[[""]], defDescs:[[""]]});
			$.ajax({
				type:"POST", url:"/reco/defs", data:r.uri
				, dataType:"text"
			}).done(async function (resp) {
				let defs=await m.strToJSON(resp);
				r.defs=true;
				if (defs[1]) {
					r.defCats=await m.strToJSON(defs[1]["def-cats"], false);
					r.defTitles=await m.strToJSON(defs[1]["def-titles"], false);
					r.defDescs=await m.strToJSON(defs[1]["def-descs"], false);
					m.showDefs(r);
				}
				resolve();
			});
		}
	});
};
m.getFullRecoStatAndPlotChart=function (uri) {
return new Promise(function (resolve, reject) {
	$.ajax({
		type:"POST", url:"/reco/stat", data:uri
		, dataType:"text"
	}).done(async function (resp) {
		if (!m.myRecos[uri]) {
			m.myRecos[uri]={};
		}
		let r=m.myRecos[uri];
		r.stat=await m.strToJSON(resp);
		r.stat.recentests=await m.strToJSON(r.stat.recentests);
		console.log(r.stat);
		let maxN=0;
		for (let i=0;i<=100;i++) {
			let nI=r.stat["n"+i]=parseInt(r.stat["n"+i], 16);
			if (nI>maxN) {
				maxN=nI;
			}
		}
		console.log(maxN);
	});
});
};
m.getAndShowDefsAndRecoInNewReco=async function (noFormatURI, fillDefs) {
	let elem=$input_uri[0];
	let uri=m.lastURI=noFormatURI?elem.value:m.formatURI(elem.value);
	if (elem.value!==uri) { elem.value=uri; }
	let uriRendered=await uriRendering(uri,true);
	let from=String(uriRendered.from);
	if (!noFormatURI) {
		m.lastURI=uri;
		if (from==="youtube") {
			uri=elem.value=`https://www.youtube.com/watch?v=${uriRendered.videoId}`;
		}
		else if (from==="instagram") {
			uri=elem.value=`https://www.instagram.com/p/${uriRendered.imgId}/`;
		}
		else if (from==="tiktok") {
			uri=elem.value=`https://www.tiktok.com/@${uriRendered.userId}/video/${uriRendered.videoId}`;
		}
		else if (from==="weverse") {
			uri=elem.value=`https://weverse.io/${uriRendered.singer}/artist/${uriRendered.videoId}`;
		}
		else if (from==="naver") {
			uri=elem.value=`https://tv.naver.com/v/${uriRendered.videoId}`;
		}
		else if (from==="vlive") {
			uri=elem.value=`https://www.vlive.tv/video/${uriRendered.videoId}`;
		}
		else if (from==="kakao") {
			uri=elem.value=`https://tv.kakao.com/v/${uriRendered.videoId}`;
		}
		else if (from==="ted") {
			uri=elem.value=`https://www.ted.com/talks/${uriRendered.videoId}`;
		}
		else if (from==="dailymotion") {
			uri=elem.value=`https://www.dailymotion.com/video/${uriRendered.videoId}`;
		}
	}
	$show_URI.html(String(uriRendered.html));
	let r=m.myRecos[uri];
	if (!r) { r=m.myRecos[uri]={uri}; }
	await m.getAndFillRecoInNewReco(r, fillDefs);
	await m.getAndFillDefsInNewReco(r, fillDefs);
	await m.getFullRecoStatAndPlotChart(uri);
	m.reNewAndReOn();
};
$new_reco.find("input, textarea").on("keydown.common", function (e) {
	if (e.keyCode===27&&$new_reco.is(":visible")) { // ESC
		$window.trigger({type:'keydown', keyCode:'N'.charCodeAt(0)});
	}
	else if (e.ctrlKey&&e.keyCode===13) { // Ctrl+Enter
		let r=m.myRecos[$input_uri[0].value];
		if (r.has) {
			$button_edit.trigger("click");
		}
		else {
			$button_reco.trigger("click");
		}
	}
});
$input_cats.off("keydown.common");
m.lastURI="x*L2$zp-|,O";
$input_uri.on("input keyup keydown cut paste click focus", function (e) {
	let uri=this.value;
	if (uri!==m.lastURI) {
		m.lastURI=uri;
		clearTimeout(m.timeOutGetInfos);
		m.timeOutGetInfos=setTimeout(function () {
			m.getAndShowDefsAndRecoInNewReco(false);
		}, 1024);
	}
});

m.lastVal=m.val("");
$input_val.before($(m["5stars"](0)).attr({id:"input-val-stars"}));
$input_val_stars=$("#input-val-stars");
$input_val_stars.on("mousedown.mdInStars touchstart.mdInStars", function(e) {
	var $bar=$input_val_stars.find(".bar");
	var barW=$bar.width();
	var $val=$input_val[0];
	$html.on("mousemove.mdInStars touchmove.mdInStars", function(e) {
		window.getSelection().removeAllRanges();
		e.preventDefault();
		e.stopPropagation();
		var x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
		var w=x-$bar.offset().left+$window.scrollLeft();
		if (w<-15) {
			w=-1;
		} else if (w<0) {
			w=0;
		} else if (w>m["5stars-width"]) {
			w=m["5stars-width"];
		}
		if (w!==barW) {
			barW=w;
			if (w<0) {
				$val.value="";
				w=0;
			} else {
				$val.value=(w/m["5stars-width"]*m.fullPts).toFixed(1)+"/"+m.fullPts;
			}
			$bar.css({width:w});
			m.lastVal=m.val($val.value);
		}
	});
	$html.on("mouseup.mdInStars touchend.mdInStars", function(e) {
		$html.off("mouseup.mdInStars touchend.mdInStars mousemove.mdInStars touchmove.mdInStars");
	});
});
$input_val_stars.on("click", function(e) {
	var $bar=$(this).find(".bar");
	var barW=$bar.width();
	var $val=$input_val[0];
	var w=e.clientX-$bar.offset().left+$window.scrollLeft();
	if (w<0) {
		w=0;
	} else if (w>m["5stars-width"]) {
		w=m["5stars-width"];
	}
	if (w!==barW) {
		$bar.css({width:w});
		$val.value=(w/m["5stars-width"]*m.fullPts).toFixed(1)+"/"+m.fullPts;
		m.lastVal=m.val($val.value);
	}
});
$input_val.on("keyup", function(e) {
	if (this.value!==m.lastVal.str) {
		var val=m.val(this.value);
		var $bar=$("#input-val-stars .bar");
		if (val.valid&&val.str.length!==0) {
			m.fullPts=val.divisor;
			$bar.css({width:m["5stars-width"]*val.val});
		} else {
			$bar.css({width:0});
		}
		m.lastVal=val;
	}
});

$button_close.on("click", function(e) {
	$new_reco.hide();
	$window.off("scroll.stop");
});
$button_back.on("click", function(e) {
	var r=m.myRecos[$input_uri[0].value];
	m.showReco(r);
});

m.reco_do=function(args) {
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strRecoDo
		, dataType:"text"
	}).fail(function() {
		$error.html("Reco failed. You may be not logged-in.");
	}).done(function(resp) {
		var res=m.strToJSON(resp);
		if (res[1]["result"]==="recoed") {
			$error.html("recoed");
			m.recoDowned(args.uri, m.myRecos);
			m.recoToEve(args.strRecoDo, m.myRecos);
			var cats=m.myRecos[args.uri]["cats"];
			m.putCats_UriToLists(cats, args.uri);
			m.refresh(cats, "recoed", args.uri);
		} else {
			$error.html(res[1]["result"]);
		}
	}).always(function() {
		$button_reco.removeClass("disabled");
	});
};
$button_reco.on("click", function(e) {
	$button_reco.addClass("disabled");
	var uri=m.formatURI($input_uri[0].value);
	var val=m.val($input_val[0].value.trim());
	var errorMsg="";
	var valid=true;
	if (uri.length===0) {
		valid=false;
		errorMsg="URI is required.";
	} else if (m.getUTF8Length(uri)>255) {
		valid=false;
		errorMsg="URI (Length "+m.getUTF8Length(uri)+" &gt; maxUTF8Length 255) is too long.";
	} else if (!val.valid) {
		valid=false;
		errorMsg="Points is of invalid form.";
	}
	if (valid) {
		var strHeads="do"+"\t"+"uri";
		var strContents="reco"+"\t"+m.encloseStr(uri);
		strHeads+="\t"+"title";
		strContents+="\t"+m.encloseStr(m.formatTitle($input_title[0].value.trim()));
		strHeads+="\t"+"cats";
		strContents+="\t"+m.encloseStr(m.formatCats($input_cats[0].value.trim()));
		strHeads+="\t"+"desc";
		strContents+="\t"+m.encloseStr($input_desc[0].value.trim());
		strHeads+="\t"+"cmt";
		strContents+="\t"+m.encloseStr($input_cmt[0].value.trim());
		strHeads+="\t"+"val";
		strContents+="\t"+m.encloseStr(val.str);
		var strRecoDo=strHeads+"\n"+strContents;
		$error.html("Being recoed.");
		m.rmb_me(m.reco_do, {strRecoDo:strRecoDo, uri:uri});
		
	} else {
		$error.html(errorMsg);
		$button_reco.removeClass("disabled");
	}
});
m.reco_change_do=function (args, err) {
	if (err) {
		m.delayedLogOut(`[--Failed change. You may not be logged-in.--] ${err}`, 60*60*24);
		$button_edit.removeClass("disabled");
		return;
	}
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).fail(function (resp) {
		$error.html("[--Failed change. You may not be logged-in.--] "+resp);
	}).done(async function (resp) {
		let res=await m.strToJSON(resp);
		let result=String(res[1]?.result)
		if (result.startsWith("changed")) {
			$error.html(m.escapeHTML(result));
			if (args.cats!==args.r.cats) {
				m.catsChangedOnUri(args.r.cats, args.cats, args.uri);
				args.r.cats=args.cats;
			}
			if (args.title!==args.r.title) { args.r.title=args.title; }
			if (args.desc!==args.r.desc) {
				args.r.desc=args.desc;
				args.r.descR=m.renderStrDescCmt(args.desc);
			}
			if (args.cmt!==args.r.cmt) {
				args.r.cmt=args.cmt;
				args.r.cmtR=m.renderStrDescCmt(args.cmt);
			}
			if (args.val.str!==args.r.val.str) { args.r.val=args.val; }
			m.refresh(args.cats, "changed", args.uri);
		}
		else if (result.startsWith("recoed")) {
			$error.html("recoed");
			m.recoDowned(args.uri, m.myRecos);
			m.recoToEve(args.strRecoDo, m.myRecos);
			var cats=m.myRecos[args.uri]["cats"];
			m.putCats_UriToLists(cats, args.uri);
			m.refresh(args.cats, "recoed", args.uri);
		}
		else {
			m.delayedLogOut(res[1]?.result, 60*60*24, args.$result);
		}
	}).always(function () {
		$button_edit.removeClass("disabled");
	});
};
$button_edit.on("click", function(e) {
	$button_edit.addClass("disabled");
	var uri=$input_uri[0].value;
	var val=m.val($input_val[0].value.trim());
	var r=m.myRecos[uri];
	if (uri.length!==0&&val.valid&&r) {
		var strHeads="do"+"\t"+"uri";
		var strContents="change"+"\t"+m.encloseStr(uri);
		var changed=false;
		var title=m.formatTitle($input_title[0].value.trim());
		if (title!==r["title"]) {
			changed=true;
			strHeads+="\t"+"title";
			strContents+="\t"+m.encloseStr(title);
		}
		var cats=m.formatCats($input_cats[0].value.trim());
		if (cats!==r["cats"]) {
			changed=true;
			strHeads+="\t"+"cats";
			strContents+="\t"+m.encloseStr(cats);
		}
		var desc=$input_desc[0].value.trim();
		if (desc!==r["desc"]) {
			changed=true;
			strHeads+="\t"+"desc";
			strContents+="\t"+m.encloseStr(desc);
		}
		var cmt=$input_cmt[0].value.trim();
		if (cmt!==r["cmt"]) {
			changed=true;
			strHeads+="\t"+"cmt";
			strContents+="\t"+m.encloseStr(cmt);
		}
		if (val.str!==r["val"].str) {
			changed=true;
			strHeads+="\t"+"val";
			strContents+="\t"+m.encloseStr(val.str);
		}
		if (changed) {
			$error.html("Being changed.");
			m.rmb_me(m.reco_change_do, {strHeads:strHeads, strContents:strContents, cats:cats, r:r, uri:uri, title:title, desc:desc, cmt:cmt, val:val});
		} else {
			$error.html("You have made no change.");
			$button_edit.removeClass("disabled");
		}
	} else {
		var errorMsg="";
		if (uri.length===0) {
			errorMsg="URI is required.";
		} else if (!val.valid) {
			errorMsg="Points is of invalid form.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_edit.removeClass("disabled");
	}
});
m.reco_delete_do=function(args) {
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).done(function(resp) {
		console.log(resp);
		var res=m.strToJSON(resp);
		if (res[1]["result"]==="deleted") {
			$error.html("Deleted");
			var cats=args.r["cats"];
			delete m.myRecos[args.uri];
			m.delCats_UriFromLists(cats, args.uri);
			if (m.myPage) {
				m.refresh(cats, "deleted", args.uri);
			}
			setTimeout(function() {
				// $button_del.removeClass("disabled");
				$button_close.trigger("click");
			}, 1000);
		} else {
			$error.html(res[1]["result"]);
			// $button_del.removeClass("disabled");
		}
	}).always(function() {
		$button_del.removeClass("disabled");
	});
};
$button_del.on("click", function(e) {
	$button_del.addClass("disabled");
	var uri=$input_uri[0].value;
	var r=m.myRecos[uri];
	if (uri.length!==0&&r) {
		var strHeads="do"+"\t"+"uri";
		var strContents="delete"+"\t"+m.encloseStr(uri);
		m.rmb_me(m.reco_delete_do, {strHeads:strHeads, strContents:strContents, r:r, uri:uri});
	} else {
		var errorMsg="";
		if (uri.length==0) {
			errorMsg="URI is required.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_del.removeClass("disabled");
	}
});
m.refresh=async function (cats, option, uri) {
	cats=String(cats);
	option=String(option);
	uri=String(uri);
	switch (option) {
		case "recoed":
			let recoHTML=await m.recoHTML(r, false, true)
			$contents.prepend(String(recoHTML));
			m.reNewAndReOn();
			break;
		case "changed": case "deleted":
			let $recos_recos=$("#contents").find(".reco");
			for (let k=0;k<$recos_recos.length;k++) {
				let $reco=$recos_recos.eq(k);
				let recoURI=m.unescapeHTML($reco.find(".textURI").html());
				if (recoURI===uri) {
					let recoHTML=await m.recoHTML(r, false, true);
					$reco.replaceWith(String(recoHTML));
				}
			}
			if (option==="changed") {
				m.reNewAndReOn();
			}
			else if (option==="deleted") {
				let r=m.myRecos[uri];
				r.deleted=true;
				r.has=false;
				m.lastURI="x*L2$zp-|,O";
				let $recos_recos=$("#contents").find(".reco");
				for (let k=0;k<$recos_recos.length;k++) {
					let $reco=$recos_recos.eq(k);
					let recoURI=m.unescapeHTML($reco.find(".textURI").html());
					if (recoURI===uri) {
						$reco.addClass("none deleted");
						$reco.find(".button.edit").addClass("deleted");
					}
				}
				m.reNewAndReOn();
			}
			break;
		default :
	}
};



////////////////////////////////////////////////
// Lang : set cookie, Cat : get ans show recos
////////////////////////////////////////////////
var vars=m.getSearchVars(window.location.search);
if (vars.lang!==undefined) {
	m.docCookies.setItem("lang", vars.lang.val, Infinity, "/");
}
if (vars.title!==undefined) {
	var title=vars.title.val;
	$input_title[0].value=title;
	// $input_title.trigger("input");
}
if (vars.uri!==undefined) {
	var uri=vars.uri.val;
	$input_uri[0].value=uri;
	$input_uri.trigger("input");
}
})(window.m, jQuery);
</script>
</html>