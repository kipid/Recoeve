<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=3, user-scalable=yes"/>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<title>Recoeve.net</title>
<script>
window.m={};
(function(m, undefined) {
	m.myIndex="{--myIndex--}";
	m.myId="{--myId--}";
	m.pathName=window.location.pathname;
	if (m.pathName.substring(0,6)!=="/user/") {
		m.pathName="/user/"+m.myId;
		if (window.location.pathname!=="/reco") {
			window.history.replaceState(null, null, m.pathName+window.location.search+window.location.hash);
		}
	}
	m.userId=decodeURIComponent(m.pathName.substring(6));
	var k=m.userId.indexOf("/");
	if (k!==-1) {
		m.userId=m.userId.substring(0,k);
		// m.pathName="/user/"+m.userId;
	}
	m.myPage=(m.myId===m.userId);
})(window.m);
</script>
<style>
body {margin:0; padding:0; overflow-wrap:break-word; word-wrap:break-word; word-break:break-word; background:rgb(150,150,150)}

div, form, input, textarea {-webkit-box-sizing:border-box; -moz-box-sizing:border-box; box-sizing:border-box; max-width:100%}
data {display:none}
.none {display:none}
.center {text-align:center}
.right {text-align:right}
.fLeft {float:left}
.fRight {float:right}
.cBoth {clear:both}
img {min-width:1em; min-height:1em; max-width:100%}

.button {display:inline-block; cursor:pointer; padding:.2em .5em; border:.15em solid rgb(50,50,50); background:rgb(110,110,110);}
.button.to-be-executed {display:block; max-width:15em; margin:10em auto}
.button.disabled {pointer-events:none; background:rgb(25,25,25); color:rgb(120,120,120)}
.button.left {float:left; margin-right:.5em}
.button:active {background:rgb(0,80,80)}
.button.enabled {background:rgb(50,130,50)}
.button.enabled:active {background:rgb(70,70,70)}

a {text-decoration:none}
a:link {color:rgb(60,60,160)} .dark a:link {color:rgb(190,190,235)}
a:visited {color:rgb(40,40,140)} .dark a:visited {color:rgb(170,170,215)}
a:active {color:rgb(0,100,100)} .dark a:active {color:rgb(100,215,215)}
a:hover {color:rgb(40,140,40)} .dark a:hover {color:rgb(170,215,170); text-decoration:underline}

::-webkit-scrollbar {width:7px; height:7px}
::-webkit-scrollbar-track {-webkit-border-radius:5px; border-radius:5px}
::-webkit-scrollbar-thumb {-webkit-border-radius:5px; border-radius:5px; background:rgb(0,120,120); -webkit-box-shadow:inset 0 0 3px rgb(0,0,0)}
::-webkit-scrollbar-corner {background:transparent}

#container {max-width:1000px; line-height:1.6; font-family:'Malgun Gothic', '맑은 고딕', 나눔고딕, NanumGothic, 'MS Mincho', Tahoma, Sans-serif; background:rgb(250,250,250); color:black; font-size:15px}
	#container.dark {background:rgb(75,75,75); color:white}
#sidebar-dragger {position:fixed; z-index:10; top:0; bottom:0; left:0; width:1.5em; background:transparent}
#sidebar {position:fixed; z-index:10; max-width:70%; width:15em; max-height:100%; margin:0; padding:.5em; background:rgb(230,230,230); color:black; border-right:1px solid white; border-bottom:1px solid white; overflow:auto}
	.dark #sidebar {background:rgb(35,35,35); color:white}
#sidebar-exit {position:fixed; z-index:10; right:0; width:20%; top:20%; height:4em; background:red}
.side2 {padding:0}

#user-noti {padding:.3em .2em; font-size:1.1em; color:rgb(150,150,240)}

#catList {margin-bottom:1em}
#catList .cat {border:1px solid transparent; margin-bottom:.15em}
#cat-to-here {border:1px solid rgb(130,130,130); margin:.5em}
#catList .cat.edit {position:relative; border:1px solid rgb(150,150,225); padding:0 1.3em}
#catList .cat.edit.move {position:fixed; z-index:101}
#catList .cat.edit>.edit-bar {position:absolute; width:1.3em; top:0; bottom:0; background:rgb(150,150,225)}
#catList .cat.edit>.edit-bar:first-child {left:0}
#catList .cat.edit>.edit-bar:last-child {right:0}
#catList .cat.selected {border:1px solid black}
	.dark #catList .cat.selected {border-color:white}
#catList .cat>.baseCat, #catList .cat>.EC {cursor:pointer}
#catList .cat>.baseCat {color:white}
#catList .cat.selected>.baseCat {pointer-events:none; color:rgb(255,210,210)}
#catList .cat>.noEC, #catList .cat>.EC {display:inline-block; font-size:.5em; margin-top:-.5em; width:2em; text-align:center; vertical-align:middle}

#cat-fs-container {
	position:relative;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#cat-fs-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#cat-fs-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#cat-fs-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#cat-fs-list .list-item .list-index {display:none}
#cat-fs-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#cat-fs-list .list-item .cat {font-size:.9em;}
#cat-fs-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#cat-fs-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}

#fuzzy-search-container {
	position:fixed; left:0; top:0;
	z-index:100;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#fuzzy-search {
	height:2em; max-height:5em; overflow-y:auto;
	font:inherit; font-size:1.3em; color:black;
	width:100%;
	padding:.1em 2em 0 .2em;
	border:.15em gray solid;
	background:white;
}
#fuzzy-search-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#fuzzy-search-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#fuzzy-search-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#fuzzy-search-list .list-item .list-index {display:none}
#fuzzy-search-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#fuzzy-search-list .list-item .cat {font-size:.9em;}
#fuzzy-search-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#fuzzy-search-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}
.exit {
	z-index:100;
	position:absolute; display:inline-block;
	right:0; top:0;
	margin:0;
	width:1.8em; height:1.8em; line-height:1.0;
	text-align:center;
	/*border-radius:.4em;*/
	cursor:pointer;
	border:.15em rgb(80, 80, 80) solid;
	background-color:rgb(30,30,30); color:white;
}
.exit>svg {
	width:100%; height:100%;
	font-size:1.8em; line-height:1.0;
}

#new-reco {z-index:100; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.8); overflow:auto; color:white} .dark #new-reco {color:white}
#new-reco form {position:relative; width:40em; max-width:100%; margin:1em auto; padding:1em; background:black; border:.2em solid rgb(120,120,130); text-align:left}
#new-reco label {display:inline-block; font-weight:bold; margin:.9em 0 .4em}
#new-reco label:first-child {margin-top:0}
#new-reco label>.desc {font-size:.8em}
#new-reco input, #new-reco textarea {display:block; max-width:100%; width:100%; resize:vertical; font:inherit; font-weight:bold; overflow-x:hidden; overflow-y:auto; padding:.2em .3em; background:white; color:rgb(50,50,50)}
textarea.single-line {min-height:2.2em; height:2.2em}
textarea.multi-line {font-size:.9em; min-height:10em}
#new-reco input#input-val {display:inline-block; width:8.5em}
#new-reco .def-title {margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-title.selected {border-color:rgb(255,180,180)}
#new-reco .def-cat {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-cat.selected {border-color:rgb(255,180,180)}
#new-reco #add-cat {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em;}
#input-val-stars {margin:0 .5em -.4em 0}
#new-reco .buttons {margin-top:1em; text-align:right}
#new-reco #error-msg {margin:0}

#point-range {margin:1em 0; position:relative; display:inline-block; float:right; width:300px; height:30px; background:rgb(200,100,100)}
#point-range-bar {position:absolute; left:15px; right:15px; height:100%; background:rgb(100,200,100)}
#point-range-left, #point-range-right {position:absolute; width:20px; top:0; bottom:10px; background:rgba(150,150,150,0.9); border:.15em solid rgb(50,50,50)}
#point-range-left {left:0}
#point-range-right {right:0}
#point-range-result {margin:1em; float:right; border:.15em solid black; padding:.1em .5em; vertical-align:top}
	.dark #point-range-result {border-color:white}

.numbers-of-recos {margin:1em 0; padding:.5em}

.reco {margin:0 0 1em; border-bottom:.15em solid black; background:rgb(230,230,230)}
	.dark .reco {border-color:rgb(100,100,100); background:black}
.reco:last-child {margin:0}
.reco .SNS-img {display:inline-block; margin:0; float:left; width:2em; height:2em; border:.15em gray solid; border-left:0; cursor:pointer; background-size:100% 100%}
.reco .SNS-img:first-child {border-left:.15em gray solid}
.reco>.textURI, .reco>.YTVideoId {display:none}
.reco>.uri {font-size:.8em; border:.15em solid rgb(100,100,150); border-bottom:0; padding:.2em .5em}
.reco>.title {font-size:1.1em; border:.15em solid rgb(150,100,100); padding:.2em .5em}
.reco>.cats {font-size:.8em; border:.15em solid rgb(100,150,100); border-top:0; padding:.2em .5em}
.reco>.cats>a {color:rgb(130,170,130)}
.reco>.cats>a.currentCat {color:rgb(140,180,140); font-weight:bold; text-decoration:none}
.reco>.desc {margin:.5em 0; padding:.5em}
.reco>.cmt {margin:.5em 0; padding:.5em; background:rgb(200,200,200); border-left:.3em solid rgb(10,80,80)} .dark .reco>.cmt {background:rgb(30,30,30)}
.stars-container {position:relative; display:inline-block; cursor:text}
.stars-container>div.bar {position:absolute; top:1px; bottom:1px; background:rgb(232,242,80)}
.stars-container>svg.out-stars {position:absolute; left:0; top:0; width:100%; height:100%}
.stars-container>svg.out-stars>polygon {fill:rgb(50,50,50);stroke-width:0;fill-rule:evenodd}
.reco>.val {margin:.5em 0 .3em}
.reco>.val>.str {border:.15em solid black; padding:.1em .5em; vertical-align:top}
	.dark .reco>.val>.str {border-color:white}
.reco .tFirst, .reco .tLast {display:inline-block; float:right; margin:.2em 1em; font-size:.8em}

.lyricsC {}
.lyricsArrow {width:0; height:0; padding:0; margin:0 auto; border-color:transparent transparent rgb(0,30,0); border-style:solid; border-width:0.5em}
.lyrics {border:0.3em solid rgb(0,30,0); padding:1em .5em; margin-top:-1px}

.rC, img {margin:.5em 0}
.rC.fixed {position:fixed; z-index:100; top:0; left:0; width:100%; max-width:100%; margin:0; padding:1px; background:white; border-bottom:.15em solid black}
	.dark .rC.fixed {background:black; border-color:white}
.rC>.rSC {box-sizing:content-box; -moz-box-sizing:content-box; position:relative; height:3em; padding-bottom:63%}
.rC>.rSC>* {position:absolute; width:100%; height:100%; left:0; top:0}
.pc {text-align:center; font-size:.85em} /* position change */

#foot {clear:both; margin-top:1em; border-top:.15em solid white; padding:1em .5em}

#floating-key {position:fixed; right:.5em; bottom:2.7em; width:6em; height:auto}
#floating-key div {}
#toggle-floating-key {position:fixed; right:.5em; bottom:.5em; width:auto; height:2.2em}

@media all and (min-width:701px) {
	#container {margin-left:14.9em}
	#sidebar {margin:0; position:fixed; left:0; top:0; bottom:0; width:15em}
	#sidebar-dragger {display:none}
	#sidebar-exit {display:none}
	.side2 {padding:.5em}
	.rC.fixed {width:646px; border-right:.15em solid black}
	.lyrics {text-align:right}
	::-webkit-scrollbar {width:11px; height:11px}
}
@media all and (min-width:901px) {
	#container {margin-left:19.9em}
	#sidebar {width:20em}
}
@media all and (min-height:500px) {
	#fuzzy-search-list {max-height:430px;}
}
</style>
</head>
<body>
<data id="data-myCatList">{--myCatList--}</data>
<data id="data-CatList">{--CatList--}</data>
<div id="container" class="dark">
<div id="sidebar-dragger"></div>
<div id="sidebar">
	<div id="user-noti"></div>
	<div id="catList"></div>
	<div class="right">
		<div class="button" id="change-catList-order">[--Change orders--]</div>
		<div class="button" id="change-catList-order-ok">[--OK--]</div>
		<div class="button" id="change-catList-order-cancel">[--Cancel--]</div>
	</div>
</div><!-- div#sidebar -->
<div id="sidebar-exit" style="display:none">x</div>
<div id="fuzzy-search-container" style="display:none">
	<div id="fuzzy-search" contenteditable="true"></div>
	<div id="fuzzy-search-list"></div>
	<div class="exit" onclick="$(this).parent().hide()"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
</div><!-- div#fuzzy-search-container -->
<div id="new-reco" style="display:none">
	<form>
	<label for="uri">URI <span class="desc">(required)</span></label>
		<textarea id="input-uri" class="single-line" name="uri" placeholder="Uniform Resource Indentifier: like http-URL" type="text" tabindex="1"></textarea>
		<div id="show-URI"></div>
	<label for="title">[--Title--]</label>
		<div id="def-titles"></div>
		<textarea id="input-title" class="single-line" name="title" placeholder="Title" type="text" tabindex="2"></textarea>
	<label for="cats">[--Categories--]</label>
		<div id="def-cats"><div class="def-cat">[--Indifferent--]</div> <div class="def-cat">[--Later--]</div> <div id="add-cat" onclick="m.addCat()">+;</div></div>
		<textarea id="input-cats" class="single-line" name="cats" placeholder="Category--Sub category--Subsub category ; Another category ; ..." type="text" tabindex="3"></textarea>
		<div id="cat-fs-container" class="fs-container" style="display:none">
			<div id="cat-fs-list"></div>
			<div class="exit" onclick="$(this).parent().hide()"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
		</div>
	<label for="desc">[--Description--]</label>
		<textarea id="input-desc" class="multi-line" name="desc" placeholder="Objective Description: you can refer a good description of others. In other words, you can provide a good description to the others." tabindex="4"></textarea>
	<label for="cmt">[--Comment--]</label>
		<textarea id="input-cmt" class="multi-line" name="cmt" placeholder="Comment: your personal description or opinion on this URI." tabindex="5"></textarea>
	<label for="val">[--Points--]</label>
		<input id="input-val" name="val" placeholder="Points (ex: 3/5)" type="text" tabindex="6"/>
	<div id="error-msg"></div>
	<div class="buttons">
		<div class="button" id="button-reco" tabindex="7">[--Reco--]</div>
		<div class="button" id="button-edit" tabindex="8">[--Edit--]</div>
		<div class="button" id="button-del" tabindex="11">[--Del--]</div>
		<div class="button left" id="button-close" tabindex="9">[--Close--]</div>
		<div class="button left" id="button-back" tabindex="10">[--Back--]</div>
		<div class="cBoth"></div>
	</div>
	<div id="my-reco"></div>
	<div class="exit" style="margin:-1em -.2em 0 0" onclick='$button_close.trigger("click")'><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
	</form>
</div><!-- div#new-reco -->
<div class="side2" id="head">
	<div class="button" id="my-id"></div>
	head : <a href="/account/log-out">[--Log out--]</a> / <a href="/account/log-in">[--Log in--]</a>
	<!-- <div class="button" onclick="$('#container').toggleClass('dark')">[--Toggle style--]</div> -->
	<div class="button" onclick="m.getNeighbors()">[--Get neighbors--]</div>
	<div class="button" id="out-focus" onclick='$fuzzy_search_container.show(); $fuzzy_search.focus();'>[--Fuzzy Search--]</div>
	<div class="button" id="button-new-reco">[--New Reco--]</div>
	<div>
		[--Short Keys--]
		<ul id="shortkeys"></ul>
	</div>
</div><!-- div#head -->
<div class="side2" id="subCats">
	<div id="point-range">
		<div id="point-range-bar"></div><div id="point-range-right"></div><div id="point-range-left"></div>
	</div>
	<span id="point-range-result">0~10/10</span>
	<div class="button enabled" id="show-recos-without-points">Show recos without points</div>
	<div class="cBoth"></div>
</div>
<div class="side2" id="headPlay">
	<div class="button" onclick="m.fsTitle.toggleRecoListPlay()">Toggle reco list play</div>
	<div id="playlist-container" style="display:none">
		<div class="button" onclick="m.fsTitle.Preceding()">[--Preceding--]</div>
		<div class="button" onclick="m.fsTitle.Following()">[--Following--]</div>
		<div class="button" onclick="m.fsTitle.shuffle()">[--Shuffle--]</div>
		<div class="button" onclick="m.fsTitle.toggleLoop(this)">[--Loop--]</div>
		<div class="button" onclick="m.fsTitle.toggleOneLoop(this)">[--One-loop--]</div>
		<div id="uri-rendered" style="display:none"></div>
		<div class="rC" id="rC-video-uri-rendered" style="display:none">
			<div class="rSC"><div id="video"></div></div>
			<div class="pc"><span onclick="m.togglePosition(this)">▲ [--stick to the left top--]</span></div>
		</div>
		<div class="rC" id="rC-youtube-uri-rendered" style="display:none">
			<div class="rSC"><div id="youtube"></div></div>
			<div class="pc"><span onclick="m.togglePosition(this)">▲ [--stick to the left top--]</span></div>
		</div>
		<div id="reco-playing"></div>
	</div>
</div><!-- div#headPlay -->
<div class="side2" id="contents"></div><!-- div#contents -->
<div class="side2" id="foot">[--version--] [--foot--]<br><a href="http://kipid.tistory.com/entry/Introducing-what-we-are-making-Recoevenet">Introducing what we are making : Recoeve.net</a><br><br>
	<div>Language/언어/語言
		<data id="data-lang">en	ko	ja	zh
English/영어/en	Korean/한국어/ko	Japanese/일본어/ja	Chinese/중국어(번체)/zh</data></div>
</div><!-- div#foot -->
<div id="floating-key" style="display:none">
	<div class="button" onclick="m.hideFK()">▼ Hide</div>
	<div class="button" onclick='$fuzzy_search_container.show(); $fuzzy_search.focus();'>Go</div>
	<div class="button" onclick='$fuzzy_search_container.show(); $fuzzy_search.focus();'>ToC</div>
	<div class="button" onclick="$window.trigger({type:'keydown', keyCode:68})">Backward</div>
	<div class="button" onclick="$window.trigger({type:'keydown', keyCode:70})">Forward</div>
	<div class="button" onclick="$button_new_reco.trigger('click')">New Reco</div>
</div>
<div class="button" id="toggle-floating-key" onclick="m.toggleFK()">▲</div>
</div><!-- div#container -->
</body>
<div id="scripts"></div>
<script src="/jquery.min.js"></script>
<script>
(function(m, $, undefined) {
/* Prerequisite */
//////////////////
// Variables
//////////////////
$data_myCatList=$("#data-myCatList");
$data_CatList=m.myPage?$data_myCatList:$("#data-CatList");
$data_lang=$("#data-lang");

$user_noti=$("#user-noti");
$my_id=$("#my-id");
$button_new_reco=$("#button-new-reco");

$sidebar_dragger=$("#sidebar-dragger");
$sidebar=$("#sidebar");
$sidebar_exit=$("#sidebar-exit");
$catList=$("#catList");
$change_catList_order=$("#change-catList-order");
$change_catList_order_ok=$("#change-catList-order-ok");
$change_catList_order_cancel=$("#change-catList-order-cancel");

$new_reco=$("#new-reco");

$headPlay=$("#headPlay");
$playlist_container=$("#playlist-container");
$uri_rendered=$("#uri-rendered");
$rC_video_uri_rendered=$("#rC-video-uri-rendered");
$video=$("#video");
$rC_youtube_uri_rendered=$("#rC-youtube-uri-rendered");
$youtube=$("#youtube");
$reco_playing=$("#reco-playing");

$input_uri=$("#input-uri");
$def_titles=$("#def-titles");
$input_title=$("#input-title");
$def_cats=$("#def-cats");
$input_cats=$("#input-cats");
$input_desc=$("#input-desc");
$input_cmt=$("#input-cmt");
$input_val=$("#input-val");

$error=$("#error-msg");

$button_reco=$("#button-reco");
$button_edit=$("#button-edit");
$button_del=$("#button-del");
$button_back=$("#button-back");
$button_close=$("#button-close");

$out_focus=$("#out-focus");
$fuzzy_search_container=$("#fuzzy-search-container");
$fuzzy_search=$("#fuzzy-search");
$fuzzy_search_list=$("#fuzzy-search-list");

$cat_fs_container=$("#cat-fs-container");
$cat_fs_list=$("#cat-fs-list");

$point_range=$("#point-range");
$point_range_bar=$("#point-range-bar");
$point_range_left=$("#point-range-left");
$point_range_right=$("#point-range-right");
$point_range_result=$("#point-range-result");
$show_recos_without_points=$("#show-recos-without-points");
m.showRWOP=true; // RWOP : Reco WithOut Point

$subCats=$("#subCats");
$contents=$("#contents");
$scripts=$("#scripts");

$window=$(window);
$html=$("html");
$body=$("body");
$.fn.exists=function() { return this.length!==0; };

$("title").html(m.userId+" on Recoeve.net");
$user_noti.html(m.userId+"'s recos");
if (m.myIndex) {
	$my_id.html(m.myId+" ▾");
} else {
	$my_id.hide();
	$button_new_reco.remove();
}

m.delayPad=m.delayPad||256;
m.wait=m.wait||512;
m.delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
m.previous=Date.now();

m.catList=[];
m.myCatList=m.myPage?m.catList:[];
m.currentCat=null;
m.catUriList=[];
m.userRecos={};
m.myRecos=m.myPage?m.userRecos:{};
m.maxShowReco=10;

m.fsCat=[];
m.fsCat[0]=m.fsCat[1]=[];
m.fsCat[0].k=m.fsCat[1].k=-1;
m.fsCat.fullList=[];
m.fsCat.desc=false;
m.fsCat.$fs=$input_cats;
m.fsCat.$fsl=$cat_fs_list;

m.fsTitle=[];
m.fsTitle[0]=m.fsTitle[1]=[];
m.fsTitle.fullList=[];
m.fsTitle.desc=true;
m.fsTitle.$fs=$fuzzy_search;
m.fsTitle.$fsl=$fuzzy_search_list;
m.fsTitle.currentIndex=-1;
m.fsTitle.shuffled=[];
m.fsTitle.oneLoop=false;
m.fsTitle.loop=false;

m.fsGo=[];
m.fsGo[0]=m.fsGo[1]=[];
m.fsGo.fullList=[];
m.fsGo.desc=true;
m.fsGo.$fs=$fuzzy_search;
m.fsGo.$fsl=$fuzzy_search_list;

YT=undefined;
m.YtPlayer=null;
m.YtAPILoaded=false;

m.ptnURI=[];
m.ptnURL=/^https?:\/\/\S+/i;
m.ptnTag=/^<\w+[\s\S]+>$/i;
m.ptnVal=/^([0-9]+(?:\.[0-9]+)?)\/([0-9]+(?:\.[0-9]+)?)$/;
m.ptnDescCmt=/^#(\S+)/mg; // \w=[A-Za-z0-9_]

m.ptsRangeFrom=0; // from <= pts <= to
m.ptsRangeTo=1;
m.mdInPRL=false; // mouse down in Point Range Left
m.mdInPRR=false; // mouse down in Point Range Right
m.PRmax=10;
m.PRLw=15;
m.PRw=$point_range.width();
m.PRRw=m.PRw-15;
m.fullPts=10;

m.neighbors={};
	// m.neighbors[cat_from]={down:true};
	// m.neighbors[cat_from][user_i]={}
	// m.neighbors[cat_from][user_i][cat_i]={sumSim:sumSim, nSim:nSim, simAvg100:simAvg100, tUpdate:tUpdate};
////////////////////////////////////////////////////
// Get neighbors
////////////////////////////////////////////////////
m.getNeighbors=function() {
	if (m.neighbors[m.currentCat]&&m.neighbors[m.currentCat].down) {
		var req="user_i\tcat_i";
		var neighbors=m.neighbors[m.currentCat]
		for (var p in neighbors) {
			if (p!=="down") {
				for (var q in neighbors[p]) {
					req+="\n"+p+"\t"+q;
				}
			}
		}
		console.log(req);
		$.ajax({
			type:"POST", url:m.pathName+"/get-URI-cats-val", data:req
			, dataType:"text"
		}).done(function(resp) {
			console.log(resp);
		});
	} else {
		var req="cat_from\n"+m.currentCat;
		$.ajax({
			type:"POST", url:m.pathName+"/get-Neighbors", data:req
			, dataType:"text"
		}).done(function(resp) {
			var cat_froms=m.strToJSON(req);
			for (var i=1;i<cat_froms.length;i++) {
				m.neighbors[cat_froms[i].cat_from]={down:true};
			}
			var res=m.strToJSON(resp);
			for (var i=1;i<res.length;i++) {
				m.neighbors[res[i].cat_from][res[i].user_i]={};
				m.neighbors[res[i].cat_from][res[i].user_i][res[i].cat_i]=res[i];
			}
			console.log(m.neighbors);
		});
	}
};

////////////////////////////////////////////////////
// Floating key
////////////////////////////////////////////////////
$floating_key=$("#floating-key");
$toggle_floating_key=$("#toggle-floating-key");

m.hideFK=function() {
	$floating_key.hide();
	// $toggle_floating_key.html("▲ Show");
}
m.toggleFK=function() {
	$floating_key.toggle();
	// if ($floating_key.is(":visible")) {
	// 	$floating_key.hide();
		// $toggle_floating_key.html("▲ Show");
	// } else {
	// 	$floating_key.show();
		// $toggle_floating_key.html("▲ Hide");
	// }
}
////////////////////////////////////////////////////
// Sidebar dragger and exit
////////////////////////////////////////////////////
m.browserWidth=0;
$window.on("resize", function(e) {
	if (window.innerWidth!==m.browserWidth) {
		m.browserWidth=window.innerWidth;
		if (m.browserWidth<701) {
			$sidebar.css({"margin-left":-$sidebar.outerWidth()});
			$sidebar_dragger.css({display:"block", "left":0});
			$sidebar_exit.hide();
		} else {
			$sidebar.css({"margin-left":0});
			$sidebar_dragger.hide();
			$sidebar_exit.hide();
		}
	}
});
$window.trigger("resize");
$sidebar_dragger.on("mousedown.sd touchstart.sd", function(e) {
	var touch0=(e.type==='touchstart')?e.originalEvent.touches[0]:e;
	var relativeX=touch0.clientX-Math.round($sidebar_dragger.offset().left)+$window.scrollLeft();
	$html.on("mousemove.sd touchmove.sd", function(e) {
		window.getSelection().removeAllRanges();
		e.preventDefault();
		// e.stopPropagation();
		var touch0=(e.type==='touchmove')?e.originalEvent.touches[0]:e;
		$sidebar.css({"margin-left":-$sidebar.outerWidth()+touch0.clientX-relativeX});
		$sidebar_dragger.css({"left":touch0.clientX-relativeX});
		$html.on("mouseup.sd touchend.sd", function() {
			$html.off("mouseup.sd touchend.sd mousemove.sd touchmove.sd");
			if (touch0.clientX-relativeX>$sidebar.outerWidth()/2) {
				$sidebar.css({"margin-left":0});
				$sidebar_dragger.css({"left":$sidebar.outerWidth()});
				$sidebar_exit.show();
			} else {
				$sidebar.css({"margin-left":-$sidebar.outerWidth()});
				$sidebar_dragger.css({"left":0});
				$sidebar_exit.hide();
			}
		});
	})
});
$sidebar_exit.on("click", function() {
	$sidebar_exit.hide();
	$sidebar.css({"margin-left":-$sidebar.outerWidth()});
	$sidebar_dragger.css({"left":0});
});

////////////////////////////////////////////////////
// Escape and Unescape HTML string.
////////////////////////////////////////////////////
m.escapeHTML=function(str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
};
m.unescapeHTML=function(str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&');
};
m.escapeAMP=function(str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/%/g,'%25').replace(/&/g,'%26').replace(/#/g,'%23');
};
m.unescapeAMP=function(str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/%23/g,'#').replace(/%26/g,'&').replace(/%25/g,'%');
};

////////////////////////////
// String to Array
////////////////////////////
m.encloseStr=function(str) {
	if (!str||str.constructor!==String) { return ""; }
	if (str.charAt(0)==="\""||/[\n\t]/.test(str)) {
		return '"'+str.replace(/"/g,'""')+'"';
	} return str;
};
m.strToJSON=function(str, colMap, rowMap) {
	if (!str||str.constructor!==String) { return []; }
	if (colMap===undefined||colMap===null) { colMap=true; }
	// str=str.trim()+"\n";
	if (str.charAt(str.length-1)!=="\n") {
		str+="\n";
	}
	var ret=[];
	var delimiter=/([^\t\n]*)([\t\n])/g;
	var lastQuote=/[^"](?:"")*"([\t\n])/g;
	var exec;
	var start=0;
	var row=-1, col=-1, delim="\n";
	var strElem="";
	function increseRC(str) {
		if (str==='\t') {
			col++; return true;
		} else if (str==='\n') {
			row++; col=0; ret.push([]); return true;
		} return false;
	}
	while (start<str.length&&increseRC(delim)) {
		if ((str.substring(start, start+1))==='"') {
			lastQuote.lastIndex=start+1;
			if ((exec=lastQuote.exec(str))!==null) {
				strElem=str.substring(start+1, lastQuote.lastIndex-2);
				delim=exec[1];
				start=delimiter.lastIndex=lastQuote.lastIndex;
			} else {
				strElem=str.substring(start+1);
				delim="";
				start=str.length;
			}
			strElem=strElem.replace(/""/g,'"');
		} else {
			if ((exec=delimiter.exec(str))!==null) {
				strElem=exec[1];
				delim=exec[2];
				start=delimiter.lastIndex;
			} else {
				strElem=str.substring(start);
				delim="";
				start=str.length;
			}
		}
		ret[row][col]=strElem;
	}
	if (colMap) {
		var firstColSize=ret[0].length;
		for (var i=0;i<ret.length;i++) {
			var jMax=ret[i].length;
			if (jMax>firstColSize) { jMax=firstColSize; }
			for (var j=0;j<jMax;j++) {
				var key=ret[0][j];
				if (key!==undefined) {
					ret[i][key]=ret[i][j];
				}
			}
		}
	}
	if (rowMap) {
		for (var i=0;i<ret.length;i++) {
			var key=ret[i][0];
			if (key!==undefined) {
				ret[key]=ret[i];
			}
		}
	}
	return ret;
};

/////////////////////////////
// cookies.js
/////////////////////////////
m.docCookies={
	hasItem:function(sKey) {
		return (new RegExp("(?:^|;\\s*)"+encodeURIComponent(sKey).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=")).test(document.cookie);
	}
	, getItem:function(sKey) {
		return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(sKey).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;
	}
	, removeItem:function(sKey, sPath, sDomain, bSecure) {
		if (!sKey||/^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
		document.cookie=encodeURIComponent(sKey)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(sDomain?"; domain="+sDomain:"")+(sPath?"; path="+sPath:"")+(bSecure?"; secure":"");
		return true;
	}
	, setItem:function(sKey, sValue, vEnd, sPath, sDomain, bSecure) {
		if (!sKey||/^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
		var sExpires="";
		if (vEnd) { switch (vEnd.constructor) {
			case Number:
				sExpires=vEnd===Infinity?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+vEnd;
				break;
			case String:
				sExpires="; expires="+vEnd;
				break;
			case Date:
				sExpires="; expires="+vEnd.toUTCString();
				break;
		}}
		document.cookie=encodeURIComponent(sKey)+"="+encodeURIComponent(sValue)+sExpires+(sDomain?"; domain="+sDomain:"")+(sPath?"; path="+sPath:"")+(bSecure?"; secure":"");
		return true;
	}
	, keys:function() {
		var aKeys=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/);
		for (var nIdx=0;nIdx<aKeys.length;nIdx++) { aKeys[nIdx]=decodeURIComponent(aKeys[nIdx]); }
		return aKeys;
	}
};

////////////////////////////////////////////////////
// Delayed Loading.
////////////////////////////////////////////////////
$.fn.inView=function() {
	if (this.is(":visible")) {
		var viewportHeight=window.innerHeight;
		var scrollTop=$window.scrollTop();
		var elemTop=this.offset().top-m.delayPad;
		var elemBottom=elemTop+this.height()+m.delayPad;
		return (scrollTop+viewportHeight>elemTop)&&(scrollTop<elemBottom);
	} else {
		return false;
	}
};
$.fn.delayedLoad=function() {
	var done=false;
	if (this.inView()) {
		if (this.hasClass("to-be-executed")) {
			this.trigger("click");
		}
		// divs with background-image
		if (this.attr("delayed-bgimage")) {
			this.css("background-image", "url("+this.attr("delayed-bgimage")+")");
			this.removeAttr("delayed-bgimage");
			done=true;
		} 
		// iframes or images
		if (this.attr("delayed-src")) {
			this.attr("src", this.attr("delayed-src"));
			this.removeAttr("delayed-src");
			done=true;
		}
		// MathJax Process
		if (typeof MathJax!=='undefined'&&this.is(".MathJax_Preview")) {
			MathJax.Hub.Queue(["Process", MathJax.Hub, this.next()[0]]);
			done=true;
		}
	}
	return done;
};
m.delayedLoadAll=function() {
	m.delayedElems.each(function() {
		if ($(this).delayedLoad()) {
			m.delayedElems=m.delayedElems.not(this);
		}
	});
	if (m.delayedElems.length>0) {
		$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
	}
	m.previous=Date.now();
};
m.delayedLoadByScroll=function() {
	$window.off("scroll.delayedLoad");
	var now=Date.now();
	var passed=now-m.previous;
	if (passed>m.wait) {
		m.delayedLoadAll();
	} else {
		m.delayedLoadSetTimeout=setTimeout(function() {
			m.delayedLoadAll();
		}, m.wait*1.1-passed);
	}
};
$window.on("scroll.delayedLoad", m.delayedLoadByScroll);

/* Remember user */
m.sW=screen.width;
m.sH=screen.height;
if (m.sW<m.sH) {
	m.sW=screen.height;
	m.sH=screen.width;
}
m.str_rmb_me='log\tsW\tsH'
	+'\nweb\t'+m.sW+'\t'+m.sH;
m.rmb_me=function(callback, args) {
	if (m.docCookies.hasItem('tCjs')) {
		callback(args);
	} else {
		$.ajax({
			type:"POST", url:"/account/log-in/remember-me.do", data:m.str_rmb_me
			, dataType:"text"
		}).done(function(resp) {
			if (resp==="Rmbd") {
				callback(args);
			} else {
				console.log(resp);
			}
		});
	}
};


/* Fuzzy search */
////////////////////////////////////////////////////
// Hangul (Korean) split and map to English
// KE : Korean Expanded
////////////////////////////////////////////////////
m.jamoKE = ["ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄷㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
m.jamo = ["ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄸ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅃ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

m.mapKE = {"q":"ㅂ", "Q":"ㅃ", "w":"ㅈ", "W":"ㅉ", "e":"ㄷ", "E":"ㄸ", "r":"ㄱ", "R":"ㄲ", "t":"ㅅ", "T":"ㅆ", "y":"ㅛ", "Y":"ㅛ", "u":"ㅕ", "U":"ㅕ", "i":"ㅑ", "I":"ㅑ", "o":"ㅐ", "O":"ㅒ", "p":"ㅔ", "P":"ㅖ", "a":"ㅁ", "A":"ㅁ", "s":"ㄴ", "S":"ㄴ", "d":"ㅇ", "D":"ㅇ", "f":"ㄹ", "F":"ㄹ", "g":"ㅎ", "G":"ㅎ", "h":"ㅗ", "H":"ㅗ", "j":"ㅓ", "J":"ㅓ", "k":"ㅏ", "K":"ㅏ", "l":"ㅣ", "L":"ㅣ", "z":"ㅋ", "Z":"ㅋ", "x":"ㅌ", "X":"ㅌ", "c":"ㅊ", "C":"ㅊ", "v":"ㅍ", "V":"ㅍ", "b":"ㅠ", "B":"ㅠ", "n":"ㅜ", "N":"ㅜ", "m":"ㅡ", "M":"ㅡ"};
for (var p in m.mapKE) {
	m.mapKE[m.mapKE[p]]=p;
}

m.rChoKE = ["ㄱ", "ㄱㄱ", "ㄴ", "ㄷ", "ㄷㄷ", "ㄹ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
m.rCho = ["ㄱ", "ㄲ", "ㄴ", "ㄷ", "ㄸ", "ㄹ", "ㅁ", "ㅂ", "ㅃ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

m.rJungKE = ["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
m.rJung = ["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

m.rJongKE = ["", "ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
m.rJong = ["", "ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

m.splitHangul=function(str) {
	var res=[];
	res.originalStr=str;
	res.splitted3="";
	res.splitted="";
	res.pCho=[]; // position of word-start or 초성
	var p=0;
	res.pCho[p]=true;
	var cho, jung, jong;
	for (var i=0;i<str.length;i++) {
		var c=str.charAt(i)
		var n=str.charCodeAt(i);
		if (n>=0x3131&&n<=0x3163) {
			n-=0x3131;
			res[i]={"char":c, "splitted3":c, "splitted":m.jamoKE[n]};
			res.pCho[p]=true;
		} else if (n>=0xAC00&&n<=0xD7A3) {
			n-=0xAC00;
			jong=n%28;
			jung=( (n-jong)/28 )%21;
			cho=( ((n-jong)/28)-jung )/21;
			res[i]={"char":c
				, "splitted3":m.rCho[cho]+m.rJung[jung]+m.rJong[jong]
				, "splitted":m.rChoKE[cho]+m.rJungKE[jung]+m.rJongKE[jong]};
			res.pCho[p]=true;
		} else {
			res[i]={"char":c, "splitted3":c, "splitted":c};
			if (i>0&&/[^a-zA-Z0-9]$/.test(res[i-1].splitted)&&/[a-zA-Z0-9]/.test(c)) {
				res.pCho[p]=true;
			}
		}
		p+=res[i].splitted.length;
		res.splitted3+=res[i].splitted3;
		res.splitted+=res[i].splitted;
	}
	return res;
};

////////////////////////////////////////////////////
// Fuzzy search prepare
////////////////////////////////////////////////////
m.fsCat[0].ptnSH=m.fsCat[1].ptnSH
=m.fsTitle[0].ptnSH=m.fsTitle[1].ptnSH
=m.fsGo[0].ptnSH=m.fsGo[1].ptnSH=m.splitHangul("$!@#");
RegExp.quote=function(str) {
	return str.replace(/[.?*+^$[\]\\{}()|-]/g, "\\$&").replace(/\s/g, "[\\s\\S]");
};
m.arrayRegExs=function(ptnSH) {
	var str=ptnSH.splitted;
	var res=[];
	for (var i=0;i<str.length;i++) {
		var c=str.charAt(i);
		var mapKE=m.mapKE[c];
		if (mapKE) {
			res.push( new RegExp("["+c+mapKE+"]", "ig") );
		} else {
			res.push( new RegExp(RegExp.quote(c), "ig") );
		}
	}
	return res;
};
m.highlightStrFromIndices=function(strSplitted, indices) {
	var res="";
	for (var i=0, j=1, k=0, p1=0, p2=0;j<=indices.length;i=j,j++) {
		while (j<indices.length&&indices[j-1].end===indices[j].start) {
			j++;
		}
		for (;k<strSplitted.length;k++) {
			p1=p2;
			p2=p1+strSplitted[k]["splitted"].length;
			if (p2<=indices[i].start) {
				strSplitted[k]["matched"]=false;
			} else if (p1<indices[j-1].end) {
				strSplitted[k]["matched"]=true;
			} else {
				if (j===indices.length) {
					for (;k<strSplitted.length;k++) {
						strSplitted[k]["matched"]=false;
					}
				}
				p2=p1;
				break;
			}
		}
	}
	for (var i=0;i<strSplitted.length;) {
		if (strSplitted[i]["matched"]) {
			res+='<span class="bold">';
			while (i<strSplitted.length&&strSplitted[i]["matched"]) {
				res+=m.escapeHTML(strSplitted[i]["char"]);
				i++;
			}
			res+='</span>';
		} else {
			while (i<strSplitted.length&&!strSplitted[i]["matched"]) {
				res+=m.escapeHTML(strSplitted[i]["char"]);
				i++;
			}
		}
	}
	return res;
};
m.matchScoreFromIndices=function(strSH, ptnSH, indices) {
	var res=0;
	for (var i=0;i<indices.length;i++) {
		if (strSH.pCho[indices[i].start])
			res+=10;
	}
	for (var i=1;i<indices.length;i++) {
		var diff=indices[i].start-indices[i-1].start;
		if (diff<5) res+=8*(5-diff);
	}
	return res;
};
m.fuzzySearch=function(ptnSH, fs) {
	var list=[];
	if (ptnSH.splitted.indexOf(fs[0].ptnSH.splitted)===0) {
		fs[1]=fs[0];
	} else if (fs[1] && ptnSH.splitted.indexOf(fs[1].ptnSH.splitted)===0) {
		if (ptnSH.splitted===fs[1].ptnSH.splitted) {
			return fs[0]=fs[1];
		}
	} else {
		fs[1]=null;
	}
	var listIsFullList=false;
	if (fs[1]&&fs[1].sorted) {
		var sorted=fs[1].sorted;
		for (var i=0;i<sorted.length;i++) {
			list.push(fs.fullList[ fs[1][sorted[i]].i ]);
		}
	} else {
		list=fs.fullList;
		listIsFullList=true;
	}
	fs[0]=[];
	fs[0].ptnSH=ptnSH;
	var regExs=m.arrayRegExs(ptnSH);
	for (var i=0;i<list.length;i++) {
	if (regExs.length>0) {
		var txt=list[i].txt;
		var txtS=txt.splitted;
		regExs[0].lastIndex=0;
		var exec=regExs[0].exec(txtS);
		var matched=(exec!==null);
		var indices=[];
		if (matched) {
			indices[0]={start:exec.index, end:regExs[0].lastIndex};
		}
		for (var j=1;matched&&(j<regExs.length);j++) {
			regExs[j].lastIndex=regExs[j-1].lastIndex;
			exec=regExs[j].exec(txtS);
			matched=(exec!==null);
			if (matched) {
				indices[j]={start:exec.index, end:regExs[j].lastIndex};
			}
		}
		if (matched) {
			var maxMatchScore=m.matchScoreFromIndices(txt, ptnSH, indices);
			var indicesMMS=[]; // indices of max match score
			for (var p=0;p<indices.length;p++) {
				indicesMMS[p]=indices[p]; // hard copy of indices
			}
			for (var k=indices.length-2;k>=0;) {
				regExs[k].lastIndex=indices[k].start+1;
				exec=regExs[k].exec(txtS);
				matched=(exec!==null);
				if (matched) {
					indices[k]={start:exec.index, end:regExs[k].lastIndex};
				}
				for (var j=k+1;matched&&(j<regExs.length);j++) {
					regExs[j].lastIndex=regExs[j-1].lastIndex;
					exec=regExs[j].exec(txtS);
					matched=(exec!==null);
					if (matched) {
						indices[j]={start:exec.index, end:regExs[j].lastIndex};
					}
				}
				if (matched) {
					var matchScore=m.matchScoreFromIndices(txt, ptnSH, indices);
					if (matchScore>maxMatchScore) {
						maxMatchScore=matchScore;
						for (var p=0;p<indices.length;p++) {
							indicesMMS[p]=indices[p]; // hard copy of indices
						}
					}
					k=indices.length-2;
				} else {
					k--;
				}
			}
			fs[0].push({i:list[i].i, maxMatchScore:maxMatchScore, highlight:m.highlightStrFromIndices(txt, indicesMMS)});
		}
	} else {
		fs[0].push({i:list[i].i, maxMatchScore:0});
	}}
	var sorted=fs[0].sorted=[];
	for (var i=0;i<fs[0].length;i++) {
		if (listIsFullList&&fs.desc) {
			sorted[i]=fs[0].length-1-i;
		} else {
			sorted[i]=i;
		}
	}
	for (var i=1;i<sorted.length;i++) {
		var temp=sorted[i];
		var j=i;
		for (;(j>0) && (fs[0][sorted[j-1]].maxMatchScore<fs[0][temp].maxMatchScore);j--)
			sorted[j]=sorted[j-1];
		sorted[j]=temp;
	}
};

/* CatList */
////////////////////////////////////////////////////
// CatList rendering
////////////////////////////////////////////////////
m.pathOfCat=function(cat) {
	return m.pathName+"?cat="+m.escapeAMP(cat);
};
m.getDepthOfTabs=function(str) {
	var n=0;
	while (n<str.length&&str.charAt(n)==='\t') { n++; }
	return n;
};
m.getSuperCat=function(cat) {
	if (cat&&cat.constructor===String) {
		var i=cat.lastIndexOf("--");
		if (i!=-1) {
			return cat.substring(0,i);
		}
	}
	return null;
};
m.strCatListToJSON=function(strCatList, catList) {
	var list=strCatList.trim().split("\n");
	if (strCatList.length===0) {
		list=[];
	}
	list.unshift("");
	if (catList===undefined||catList===null) {
		if (m.catList) {
			catList=m.catList;
		} else {
			catList=m.catList=[];
		}
	}
	var superCats=[];
	for (var i=0;i<list.length;i++) {
		var baseCat=list[i].trim();
		var depth=m.getDepthOfTabs(list[i]);
		superCats.splice(depth, superCats.length-depth, baseCat);
		var cat=superCats[0];
		for (var j=1;j<=depth;j++) {
			cat+="--"+superCats[j];
		}
		if (catList[cat]) {
			catList[cat].i=i;
			catList[i]=catList[cat];
		} else {
			catList[i]=catList[cat]={i:i, cat:cat, baseCat:baseCat, depth:depth};
		}
	}
};
m.catListToHTML=function() {
	var cL=m.catList;
	var catListHTML='<div class="cat" id="cat-0" style="margin-left:'+cL[0].depth+'em"><span class="noEC"></span><a href="'+m.pathOfCat("")+'" class="baseCat" onclick="return m.openCat(m.catList[0].cat, event)">[--Uncategorized--]</a></div>';
	var i=1;
	for (;i<cL.length-1;i++) {
		var beforeDepth=cL[i-1].depth;
		var currentDepth=cL[i].depth;
		var afterDepth=cL[i+1].depth;
		if (beforeDepth<currentDepth) { // open subCat
			catListHTML+='<div class="subCat" style="display:none">';
		} else {
			for (var j=currentDepth;j<beforeDepth;j++) { // close subCats
				catListHTML+='</div>';
			}
		}
		catListHTML+='<div class="cat" id="cat-'+i+'" style="margin-left:'+cL[i].depth+'em">';
		if (currentDepth<afterDepth) {
			catListHTML+='<span class="EC" onclick="m.ExpCol(this,m.catList['+i+'])">▶</span>';
		} else {
			catListHTML+='<span class="noEC"></span>';
		}
		catListHTML+='<a href="'+m.pathOfCat(cL[i].cat)+'" class="baseCat" onclick="return m.openCat(m.catList['+i+'].cat, event)">'+m.escapeHTML(cL[i].baseCat)+'</a>'+'</div>';
	}
	if (cL.length>1) {
		var beforeDepth=cL[i-1].depth;
		var currentDepth=cL[i].depth;
		if (beforeDepth<currentDepth) { // open subCat
			catListHTML+='<div class="subCat" style="display:none">';
		} else {
			for (var j=currentDepth;j<beforeDepth;j++) { // close subCats
				catListHTML+='</div>';
			}
		}
		catListHTML+='<div class="cat" id="cat-'+i+'" style="margin-left:'+cL[i].depth+'em">'
			+'<span class="noEC"></span>'
			+'<a href="'+m.pathOfCat(cL[i].cat)+'" class="baseCat" onclick="return m.openCat(m.catList['+i+'].cat, event)">'+m.escapeHTML( cL[i].baseCat )+'</a>'
		+'</div>';
		for (var j=0;j<currentDepth;j++) { // close subCats
			catListHTML+='</div>';
		}
	}
	$catList.html(catListHTML);
};
if (m.myIndex) { m.strCatListToJSON(m.unescapeHTML($data_myCatList.html()), m.myCatList); }
if (!m.myPage) { m.strCatListToJSON(m.unescapeHTML($data_CatList.html())); }
m.catListToHTML();
var $catECs=$catList.find(".cat:has(>.EC)");
for (var i=$catECs.length-1;i>=0;i--) {
	m.catList[Number($catECs.eq(i).attr("id").substring(4))].subCatExpanded=false;
}
m.catsToA=function(cats) {
	if (!cats||cats.constructor!==String||cats.trim().length===0) {
		return '<a href="'+m.pathOfCat("")+'" onclick="return m.openCat(m.catList[0].cat, event)"'+(m.currentCat===""?' class="currentCat"':'')+'>[--Uncategorized--]</a>';
	}
	var arrayHTML=[];
	var list=cats.split(";");
	for (var i=0;i<list.length;i++) {
		var cat=list[i];
		arrayHTML.push('<a href="'+m.pathOfCat(cat)+'" onclick="return m.openCat(m.catList['+m.catList[cat].i+'].cat, event)"'+(m.currentCat===cat?' class="currentCat"':'')+'>'+m.escapeHTML(cat)+'</a>');
	}
	return arrayHTML.join(" ; ");
};
m.getCatListChanged=function() {
	$change_catList_order_ok.hide();
	$change_catList_order_cancel.hide();
	var $cats=$("#catList .cat").not("#cat-0");
	$cats.removeClass("edit");
	$cats.find('.edit-bar').remove();
	var catListChanged="\n";
	for (var i=0;i<$cats.length;i++) {
		var catI=Number($cats.eq(i).attr("id").substring(4));
		for (var j=0;j<m.catList[catI].depth;j++) {
			catListChanged+="\t";
		}
		catListChanged+=m.catList[catI].baseCat+"\n";
	}
	return catListChanged;
};

//////////////////////////////////////
// CatList order
//////////////////////////////////////
$change_catList_order_ok.hide();
$change_catList_order_cancel.hide();
$change_catList_order.on("click", function(e) {
	$change_catList_order.hide();
	$change_catList_order_ok.show();
	$change_catList_order_cancel.show();
	var $cats=$("#catList .cat").not("#cat-0");
	$cats.addClass("edit");
	$cats.prepend('<div class="edit-bar"></div>');
	$cats.append('<div class="edit-bar"></div>');
	$("#catList .edit-bar").on("mousedown touchstart", function(e) {
		var $catM=$(this).parent(); // cat-moving
		var $catSiblings=$catM.siblings(".cat").not("#cat-0");
		if ($catSiblings.exists()) {
			var touch0=(e.type==='touchstart')?e.originalEvent.touches[0]:e;
			var relativeX=touch0.clientX-Math.round($catM.offset().left)+$window.scrollLeft();
			var relativeY=touch0.clientY-Math.round($catM.offset().top)+$window.scrollTop();
			var $subCat=$catM.next(".subCat");
			var subCatIsVisible=false;
			if ($subCat.exists()&&$subCat.is(":visible")) {
				$subCat.hide();
				subCatIsVisible=true;
			}
			var $lastSibling=$catSiblings.last();
			var $lastSubCat=$lastSibling.next(".subCat");
			if ($lastSubCat.exists()&&$lastSubCat.is(":visible")) { $lastSibling=$lastSubCat; }
			$catM.css({width:$catM.outerWidth()});
			$catM.addClass("move");
			var catI=Number($catM.attr("id").substring(4));
			var $catTo=$('<div id="cat-to-here" style="margin-left:'+(m.catList[catI].depth+0.5)+'em"></div>');
			$catM.before($catTo);
			var catTo=-1;
			$html.on("mousemove.mdInEB touchmove.mdInEB", function(e) {
				window.getSelection().removeAllRanges();
				e.preventDefault();
				e.stopPropagation();
				var touch0=(e.type==='touchmove')?e.originalEvent.touches[0]:e;
				$catM.css({left:touch0.clientX-relativeX, top:touch0.clientY-relativeY});
				var wST=$window.scrollTop();
				var sidebarTop=$sidebar.offset().top-wST;
				var sidebarBottom=sidebarTop+$sidebar.outerHeight();
				var scrollPad=20;
				if (sidebarTop<0?touch0.clientY<scrollPad:touch0.clientY<sidebarTop+scrollPad) {
					if (sidebarTop<0) {
						$window.scrollTop(wST+touch0.clientY-scrollPad);
					} else {
						$sidebar.scrollTop($sidebar.scrollTop()+touch0.clientY-sidebarTop-scrollPad);
					}
				} else if (sidebarBottom>$window.outerHeight()?touch0.clientY>$window.outerHeight()-scrollPad:touch0.clientY>sidebarBottom-scrollPad) {
					if (sidebarBottom>$window.outerHeight()) {
						$window.scrollTop(wST+touch0.clientY-$window.outerHeight()+scrollPad);
					} else {
						$sidebar.scrollTop($sidebar.scrollTop()+touch0.clientY-sidebarBottom+scrollPad);
					}
				}
				var tops=[];
				for (var i=1;i<$catSiblings.length;i++) {
					tops.push(($catSiblings.eq(i-1).offset().top-wST+$catSiblings.eq(i).offset().top-wST)/2);
				}
				tops.push(($catSiblings.last().offset().top-wST+$lastSibling.offset().top+$lastSibling.outerHeight()-wST)/2);
				var k=0;
				for (;k<tops.length;k++) {
					if (touch0.clientY<tops[k]) { break; }
				}
				if (catTo!==k) {
					if (k<tops.length) {
						$catSiblings.eq(k).before($catTo);
					} else {
						$lastSibling.after($catTo);
					}
					catTo=k;
				}
			});
			$html.on("mouseup.mdInEB touchend.mdInEB", function(e) {
				$html.off("mouseup.mdInEB touchend.mdInEB mousemove.mdInEB touchmove.mdInEB");
				$catM.removeClass("move");
				$catM.css({width:'', left:'', top:''});
				$catTo.replaceWith($catM);
				if ($subCat.exists()) {
					$catM.after($subCat);
					if (subCatIsVisible) { $subCat.show(); }
				}
			});
		} else { // if $catSiblings doesn't exist.
			$catM.css({"border-color":"rgb(230,120,120)"});
			$html.on("mousemove.mdInEB touchmove.mdInEB", function(e) {
				window.getSelection().removeAllRanges();
				e.preventDefault();
				e.stopPropagation();
			});
			$html.on("mouseup.mdInEB touchend.mdInEB", function(e) {
				$html.off("mouseup.mdInEB touchend.mdInEB mousemove.mdInEB touchmove.mdInEB");
				$catM.css({"border-color":""});
			});
		}
	});
});
m.change_catList_order_do=function(args) {
	$.ajax({
		type:"POST", url:"/changeOrders/CatList", data:args
		, dataType:"text"
	}).fail(function() {
		console.log("Changing CatList order has failed.");
	}).done(function(resp) {
		console.log(resp);
	}).always(function() {
		$data_myCatList.html(m.escapeHTML(args));
		m.updateCatFS();
		$change_catList_order.show();
	});
}
$change_catList_order_ok.on("click", function(e) {
	var catListChanged=m.getCatListChanged();
	if (catListChanged!==m.unescapeHTML($data_CatList.html())) {
		if (m.myPage) {
			m.rmb_me(m.change_catList_order_do, catListChanged);
		} else {
			$data_CatList.html(m.escapeHTML(catListChanged));
			$change_catList_order.show();
		}
	} else {
		$change_catList_order.show();
	}
});
$change_catList_order_cancel.on("click", function(e) {
	var catListChanged=m.getCatListChanged();
	var catList=m.unescapeHTML($data_CatList.html());
	if (catListChanged!==catList) {
		var $catSelected=$catList.find(".cat.selected");
		var selected=[];
		for (var i=0;i<$catSelected.length;i++) {
			selected.push(m.catList[Number($catSelected.eq(i).attr("id").substring(4))].cat);
		}
		m.strCatListToJSON(catList);
		m.catListToHTML();
		for (var i=0;i<selected.length;i++) {
			$("#cat-"+m.catList[selected[i]].i).addClass("selected");
		}
		for (var i=m.catList.length-1;i>=0;i--) {
			if (m.catList[i].subCatExpanded) {
				$("#cat-"+i+">.EC").trigger("click");
			}
		}
	}
	$change_catList_order.show();
});

//////////////////////////////////////
// Fuzzy search on Cat
//////////////////////////////////////
m.putCatToFSFullList=function(i, cat) {
	if (m.fsCat.fullList[cat]) {
		m.fsCat.fullList[i]=m.fsCat.fullList[cat];
	} else {
		m.fsCat.fullList[i]=m.fsCat.fullList[cat]={txt:m.splitHangul(cat), cat:cat, html:m.escapeHTML(cat)};
	}
};
m.updateCatFS=function() {
	m.fsCat.fullList.splice(0, m.fsCat.fullList.length);
	if (!m.myPage) {
		m.strCatListToJSON(m.unescapeHTML($data_myCatList.html()), m.myCatList);
	}
	for (var i=0;i<m.myCatList.length;i++) {
		m.putCatToFSFullList(i, m.myCatList[i].cat);
	}
};
m.updateCatFS();
m.chooseCat=function(elem, j) {
	var $elem=$(elem);
	var fs=m.fsCat;
	if ($elem.hasClass("selected")) {
		// fs.$fs.trigger({type:"keydown", keyCode:27}); // keyCode:27=ESC
	} else {
		fs.$fsLis.removeClass("selected");
		$elem.addClass("selected");
		var k=fs.k;
		fs.listOfCats[k]=fs.fullList[j].cat;
		fs.$fs[0].value=fs.listOfCats.join(";");
		var sStart=0;
		for (var i=0;i<k;i++) {
			sStart+=fs.listOfCats[i].length+1;
		}
		var sEnd=sStart+fs.listOfCats[k].length;
		fs.$fs.focus();
		fs.$fs[0].setSelectionRange(sEnd,sEnd);
	}
};
m.doFSCat=function(fs) {
	var catsTxt=fs.$fs[0].value;
	var sEnd=fs.$fs[0].selectionEnd;
	var listOfCats=fs.listOfCats=catsTxt.split(";");
	var l=catsTxt.length;
	fs.k=0;
	for (var i=listOfCats.length-1;i>=0;i--) {
		l-=listOfCats[i].length+1;
		if (l<sEnd) {
			fs.k=i;
			break;
		}
	}
	var fsCatSH=m.splitHangul(listOfCats[fs.k]);
	m.fuzzySearch(fsCatSH, fs);
	var str="";
	for (var i=0;i<fs[0].length;i++) {
		var k=fs[0][fs[0].sorted[i]];
		str+='<div class="list-item" onclick="m.chooseCat(this,'+k.i+')">'
				+'<div class="list-index">'+i+'</div>'
				+fs.fullList[k.i].html
				+(k.highlight!==undefined?
				'<div class="highlighted">'+'<span class="maxMatchScore">'+k.maxMatchScore+'</span> :: '+k.highlight+'</div>':'')
			+'</div>';
	}
	$cat_fs_list.html(str);
	fs.$fsLis=fs.$fsl.find(".list-item");
};
m.fsCatOn=function() {
	var now=Date.now();
	var passed=now-m.previous;
	if (passed>m.wait) {
		m.previous=now;
		m.doFSCat(m.fsCat);
	} else {
		$input_cats.off("input.fs keyup.fs cut.fs paste.fs click.fs");
		setTimeout(function() {
			$input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsCatOn);
			m.previous=Date.now();
			m.doFSCat(m.fsCat);
		}, m.wait*1.1-passed);
	}
};
$input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsCatOn);
$input_cats.on("keydown.fs", function(e) {
	e.stopPropagation();
	switch (e.keyCode) {
	// case 9: // Tab = 9
	// 	e.preventDefault();
	// 	m.fsTitle.$fsLis.eq(0).trigger("click");
	// 	break;
	case 27: // ESC = 27
		e.preventDefault();
		$cat_fs_container.hide();
		break;
	// case 38: // up = 38
	// case 40: // down = 40
	// 	e.preventDefault();
	// 	var $fsl=$cat_fs_list;
	// 	var $lis=$fsl.find(".list-item");
	// 	var $liSelected=$fsl.find(".list-item.selected").eq(0);
	// 	var $liTo=null;
	// 	if ($liSelected.exists()) {
	// 		if (e.keyCode===38) {
	// 			$liTo=$liSelected.prev();
	// 		} else {
	// 			$liTo=$liSelected.next();
	// 		}
	// 		if ($liTo.exists()) {
	// 			$liTo.eq(0).trigger("click");
	// 			if ($liTo.offset().top<$fsl.offset().top+2) { // $liTo at upside of scroll.
	// 				$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top-$fsl.offset().top-2);
	// 			} else if ($liTo.offset().top+$liTo.outerHeight()>$fsl.offset().top+$fsl.height()+2) { // $liTo at downside of scroll.
	// 				$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top+$liTo.outerHeight()-$fsl.offset().top-$fsl.height()-2);
	// 			}
	// 		}
	// 	} else {
	// 		if ($lis.exists()) {
	// 			if (e.keyCode===38) {
	// 				$liTo=$lis.last();
	// 				$fsl.scrollTop($fsl[0].scrollHeight);
	// 			} else {
	// 				$liTo=$lis.first();
	// 				$fsl.scrollTop(0);
	// 			}
	// 			$liTo.eq(0).trigger("click");
	// 		}
	// 	}
	// 	break;
	}
});
if (m.myIndex) {
	for (var i=0;i<m.myCatList.length;i++) {
		var cat=m.myCatList[i].cat;
		m.fsCat.fullList[i]={i:i, txt:m.splitHangul(cat), cat:cat, html:m.escapeHTML(cat)};
	}
}
$input_cats.trigger("keyup");
$input_cats.on("focus", function() {
	$cat_fs_container.show();
});

//////////////////////////////////////
// Put/Delete/Change Cats
//////////////////////////////////////
m.putCat=function(cat) {
	var res=false;
	if (cat===null||cat.length===0) { return res; }
	var fullCats=m.unescapeHTML($data_myCatList.html());
	var levels=cat.split("--");
	var pre="\n";
	var start=0;
	var end=fullCats.length;
	for (var j=0;j<levels.length;j++) {
		var subStr=fullCats.substring(start,end);
		var toFind=pre+levels[j]+"\n";
		var i=subStr.indexOf(toFind);
		if (i!=-1) {
			var ptnEnd=new RegExp(pre.replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"[^\\t\\n]", "g");
			ptnEnd.lastIndex=i+toFind.length-1;
			var matchEnd=ptnEnd.exec(subStr);
			if (matchEnd!==null) {
				end=start+matchEnd.index+1;
			}
			start+=i+toFind.length-1;
			pre+="\t";
		} else {
			var toPut="";
			for (;j<levels.length;j++) {
				toPut+=pre+levels[j];
				pre+="\t";
			}
			fullCats=fullCats.substring(0,end-1)+toPut+"\n"+fullCats.substring(end);
			res=true;
		}
	}
	if (res) { $data_myCatList.html(m.escapeHTML(fullCats)); }
	return res;
};
m.deleteCat=function(cat) {
	var res=false;
	if (cat===null||cat.length===0) { return res; }
	var fullCats=m.unescapeHTML($data_myCatList.html());
	var levels=cat.split("--");
	var pre="\n";
	var start0=0;
	var start=0;
	var end=fullCats.length;
	var subStr="";
	for (var j=0;j<levels.length;j++) {
		subStr=fullCats.substring(start,end);
		var toFind=pre+levels[j]+"\n";
		var i=subStr.indexOf(toFind);
		if (i===-1) {
			return res;
		} else {
			var ptnEnd=new RegExp(pre.replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"[^\\t\\n]", "g");
			ptnEnd.lastIndex=i+toFind.length-1;
			var matchEnd=ptnEnd.exec(subStr);
			if (matchEnd!==null) {
				end=start+matchEnd.index+1;
			}
			start0=start+i;
			start+=i+toFind.length-1;
			pre+="\t";
		}
	}
	subStr=fullCats.substring(start+1,end);
		// subStr=subCats+"\n"
		// if no subCats, this is empty.
	if (subStr.length===0) {
		fullCats=fullCats.substring(0,start0+1)+fullCats.substring(end); // delete a cat if there is no subCat.
		res=true;
	}
	if (res) { $data_myCatList.html(m.escapeHTML(fullCats)); }
	return res;
};
m.putCats_UriToLists=function(cats, uri) {
	var catSplit=cats.split(";");
	var catIsPut=false;
	for (var i=0;i<catSplit.length;i++) {
		var cat=catSplit[i];
		if (m.myPage) {
			if (m.catUriList[cat]) {
				if (m.catUriList[cat].has) {
					m.catUriList[cat]["UriList"]=uri+"\n"+m.catUriList[cat]["UriList"];
				}
			} else {
				catIsPut=m.putCat(cat)||catIsPut;
				m.catUriList[cat]={cat:cat, down:true, has:true, UriList:uri};
			}
		} else {
			catIsPut=m.putCat(cat)||catIsPut;
		}
	}
	if (catIsPut) {
		if (m.myPage) { $change_catList_order_cancel.trigger("click"); }
		m.updateCatFS();
	}
};
m.delCats_UriFromLists=function(cats, uri) {
if (m.myPage) {
	var catSplit=cats.split(";");
	var catIsDeleted=false;
	for (var i=0;i<catSplit.length;i++) {
		var cat=catSplit[i];
		if (m.catUriList[cat]&&m.catUriList[cat].has) {
			var fullURIs="\n"+m.catUriList[cat]["UriList"]+"\n";
			var k=fullURIs.indexOf("\n"+uri+"\n");
			if (k!==-1) {
				m.catUriList[cat]["UriList"]=(fullURIs.substring(0,k)+fullURIs.substring(k+uri.length+1)).trim();
			}
			if (m.catUriList[cat]["UriList"].length===0) {
				var c=true;
				while (cat!==null&&c) {
					c=false;
					if (m.catUriList[cat].has&&m.catUriList[cat]["UriList"].length===0) {
						c=m.deleteCat(cat);
						catIsDeleted=catIsDeleted||c;
					}
					cat=m.getSuperCat(cat);
				}
			}
		}
	}
	if (catIsDeleted) {
		$change_catList_order_cancel.trigger("click");
		// Intentionally no m.updateCatFS();
	}
}};
m.catsChangedOnUri=function(oldCats, newCats, uri) {
if (uri&&uri.constructor===String&&oldCats!==null&&oldCats!==undefined&&oldCats.constructor===String&&newCats!==null&&newCats!==undefined&&newCats.constructor===String) {
	var oldCatSplit=oldCats.split(";");
	var newCatSplit=newCats.split(";");
	var o=[];
	var n=[];
	for (var i=0;i<oldCatSplit.length;i++) {
		o[oldCatSplit[i]]=true;
	}
	newCats="";
	for (var i=0;i<newCatSplit.length;i++) {
		if (o[newCatSplit[i]]) {
			o[newCatSplit[i]]=false;
			n[newCatSplit[i]]=false;
		} else {
			newCats+=newCatSplit[i]+";";
			n[newCatSplit[i]]=true;
		}
	}
	oldCats="";
	for (var p in o) {
		if (o[p]) { oldCats+=p+";"; }
	}
	if (oldCats.length>0) {
		m.delCats_UriFromLists(oldCats.substring(0,oldCats.length-1), uri);
	}
	if (newCats.length>0) {
		m.putCats_UriToLists(newCats.substring(0,newCats.length-1), uri);
	}
}};



/* Renderings */
////////////////////////////////////////////////////
// URI rendering :: http link itself, videos, images, maps.
////////////////////////////////////////////////////
m.uriToA=function(uri) {
	if (!uri||uri.constructor!==String) { return ""; }
	var exec=m.ptnURL.exec(uri);
	if (exec!==null) {
		return '<a target="_blank" href="'+exec[0]+'">'+m.escapeHTML(decodeURIComponent(uri))+'</a>';
	} else {
		return m.escapeHTML(uri);
	}
};
m.togglePosition=function(elem) {
	var $elem=$(elem);
	var $parent=$elem.parent().parent();
	if ($parent.hasClass("fixed")) {
		$parent.removeClass("fixed");
		window.scrollTo(0, $parent.offset().top);
		$elem.text("▲ [--stick to the left top--]");
	} else {
		$parent.addClass("fixed");
		window.scrollBy(0, -$parent.height());
		$elem.text("▲ [--return to the original position--]");
	}
};
m.rC=function(elemStr, pb) {
	if (pb&&pb.constructor===Number) {
		if (pb>200) {
			pb=200;
		} else if (pb<20) {
			pb=20;
		}
	} else {
		pb=null;
	}
	return '<div class="rC">'
		+'<div class="rSC"'+(pb?' style="padding-bottom:'+pb+'%"':'')+'>'
			+elemStr
		+'</div>'
		+(pb&&pb>70?'':'<div class="pc"><span onclick="m.togglePosition(this)">▲ [--stick to the left top--]</span></div>')
	+'</div>';
};
m.uriRendering=function(uri, toA) {
	if (uri&&uri.constructor===String) {
		if (uri.substring(0,4).toLowerCase()==="http") {
			var k=4;
			if (uri.charAt(k).toLowerCase()==='s') {
				k++;
			}
			if (uri.substring(k,k+3)==="://") {
				k+=3;
				var l=uri.indexOf('/',k);
				var uriHost=null;
				var uriRest='';
				if (l===-1) {
					uriHost=uri.substring(k);
				} else {
					uriHost=uri.substring(k,l);
					uriRest=uri.substring(l+1);
				}
				if (m.ptnURI[uriHost]) {
					var result=m.ptnURI[uriHost].toIframe(uriRest);
					if (result) { return result; }
				}
			}
		}
		for (var i=0;i<m.ptnURI.length;i++) {
			var result=m.ptnURI[i].toIframe(uri);
			if (result) { return result; }
		}
	}
	return {html:(toA?m.uriToA(uri):"")};
};
m.YTiframe=function(v, vars) {
	return m.rC('<iframe delayed-src="https://www.youtube.com/embed/'+v+(vars&&vars.list&&vars.list.val?'?list='+vars.list.val:'')+'" frameborder="0" allowfullscreen=""></iframe>');
};
var ptnURI;
ptnURI=m.ptnURI["www.youtube.com"]={};
ptnURI.regEx=/^(?:watch|embed\/([\w-]+))(\?\S+)?/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["www.youtube.com"].regEx.exec(uriRest);
	if (exec!==null) {
		var vars=null;
		if (exec[2]) { vars=m.getSearchVars(exec[2]); }
		var v=null;
		if (exec[1]) {
			v=exec[1];
		} else if (vars&&vars.v) {
			v=vars.v.val;
		}
		if (v) {
			return {html:m.YTiframe(v,vars), from:"youtube", videoId:v};
		}
	}
	return false;
};
ptnURI=m.ptnURI["youtu.be"]={};
ptnURI.regEx=/^([\w-]+)(\?\S+)?/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["youtu.be"].regEx.exec(uriRest);
	if (exec!==null) {
		var vars=null;
		if (exec[2]) {
			vars=m.getSearchVars(exec[2]);
		}
		return {html:m.YTiframe(exec[1],vars), from:"youtube", videoId:exec[1]};
	}
	return false;
};
ptnURI=m.ptnURI["m.youtube.com"]={};
ptnURI.regEx=/^watch(\?\S+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["m.youtube.com"].regEx.exec(uriRest);
	if (exec!==null) {
		var vars=m.getSearchVars(exec[1]);
		if (vars.v&&vars.v.val) {
			return {html:m.YTiframe(vars.v.val,vars), from:"youtube", videoId:vars.v.val};
		}
	}
	return false;
};
ptnURI=m.ptnURI["tvpot.daum.net"]={};
ptnURI.regEx=/^v\/([\w-]+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["tvpot.daum.net"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="http://videofarm.daum.net/controller/video/viewer/Video.html?vid='+exec[1]+(exec[1].length<15?'$':'')+'&play_loc=undefined" frameborder="0" scrolling="no"></iframe>'), from:"daum", videoId:exec[1]};
	}
	return false;
};
ptnURI=m.ptnURI["videofarm.daum.net"]={};
ptnURI.regEx=/^controller\/video\/viewer\/Video\.html(\?\S+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["videofarm.daum.net"].regEx.exec(uriRest);
	if (exec!==null) {
		var vars=m.getSearchVars(exec[1]);
		return {html:m.rC('<iframe delayed-src="http://videofarm.daum.net/controller/video/viewer/Video.html?vid='+vars.vid.val+'&play_loc='+vars.play_loc.val+'" frameborder="0" scrolling="no"></iframe>'), from:"daum"};
	}
	return false;
};
ptnURI=m.ptnURI["serviceapi.rmcnmv.naver.com"]={};
ptnURI.regEx=/^flash\/outKeyPlayer\.nhn(\?\S+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["serviceapi.rmcnmv.naver.com"].regEx.exec(uriRest);
	if (exec!==null) {
		var vars=m.getSearchVars(exec[1]);
		var lastPath="flash/outKeyPlayer.nhn?";
		for (var i=0;i<vars.length;i++) {
			if (vars[i].key==="isAutoPlay") {
				lastPath+="isAutoPlay=false&";
			} else {
				lastPath+=vars[i].key+"="+vars[i].val+"&";
			}
		}
		return {html:m.rC('<iframe delayed-src="http://serviceapi.rmcnmv.naver.com/'+lastPath.substring(0,lastPath.length-1)+'" frameborder="0" scrolling="no"></iframe>'), from:"naver"};
	}
	return false;
};
ptnURI=m.ptnURI["vimeo.com"]={};
ptnURI.regEx=/^([0-9]+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["vimeo.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="http://player.vimeo.com/video/'+exec[1]+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>'), from:"vimeo", videoId:exec[1]};
	}
	return false;
};
ptnURI=m.ptnURI["www.dailymotion.com"]={};
ptnURI.regEx=/^video\/(\w+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["www.dailymotion.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="http://www.dailymotion.com/embed/video/'+exec[1]+'" frameborder="0" allowfullscreen></iframe>'), from:"dailymotion", videoId:exec[1]};
	}
	return false;
};
ptnURI=m.ptnURI["www.ted.com"]={};
ptnURI.regEx=/^talks\//i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["www.ted.com"].regEx.exec(uriRest);
	if (exec!==null) {
		uriRest=uriRest.substring(6);
		var k=uriRest.indexOf("?");
		var vars=null;
		if (k!==-1) {
			vars=m.getSearchVars(uriRest.substring(k));
			uriRest=uriRest.substring(0,k);
		}
		var v=uriRest;
		if (vars&&vars.language) {
			uriRest="lang/"+vars.language.val+"/"+uriRest;
		}
		return {html:m.rC('<iframe delayed-src="https://embed-ssl.ted.com/talks/'+uriRest+'.html" frameborder="0" scrolling="no" allowfullscreen></iframe>'), from:"ted", videoId:v};
	}
	return false;
};
ptnURI=m.ptnURI["embed-ssl.ted.com"]={};
ptnURI.regEx=/^talks\//i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["embed-ssl.ted.com"].regEx.exec(uriRest);
	if (exec!==null) {
		uriRest=uriRest.substring(6);
		var v=uriRest.replace(/^lang\/\w+\//i,"").replace(/\.html$/i,"");
		return {html:m.rC('<iframe delayed-src="https://embed-ssl.ted.com/talks/'+uriRest+'" frameborder="0" scrolling="no" allowfullscreen></iframe>'), from:"ted", videoId:v};
	}
	return false;
};
ptnURI=m.ptnURI["w.soundcloud.com"]={};
ptnURI.regEx=/^player\/(\?\S+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["w.soundcloud.com"].regEx.exec(uriRest);
	if (exec!==null) {
		var vars=m.getSearchVars(exec[1]);
		var lastPath="player/?";
		for (var i=0;i<vars.length;i++) {
			if (vars[i].key==="auto_play") {
				lastPath+="auto_play=false&";
			} else {
				lastPath+=vars[i].key+"="+vars[i].val+"&";
			}
		}
		return {html:m.rC('<iframe delayed-src="https://w.soundcloud.com/'+lastPath.substring(0,lastPath.length-1)+'" scrolling="no" frameborder="no"></iframe>',40), from:"ted", videoId:vars.url&&vars.url.val};
	}
	return false;
};
ptnURI=m.ptnURI["appsurprise.co.kr"]={};
ptnURI.regEx=/^\S*/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["appsurprise.co.kr"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="http://appsurprise.co.kr/'+uriRest+'" frameborder="0"></iframe>')};
	}
	return false;
};
ptnURI=m.ptnURI["instagram.com"]=m.ptnURI["www.instagram.com"]={};
ptnURI.regEx=/^p\/([\w-]+)/i;
ptnURI.toIframe=function(uriRest) {
	var exec=m.ptnURI["instagram.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="https://instagram.com/p/'+exec[1]+'/embed" frameborder="0" scrolling="no" allowtransparency="true"></iframe>', 113)};
	}
	return false;
};

ptnURI=m.ptnURI[0]={};
ptnURI.regEx=/^https?:\/\/\S+\.(?:jpg|jpeg|bmp|gif|png|webp|svg|tif)(?=$|\?|\s)/i;
ptnURI.toIframe=function(uri) {
	var exec=m.ptnURI[0].regEx.exec(uri);
	if (exec!==null) {
		return {html:'<div class="center"><img delayed-src="'+exec[0]+'"/></div>'};
	}
	return false;
};
ptnURI=m.ptnURI[1]={};
ptnURI.regEx=/^https?:\/\/\S+\.(?:mp4|ogg|webm)(?=$|\?|\s)/i;
ptnURI.toIframe=function(uri) {
	var exec=m.ptnURI[1].regEx.exec(uri);
	if (exec!==null) {
		return {html:m.rC('<video controls preload="auto" delayed-src="'+exec[0]+'"></video>'), from:'video', src:exec[0]};
	}
	return false;
};

////////////////////////////////////////////////////
// desc and cmt rendering
////////////////////////////////////////////////////
m.slideToggle=function(elem) {
	var $elem=$(elem);
	$elem.addClass("disabled");
	$elem.parent().next().slideToggle(1000);
	setTimeout(function() {
		$elem.removeClass("disabled");
	}, 1000);
};
m.slideUp=function(elem) {
	var $elem=$(elem).parent().parent();
	$elem.slideUp(1000);
	$body.animate({scrollTop:'-='+$elem.height()}, 1000);
};
m.renderStrDescCmt=function(str) {
	var res=[];
	str=str.trim();
	var key="#";
	var i=0;
	var start=0;
	var exec;
	while ((exec=m.ptnDescCmt.exec(str))!==null) {
		res[i++]=key;
		res[key]=str.substring(start, exec.index).trim();
		start=m.ptnDescCmt.lastIndex;
		key=exec[1];
	}
	res[i++]=key;
	res[key]=str.substring(start).trim();
	return res;
};



/* Points */
////////////////////////////////////////////////////
// val, points, stars
////////////////////////////////////////////////////
m.val=function(val) {
	var res={};
	res.str=val;
	if (val.length===0) {
		res.valid=true;
		res.val=-1;
	} else {
		var exec=m.ptnVal.exec(val);
		if (exec!==null) {
			res.num=Number(exec[1]);
			res.divisor=Number(exec[2])
			res.valid=(res.num<=res.divisor);
			if (res.valid) {
				res.val=res.num/res.divisor;
			} else {
				res.val=-1;
			}
		}
	}
	return res;
};
{
	var r=12; // outer radius of star
	var r0=6; // inner radius of star
	var pad=1; // padding of star
	var pad0=9; // left/right pad
	var thetas=[];
	var coss=[];
	var sins=[];
	for (var i=0;i<10;i++) {
		thetas.push(-Math.PI/2+2*Math.PI/10*i);
		coss.push(Math.cos(thetas[i]));
		sins.push(Math.sin(thetas[i]));
	}
	var str=pad0+',0 ';
	var yc=pad+r;
	var xc=pad0+pad+r;
	for (var k=0;k<5;k++,xc+=2*r+pad) {
		str+=xc+',0 ';
		for (var i=0;i<10;i++) {
			var rp=(i%2==0)?r:r0;
			str+=(xc+rp*coss[i]).toFixed(1)+','+(yc+rp*sins[i]).toFixed(1)+' ';
		}
		str+=xc+','+pad+' '+xc+',0 ';
	}
	xc-=r;
	yc+=r*sins[4]+pad;
	str+=xc+',0 '+xc+','+yc.toFixed(1)+' '+pad0+','+yc.toFixed(1);
	m["5stars-pre"]='<div class="stars-container" style="width:'+(xc+pad0)+'px; height:'+yc.toFixed(1)+'px"><div class="bar" style="left:'+(pad0+1)+'px; width:';
	m["5stars-width"]=xc-pad0-2;
	m["5stars-pad0+1"]=pad0+1;
	m["5stars-post"]='px"></div><svg class="out-stars">'
			+'<polygon points="'+str+'"/>'
		+'</svg></div>';
	m["5stars"]=function(val) {
		if (val<0) { val=0; }
		else if (val>1) { val=1; }
		return m["5stars-pre"]+(m["5stars-width"]*val).toFixed(1)+m["5stars-post"];
	}
}

////////////////////////////////////////////////////
// Point range
////////////////////////////////////////////////////
$show_recos_without_points.on("click", function(e) {
	if ($show_recos_without_points.hasClass("enabled")) {
		$show_recos_without_points.removeClass("enabled");
		m.showRWOP=false;
	} else {
		$show_recos_without_points.addClass("enabled");
		m.showRWOP=true;
	}
	clearTimeout(m.timeOutRange);
	m.timeOutRange=setTimeout(function() {
		m.getUriListAndShowRecosOnCat(m.currentCat);
	}, 500);
});
m.PRtoFixed=function(w) {
	return (m.PRmax*(w-15)/(m.PRw-30)).toFixed(1);
};
m.mmInPR=function(e) {
	window.getSelection().removeAllRanges();
	e.preventDefault();
	e.stopPropagation();
	var x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
	var w=x-$point_range.offset().left+$window.scrollLeft();
	w=(w>15)?w:15;
	w=(w<m.PRw-15)?w:m.PRw-15;
	var changed=false;
	if (m.mdInPRL) {
		if (w>m.PRRw) { w=m.PRRw; }
		if (m.PRLw!==w) {
			$point_range_left.css({left:w-15});
			$point_range_bar.css({left:w});
			m.PRLw=w;
			changed=true;
		}
	} else {
		if (w<m.PRLw) { w=m.PRLw; }
		if (m.PRRw!==w) {
			$point_range_right.css({left:w-5});
			$point_range_bar.css({right:m.PRw-w});
			m.PRRw=w;
			changed=true;
		}
	}
	if (changed) {
		var PRL=m.PRtoFixed(m.PRLw);
		var PRR=m.PRtoFixed(m.PRRw);
		$point_range_result.html(PRL+"~"+PRR+" / "+m.PRmax);
		PRL=Number(PRL)/m.PRmax;
		PRR=Number(PRR)/m.PRmax;
		if (m.ptsRangeFrom!==PRL||m.ptsRangeTo!==PRR) {
			m.ptsRangeFrom=PRL;
			m.ptsRangeTo=PRR;
			clearTimeout(m.timeOutRange);
			m.timeOutRange=setTimeout(function() {
				m.getUriListAndShowRecosOnCat(m.currentCat);
			}, 800);
		}
	}
};
$point_range_left.on("mousedown touchstart", function(e) {
	m.mdInPRL=true;
	$html.on("mousemove.mdInPR touchmove.mdInPR", m.mmInPR);
	$html.on("mouseup.mdInPR touchend.mdInPR", function(e) {
		m.mdInPRL=false;
		$html.off("mouseup.mdInPR touchend.mdInPR mousemove.mdInPR touchmove.mdInPR");
	});
});
$point_range_right.on("mousedown touchstart", function(e) {
	m.mdInPRR=true;
	$html.on("mousemove.mdInPR touchmove.mdInPR", m.mmInPR);
	$html.on("mouseup.mdInPR touchend.mdInPR", function(e) {
		m.mdInPRR=false;
		$html.off("mouseup.mdInPR touchend.mdInPR mousemove.mdInPR touchmove.mdInPR");
	});
});

////////////////////////////////////////////////////
// Show recos
////////////////////////////////////////////////////
m.recoHTML=function(r, uriRenderDisable) {
	var res="";
	if (r&&r["has"]) {
		res+='<div class="reco">'
			+'<a class="SNS-img" style="background-image:url(\'/icon-Twitter.png\')" target="_blank" href="https://twitter.com/intent/tweet?text='+encodeURIComponent(r.title)+'&url='+encodeURIComponent(r.uri)+'"></a><a class="SNS-img" style="background-image:url(\'/icon-Facebook.png\')" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(r.uri)+'"></a>'
			+((m.myIndex)?'<div class="button edit fRight" onclick="m.editOrRecoToMine(this)">'+((m.myPage)?'Edit':'Reco to mine')+'</div>':'')
			+'<div class="textURI">'+m.escapeHTML(r.uri)+'</div>'
			+'<div class="uri cBoth">'+m.uriToA(r.uri)+'</div>'
			+'<div class="title">'+m.escapeHTML(r.title)+'</div>'
			+'<div class="cats">'+m.catsToA(r.cats)+'</div>'
			+(uriRenderDisable?"":m.uriRendering(r.uri).html);
		if (r["desc"]) {
			var descR=r["descR"];
			res+='<div class="desc">';
			for (var l=0;l<descR.length;l++) {
				var key=m.escapeHTML( descR[l] );
				var value=m.escapeHTML( descR[descR[l]] );
				switch (key.toLowerCase()) {
				case "#" : case "" :
					res+='<div class="value">'+value.replace(/\n/g,"<br>")+'</div>';
					break;
				case "lyrics" : case "lyric" : case "가사" :
					res+='<div class="value"><div class="center"><div class="button" onclick="m.slideToggle(this)">▼ Toggle lyrics</div></div>'
						+'<div class="lyricsC" style="display:none">'
							+'<div class="lyricsArrow"></div>'
							+'<div class="lyrics">'+value.replace(/\n/g,"<br>")+'</div>'
							+'<div class="right"><div class="button" onclick="m.slideUp(this)">▲ Hide lyrics</div></div>'
						+'</div></div>';
					break;
				case "related" :
					res+='<div class="value"><span class="key">#'+key+'</span>';
					var relateds=value.split("\n");
					for (var p=0;p<relateds.length;p++) {
						res+='<br>'+m.uriRendering(m.formatURI(relateds[p]),true).html;
					}
					res+='</div>';
					break;
				default :
					res+='<div class="value"><span class="key">#'+key+' </span>'+value.replace(/\n/g,"<br>")+'</div>';
				}
			}
			res+='</div>';
		}
		res+=(r["cmt"].length!==0?('<div class="cmt">'+m.escapeHTML( r["cmt"] ).replace(/\n/g,"<br>")+'</div>'):"");
		if (r["val"].str) {
			res+='<div class="val">'+m["5stars"]( r["val"].val )+' <span class="str">'+m.escapeHTML( r["val"].str )+'</span></div>';
		}
		res+='<div class="tFirst">Firstly Recoed at '+r.tFirst+'</div><div class="cBoth"></div>';
		if (r.tFirst!==r.tLast) {
			res+='<div class="tLast">Lastly Editted at '+r.tLast+'</div><div class="cBoth"></div>';
		}
		res+='</div>';
	} else {
		res+='<div class="reco">No Reco</div>';
	}
	return res;
};
m.showRecosOnCat=function(elem, from, minus, plus) {
	var fs=m.fsTitle;
	var l=fs.fullList.length;
	var strHTML="";
	if (l>0) {
		if (from===undefined||from===null) {
			from=l-1;
		} else if (from.constructor===Number) {
			if (from>=l) {
				from=l-1;
			} else if (from<0) {
				from=0;
			}
		} else if (from.constructor===String) {
			// from==uri
			from=fs.fullList[from].i;
		} else {
			from=l-1;
		}
		if (minus===undefined||minus===null) {
			minus=-m.maxShowReco;
		} else if (minus.constructor===Number) {
			minus=minus>0?-minus:minus;
		} else {
			minus=-m.maxShowReco;
		}
		if (plus===undefined||plus===null) {
			plus=m.maxShowReco;
		} else if (plus.constructor===Number) {
			plus=plus>0?plus:-plus;
		} else {
			plus=m.maxShowReco;
		}
		var nHiden=0, nShown=0;
		for (var k=0;k<l;k++) {
			var fsFLk=fs.fullList[k];
			var uri=fsFLk.uri;
			var r=fsFLk.reco;
			var val=r.val.val;
			var titleSH=m.splitHangul(r.title);
			fsFLk.txt=titleSH;
			fsFLk.html=m.escapeHTML(r.title);
			if (val===-1) {
				if (m.showRWOP) {
					fsFLk.inRange=true;
					nShown++;
				} else {
					fsFLk.inRange=false;
					nHiden++
				}
			} else {
				if (m.ptsRangeFrom<=val&&val<=m.ptsRangeTo) {
					fsFLk.inRange=true;
					nShown++;
				} else {
					fsFLk.inRange=false;
					nHiden++;
				}
			}
		}
		if (from===l-1) {
			strHTML+='<div class="numbers-of-recos">You have '+l+' recos ('+nShown+' to be shown, and '+nHiden+' hiden.) on cat='+m.currentCat+'.</div>';
		}
		// minus
		var i=from;
		var maxShowReco=-minus;
		for (var k=0;0<=i&&i<l&&k<maxShowReco;i--) {
			var fsFLi=fs.fullList[i];
			var r=fsFLi.reco;
			if (fsFLi.inRange) {
				if (fsFLi.$listI) { break; }
				strHTML+=m.recoHTML(r);
				k++;
			}
		}
		if (0<=i&&i<l&&!(fs.fullList[i].$listI)) {
			strHTML+='<div class="button to-be-executed" onclick="m.showRecosOnCat(this,'+i+',10,1)">Load more... from <span class="from">'+(i-9)+'</span> to <span class="to">'+(i+1)+'</span></div>';
		}
		if (elem) {
			$(elem).after(strHTML);
		} else {
			$contents.html(strHTML);
		}
		var h0=$body.height();
		strHTML="";
		// plus
		i=from+1;
		maxShowReco=plus;
		for (var k=1;0<=i&&i<l&&k<maxShowReco;i++) {
			var fsFLi=fs.fullList[i];
			var r=fsFLi.reco;
			if (fsFLi.inRange) {
				if (fsFLi.$listI) { break; }
				strHTML=m.recoHTML(r)+strHTML;
				k++;
			}
		}
		if (0<=i&&i<l&&!(fs.fullList[i].$listI)) {
			strHTML='<div class="button to-be-executed" onclick="m.showRecosOnCat(this,'+i+',1,10)">Load more... from <span class="from">'+(i)+'</span> to <span class="to">'+(i+10)+'</span></div>'+strHTML;
		}
		if (elem) {
			$(elem).replaceWith(strHTML);
		} else {
			$contents.prepend(strHTML);
		}
		var h1=$body.height();
		var wST=$window.scrollTop();
		$window.scrollTop(wST+h1-h0);
	} else {
		strHTML='<div class="numbers-of-recos">No reco on cat='+m.escapeHTML(m.currentCat)+'.</div>';
		$contents.html(strHTML);
	}
	var $recos=$contents.find(".reco");
	for (var i=0;i<$recos.length;i++) {
		var uri=m.unescapeHTML($recos.eq(i).find(".textURI").html());
		fs.fullList[uri].$listI=$recos.eq(i);
	}
	m.delayedElems=m.delayedElems.add( $contents.find("[delayed-src], [delayed-bgimage], .to-be-executed") );
	$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
	$window.trigger("scroll.delayedLoad");
	m.fdList=$("#sidebar, #head, #contents .reco, #foot");
	fs[0].ptnSH=m.splitHangul("$!@#");
	fs.$fs.trigger("keyup");
};
m.editOrRecoToMine=function(elem) {
	var $reco=$(elem).parent(".reco");
	var uri=m.unescapeHTML($reco.find(".textURI").html());
	var r=m.userRecos[uri];
	$input_uri[0].value=r["uri"];
	$input_uri[0].disabled=true;
	$new_reco.show();
	if (uri.length!==0&&uri!==m.lastURI) {
		m.getAndShowDefsAndReco(true);
	}
	m.wST=$window.scrollTop();
	$window.on("scroll.stop", function(e) {
		$window.scrollTop(m.wST);
	});
};
m.recoDowned=function(urisStr, recos) {
	var uris=urisStr.split("\n");
	for (k=0;k<uris.length;k++) {
		var uri=uris[k];
		var p=recos[uri];
		if (!p) { p=recos[uri]={}; }
		p.down=true;
	}
};
m.recoToEve=function(resp, recos) {
	var resp=m.strToJSON(resp);
	for (var k=1;k<resp.length;k++) {
		var recoK=resp[k];
		var uri=recoK["uri"];
		var p=recos[uri];
		if (!p) { p=recos[uri]={}; }
		p["has"]=true;
		for (var prop in recoK) {
			if (isNaN(prop)) {
				p[prop]=recoK[prop];
			}
		}
		if (p.desc!==undefined) {
			p.descR=m.renderStrDescCmt(p.desc); // R for rendered.
		}
		if (p.cmt!==undefined) {
			p.cmtR=m.renderStrDescCmt(p.cmt); // R for rendered.
		}
		if (p.val!==undefined) {
			p.val=m.val(p.val);
		}
	}
};
m.getAndShowRecosOnCat=function(cat) {
	var uriList=(m.catUriList[cat].has?m.catUriList[cat].UriList:"").trim();
	var uris=[];
	if (uriList.length!==0) { uris=uriList.split("\n"); }
	var getRecosStr="uri";
	var getRecosN=0;
	var fs=m.fsTitle;
	var fsFL=fs.fullList=[];
	fsFL.cat=cat;
	for (var i=0;i<uris.length;i++) {
		var uri=uris[i];
		var r=m.userRecos[uri];
		if (!r) { r=m.userRecos[uri]={}; }
		fsFL[uris.length-1-i]=fsFL[uri]={i:uris.length-1-i, uri:uri, reco:r};
		if (!r.down) {
			getRecosStr+="\n"+uri;
			getRecosN++;
		}
	}
	if (getRecosN>0) {
		$.ajax({
			type:"POST", url:m.pathName+"/get-Recos", data:getRecosStr
			, dataType:"text"
		}).done(function(resp) {
			m.recoDowned(getRecosStr.substring(4), m.userRecos);
			m.recoToEve(resp, m.userRecos);
			m.showRecosOnCat();
			fs.prepareRecoListPlay();
			fs[1]=null;
			fs[0].ptnSH=m.splitHangul("$!@#");
			fs.$fs.trigger("keyup");
		});
	} else {
		m.showRecosOnCat();
		fs.prepareRecoListPlay();
		fs[1]=null;
		fs[0].ptnSH=m.splitHangul("$!@#");
		fs.$fs.trigger("keyup");
	}
};
m.getUriListAndShowRecosOnCat=function(cat) {
	$contents.html("Loading recos in cat="+m.escapeHTML(cat)+"...");
	var catList=m.catList[cat];
	if (catList) {
		$catList.find(".cat").removeClass("selected");
		var $cat=$("#cat-"+catList.i);
		$cat.addClass("selected");
		var $parents=$cat.parents(".subCat");
		for (var i=$parents.length-1;i>=0;i--) {
			if (!$parents.eq(i).is(":visible")) {
				$parents.eq(i).prev().find(">.EC").trigger("click");
			}
		}
		var catUriList=m.catUriList[cat];
		if (!catUriList) { catUriList=m.catUriList[cat]={}; }
		if (catUriList.down) {
			m.getAndShowRecosOnCat(cat);
		} else {
			var getUriListStr="cat\n"+(cat===""?"\tp":cat);
			$.ajax({
				type:"POST", url:m.pathName+"/get-UriList", data:getUriListStr
				, dataType:"text"
			}).fail(function() {
				$contents.html("get-UriList on "+m.escapeHTML(cat)+" has failed..");
			}).done(function(resp) {
				catUriList.down=true;
				var resp=m.strToJSON(resp);
				for (var i=1;i<resp.length;i++) {
					var catUL=m.catUriList[resp[i].cat];
					catUL.down=true;
					catUL.has=true;
					for (var p in resp[i]) {
						if (isNaN(p)) {
							catUL[p]=resp[i][p];
						}
					}
				}
				m.getAndShowRecosOnCat(cat);
			});
		}
	} else {
		$contents.html("Category \""+m.escapeHTML(cat)+"\" does not exist.");
	}
};
m.refresh=function(cats, option, uri) {
	var currentCat=m.getSearchVars(window.location.search).cat;
	if (currentCat) { currentCat=currentCat.val; }
	var c=cats.split(";");
	var k=0;
	if (currentCat!==undefined) {
		for (k=c.length-1;k>0;k--) {
			if (c[k]===currentCat) {break;}
		}
	}
	m.currentCat=c[k];
	if (c[k]!==currentCat) {
		m.getUriListAndShowRecosOnCat(c[k]);
		window.history.pushState({cat:c[k]}, null, m.pathOfCat(c[k]));
	} else {
		switch (option) {
		case "recoed" :
			var $newReco=$( m.recoHTML( m.userRecos[uri] ) );
			$contents.prepend( $newReco );
			m.delayedElems=m.delayedElems.add( $newReco.find("[delayed-src], [delayed-bgimage]") );
			$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
			$window.trigger("scroll.delayedLoad");
			m.fdList=m.fdList.add( $newReco );
			break;
		case "changed" : case "deleted" :
			var $recos=$contents.find(">.reco");
			for (var i=0;i<$recos.length;i++) {
				var $reco=$recos.eq(i);
				var recoUri=m.unescapeHTML($reco.find(">.textURI").html());
				if (recoUri===uri) {
					if (option==="changed") {
						var $newReco=$( m.recoHTML( m.userRecos[uri] ) );
						$reco.replaceWith($newReco);
						m.delayedElems=m.delayedElems.add( $newReco.find("[delayed-src], [delayed-bgimage]") );
						$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
						$window.trigger("scroll.delayedLoad");
						m.fdList=m.fdList.add( $newReco );
					} else if (option==="deleted") {
						$reco.remove();
					}
					break;
				}
			}
			break;
		default :
			m.getUriListAndShowRecosOnCat(c[k]);
		}
	}
};

m.ExpCol=function(elem, catEC) {
	var $elem=$(elem);
	var $next=$elem.parent().next();
	if ($next.is(":visible")) {
		$next.hide();
		$elem.html("▶");
		catEC.subCatExpanded=false;
	} else {
		$next.show();
		$elem.html("▼");
		catEC.subCatExpanded=true;
	}
};

/////////////////////////////////////////
// Open Cat
/////////////////////////////////////////
m.openCat=function(cat, e) {
	if (e&&e.which===2) {
		return true;
	} else {
		if (window.history.state&&window.history.state.cat===cat) { return false; }
		m.currentCat=cat;
		m.getUriListAndShowRecosOnCat(cat);
		window.history.pushState({cat:cat}, null, m.pathOfCat(cat));
		return false;
	}
};

for (var i=0;i<m.catList.length;i++) {
	var cat=m.catList[i].cat;
	m.catUriList[cat]={cat:cat, down:false};
}

window.onpopstate=function(e) {
	if (e.state&&e.state.cat!==undefined) {
		m.getUriListAndShowRecosOnCat(e.state.cat);
	}
};
m.getSearchVars=function(searchStr) {
	var vars=[];
	if (searchStr!==0) {
		if (searchStr.substring(0,1)==="?") { searchStr=searchStr.substring(1); }
		var j=searchStr.indexOf("#");
		if (j!==-1) { searchStr=searchStr.substring(0,j); }
		var splits=searchStr.replace(/&amp;/ig,"&").split("&");
		for (var i=0;i<splits.length;i++) {
			var key=splits[i];
			var value="";
			var k=key.indexOf("=");
			if (k!==-1) {
				value=decodeURIComponent(key.substring(k+1));
				key=key.substring(0,k);
			}
			key=decodeURIComponent(key);
			vars[i]=vars[key]={key:key, val:value};
		}
	}
	return vars;
};

////////////////////////////////////////////////////
// New Reco or Edit
////////////////////////////////////////////////////
m.getUTF8Length=function(s) {
	var len=0;
	for (var i=0;i<s.length;i++) {
		var code=s.charCodeAt(i);
		if (code<=0x7f) {
			len+=1;
		} else if (code<=0x7ff) {
			len+=2;
		} else if (code>=0xd800&&code<=0xdfff) {
			// Surrogate pair: These take 4 bytes in UTF-8 and 2 chars in UCS-2
			// (Assume next char is the other [valid] half and just skip it)
			len+=4; i++;
		} else if (code<0xffff) {
			len+=3;
		} else {
			len+=4;
		}
	}
	return len;
};
m.formatURI=function(uri) {
	uri=uri.trim().replace(/[\t\n]/g," ");
	var exec=m.ptnTag.exec(uri);
	if (exec!==null) {
		try {
			var $uri=$(uri);
			var src=$uri.attr("src");
			if (src) {
				uri=src;
			} else {
				src=$uri.find("[src]").attr("src");
				if (src) { uri=src; }
			}
		} catch (err) { console.log(err); }
	}
	return uri.replace(/&amp;/ig,"&").trim();
};
m.formatTitle=function(title) {
	return title.trim().replace(/[\t\n]/g," ");
};
m.formatCats=function(cats) {
	if (!cats||cats.constructor!==String||cats.trim().length===0) {
		return "";
	}
	cats=cats.trim().replace(/[\t\r\n]/g," ");
	var list=cats.split(";");
	for (var i=0;i<list.length;i++) {
		var levels=list[i].split("--");
		for (var j=0;j<levels.length;j++) {
			levels[j]=levels[j].replace(/^[\s-]+/,"").replace(/[\s-]+$/,"");
		}
		list[i]="";
		var k=0;
		for (;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]=levels[k];
				break;
			}
		}
		for (k++;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]+="--"+levels[k];
			}
		}
	}
	var catsMap={};
	catsMap[list[0]]=true;
	cats=list[0];
	for (var i=1;i<list.length;i++) {
		if (catsMap[list[i]]) {
		} else {
			catsMap[list[i]]=true;
			cats+=";"+list[i];
		}
	}
	return cats;
};

m.userRecos[""]={
	has:false, down:true, defs:true, title:"", cats:"", desc:"", cmt:"", val:m.val(""), "def-titles":"", "def-cats":""
};
m.showMyReco=function(r) {
	if (r["has"]) {
		$button_reco.hide();
		$button_edit.show();
		$button_del.show();
	} else {
		$button_reco.show();
		$button_edit.hide();
		$button_del.hide();
	}
	var $mR=$("#my-reco");
	$mR.html( m.recoHTML(r) ); // need to be edit.
	if (r["has"]) {
		var $edit=$mR.find(".button.edit");
		$edit.html("Edit mine");
		$edit.on("click", function(e) {
			$input_title[0].value=r["title"];
			$input_cats[0].value=r["cats"];
			$input_desc[0].value=r["desc"];
			$input_cmt[0].value=r["cmt"];
			$input_val[0].value=r["val"].str;
			$input_val.trigger("keyup");
		});
	}
};
m.showReco=function(r) {
	if (r["has"]) {
		$input_title[0].value=r.title;
		$input_cats[0].value=r.cats;
		$input_desc[0].value=r.desc;
		if (m.myPage) {
			$input_cmt[0].value=r.cmt;
			$input_val[0].value=r.val.str;
		} else {
			$input_cmt[0].value="";
			$input_val[0].value="";
		}
		$input_val.trigger("keyup");
	}
	if (m.myPage) {
		if (r["has"]) {
			$button_reco.hide();
			$button_edit.show();
			$button_del.show();
			$button_back.show();
		} else {
			$button_reco.show();
			$button_edit.hide();
			$button_del.hide();
			$button_back.hide();
		}
	}
};
m.emptifyReco=function() {
	$input_uri[0].value="";
	$input_title[0].value="";
	$input_cats[0].value="";
	$input_desc[0].value="";
	$input_cmt[0].value="";
	$input_val[0].value="";
	$input_val.trigger("keyup");
	m.getAndShowDefsAndReco();
};
m.addCat=function() {
	$input_cats[0].value+=";";
	var l=$input_cats[0].value.length;
	$input_cats.focus();
	$input_cats[0].setSelectionRange(l,l);
};
m.showDefs=function(r) {
	var defTitles=r["def-titles"].trim().split("\n");
	var defTitlesHTML="";
	for (var i=0;i<defTitles.length;i++) {
		var title=defTitles[i].trim();
		if (title.length!==0) {
			defTitlesHTML+='<div class="def-title">'+m.escapeHTML(title)+'</div>';
		}
	}
	$def_titles.html(defTitlesHTML);
	var $defTitle=$def_titles.find(".def-title");
	$defTitle.on("click", function(e) {
		$defTitle.removeClass("selected");
		var $this=$(this);
		$this.addClass("selected");
		$input_title[0].value=m.unescapeHTML($this.html());
	});
	
	var defCats=r["def-cats"].trim().split("\n");
	var defCatsHTML='<div class="def-cat">[--Indifferent--]</div> <div class="def-cat">[--Later--]</div> <div id="add-cat" onclick="m.addCat()">+;</div><br>';
	for (var i=0;i<defCats.length;i++) {
		var cat=defCats[i].trim();
		if (cat.length!==0) {
			defCatsHTML+='<div class="def-cat">'+m.escapeHTML(cat)+'</div> ';
		}
	}
	$def_cats.html(defCatsHTML);
	var $defCat=$def_cats.find(".def-cat");
	$defCat.on("click", function(e) {
		$defCat.removeClass("selected");
		var $this=$(this);
		$this.addClass("selected");
		$input_cats[0].value=m.unescapeHTML($this.html());
	});
};
m.getAndShowDefsAndReco=function(noFormatURI) {
	var elem=$input_uri[0];
	var uri=m.lastURI=noFormatURI?elem.value:m.formatURI(elem.value);
	if (elem.value!==uri) { elem.value=uri; }
	$("#show-URI").html(m.uriRendering(uri,true).html.replace(/delayed-src/gi,"src"));
	var r=m.userRecos[uri];
	if (!r) { r=m.userRecos[uri]={}; }
	if (r.down) {
		m.showReco(r);
	} else {
		var getRecosStr="uri"+"\n"+uri;
		$.ajax({
			type:"POST", url:m.pathName+"/get-Recos", data:getRecosStr
			, dataType:"text"
		}).done(function(resp) { // User reco 가 없으면 head 만 보냄.
			m.recoDowned(uri, m.userRecos);
			m.recoToEve(resp, m.userRecos);
			m.showReco(r);
		});
	}
	if (r.defs) {
		m.showDefs(r);
	} else {
		m.showDefs({"def-titles":"", "def-cats":""});
		$.ajax({
			type:"POST", url:"/reco/infos", data:uri
			, dataType:"text"
		}).done(function(resp) {
			var defs=m.strToJSON(resp);
			r.defs=true;
			r["def-cats"]=defs[1]["def-cats"];
			r["def-titles"]=defs[1]["def-titles"];
			m.showDefs(r);
		});
	}
	if (m.myPage||uri==="") {
		$error.html("");
	} else {
		$error.html("Be careful! This is not your page. On this URI, you have");
		var mR=m.myRecos[uri];
		if (!mR) { mR=m.myRecos[uri]={}; }
		if (mR.down) {
			m.showMyReco(mR);
		} else {
			var getRecosStr="uri"+"\n"+uri;
			$.ajax({
				type:"POST", url:"/user/"+m.myId+"/get-Recos", data:getRecosStr
				, dataType:"text"
			}).done(function(resp) { // User reco 가 없으면 head 만 보냄.
				m.recoDowned(uri, m.myRecos);
				m.recoToEve(resp, m.myRecos);
				m.showMyReco(mR);
			});
		}
	}
};
$new_reco.find("input, textarea").on("keydown.common", function(e) {
	if (e.keyCode===27) { // ESC
		$out_focus.focus();
		$button_close.trigger("click");
	} else if (e.ctrlKey&&e.keyCode===13) { // Ctrl+Enter
		var r=m.myRecos[$input_uri[0].value];
		if (r["has"]) {
			$button_edit.trigger("click");
		} else {
			$button_reco.trigger("click");
		}
	}
});
$input_cats.off("keydown.common");
$input_uri.on("input.rd keyup.rd cut.rd paste.rd click.rd", function(e) {
	var uri=this.value;
	if (uri!==m.lastURI) {
		m.lastURI=uri;
		clearTimeout(m.timeOutGetInfos);
		m.timeOutGetInfos=setTimeout(m.getAndShowDefsAndReco, 1000);
	}
});

m.lastVal=m.val("");
$input_val.before($(m["5stars"](0)).attr({id:"input-val-stars"}));
$input_val_stars=$("#input-val-stars");
$input_val_stars.on("mousedown.mdInStars touchstart.mdInStars", function(e) {
	var $bar=$input_val_stars.find(".bar");
	var barW=$bar.width();
	var $val=$input_val[0];
	$html.on("mousemove.mdInStars touchmove.mdInStars", function(e) {
		window.getSelection().removeAllRanges();
		e.preventDefault();
		e.stopPropagation();
		var x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
		var w=x-$bar.offset().left+$window.scrollLeft();
		if (w<-15) {
			w=-1;
		} else if (w<0) {
			w=0;
		} else if (w>m["5stars-width"]) {
			w=m["5stars-width"];
		}
		if (w!==barW) {
			barW=w;
			if (w<0) {
				$val.value="";
				w=0;
			} else {
				$val.value=(w/m["5stars-width"]*m.fullPts).toFixed(1)+"/"+m.fullPts;
			}
			$bar.css({width:w});
			m.lastVal=m.val($val.value);
		}
	});
	$html.on("mouseup.mdInStars touchend.mdInStars", function(e) {
		$html.off("mouseup.mdInStars touchend.mdInStars mousemove.mdInStars touchmove.mdInStars");
	});
});
$input_val_stars.on("click", function(e) {
	var $bar=$(this).find(".bar");
	var barW=$bar.width();
	var $val=$input_val[0];
	var w=e.clientX-$bar.offset().left+$window.scrollLeft();
	if (w<0) {
		w=0;
	} else if (w>m["5stars-width"]) {
		w=m["5stars-width"];
	}
	if (w!==barW) {
		$bar.css({width:w});
		$val.value=(w/m["5stars-width"]*m.fullPts).toFixed(1)+"/"+m.fullPts;
		m.lastVal=m.val($val.value);
	}
});
$input_val.on("keyup", function(e) {
	if (this.value!==m.lastVal.str) {
		var val=m.val(this.value);
		var $bar=$("#input-val-stars .bar");
		if (val.valid&&val.str.length!==0) {
			m.fullPts=val.divisor;
			$bar.css({width:m["5stars-width"]*val.val});
		} else {
			$bar.css({width:0});
		}
		m.lastVal=val;
	}
});

$button_new_reco.on("click", function(e) {
	$input_uri[0].disabled=false;
	$new_reco.show();
	var cat=m.getSearchVars(window.location.search).cat;
	if (cat) { cat=cat.val; }
	if (cat&&($input_cats[0].value===""||$input_title[0].value===""||$input_uri[0].value==="")) {
		$input_cats[0].value=cat;
	}
	m.wST=$window.scrollTop();
	$window.on("scroll.stop", function(e) {
		$window.scrollTop(m.wST);
	});
	$input_uri.focus();
	$input_uri.trigger("keyup");
});
$button_close.on("click", function(e) {
	$new_reco.hide();
	$window.off("scroll.stop");
});
$button_back.on("click", function(e) {
	var r=m.userRecos[$input_uri[0].value];
	m.showReco(r);
});

m.reco_do=function(args) {
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strRecoDo
		, dataType:"text"
	}).fail(function() {
		$error.html("Reco failed. You may be not logged-in.");
		// $button_reco.removeClass("disabled");
	}).done(function(resp) {
		var res=m.strToJSON(resp);
		if (res[1]["result"]==="recoed") {
			$error.html("Recoed");
			m.recoDowned(args.uri, m.myRecos);
			m.recoToEve(args.strRecoDo, m.myRecos);
			var cats=m.myRecos[args.uri]["cats"];
			m.putCats_UriToLists(cats, args.uri);
			if (m.myPage) {
				m.refresh(cats, "recoed", args.uri);
			}
			setTimeout(function() {
				m.emptifyReco();
				// $button_reco.removeClass("disabled");
				$button_close.trigger("click");
			}, 1000);
		} else {
			$error.html(res[1]["result"]);
			// $button_reco.removeClass("disabled");
		}
	}).always(function() {
		$button_reco.removeClass("disabled");
	});
};
$button_reco.on("click", function(e) {
	$button_reco.addClass("disabled");
	var uri=m.formatURI($input_uri[0].value);
	var val=m.val($input_val[0].value.trim());
	var errorMsg="";
	var valid=true;
	if (uri.length===0) {
		valid=false;
		errorMsg="URI is required.";
	} else if (m.getUTF8Length(uri)>255) {
		valid=false;
		errorMsg="URI (Length "+m.getUTF8Length(uri)+" &gt; maxUTF8Length 255) is too long.";
	} else if (!val.valid) {
		valid=false;
		errorMsg="Points is of invalid form.";
	}
	if (valid) {
		var strHeads="do"+"\t"+"uri";
		var strContents="reco"+"\t"+m.encloseStr(uri);
		strHeads+="\t"+"title";
		strContents+="\t"+m.encloseStr(m.formatTitle($input_title[0].value.trim()));
		strHeads+="\t"+"cats";
		strContents+="\t"+m.encloseStr(m.formatCats($input_cats[0].value.trim()));
		strHeads+="\t"+"desc";
		strContents+="\t"+m.encloseStr($input_desc[0].value.trim());
		strHeads+="\t"+"cmt";
		strContents+="\t"+m.encloseStr($input_cmt[0].value.trim());
		strHeads+="\t"+"val";
		strContents+="\t"+m.encloseStr(val.str);
		var strRecoDo=strHeads+"\n"+strContents;
		$error.html("Being recoed.");
		m.rmb_me(m.reco_do, {strRecoDo:strRecoDo, uri:uri});
		
	} else {
		$error.html(errorMsg);
		$button_reco.removeClass("disabled");
	}
});
m.reco_change_do=function(args) {
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).fail(function() {
		$error.html("Failed change. You may not be logged-in.");
		// $button_edit.removeClass("disabled");
	}).done(function(resp) {
		var res=m.strToJSON(resp);
		if (res[1]["result"]==="changed") {
			$error.html("Changed");
			if (args.cats!==args.r["cats"]) {
				m.catsChangedOnUri(args.r.cats, args.cats, args.uri);
				args.r["cats"]=args.cats;
			}
			if (args.title!==args.r["title"]) { args.r["title"]=args.title; }
			if (args.desc!==args.r["desc"]) {
				args.r["desc"]=args.desc;
				args.r["descR"]=m.renderStrDescCmt(args.desc);
			}
			if (args.cmt!==args.r["cmt"]) {
				args.r["cmt"]=args.cmt;
				args.r["cmtR"]=m.renderStrDescCmt(args.cmt);
			}
			if (args.val.str!==args.r["val"].str) { args.r["val"]=args.val; }
			if (m.myPage) { m.refresh(args.cats, "changed", args.uri); }
			setTimeout(function() {
				m.emptifyReco();
				// $button_edit.removeClass("disabled");
				$button_close.trigger("click");
			}, 1000);
		} else {
			$error.html(res[1]["result"]);
			// $button_edit.removeClass("disabled");
		}
	}).always(function() {
		$button_edit.removeClass("disabled");
	});
};
$button_edit.on("click", function(e) {
	$button_edit.addClass("disabled");
	var uri=$input_uri[0].value;
	var val=m.val($input_val[0].value.trim());
	var r=m.myRecos[uri];
	if (uri.length!==0&&val.valid&&r) {
		var strHeads="do"+"\t"+"uri";
		var strContents="change"+"\t"+m.encloseStr(uri);
		var changed=false;
		var title=m.formatTitle($input_title[0].value.trim());
		if (title!==r["title"]) {
			changed=true;
			strHeads+="\t"+"title";
			strContents+="\t"+m.encloseStr(title);
		}
		var cats=m.formatCats($input_cats[0].value.trim());
		if (cats!==r["cats"]) {
			changed=true;
			strHeads+="\t"+"cats";
			strContents+="\t"+m.encloseStr(cats);
		}
		var desc=$input_desc[0].value.trim();
		if (desc!==r["desc"]) {
			changed=true;
			strHeads+="\t"+"desc";
			strContents+="\t"+m.encloseStr(desc);
		}
		var cmt=$input_cmt[0].value.trim();
		if (cmt!==r["cmt"]) {
			changed=true;
			strHeads+="\t"+"cmt";
			strContents+="\t"+m.encloseStr(cmt);
		}
		if (val.str!==r["val"].str) {
			changed=true;
			strHeads+="\t"+"val";
			strContents+="\t"+m.encloseStr(val.str);
		}
		if (changed) {
			$error.html("Being changed.");
			m.rmb_me(m.reco_change_do, {strHeads:strHeads, strContents:strContents, cats:cats, r:r, uri:uri, title:title, desc:desc, cmt:cmt, val:val});
		} else {
			$error.html("You have made no change.");
			$button_edit.removeClass("disabled");
		}
	} else {
		var errorMsg="";
		if (uri.length===0) {
			errorMsg="URI is required.";
		} else if (!val.valid) {
			errorMsg="Points is of invalid form.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_edit.removeClass("disabled");
	}
});
m.reco_delete_do=function(args) {
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).done(function(resp) {
		console.log(resp);
		var res=m.strToJSON(resp);
		if (res[1]["result"]==="deleted") {
			$error.html("Deleted");
			var cats=args.r["cats"];
			delete m.myRecos[args.uri];
			m.delCats_UriFromLists(cats, args.uri);
			if (m.myPage) {
				m.refresh(cats, "deleted", args.uri);
			}
			setTimeout(function() {
				// $button_del.removeClass("disabled");
				$button_close.trigger("click");
			}, 1000);
		} else {
			$error.html(res[1]["result"]);
			// $button_del.removeClass("disabled");
		}
	}).always(function() {
		$button_del.removeClass("disabled");
	});
};
$button_del.on("click", function(e) {
	$button_del.addClass("disabled");
	var uri=$input_uri[0].value;
	var r=m.myRecos[uri];
	if (uri.length!==0&&r) {
		var strHeads="do"+"\t"+"uri";
		var strContents="delete"+"\t"+m.encloseStr(uri);
		m.rmb_me(m.reco_delete_do, {strHeads:strHeads, strContents:strContents, r:r, uri:uri});
	} else {
		var errorMsg="";
		if (uri.length==0) {
			errorMsg="URI is required.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_del.removeClass("disabled");
	}
});


///////////////////////////////////////////
// Fuzzy search on Titles
///////////////////////////////////////////
$fuzzy_search.on("keydown", function(e) {
	e.stopPropagation();
	switch (e.keyCode) {
	case 27: // ESC = 27
		e.preventDefault();
		$out_focus.focus();
		$fuzzy_search_container.hide();
		break;
	case 38: // up = 38
	case 40: // down = 40
		e.preventDefault();
		var $fsl=$fuzzy_search_list;
		var $lis=$fsl.find(".list-item");
		var $liSelected=$fsl.find(".list-item.selected").eq(0);
		var $liTo=null;
		if ($liSelected.exists()) {
			if (e.keyCode===38) {
				$liTo=$liSelected.prev();
			} else {
				$liTo=$liSelected.next();
			}
			if ($liTo.exists()) {
				$liTo.eq(0).trigger("click");
				if ($liTo.offset().top<$fsl.offset().top+2) { // $liTo at upside of scroll.
					$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top-$fsl.offset().top-2);
				} else if ($liTo.offset().top+$liTo.outerHeight()>$fsl.offset().top+$fsl.height()+2) { // $liTo at downside of scroll.
					$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top+$liTo.outerHeight()-$fsl.offset().top-$fsl.height()-2);
				}
			}
		} else {
			if ($lis.exists()) {
				if (e.keyCode===38) {
					$liTo=$lis.last();
					$fsl.scrollTop($fsl[0].scrollHeight);
				} else {
					$liTo=$lis.first();
					$fsl.scrollTop(0);
				}
				$liTo.eq(0).trigger("click");
			}
		}
		break;
	}
});
m.gotoLi=function(e, elem, k, fs) {
if (e&&e.srcElement&&e.srcElement.nodeName=="A") {
} else {
	var $elem=$(elem);
	var uri=fs.fullList[k].uri;
	if ($elem.hasClass("selected")) {
		fs.$fs.trigger({type:"keydown", keyCode:27}); // keyCode:27=ESC
	} else {
		fs.$fsLis.removeClass("selected");
		$elem.addClass("selected");
	}
	var $listI=fs.fullList[k].$listI;
	if ($listI) {
		$window.scrollTop($listI.offset().top);
	} else {
		var $insert=$('<div class="button">inserting...</div>');
		var $loads=$contents.find(">.button.to-be-executed");
		var i=0;
		for (;i<$loads.length-1;i++) {
			var from0=Number($loads.eq(i).find(".from").html());
			var to0=Number($loads.eq(i).find(".to").html());
			if (to0<=k&&k<from0) {
				$loads.eq(i).trigger("click");
				break;
			}
			var to1=Number($loads.eq(i+1).find(".to").html());
			if (to1<=k&&k<from0) {
				$loads.eq(i).after($insert);
				$elem=m.showRecosOnCat($insert[0], k, 2, 3);
				break;
			}
		}
		if (i===$loads.length-1) {
			var from0=Number($loads.eq(i).find(".from").html());
			var to0=Number($loads.eq(i).find(".to").html());
			if (to0<=k&&k<from0) {
				$loads.eq(i).trigger("click");
			} else {
				$loads.eq(i).after($insert);
				$elem=m.showRecosOnCat($insert[0], k, 2, 3);
			}
		}
		setTimeout(function() {
			$window.scrollTop(fs.fullList[k].$listI.offset().top);
		}, 512);
	}
}};
m.doFSTitle=function(fs) {
	var fsPtnSH=m.splitHangul(fs.$fs.text());
	if (fs[0].ptnSH.splitted!==fsPtnSH.splitted) {
		m.fuzzySearch(fsPtnSH, fs);
		var res=fs[0];
		var sorted=res.sorted;
		var str="";
		for (var i=0;i<sorted.length;i++) {
			var k=res[sorted[i]].i;
			var fsFLk=fs.fullList[k];
			if (fsFLk.inRange) {
				var uri=fsFLk.uri;
				str+='<div class="list-item" onclick="m.gotoLi(event,this,'+k+',m.fsTitle)">'
						+fs.fullList[k].html
						+((res[sorted[i]].highlight!==undefined)?
						'<div class="highlighted">'+'<span class="maxMatchScore">'+res[sorted[i]].maxMatchScore+'</span> :: '+res[sorted[i]].highlight+'</div>':'')
					+'</div>';
			}
		}
		fs.$fsl.html(str);
		// fs.$fsl.scrollTop(0);
		fs.$fsLis=fs.$fsl.find(".list-item");
	}
};
m.fsTitleOn=function() {
	var now=Date.now();
	var passed=now-m.previous;
	if (passed>m.wait) {
		m.previous=now;
		m.doFSTitle(m.fsTitle);
	} else {
		$fuzzy_search.off("input.fs keyup.fs cut.fs paste.fs");
		setTimeout(function() {
			$fuzzy_search.on("input.fs keyup.fs cut.fs paste.fs", m.fsTitleOn);
			m.previous=Date.now();
			m.doFSTitle(m.fsTitle);
		}, m.wait*1.1-passed);
	}
};
$fuzzy_search.on("input.fs keyup.fs cut.fs paste.fs", m.fsTitleOn);
$fuzzy_search.trigger("keyup");

////////////////////////////////////////////////////
// Language/언어/語言
////////////////////////////////////////////////////
m.changeLang=function(lang, e, elem) {
	var search=window.location.search;
	var href=m.pathName+(search?search+"&":"?")+"lang="+lang+window.location.hash;
	if (e&&e.which===2) {
		$(elem).attr({"href":href});
		return true;
	} else {
		window.location.href=href;
		return false;
	}
};
var dataLang=m.strToJSON( $data_lang.html().trim() );
var htmlLang='<div>';
for (var i=0;i<dataLang[0].length;i++) {
	htmlLang+='<a href="'+m.pathName+"?lang="+dataLang[0][i]+'" onclick="return m.changeLang(\''+dataLang[0][i]+'\',event,this)">'+dataLang[1][i]+'</a><br>';
}
htmlLang+='</div>';
$data_lang.after(htmlLang);

////////////////////////////////////////////////
// Lang : set cookie, Cat : get ans show recos
////////////////////////////////////////////////
var vars=m.getSearchVars(window.location.search);
if (vars.lang!==undefined) {
	m.docCookies.setItem("lang", vars.lang.val, Infinity, "/");
}
if (vars.cat!==undefined) {
	var cat=vars.cat.val;
	m.currentCat=cat;
	m.getUriListAndShowRecosOnCat(cat);
	window.history.pushState({cat:cat}, null, m.pathOfCat(cat));
}
if (vars.title!==undefined) {
	var title=vars.title.val;
	$input_title[0].value=title;
	// $input_title.trigger("input");
}
if (vars.uri!==undefined) {
	$new_reco.show();
	var uri=vars.uri.val;
	$input_uri[0].value=uri;
	$input_uri.trigger("input.rd");
}
if (window.location.pathname==="/reco") {
	$new_reco.show();
}

////////////////////////////////////////////////////
// SNS Sharing
////////////////////////////////////////////////////
m.shareSNS=function(elem, service) {
	var $reco=$(elem).parent(".reco");
	var uri=encodeURIComponent(m.unescapeHTML($reco.find(".textURI").html()));
	var title=encodeURIComponent( $reco.find(".title").text() );
	// encodeURIComponent(window.location.href);
	var open="";
	switch (service) {
		case 'twitter':
			open="https://twitter.com/intent/tweet"+"?text="+title+"&url="+uri;
			break;
		case 'facebook':
			open="https://www.facebook.com/sharer/sharer.php"+"?u="+uri;
			break;
	}
	window.open(open);
};

////////////////////////////////////////////////////
// ShortKeys
////////////////////////////////////////////////////
m.fdList=$("#sidebar, #head, #contents .reco, #foot"); // Ordered automatically by jQuery.
m.processShortKey=function(e) {
	if (e.altKey||e.ctrlKey||e.metaKey) { return; }
	switch (e.target.nodeName) {
		case "INPUT": case "SELECT": case "TEXTAREA": return;
	}
	switch (e.keyCode) {
		case 71: case 84: // G = 71, T = 84
			e.preventDefault();
			$fuzzy_search_container.show();
			$fuzzy_search.focus();
			break;
		case 78: // N = 78
			e.preventDefault();
			$button_new_reco.trigger("click");
			break;
		case 70: //F = 70
		case 68: //D = 68
			var scrollTop=$window.scrollTop();
			var i, k=m.fdList.length;
			var hI;
			if (e.keyCode===70) {
				scrollTop+=10;
				for (i=0;i<k;i++) {
					hI=m.fdList.eq(i);
					if (hI.is(":visible")&&scrollTop<hI.offset().top) { break; }
				}
				if (i===k) {
					// hI=m.fdList.eq(0);
					// alert("This is the last section.");
					return;
				}
			} else{
				scrollTop-=10;
				for (i=k-1;i>=0;i--) {
					hI=m.fdList.eq(i);
					if (hI.is(":visible")&&scrollTop>hI.offset().top) { break; }
				}
				if (i===-1) {
					// hI=m.fdList.eq(k-1);
					// alert("This is the first section.");
					return;
				}
			}
			$window.scrollTop(hI.offset().top);
			break;
		default:
	}
}
$window.on("keydown", m.processShortKey);
var $shortkeyDesc=$("ul#shortkeys");
if ($shortkeyDesc.exists()) {
	$shortkeyDesc.prepend(
		"<li>G,T: [--Fuzzy Search--] (Go), or Table of Recos</li>"
		+"<li>F: Forward [--Reco--]</li>"
		+"<li>D: Previous [--Reco--]</li>"
		+"<li>N: New [--Reco--]</li>"
	);
}

////////////////////////////////////////////////////
// YouTube API
////////////////////////////////////////////////////
m.fsTitle.Preceding=function() {
	m.fsTitle.playNext(-1);
};
m.fsTitle.Following=function() {
	m.fsTitle.playNext(1);
};
m.fsTitle.shuffle=function() {
	var fs=m.fsTitle;
	var shuffled=fs.shuffled;
	for (var i=0;i<shuffled.length;i++) {
		shuffled[i].randomN=Math.random();
	}
	for (var i=1;i<shuffled.length;i++) {
		var temp=shuffled[i];
		var j=i;
		for (;(j>0)&&(shuffled[j-1].randomN<temp.randomN);j--) {
			shuffled[j]=shuffled[j-1];
		}
		shuffled[j]=temp;
	}
	fs.currentIndex=-1;
	fs.playNext(1,true);
};
m.fsTitle.toggleLoop=function(elem) {
	var $elem=$(elem);
	if ($elem.hasClass("enabled")) {
		$elem.removeClass("enabled");
		m.fsTitle.loop=false;
	} else {
		$elem.addClass("enabled");
		m.fsTitle.loop=true;
	}
};
m.fsTitle.toggleOneLoop=function(elem) {
	var $elem=$(elem);
	if ($elem.hasClass("enabled")) {
		$elem.removeClass("enabled");
		m.fsTitle.oneLoop=false;
	} else {
		$elem.addClass("enabled");
		m.fsTitle.oneLoop=true;
	}
};
m.fsTitle.getAndPlayVideo=function(cue) {
var fs=m.fsTitle;
fs.pauseVideo();
var i=fs.currentIndex;
if (0<=i&&i<fs.shuffled.length) {
	var r=fs.fullList[fs.shuffled[i].i].reco;
	$reco_playing.html(m.recoHTML(r, true));
	var uriRendered=m.uriRendering(r.uri);
	if (uriRendered.from==="youtube") {
		$uri_rendered.html('');
		$video.html('');
		$rC_video_uri_rendered.hide();
		$rC_youtube_uri_rendered.show();
		if (m.YtPlayer) {
			if (cue) {
				m.YtPlayer.cueVideoById(uriRendered.videoId);
			} else {
				m.YtPlayer.loadVideoById(uriRendered.videoId);
			}
		} else if (YT!==undefined&&YT.Player) {
			m.YtPlayer=new YT.Player('youtube', {videoId:uriRendered.videoId
				, events:{
					'onError':function(e) {
						m.playListSetTimeout=setTimeout(function() {
							fs.playNext(1);
						}, 2500);
					}, 'onStateChange':function(e) {
						if (e.data===YT.PlayerState.ENDED) {
							if (fs.oneLoop) {
								m.YtPlayer.seekTo(0,true);
							} else {
								fs.playNext(1);
							}
						}
					}
				}}
			);
		}
	} else if (uriRendered.from==="video") {
		$uri_rendered.html('');
		$rC_youtube_uri_rendered.hide();
		$rC_video_uri_rendered.show();
		
		$video.replaceWith($('<video id="video" controls '+(fs.oneLoop?'loop ':'')+'preload="auto" src="'+uriRendered.src+'"></video>'));
		$video=$("#video");
		$video.on("ended", function() {
			if (fs.oneLoop) {
				$video[0].play();
			} else {
				fs.playNext(1);
			}
		});
		if (!cue) {
			$video[0].play();
		}
	} else {
		$uri_rendered.html(uriRendered.html);
		$video.html('');
		$rC_video_uri_rendered.hide();
		$rC_youtube_uri_rendered.hide();
		if (!cue) {
			m.playListSetTimeout=setTimeout(function() {
				fs.playNext(1);
			}, 2500);
		}
	}
} else {
	$reco_playing.html('');
	$uri_rendered.html('');
	$video.html('');
	$rC_video_uri_rendered.hide();
	$rC_youtube_uri_rendered.hide();
}
	m.delayedElems=m.delayedElems.add( $headPlay.find("[delayed-src], [delayed-bgimage], .to-be-executed") );
	$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
	$window.trigger("scroll.delayedLoad");
};
m.fsTitle.pauseVideo=function() {
	if ($video&&$video[0]&&$video[0].tagName=="VIDEO") {
		$video[0].pause();
	}
	if (m.YtPlayer) {
		m.YtPlayer.pauseVideo();
	}
};
m.fsTitle.playNext=function(increment, cue, first) {
	clearTimeout(m.playListSetTimeout);
	var fs=m.fsTitle;
	if (increment===undefined||increment===null||increment.constructor!==Number) { increment=1; }
	if (first) { fs.currentIndex=-1; }
	var l=fs.shuffled.length;
	if (l===0) {
		if (first) { fs.getAndPlayVideo(cue); }
	} else {
		var count=first?0:1;
		var i=fs.currentIndex+increment;
		if (fs.loop) { i=(i+l)%l; }
		var done=false;
		while (0<=i&&i<l&&count<l) {
			if (fs.fullList[fs.shuffled[i].i].inRange) {
				fs.currentIndex=i;
				fs.getAndPlayVideo(cue);
				done=true;
				break;
			} else {
				count++;
				i+=increment; // i=fs.currentIndex+increment*(count+1);
				if (fs.loop) { i=(i+l)%l; }
			}
		}
		if (!done) {
			if (first) {
				fs.currentIndex=-1;
				fs.getAndPlayVideo(cue);
			}
			if (!cue) {
				m.fsTitle.pauseVideo();
			}
		}
	}
};
m.fsTitle.prepareRecoListPlay=function() {
	var fs=m.fsTitle;
	var YtAPINeeded=false;
	if (!m.YtAPILoaded) {
		for (var i=0;i<fs.fullList.length;i++) {
			var r=fs.fullList[i].reco;
			var uriRendered=m.uriRendering(r.uri);
			if (uriRendered.from==="youtube") {
				YtAPINeeded=true;
				break;
			}
		}
		if (YtAPINeeded) {
			var ytAPI=document.createElement('script');
			ytAPI.src="http://www.youtube.com/player_api";
			$scripts.append(ytAPI);
			m.YtAPILoaded=true;
		}
	}
	if (!YtAPINeeded||(YT!==undefined&&YT.Player)) {
		fs.shuffled=[];
		for (var i=0;i<fs.fullList.length;i++) {
			fs.shuffled[i]={"i":fs.fullList.length-1-i};
		}
		fs.currentIndex=-1;
		fs.playNext(1,true,true);
	} else {
		setTimeout(function() {
			fs.prepareRecoListPlay();
		}, 1000);
	}
};
m.fsTitle.toggleRecoListPlay=function() {
	var fs=m.fsTitle;
	if ($playlist_container.is(":visible")) {
		fs.pauseVideo();
		$playlist_container.hide();
	} else {
		$playlist_container.show();
	}
};
})(window.m, jQuery);
</script>
</html>