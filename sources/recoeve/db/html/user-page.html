<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=3, user-scalable=yes"/>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<title>Recoeve.net</title>
<script>
window.m={};
(function (m, undefined) {
m.myIndex="{--myIndex--}";
m.myId="{--myId--}";
m.pathName=window.location.pathname;
if (m.pathName.substring(0,6)!=="/user/") {
	m.pathName="/user/"+m.myId;
	if (window.location.pathname!=="/reco") {
		window.history.replaceState(null, null, m.pathName+window.location.search+window.location.hash);
	}
}
m.userId=decodeURIComponent(m.pathName.substring(6));
let k=m.userId.indexOf("/");
if (k!==-1) {
	m.userId=m.userId.substring(0,k);
	// m.pathName="/user/"+m.userId;
}
m.myPage=(m.myId===m.userId);

/////////////////////////////
// cookies.js
/////////////////////////////
m.docCookies={
	hasItem:function (sKey) {
		return (new RegExp("(?:^|;\\s*)"+encodeURIComponent(sKey).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=")).test(document.cookie);
	}
	, getItem:function (sKey) {
		return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(sKey).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;
	}
	, removeItem:function (sKey, sPath, sDomain, bSecure) {
		if (!sKey||/^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
		document.cookie=encodeURIComponent(sKey)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(sDomain?"; domain="+sDomain:"")+(sPath?"; path="+sPath:"")+(bSecure?"; secure":"");
		return true;
	}
	, setItem:function (sKey, sValue, vEnd, sPath, sDomain, bSecure) {
		if (!sKey||/^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
		let sExpires="";
		if (vEnd) { switch (vEnd.constructor) {
			case Number:
				sExpires=vEnd===Infinity?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+vEnd;
				break;
			case String:
				sExpires="; expires="+vEnd;
				break;
			case Date:
				sExpires="; expires="+vEnd.toUTCString();
				break;
		}}
		document.cookie=encodeURIComponent(sKey)+"="+encodeURIComponent(sValue)+sExpires+(sDomain?"; domain="+sDomain:"")+(sPath?"; path="+sPath:"")+(bSecure?"; secure":"");
		return true;
	}
	, keys:function () {
		let aKeys=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/);
		for (let nIdx=0;nIdx<aKeys.length;nIdx++) { aKeys[nIdx]=decodeURIComponent(aKeys[nIdx]); }
		return aKeys;
	}
};

m.saveSSN=function () {
	if (m.docCookies.hasItem("salt")) {
		m.saltSSN=m.docCookies.getItem("salt");
		m.docCookies.removeItem("salt", "/");
	}
	if (m.docCookies.hasItem("session")) {
		m.session=m.docCookies.getItem("session");
		m.docCookies.removeItem("session", "/");
	}
};
m.saveSSN();
})(window.m);
</script>
<style>
body {margin:0; padding:0; overflow-wrap:break-word; word-wrap:break-word; word-break:break-word; background:rgb(150,150,150)}

div, form, input, textarea {-webkit-box-sizing:border-box; -moz-box-sizing:border-box; box-sizing:border-box; max-width:100%}
data {display:none}
.none {display:none}
.center {text-align:center}
.right {text-align:right}
.fLeft {float:left}
.fRight {float:right}
.cBoth {clear:both}
img {min-width:1em; min-height:1em; max-width:100%}

.button {display:inline-block; cursor:pointer; padding:.2em .5em; border:.15em solid rgb(50,50,50); background:rgb(110,110,110);}
.button.to-be-executed {display:block; width:100%; text-align:center; margin:20em auto 50em}
.button.disabled {pointer-events:none; background:rgb(25,25,25); color:rgb(120,120,120)}
.button.left {float:left; margin-right:.5em}
.button:active {background:rgb(0,80,80)}
.button.enabled {background:rgb(50,130,50)}
.button.enabled:active {background:rgb(70,70,70)}

a {text-decoration:none}
a:link {color:rgb(60,60,160)} .dark a:link {color:rgb(190,190,235)}
a:visited {color:rgb(40,40,140)} .dark a:visited {color:rgb(170,170,215)}
a:active {color:rgb(0,100,100)} .dark a:active {color:rgb(100,215,215)}
a:hover {color:rgb(40,140,40)} .dark a:hover {color:rgb(170,215,170); text-decoration:underline}

::-webkit-scrollbar {width:7px; height:7px}
::-webkit-scrollbar-track {-webkit-border-radius:5px; border-radius:5px}
::-webkit-scrollbar-thumb {-webkit-border-radius:5px; border-radius:5px; background:rgb(0,120,120); -webkit-box-shadow:inset 0 0 3px rgb(0,0,0)}
::-webkit-scrollbar-corner {background:transparent}

#container {max-width:1000px; line-height:1.6; font-family:'Malgun Gothic', '맑은 고딕', 나눔고딕, NanumGothic, 'MS Mincho', Tahoma, Sans-serif; background:rgb(250,250,250); color:black; font-size:15px}
	#container.dark {background:rgb(75,75,75); color:white}
#sidebar-dragger {position:fixed; z-index:10; top:0; bottom:0; left:0; width:1.5em; background:transparent}
#sidebar-dragger-in {position:absolute; top:2em; left:0; right:0; bottom:0;}
#sidebar {position:fixed; z-index:10; max-width:70%; width:15em; max-height:100%; margin:0; padding:.5em; background:rgb(230,230,230); color:black; border-right:1px solid white; border-bottom:1px solid white; overflow:auto}
	.dark #sidebar {background:rgb(35,35,35); color:white}
.side2 {padding:0}
#sidebar-toggle {width:2em; height:2em; background: black; border:white 2px solid;}

#user-noti {padding:.3em .2em; font-size:1.1em; color:rgb(150,150,240)}

#catList {margin-bottom:1em}
#catList .cat {border:1px solid transparent; margin-bottom:.15em}
#cat-to-here {border:1px solid rgb(130,130,130); margin:.5em}
#catList .cat.edit {position:relative; border:1px solid rgb(150,150,225); padding:0 1.3em}
#catList .cat.edit.move {position:fixed; z-index:101}
#catList .cat.edit>.edit-bar {position:absolute; width:1.3em; top:0; bottom:0; background:rgb(150,150,225)}
#catList .cat.edit>.edit-bar:first-child {left:0}
#catList .cat.edit>.edit-bar:last-child {right:0}
#catList .cat.selected {border:1px solid black}
	.dark #catList .cat.selected {border-color:white}
#catList .cat>.baseCat, #catList .cat>.EC {cursor:pointer}
#catList .cat>.baseCat {color:white}
#catList .cat.selected>.baseCat {pointer-events:none; color:rgb(255,210,210)}
#catList .cat>.noEC, #catList .cat>.EC {display:inline-block; font-size:.5em; margin-top:-.5em; width:2em; text-align:center; vertical-align:middle}

#cat-fs-container {
	position:relative;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#cat-fs-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#cat-fs-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#cat-fs-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#cat-fs-list .list-item .list-index {display:none}
#cat-fs-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#cat-fs-list .list-item .cat {font-size:.9em;}
#cat-fs-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#cat-fs-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}

#multireco-cats-container {
	position:fixed;
	left:0; top:0;
	z-index:10000;
	background:black;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#multireco-cats-container .def-cat {
	display: inline-block;
	margin: 0.2em 0;
	border: 1px solid rgb(130,130,130);
	padding: 1px 0.5em;
	font-size: .9em;
}
#multireco-cats-container textarea {
	display: block;
	max-width: 100%;
	width: 100%;
	resize: vertical;
	font: inherit;
	font-weight: bold;
	overflow-x: hidden;
	overflow-y: auto;
	padding: 0.2em 0.3em;
	background: white;
	color: rgb(50,50,50);
}
#multireco-cat-fs-container {
	position:relative;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#multireco-cat-fs-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#multireco-cat-fs-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#multireco-cat-fs-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#multireco-cat-fs-list .list-item .list-index {display:none}
#multireco-cat-fs-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#multireco-cat-fs-list .list-item .cat {font-size:.9em;}
#multireco-cat-fs-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#multireco-cat-fs-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}

#fuzzy-search-container, #table-of-recos-container {
	position:fixed; left:0; top:0;
	z-index:10010;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#fuzzy-search, #table-of-recos {
	height:2em; max-height:5em; overflow-y:auto;
	font:inherit; font-size:1.3em; color:black;
	width:100%;
	padding:.1em 2em 0 .2em;
	border:.15em gray solid;
	background:white;
}
#fuzzy-search-list, #table-of-recos-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#fuzzy-search-list .list-item, #table-of-recos-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#fuzzy-search-list .list-item.selected, #table-of-recos-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#fuzzy-search-list .list-item .list-index, #table-of-recos-list .list-item .list-index {display:none}
#fuzzy-search-list .list-item:nth-child(2n), #table-of-recos-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#fuzzy-search-list .list-item .cat, #table-of-recos-list .list-item .cat {font-size:.9em;}
#fuzzy-search-list .list-item .highlighted, #table-of-recos-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#fuzzy-search-list .list-item .highlighted .bold, #table-of-recos-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}
.exit {
	z-index:10010;
	position:absolute; display:inline-block;
	right:0; top:0;
	margin:0;
	width:1.8em; height:1.8em; line-height:1.0;
	text-align:center;
	/*border-radius:.4em;*/
	cursor:pointer;
	border:.15em rgb(80, 80, 80) solid;
	background-color:rgb(30,30,30); color:white;
}
.exit>svg {
	width:100%; height:100%;
	font-size:1.8em; line-height:1.0;
}

#new-reco {z-index:10010; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.8); overflow:auto; color:white} .dark #new-reco {color:white}
#new-reco form {position:relative; width:40em; max-width:100%; margin:1em auto; padding:1em; background:black; border:.2em solid rgb(120,120,130); text-align:left}
#new-reco label {display:inline-block; font-weight:bold; margin:.9em 0 .4em}
#new-reco label:first-child {margin-top:0}
#new-reco label>.desc {font-size:.8em}
#new-reco input, #new-reco textarea {display:block; max-width:100%; width:100%; resize:vertical; font:inherit; font-weight:bold; overflow-x:hidden; overflow-y:auto; padding:.2em .3em; background:white; color:rgb(50,50,50)}
textarea.single-line {min-height:2.2em; height:2.2em}
textarea.multi-line {font-size:.9em; min-height:10em}
#new-reco input#input-val {display:inline-block; width:8.5em}
#new-reco .def-title {margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-title.selected {border-color:rgb(255,180,180)}
#new-reco .def-cat {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-cat.selected {border-color:rgb(255,180,180)}
#input-val-stars {margin:0 .5em -.4em 0}
#new-reco .buttons {margin-top:1em; text-align:right}
#new-reco #error-msg {margin:0}

#point-range {margin:1em 0; position:relative; display:inline-block; float:right; width:300px; height:30px; background:rgb(200,100,100)}
#point-range-bar {position:absolute; left:15px; right:15px; height:100%; background:rgb(100,200,100)}
#point-range-left, #point-range-right {position:absolute; width:20px; top:0; bottom:10px; background:rgba(150,150,150,0.9); border:.15em solid rgb(50,50,50)}
#point-range-left {left:0}
#point-range-right {right:0}
#point-range-result {margin:1em; float:right; border:.15em solid black; padding:.1em .5em; vertical-align:top}
	.dark #point-range-result {border-color:white}

#numbers-of-recos {margin:1em 0; padding:.5em; width:100%}
.numbers-of-recos {margin:1em 0; padding:.5em; width:100%}

#my-id {margin-left:2.5em;}

.multireco {display:flex; justify-content:space-evenly; flex-wrap:wrap}
.reco {margin:0 0 1em; border-bottom:.15em solid black; background:rgb(230,230,230)}
	.dark .reco {border-color:rgb(100,100,100); background:black}
.multireco .reco {width:100%}
.reco .SNS-img {display:inline-block; margin:0; float:left; width:2em; height:2em; border:.15em gray solid; border-left:0; cursor:pointer; background-size:100% 100%}
.reco .SNS-img:first-child {border-left:.15em gray solid}
.reco>.textURI, .reco>.YTVideoId {display:none}
.reco>.uri {font-size:.5em; border:2px solid rgb(100,100,150); border-bottom:0; padding:.2em .5em}
.multireco .reco>.uri {font-size:.3em}
.reco>.title {font-size:1.1em; border:2px solid rgb(150,100,100); padding:.2em .5em}
.multireco .reco>.title {clear:both; font-size:0.9em}
.reco>.cats {font-size:.8em; border:2px solid rgb(100,150,100); border-top:0; padding:.2em .5em}
.multireco .reco>.cats {display:none}
.reco>.cats>a {color:rgb(130,170,130)}
.reco>.cats>a.currentCat {color:rgb(140,180,140); font-weight:bold; text-decoration:none}
.reco>.desc {margin:.5em 0; padding:.5em}
.multireco .reco>.desc {display:none}
.reco>.cmt {margin:.5em 0; padding:.5em; background:rgb(200,200,200); border-left:.3em solid rgb(10,80,80)} .dark .reco>.cmt {background:rgb(30,30,30)}
.multireco .reco>.cmt {display:none}
.stars-container {position:relative; display:inline-block; cursor:text}
.val {display:block}
.multireco .val {display:none}
.my-point {display:none}
.multireco .my-point {display:block}
.stars-container>div.bar {position:absolute; top:1px; bottom:1px; background:rgb(232,242,80)}
.stars-container>svg.out-stars {position:absolute; left:0; top:0; width:100%; height:100%}
.stars-container>svg.out-stars>polygon {fill:rgb(50,50,50);stroke-width:0;fill-rule:evenodd}
.reco>.val {margin:.5em 0 .3em}
.multireco .reco>.val {display:none}
.reco>.val>.str, .reco>.my-point>.str {border:.15em solid black; padding:.1em .5em; vertical-align:top}
	.dark .reco>.val>.str, .dark .reco>.my-point>.str {border-color:white}
.reco .tFirst, .reco .tLast {display:inline-block; float:right; margin:.2em 1em; font-size:.8em}
.multireco .reco .tFirst, .multireco .reco .tLast {display:none}
.reco .my-point {display:none}
.multireco .reco .my-point {display:block}

.lyricsC {}
.lyricsArrow {width:0; height:0; padding:0; margin:0 auto; border-color:transparent transparent rgb(0,30,0); border-style:solid; border-width:0.5em}
.lyrics {border:0.3em solid rgb(0,30,0); padding:1em .5em; margin-top:-1px}

.rC, img {margin:.5em 0}
.rC.fixed {position:fixed; top:0; left:0; width:100%; max-width:100%; margin:0; padding:1px; background:white; border-bottom:.15em solid black}
	.dark .rC.fixed {background:black; border-color:white}
.rC>.rSC {box-sizing:content-box; -moz-box-sizing:content-box; position:relative; height:3em; padding-bottom:63%}
.rC>.rSC>* {position:absolute; width:100%; height:100%; left:0; top:0}
.pc {text-align:center; font-size:.5em} /* position change */

#foot {clear:both; border-top:.15em solid white; padding:1em .5em}

#floating-key {position:fixed; right:.5em; bottom:2.7em; width:6em; height:auto}
#floating-key div {}
#toggle-floating-key {position:fixed; right:.5em; bottom:.5em; width:auto; height:2.2em}

@media all and (min-width:400px) {
	.multireco .reco {width:49%}
}
@media all and (min-width:600px) {
	.multireco .reco {width:33%}
}
@media all and (min-width:701px) {
	.multireco .reco {width:49%}
	#container {margin-left:14.9em}
	#sidebar {margin:0; position:fixed; left:0; top:0; bottom:0; width:15em}
	#sidebar-dragger {display:none}
	#my-id {margin-left:0;}
	.side2 {padding:.5em}
	.rC.fixed {width:646px; border-right:.15em solid black}
	.lyrics {text-align:right}
	::-webkit-scrollbar {width:11px; height:11px}
}
@media all and (min-width:901px) {
	.multireco .reco {width:33%}
	#container {margin-left:19.9em}
	#sidebar {width:20em}
}
@media all and (min-width:1210px) {
	.multireco .reco {width:24%}
}

@media all and (min-height:500px) {
	#fuzzy-search-list, #table-of-recos-list {max-height:430px}
}
</style>
</head>
<body>
<data id="data-myCatList">{--myCatList--}</data>
<data id="data-CatList">{--CatList--}</data>
<div id="container" class="dark">
<div id="sidebar-dragger">
	<svg id="sidebar-toggle"><g style="stroke:white;stroke-width:20%; stroke-linecap:round;"><line x1="20%" y1="50%" x2="80%" y2="50%"></line><line x1="80%" y1="50%" x2="50%" y2="20%"></line><line x1="80%" y1="50%" x2="50%" y2="80%"></line></g></svg>
	<div id="sidebar-dragger-in"></div>
</div>
<div id="sidebar">
	<div id="user-noti"></div>
	<div id="catList"></div>
	<div class="right">
		<div class="button" id="change-catList-order">[--Change orders--]</div>
		<div class="button" id="change-catList-order-ok">[--OK--]</div>
		<div class="button" id="change-catList-order-cancel">[--Cancel--]</div>
	</div>
</div><!-- div#sidebar -->
<div id="fuzzy-search-container" style="display:none">
	<div id="fuzzy-search" contenteditable="true"></div>
	<div id="fuzzy-search-list"></div>
	<div class="exit" onclick="$window.trigger({type:'keydown', keyCode:71})"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
</div><!-- div#fuzzy-search-container -->
<div id="table-of-recos-container" style="display:none">
	<div id="table-of-recos" contenteditable="true"></div>
	<div id="table-of-recos-list"></div>
	<div class="exit" onclick="$window.trigger({type:'keydown', keyCode:84})"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
</div><!-- div#table-of-recos-container -->
<div id="new-reco" style="display:none">
	<form>
	<label for="uri">URI <span class="desc">(required)</span></label>
		<textarea id="input-uri" class="single-line" name="uri" placeholder="Unique Resource Indentifier: like http-URL" type="text" tabindex="1"></textarea>
		<div id="show-URI"></div>
	<label for="title">[--Title--]</label>
		<div id="def-titles"></div>
		<textarea id="input-title" class="single-line" name="title" placeholder="Title" type="text" tabindex="2"></textarea>
	<label for="cats">[--Categories--]</label>
		<div id="def-cats"><div class="def-cat">[--Indifferent--]</div> <div class="def-cat">[--Later--]</div> <div id="add-cat" class="def-cat">;</div> <div id="sub-cat" class="def-cat">--</div></div>
		<textarea id="input-cats" class="single-line" name="cats" placeholder="Category--Sub category--Subsub category ; Another category ; ..." type="text" tabindex="3"></textarea>
		<div id="cat-fs-container" class="fs-container" style="display:none">
			<div id="cat-fs-list"></div>
			<div class="exit" onclick="$(this).parent().hide()"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
		</div>
	<label for="desc">[--Description--]</label>
		<textarea id="input-desc" class="multi-line" name="desc" placeholder="Objective Description: you can refer a good description of others. In other words, you can provide a good description to the others." tabindex="4"></textarea>
	<label for="cmt">[--Comment--]</label>
		<textarea id="input-cmt" class="multi-line" name="cmt" placeholder="Comment: your personal description or opinion on this URI." tabindex="5"></textarea>
	<label for="val">[--Points--]</label>
		<input id="input-val" name="val" placeholder="(ex: 7.5/10)" type="text" tabindex="6"/>
	<div id="error-msg"></div>
	<div class="buttons">
		<div class="button" id="button-reco" tabindex="7">[--Reco--]</div>
		<div class="button" id="button-edit" tabindex="8">[--Edit--]</div>
		<div class="button" id="button-del" tabindex="11">[--Del--]</div>
		<div class="button left" id="button-close" tabindex="9">[--Close--]</div>
		<div class="button left" id="button-back" tabindex="10">[--Back--]</div>
		<div class="cBoth"></div>
	</div>
	<div id="my-reco"></div>
	<div class="exit" style="margin:-1em -.2em 0 0" onclick='$button_close.trigger("click")'><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
	</form>
</div><!-- div#new-reco -->
<div id="multireco-cats-container" style="display:none">
	<label for="multireco-cats">[--Multireco Categories--]</label>
		<div id="multireco-def-cats"><div class="def-cat">[--Indifferent--]</div> <div class="def-cat">[--Later--]</div> <div id="multireco-add-cat" class="def-cat">;</div> <div id="multireco-sub-cat" class="def-cat">--</div></div>
		<textarea id="multireco-input-cats" class="single-line" name="multireco-cats" placeholder="Category--Sub category--Subsub category ; Another category ; ..." type="text"></textarea>
		<div id="multireco-cat-fs-container" class="fs-container" style="display:none">
			<div id="multireco-cat-fs-list"></div>
			<div class="exit" onclick="$(this).parent().hide()"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
		</div>
</div><!-- div#multireco-cats-container -->
<div class="side2" id="foot">&nbsp; &nbsp; [--version--] [--foot--]<br><a href="http://kipid.tistory.com/entry/Introducing-what-we-are-making-Recoevenet">Introducing what we are making : Recoeve.net</a><br><br>
	<div>Language/언어/語言
		<data id="data-lang">en	ko	ja	zh
English/영어/en	Korean/한국어/ko	Japanese/일본어/ja	Chinese/중국어(번체)/zh</data></div>
</div><!-- div#foot -->
<div class="side2">
	[--Short Keys--]
	<ul id="shortkeys"></ul>
</div>
<div class="side2" id="head">
	<div class="button" id="my-id"></div>
	head : <a href="/account/log-out">[--Log out--]</a> / <a id="a-log-in" href="/account/log-in">[--Log in--]</a>
	<!-- <div class="button" onclick="$('#container').toggleClass('dark')">[--Toggle style--]</div> -->
	<div class="button button-Go" id="out-focus" onclick='$window.trigger({type:"keydown", keyCode:71});'>[--Fuzzy Search--]</div>
	<div class="button" id="button-neighbors-page" onclick="m.see_Neighbors()">[--See neighbors--]</div>
	<div class="button" id="button-multireco-mode" onclick="m.show_Multireco_Mode(event)">[--Multireco mode--]</div>
	<div class="button" id="button-new-reco">[--New Reco--]</div>
</div><!-- div#head -->
<div class="side2" id="subCats">
	<span id="point-range-result">0~10/10</span>
	<div id="point-range">
		<div id="point-range-bar"></div><div id="point-range-right"></div><div id="point-range-left"></div>
	</div>
	<div class="button enabled" id="show-recos-without-points">[--Show recos without points--]</div>
	<div class="button" id="hide-recoed-ones">[--Hide recoed ones--]</div>
	<div class="cBoth"></div>
</div>
<div class="side2" id="numbers-of-recos"></div>
<div class="side2" id="headPlay">
	<div class="button enabled" id="toggle-reco-list-play" onclick="m.fsToRs.toggleRecoListPlay()">Toggle reco list play</div>
	<div id="playlist-container">
		<div id="uri-rendered"></div>
		<div class="rC" id="rC-video-uri-rendered" style="display:none">
			<div class="rSC"><div id="video"></div></div>
			<div class="pc"><span onclick="m.togglePosition(this)">▲ [--stick to the left top--]</span></div>
		</div>
		<div class="rC" id="rC-youtube-uri-rendered" style="display:none">
			<div class="rSC"><div id="youtube"></div></div>
			<div class="pc"><span onclick="m.togglePosition(this)">▲ [--stick to the left top--]</span></div>
		</div>
		<div class="button" onclick="m.fsToRs.Preceding()">[--Preceding--]</div>
		<div class="button" onclick="m.fsToRs.Following()">[--Following--]</div>
		<div class="button" onclick="m.fsToRs.shuffle()">[--Shuffle--]</div>
		<div class="button" onclick="m.fsToRs.toggleLoop(this)">[--Loop--]</div>
		<div class="button" onclick="m.fsToRs.toggleOneLoop(this)">[--One-loop--]</div>
		<div class="button button-ToR" onclick="$window.trigger({type:'keydown', keyCode:84});">[--ToR--]</div>
		<div id="reco-playing"></div>
	</div>
</div><!-- div#headPlay -->
<div class="side2" id="contents"></div><!-- div#contents -->
<div id="floating-key">
	<div id="button-hideFK" class="button" onclick="m.hideFK()">▼ Hide</div>
	<div class="button button-Go" onclick="$window.trigger({type:'keydown', keyCode:71});">Go</div>
	<div class="button button-ToR" onclick="$window.trigger({type:'keydown', keyCode:84});">[--ToR--]</div>
	<div class="button" onclick="$window.trigger({type:'keydown', keyCode:68})">[--Backward--]</div>
	<div class="button" onclick="$window.trigger({type:'keydown', keyCode:70})">[--Forward--]</div>
	<div class="button" onclick="$window.trigger({type:'keydown', keyCode:78});">[--New Reco--]</div>
</div>
<div class="button" id="toggle-floating-key" onclick="m.toggleFK()">▲</div>
</div><!-- div#container -->
</body>
<div id="scripts"></div>
<script src="/jquery.min.js"></script>
<script>
(function (m, $, undefined) {
/* Prerequisite */
//////////////////
// Variables
//////////////////
$data_myCatList=$("#data-myCatList");
$data_CatList=m.myPage?$data_myCatList:$("#data-CatList");
$data_lang=$("#data-lang");

$user_noti=$("#user-noti");
$my_id=$("#my-id");
$button_neighbors_page=$("#button-neighbors-page");
$button_multireco_mode=$("#button-multireco-mode");
$button_new_reco=$("#button-new-reco");

$sidebar_dragger=$("#sidebar-dragger");
$sidebar_toggle=$("#sidebar-toggle");
$sidebar_dragger_in=$("#sidebar-dragger-in");
$sidebar=$("#sidebar");
$sidebar_exit=$("#sidebar-exit");
$catList=$("#catList");
$change_catList_order=$("#change-catList-order");
$change_catList_order_ok=$("#change-catList-order-ok");
$change_catList_order_cancel=$("#change-catList-order-cancel");

$new_reco=$("#new-reco");

$headPlay=$("#headPlay");
$toggle_reco_list_play=$("#toggle-reco-list-play");
$playlist_container=$("#playlist-container");
$uri_rendered=$("#uri-rendered");
$rC_video_uri_rendered=$("#rC-video-uri-rendered");
$video=$("#video");
$rC_youtube_uri_rendered=$("#rC-youtube-uri-rendered");
$youtube=$("#youtube");
$reco_playing=$("#reco-playing");

$input_uri=$("#input-uri");
$def_titles=$("#def-titles");
$input_title=$("#input-title");
$def_cats=$("#def-cats");
$input_cats=$("#input-cats");
$input_desc=$("#input-desc");
$input_cmt=$("#input-cmt");
$input_val=$("#input-val");

$error=$("#error-msg");

$button_reco=$("#button-reco");
$button_edit=$("#button-edit");
$button_del=$("#button-del");
$button_back=$("#button-back");
$button_close=$("#button-close");

$a_log_in=$("#a-log-in");

$out_focus=$("#out-focus");
$fuzzy_search_container=$("#fuzzy-search-container");
$fuzzy_search=$("#fuzzy-search");
$fuzzy_search_list=$("#fuzzy-search-list");

$table_of_recos_container=$("#table-of-recos-container");
$table_of_recos=$("#table-of-recos");
$table_of_recos_list=$("#table-of-recos-list");
$button_Go=$(".button-Go");
$button_ToR=$(".button-ToR");

$cat_fs_container=$("#cat-fs-container");
$cat_fs_list=$("#cat-fs-list");

$multireco_cats_container=$("#multireco-cats-container");
$multireco_def_cats=$("#multireco-def-cats");
$multireco_input_cats=$("#multireco-input-cats");
$multireco_cat_fs_container=$("#multireco-cat-fs-container");
$multireco_cat_fs_list=$("#multireco-cat-fs-list");

$point_range=$("#point-range");
$point_range_bar=$("#point-range-bar");
$point_range_left=$("#point-range-left");
$point_range_right=$("#point-range-right");
$point_range_result=$("#point-range-result");
$show_recos_without_points=$("#show-recos-without-points");
m.showRWOP=true; // RWOP : Reco WithOut Point
$hide_recoed_ones=$("#hide-recoed-ones");

$numbers_of_recos=$("#numbers-of-recos");

$subCats=$("#subCats");
$contents=$("#contents");
$scripts=$("#scripts");

$window=$(window);
$html=$("html");
$body=$("body");
$.fn.exists=function () { return this.length!==0; };

$("title").html(m.userId+" on Recoeve.net");
$user_noti.html(m.userId+"'s recos");
if (m.myIndex) {
	$my_id.html(m.myId+" ▾");
} else {
	$my_id.hide();
	$button_new_reco.remove();
}

m.see_Neighbors=function () {
	if ($button_neighbors_page.hasClass("enabled")) {
		$button_neighbors_page.removeClass("enabled");
	} else {
		$button_neighbors_page.addClass("enabled");
	}
}

m.show_Multireco_Mode=function (e) {
	if ($contents.hasClass("multireco")) {
		$button_multireco_mode.removeClass("enabled");
		$contents.removeClass("multireco");
		if (!m.myPage) {
			$multireco_cats_container.hide();
		}
		window.history.pushState({cat:m.currentCat}, null, m.pathOfCat(m.currentCat));
	} else {
		$button_multireco_mode.addClass("enabled");
		$contents.addClass("multireco");
		if (!m.myPage) {
			$multireco_cats_container.show();
			$multireco_input_cats[0].value=m.currentCat;
		}
		window.history.pushState({cat:m.currentCat, mode:"multireco"}, null, m.pathOfCat(m.currentCat, "multireco"));
		$a_log_in.attr("href", "/account/log-in?goto="+escape(m.pathOfCat(m.currentCat, "multireco")));
		if (m.myPage) {
			m.showRecosOnCat();
		} else {
			let cat=m.currentCat;
			let uriList="";
			if (m.catUriList[cat]&&m.catUriList[cat].has) {
				uriList=m.catUriList[cat].UriList.trim();
			} else {
				$contents.removeClass("multireco");
				setTimeout(function () {
					m.show_Multireco_Mode(e);
				}, 1000);
				return;
			}
			let uris=[];
			if (uriList.length!==0) { uris=uriList.split("\n"); }
			let getRecosStr="uri";
			let getRecosN=0;
			for (let i=0;i<uris.length;i++) {
				let uri=uris[i];
				let r=m.myRecos[uri];
				if (!r) { r=m.myRecos[uri]={}; }
				if (!r.down) {
					getRecosStr+="\n"+uri;
					getRecosN++;
				}
			}
			if (getRecosN>0) {
				$.ajax({
					type:"POST", url:`/user/${m.myId}/get-Recos`, data:getRecosStr
					, dataType:"text"
				}).done(function (resp) {
					m.recoDowned(getRecosStr.substring(4), m.myRecos);
					m.recoToEve(resp, m.myRecos);
					m.showRecosOnCat();
				});
			} else {
				m.showRecosOnCat();
			}
		}
	}
};

if (m.myPage) {
	$hide_recoed_ones.hide();
} else {
	$hide_recoed_ones.on("click", function () {
		if ($hide_recoed_ones.hasClass("enabled")) {
			$hide_recoed_ones.removeClass("enabled");
		} else {
			$hide_recoed_ones.addClass("enabled");
		}
	});
}

m.delayPad=m.delayPad||256;
m.wait=m.wait||2048;
m.delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
m.previous=Date.now();

m.catList=[];
m.myCatList=m.myPage?m.catList:[];
m.currentCat=null;
m.catUriList=[];
m.userRecos={};
m.myRecos=m.myPage?m.userRecos:{};
m.timeout={};
m.maxShowReco=20;

m.fsCat=[];
m.fsCat[0]=m.fsCat[1]=[];
m.fsCat[0].k=m.fsCat[1].k=-1;
m.fsCat.fullList=[];
m.fsCat.desc=false;
m.fsCat.$fs=$input_cats;
m.fsCat.$fsl=$cat_fs_list;

m.fsTitle=[];
m.fsTitle[0]=m.fsTitle[1]=[];
m.fsTitle.fullList=[];
m.fsTitle.desc=true;
m.fsTitle.$fs=$fuzzy_search;
m.fsTitle.$fsl=$fuzzy_search_list;

m.fsToRs=[];
m.fsToRs[0]=m.fsToRs[1]=[];
m.fsToRs.fullList=[];
m.fsToRs.desc=true;
m.fsToRs.$fs=$table_of_recos;
m.fsToRs.$fsl=$table_of_recos_list;
m.fsToRs.$fsl.viewAndScroll=function ($next) {
	let $fsl=m.fsToRs.$fsl;
	if ($table_of_recos_container.is(":visible")) {
		$fsl.scrollTop($fsl.scrollTop()+$next.offset().top-$fsl.offset().top-100);
	} else {
		$table_of_recos_container.show();
		$fsl.scrollTop($fsl.scrollTop()+$next.offset().top-$fsl.offset().top-100);
		$table_of_recos_container.hide();
	}
};
m.fsToRs.oneLoop=false;
m.fsToRs.loop=false;

m.fsGo=[];
m.fsGo[0]=m.fsGo[1]=[];
m.fsGo.fullList=[];
m.fsGo.desc=true;
m.fsGo.$fs=$fuzzy_search;
m.fsGo.$fsl=$fuzzy_search_list;

YT=undefined;
m.YtPlayer=null;
m.YtAPILoaded=false;

m.ptnURI=[];
m.ptnURL=/^https?:\/\/\S+/i;
m.ptnTag=/^<\w+[\s\S]+>$/i;
m.ptnVal=/^([0-9]+(?:\.[0-9]+)?)\/([0-9]+(?:\.[0-9]+)?)$/;
m.ptnDescCmt=/^#(\S+)/mg; // \w=[A-Za-z0-9_]

m.mdInPRL=false; // mouse down in Point Range Left
m.mdInPRR=false; // mouse down in Point Range Right
m.PRmax=10;
m.PRw=$point_range.width();
m.fullPts=10;
// from <= pts <= to
if (m.docCookies.hasItem("PRL")&&m.docCookies.hasItem("PRR")) {
	m.ptsRangeFrom=Number(m.docCookies.getItem("PRL"));
	m.ptsRangeTo=Number(m.docCookies.getItem("PRR"));
	m.PRLw=m.ptsRangeFrom*(m.PRw-30)+15;
	$point_range_left.css({left:m.PRLw-15});
	$point_range_bar.css({left:m.PRLw});
	m.PRRw=m.ptsRangeTo*(m.PRw-30)+15;
	$point_range_right.css({left:m.PRRw-5});
	$point_range_bar.css({right:m.PRw-m.PRRw});
	$point_range_result.html((m.ptsRangeFrom*m.PRmax).toFixed(1)+"~"+(m.ptsRangeTo*m.PRmax).toFixed(1)+" / "+m.PRmax);
} else {
	m.ptsRangeFrom=0;
	m.ptsRangeTo=1;
	m.PRLw=15;
	m.PRRw=m.PRw-15;
}

m.neighbors={};
	// m.neighbors[cat_from]={down:true};
	// m.neighbors[cat_from][user_i]={}
	// m.neighbors[cat_from][user_i][cat_i]={sumSim:sumSim, nSim:nSim, simAvg100:simAvg100, tUpdate:tUpdate};
////////////////////////////////////////////////////
// Get neighbors
////////////////////////////////////////////////////
m.getNeighbors=function () {
	if (m.neighbors[m.currentCat]&&m.neighbors[m.currentCat].down) {
		let req="user_i\tcat_i";
		let neighbors=m.neighbors[m.currentCat]
		for (let p in neighbors) {
			if (p!=="down") {
				for (let q in neighbors[p]) {
					req+="\n"+p+"\t"+q;
				}
			}
		}
		console.log(req);
		$.ajax({
			type:"POST", url:m.pathName+"/get-URI-cats-val", data:req
			, dataType:"text"
		}).done(function (resp) {
			console.log(resp);
		});
	} else {
		let req="cat_from\n"+m.currentCat;
		$.ajax({
			type:"POST", url:m.pathName+"/get-Neighbors", data:req
			, dataType:"text"
		}).done(function (resp) {
			let cat_froms=m.strToJSON(req);
			for (let i=1;i<cat_froms.length;i++) {
				m.neighbors[cat_froms[i].cat_from]={down:true};
			}
			let res=m.strToJSON(resp);
			for (let i=1;i<res.length;i++) {
				m.neighbors[res[i].cat_from][res[i].user_i]={};
				m.neighbors[res[i].cat_from][res[i].user_i][res[i].cat_i]=res[i];
			}
			console.log(m.neighbors);
		});
	}
};

////////////////////////////////////////////////////
// Floating key
////////////////////////////////////////////////////
$floating_key=$("#floating-key");
$toggle_floating_key=$("#toggle-floating-key");
$button_hideFK=$("#button-hideFK");
if ((!m.myPage)&&m.myId) {
	$button_hideFK.after(`<div class="button" onclick="window.open('/user/${m.myId}')">[--To my page--]</div>`);
}

m.hideFK=function () {
	$floating_key.hide();
	m.docCookies.setItem("hideFK", "y", Infinity, "/");
};
m.toggleFK=function () {
	if ($floating_key.is(":visible")) {
		m.docCookies.setItem("hideFK", "y", Infinity, "/");
	} else {
		m.docCookies.removeItem("hideFK", "/");
	}
	$floating_key.toggle();
};
if (m.docCookies.getItem("hideFK")==="y") {
	$floating_key.hide();
}

////////////////////////////////////////////////////
// hash encrypt
////////////////////////////////////////////////////
m.pad=function(str, max) {
	str=str.toString();
	return (str.length<max)?m.pad("0"+str,max):str;
};
m.hash1=function(str) {
	let h=-17-str.length;
	for (let i=0;i<str.length;i++) {
		h+=str.charCodeAt(i);
		h+=(h<<10);
		h^=(h>>>6);
	}
	h+=(((h>>>0)%1318489)<<7);
		// prime from http://www.gutenberg.org/cache/epub/65/pg65.html.utf8
	h+=(h<<3);
	h^=(h>>>11);
	h+=(h<<15);
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash2=function(str) {
	let h=str.length+1;
	let tmp;
	for (let i=0;i<str.length;i++) {
		h+=str.charCodeAt(i);
		tmp=(str.charCodeAt(str.length-1-i)<<11)^h;
		h+=(h<<16)^tmp;
		h^=(h>>>7);
		h+=(h<<11);
	}
	h+=( ((h>>>0)%918679)<<11 );
		// prime from http://www.gutenberg.org/cache/epub/65/pg65.html.utf8
	h^=h<<3;
	h+=h>>>5;
	h^=h<<4;
	h+=h>>>17;
	h^=h<<25;
	h+=h>>>6;
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash3=function(str) {
	let h=-1023+str.length;
	for (let i=0;i<str.length;i++) {
		h^=(h<<5)+(h>>>2)+str.charCodeAt(i);
	}
	h^=h<<15;
	h+=h<<15;
	h+=( ((h>>>0)%1299451)<<2 );
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash4=function(str) {/* RS Hash Function */
	let b=378551;
	let a=63689;
	let h=0;
	for (let i=0;i<str.length;i++) {
		let q=0;
		for (let j=0;j<32;j++) {
			if (a&(1<<j)) {
				q=(q+(h<<j))>>>0;
			}
		}
		h=(q+str.charCodeAt(i))>>>0;
			// h=h*a+str.charCodeAt(i);
		q=0;
		for (let j=0;j<32;j++) {
			if (b&(1<<j)) {
				q=(q+(a<<j))>>>0;
			}
		}
		a=q; // a=a*b;
	}
	return m.pad(h.toString(16), 8);
};
m.hash5=function(str) {/* JS Hash Function */
	let h=1315423911;
	for (let i=0;i<str.length;i++) {
		h^=((h<<5)+str.charCodeAt(i)+(h>>2))>>>0;
	}
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash6=function(str) {/* ELF Hash Function */
	let h=0;
	let x=0;
	for (let i=0;i<str.length;i++) {
		h=((h<<4)+str.charCodeAt(i))>>>0;
		if ((x=h&0xf0000000)!=0) {
			h^=(x>>24);
		}
		h&=~x;
	}
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash7=function(str) {/* BKDR Hash Function */
	let a=131; // 31 131 1313 13131 131313 etc..
	let h=0;
	for (let i=0;i<str.length;i++) {
		let q=0;
		for (let j=0;j<32;j++) {
			if (a&(1<<j)) {
				q=(q+(h<<j))>>>0;
			}
		}
		h=(q+str.charCodeAt(i))>>>0;
			// h=h*a+str.charCodeAt(i);
	}
	return m.pad(h.toString(16), 8);
};
m.hash8=function(str) {/* SDBM Hash Function */
	let h=0;
	for (let i=0;i<str.length;i++) {
		h=(str.charCodeAt(i)+(h<<6)+(h<<16)-h)>>>0;
	}
	return m.pad(h.toString(16), 8);
};
m.hash9=function(str) {/* DJB Hash Function */
	let h=5381;
	for (let i=0;i<str.length;i++) {
		h=(((h<<5)+h)+str.charCodeAt(i))>>>0;
	}
	return m.pad(h.toString(16), 8);
};
m.hash10=function(str) {/* DEK Hash Function */
	let h=str.length;
	for (let i=0;i<str.length;i++) {
		h=((h<<5)^(h>>27))^str.charCodeAt(i);
	}
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash11=function(str) {/* BP Hash Function */
	let h=0;
	for (let i=0;i<str.length;i++) {
		h=h<<7^str.charCodeAt(i);
	}
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash12=function(str) {/* FNV Hash Function */
	let a=0x811C9DC5;
	let h=0;
	for (let i=0;i<str.length;i++) {
		let q=0;
		for (let j=0;j<32;j++) {
			if (a&(1<<j)) {
				q=(q+(h<<j))>>>0;
			}
		}
		h=q>>>0;
			// h=h*a;
		h^=str.charCodeAt(i);
	}
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.hash13=function(str) {/* AP Hash Function */
	let h=0xAAAAAAAA;
	for(let i=0;i<str.length;i++) {
		if ((i&1)==0) {
			h^=((h<<7)^str.charCodeAt(i)*(h>>3));
		} else {
			h^=(~((h<<11)+str.charCodeAt(i)^(h>>5)));
		}
	}
	h=h>>>0;
	return m.pad(h.toString(16), 8);
};
m.encrypt=function(salt, pwd, iter) {
	iter=pwd.length+131+((iter&&iter.constructor==Number&&iter>=0)?iter:0);;
	pwd=salt+pwd;
	let h1=m.hash1(pwd);
	let h2=m.hash2(pwd);
	let h3=m.hash3(pwd);
	let h4=m.hash4(pwd);
	let h5=m.hash5(pwd);
	let h6=m.hash6(pwd);
	let h7=m.hash7(pwd);
	let h8=m.hash8(pwd);
	let h9=m.hash9(pwd);
	let h10=m.hash10(pwd);
	let h11=m.hash11(pwd);
	let h12=m.hash12(pwd);
	let h13=m.hash13(pwd);
	let tmp1, tmp2, tmp3, tmp4, tmp5, tmp6, tmp7, tmp8, tmp9, tmp10, tmp11, tmp12, tmp13;
	for (let i=0;i<iter;i++) {
		tmp1=h13+h12+h11+h10+h9+salt+h8+h7+h6+h5+h4+h3+h2+h1;
		tmp2=h1+h3+salt+h2;
		tmp3=salt+h2+h8+h1+h3;
		tmp4=h7+salt+h5;
		tmp5=h4+salt+h8;
		tmp6=h10+h13+salt+h6;
		tmp7=h6+h1+h9+salt;
		tmp8=h9+salt+h10;
		tmp9=h7+salt+h12;
		tmp10=h11+salt+h5;
		tmp11=h4+salt+h13+h2;
		tmp12=h11+salt+h6;
		tmp13=h4+h12+salt+h8;
		h1=m.hash1(tmp1);
		h2=m.hash2(tmp2);
		h3=m.hash3(tmp3);
		h4=m.hash4(tmp4);
		h5=m.hash5(tmp5);
		h6=m.hash6(tmp6);
		h7=m.hash7(tmp7);
		h8=m.hash8(tmp8);
		h9=m.hash9(tmp9);
		h10=m.hash10(tmp10);
		h11=m.hash11(tmp11);
		h12=m.hash12(tmp12);
		h13=m.hash13(tmp13);
	}
	return h1+h2+h3+h4+h5+h6+h7+h8+h9+h10+h11+h12+h13;
};
m.iterSessionFull=1000;

////////////////////////////////////////////////////
// Sidebar dragger and exit
////////////////////////////////////////////////////
m.browserWidth=0;
$window.on("resize", function (e) {
	if (window.innerWidth!==m.browserWidth) {
		m.browserWidth=window.innerWidth;
		if (m.browserWidth<701) {
			$sidebar.css({"margin-left":-$sidebar.outerWidth()});
			$sidebar_dragger.css({display:"block", "left":0});
			$sidebar_exit.hide();
		} else {
			$sidebar.css({"margin-left":0});
			$sidebar_dragger.hide();
			$sidebar_exit.hide();
		}
	}
});
$window.trigger("resize");
m.sidebar_show=(e) => {
	$sidebar.css({"margin-left":0});
	$sidebar_dragger.css({"left":$sidebar.outerWidth()});
	$sidebar_toggle.html(`<g style="stroke:white;stroke-width:20%; stroke-linecap:round;"><line x1="20%" y1="50%" x2="80%" y2="50%"></line><line x1="20%" y1="50%" x2="50%" y2="20%"></line><line x1="20%" y1="50%" x2="50%" y2="80%"></line></g>`);
	$sidebar_toggle.on("click", m.sidebar_hide);
};
m.sidebar_hide=(e) => {
	$sidebar.css({"margin-left":-$sidebar.outerWidth()});
	$sidebar_dragger.css({"left":0});
	$sidebar_toggle.html(`<g style="stroke:white;stroke-width:20%; stroke-linecap:round;"><line x1="20%" y1="50%" x2="80%" y2="50%"></line><line x1="80%" y1="50%" x2="50%" y2="20%"></line><line x1="80%" y1="50%" x2="50%" y2="80%"></line></g>`);
	$sidebar_toggle.on("click", m.sidebar_show);
};
$sidebar_toggle.on("click", m.sidebar_show);
$sidebar_dragger_in.on("mousedown.sd touchstart.sd", function (e) {
	let touch0=(e.type==='touchstart')?e.originalEvent.touches[0]:e;
	let relativeX=touch0.clientX-Math.round($sidebar_dragger.offset().left)+$window.scrollLeft();
	$html.on("mousemove.sd touchmove.sd", function (e) {
		window.getSelection().removeAllRanges();
		e.preventDefault();
		e.stopPropagation();
		let touch0=(e.type==='touchmove')?e.originalEvent.touches[0]:e;
		$sidebar.css({"margin-left":-$sidebar.outerWidth()+touch0.clientX-relativeX});
		$sidebar_dragger.css({"left":touch0.clientX-relativeX});
		$html.on("mouseup.sd touchend.sd", function () {
			$html.off("mouseup.sd touchend.sd mousemove.sd touchmove.sd");
			if (touch0.clientX-relativeX>$sidebar.outerWidth()/2) {
				m.sidebar_show();
			} else {
				m.sidebar_hide();
			}
		});
	})
});
$sidebar_exit.on("click", function () {
	$sidebar_exit.hide();
	$sidebar.css({"margin-left":-$sidebar.outerWidth()});
	$sidebar_dragger.css({"left":0});
});

////////////////////////////////////////////////////
// Escape and Unescape HTML string.
////////////////////////////////////////////////////
m.escapeHTML=function (str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
};
m.unescapeHTML=function (str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&');
};
m.escapeAMP=function (str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/%/g,'%25').replace(/&/g,'%26').replace(/#/g,'%23');
};
m.unescapeAMP=function (str) {
	if (!str||str.constructor!==String) { return ""; }
	return str.replace(/%23/g,'#').replace(/%26/g,'&').replace(/%25/g,'%');
};

////////////////////////////
// String to Array
////////////////////////////
m.encloseStr=function (str) {
  if (!str || str.constructor!==String) { return ''; }
  if (str.charAt(0)==='"' || /[\n\t]/.test(str)) {
    return `"${str.replace(/"/g,'""')}"`;
  } return str;
};
m.strToJSON=function (str, colMap=true, rowMap=false) {
  if (!str||str.constructor!==String) { return []; }
  if (str.charAt(str.length-1)!=="\n") {
    str+="\n";
  }
  const ret=[];
  const delimiter=/([^\t\n]*)([\t\n])/g;
  const lastQuote=/[^"](?:"")*"([\t\n])/g;
  let exec;
  let start=0;
  let row=-1, col=-1, delim="\n";
  let strElem="";
  function increaseRC(delim) {
    if (delim==='\t') {
      col++; return true;
    } else if (delim==='\n') {
      row++; col=0; ret.push([]); return true;
    } return false;
  }
  while (start<str.length&&increaseRC(delim)) {
    if ((str.substring(start, start+1))==='"') {
      lastQuote.lastIndex=start+1;
      if ((exec=lastQuote.exec(str))!==null) {
        strElem=str.substring(start+1, lastQuote.lastIndex-2);
        delim=exec[1];
        start=delimiter.lastIndex=lastQuote.lastIndex;
      } else {
        strElem=str.substring(start+1);
        delim="";
        start=str.length;
      }
      strElem=strElem.replace(/""/g,'"');
    } else {
      if ((exec=delimiter.exec(str))!==null) {
        strElem=exec[1];
        delim=exec[2];
        start=delimiter.lastIndex;
      } else {
        strElem=str.substring(start);
        delim="";
        start=str.length;
      }
    }
    ret[row][col]=strElem;
  }
  if (colMap) {
    const firstColSize=ret[0].length;
    for (let i=0;i<ret.length;i++) {
      let jMax=ret[i].length;
      if (jMax>firstColSize) { jMax=firstColSize; }
      for (let j=0;j<jMax;j++) {
        let key=ret[0][j];
        if (key!==undefined) {
          ret[i][key]=ret[i][j];
        }
      }
    }
  }
  if (rowMap) {
    for (let i=0;i<ret.length;i++) {
      let key=ret[i][0];
      if (key!==undefined) {
        ret[key]=ret[i];
      }
    }
  }
  return ret;
};

////////////////////////////////////////////////////
// Delayed Loading.
////////////////////////////////////////////////////
$.fn.inView=function () {
	if (this.is(":visible")) {
		let viewportHeight=window.innerHeight;
		let scrollTop=$window.scrollTop();
		let elemTop=this.offset().top-m.delayPad;
		let elemBottom=elemTop+this.height()+m.delayPad;
		return (scrollTop+viewportHeight>elemTop)&&(scrollTop<elemBottom);
	} else {
		return false;
	}
};
$.fn.delayedLoad=function () {
	let done=false;
	if (this.inView()) {
		if (this.hasClass("to-be-executed")) {
			this.trigger("click");
		}
		// divs with background-image
		if (this.attr("delayed-bgimage")) {
			this.css("background-image", "url("+this.attr("delayed-bgimage")+")");
			this.removeAttr("delayed-bgimage");
			done=true;
		}
		// iframes or images
		if (this.attr("delayed-src")) {
			this.attr("src", this.attr("delayed-src"));
			this.removeAttr("delayed-src");
			done=true;
		}
		// MathJax Process
		if (typeof MathJax!=='undefined'&&this.is(".MathJax_Preview")) {
			MathJax.Hub.Queue(["Process", MathJax.Hub, this.next()[0]]);
			done=true;
		}
	}
	return done;
};
m.delayedLoadAll=function () {
	m.delayedElems.each(function () {
		if ($(this).delayedLoad()) {
			m.delayedElems=m.delayedElems.not(this);
		}
	});
	if (m.delayedElems.length>0) {
		$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
	}
	m.previous=Date.now();
};
m.delayedLoadByScroll=function () {
	$window.off("scroll.delayedLoad");
	let now=Date.now();
	let passed=now-m.previous;
	if (passed>m.wait) {
		m.delayedLoadAll();
	} else {
		m.delayedLoadSetTimeout=setTimeout(function () {
			m.delayedLoadAll();
		}, m.wait*1.1-passed);
	}
};
$window.on("scroll.delayedLoad", m.delayedLoadByScroll);

/* Remember user */
m.sW=screen.width;
m.sH=screen.height;
if (m.sW<m.sH) {
	m.sW=screen.height;
	m.sH=screen.width;
}
m.str_rmb_me='log\tsW\tsH\n'
	+'web\t'+m.sW+'\t'+m.sH;
m.rmb_me=function (callback, args) {
	let SSNencrypt=function (callback, args) {
		$.ajax({
			type:"GET", url:"/sessionIter"
			, dataType:"text"
		}).done(function (resp) {
			console.log(resp);
			let iter=Number(resp);
			if (isNaN(iter)) {
				callback(args, resp);
			} else {
				m.docCookies.setItem("SSN", m.encrypt(m.saltSSN, m.session.substring(3,11), iter), 3, "/");
				callback(args, null);
				// m.docCookies.removeItem("SSN", "/");
			}
		});
	};
	if (m.docCookies.hasItem('tCreate')) {
		if (m.docCookies.hasItem("salt")||m.docCookies.hasItem("session")) {
			m.saveSSN();
		}
		if (m.saltSSN&&m.session) {
			SSNencrypt(callback, args);
			return;
		}
	}
	if (m.docCookies.hasItem('rmbdI')) {
		$.ajax({
			type:"POST", url:"/account/log-in/remember-me.do", data:m.str_rmb_me
			, dataType:"text"
		}).done(function (resp) {
			console.log("rmb_do : "+resp);
			setTimeout(function () {
				console.log(resp);
				console.log("tCreate: "+m.docCookies.hasItem('tCreate'));
				if (resp==="Rmbd"&&m.docCookies.hasItem('tCreate')) {
					m.saveSSN();
					if (m.saltSSN&&m.session) {
						SSNencrypt(callback, args);
					} else {
						callback(args, resp);
					}
				} else {
					callback(args, resp);
				}
			}, 1000);
		});
	} else {
		callback(args);
	}
};

/* Fuzzy search */
////////////////////////////////////////////////////
// Hangul (Korean) split and map to English
// KE : Korean Expanded
////////////////////////////////////////////////////
m.jamoKE=["ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄷㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
m.jamo=["ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄸ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅃ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

m.mapKE={"q":"ㅂ", "Q":"ㅃ", "w":"ㅈ", "W":"ㅉ", "e":"ㄷ", "E":"ㄸ", "r":"ㄱ", "R":"ㄲ", "t":"ㅅ", "T":"ㅆ", "y":"ㅛ", "Y":"ㅛ", "u":"ㅕ", "U":"ㅕ", "i":"ㅑ", "I":"ㅑ", "o":"ㅐ", "O":"ㅒ", "p":"ㅔ", "P":"ㅖ", "a":"ㅁ", "A":"ㅁ", "s":"ㄴ", "S":"ㄴ", "d":"ㅇ", "D":"ㅇ", "f":"ㄹ", "F":"ㄹ", "g":"ㅎ", "G":"ㅎ", "h":"ㅗ", "H":"ㅗ", "j":"ㅓ", "J":"ㅓ", "k":"ㅏ", "K":"ㅏ", "l":"ㅣ", "L":"ㅣ", "z":"ㅋ", "Z":"ㅋ", "x":"ㅌ", "X":"ㅌ", "c":"ㅊ", "C":"ㅊ", "v":"ㅍ", "V":"ㅍ", "b":"ㅠ", "B":"ㅠ", "n":"ㅜ", "N":"ㅜ", "m":"ㅡ", "M":"ㅡ"};
for (let p in m.mapKE) {
	m.mapKE[m.mapKE[p]]=p;
}

m.rChoKE=["ㄱ", "ㄱㄱ", "ㄴ", "ㄷ", "ㄷㄷ", "ㄹ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
m.rCho=["ㄱ", "ㄲ", "ㄴ", "ㄷ", "ㄸ", "ㄹ", "ㅁ", "ㅂ", "ㅃ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

m.rJungKE=["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
m.rJung=["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

m.rJongKE=["", "ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
m.rJong=["", "ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

m.splitHangul=function (str) {
	let res=[];
	res.originalStr=str;
	res.splitted3="";
	res.splitted="";
	res.pCho=[]; // position of word-start or 초성
	let p=0;
	res.pCho[p]=true;
	let cho, jung, jong;
	for (let i=0;i<str.length;i++) {
		let c=str.charAt(i)
		let n=str.charCodeAt(i);
		if (n>=0x3131&&n<=0x3163) {
			n-=0x3131;
			res[i]={"char":c, "splitted3":c, "splitted":m.jamoKE[n]};
			res.pCho[p]=true;
		} else if (n>=0xAC00&&n<=0xD7A3) {
			n-=0xAC00;
			jong=n%28;
			jung=( (n-jong)/28 )%21;
			cho=( ((n-jong)/28)-jung )/21;
			res[i]={"char":c
				, "splitted3":m.rCho[cho]+m.rJung[jung]+m.rJong[jong]
				, "splitted":m.rChoKE[cho]+m.rJungKE[jung]+m.rJongKE[jong]};
			res.pCho[p]=true;
		} else {
			res[i]={"char":c, "splitted3":c, "splitted":c};
			if (i>0&&/[^a-zA-Z0-9]$/.test(res[i-1].splitted)&&/[a-zA-Z0-9]/.test(c)) {
				res.pCho[p]=true;
			}
		}
		p+=res[i].splitted.length;
		res.splitted3+=res[i].splitted3;
		res.splitted+=res[i].splitted;
	}
	return res;
};

////////////////////////////////////////////////////
// Fuzzy search prepare
////////////////////////////////////////////////////
m.fsCat[0].ptnSH=m.fsCat[1].ptnSH
=m.fsTitle[0].ptnSH=m.fsTitle[1].ptnSH
=m.fsToRs[0].ptnSH=m.fsToRs[1].ptnSH
=m.fsGo[0].ptnSH=m.fsGo[1].ptnSH=m.splitHangul("$!@#");
RegExp.quote=function (str) {
	return str.replace(/[.?*+^$[\]\\{}()|-]/g, "\\$&").replace(/\s/g, "[\\s\\S]");
};
m.arrayRegExs=function (ptnSH) {
	let str=ptnSH.splitted;
	let res=[];
	for (let i=0;i<str.length;i++) {
		let c=str.charAt(i);
		let mapKE=m.mapKE[c];
		if (mapKE) {
			res.push( new RegExp("["+c+mapKE+"]", "ig") );
		} else {
			res.push( new RegExp(RegExp.quote(c), "ig") );
		}
	}
	return res;
};
m.highlightStrFromIndices=function (strSplitted, indices) {
	let res="";
	for (let i=0, j=1, k=0, p1=0, p2=0;j<=indices.length;i=j,j++) {
		while (j<indices.length&&indices[j-1].end===indices[j].start) {
			j++;
		}
		for (;k<strSplitted.length;k++) {
			p1=p2;
			p2=p1+strSplitted[k]["splitted"].length;
			if (p2<=indices[i].start) {
				strSplitted[k]["matched"]=false;
			} else if (p1<indices[j-1].end) {
				strSplitted[k]["matched"]=true;
			} else {
				if (j===indices.length) {
					for (;k<strSplitted.length;k++) {
						strSplitted[k]["matched"]=false;
					}
				}
				p2=p1;
				break;
			}
		}
	}
	for (let i=0;i<strSplitted.length;) {
		if (strSplitted[i]["matched"]) {
			res+='<span class="bold">';
			while (i<strSplitted.length&&strSplitted[i]["matched"]) {
				res+=m.escapeHTML(strSplitted[i]["char"]);
				i++;
			}
			res+='</span>';
		} else {
			while (i<strSplitted.length&&!strSplitted[i]["matched"]) {
				res+=m.escapeHTML(strSplitted[i]["char"]);
				i++;
			}
		}
	}
	return res;
};
m.matchScoreFromIndices=function (strSH, ptnSH, indices) {
	let res=0;
	for (let i=0;i<indices.length;i++) {
		if (strSH.pCho[indices[i].start])
			res+=10;
	}
	for (let i=1;i<indices.length;i++) {
		let diff=indices[i].start-indices[i-1].start;
		if (diff<5) res+=8*(5-diff);
	}
	return res;
};
m.fuzzySearch=function (ptnSH, fs) {
	let list=[];
	if (ptnSH.splitted.indexOf(fs[0].ptnSH.splitted)===0) {
		fs[1]=fs[0];
	} else if (fs[1] && ptnSH.splitted.indexOf(fs[1].ptnSH.splitted)===0) {
		if (ptnSH.splitted===fs[1].ptnSH.splitted) {
			return fs[0]=fs[1];
		}
	} else {
		fs[1]=null;
	}
	let listIsFullList=false;
	if (fs[1]&&fs[1].sorted) {
		let sorted=fs[1].sorted;
		for (let i=0;i<sorted.length;i++) {
			list.push(fs.fullList[ fs[1][sorted[i]].i ]);
		}
	} else {
		list=fs.fullList;
		listIsFullList=true;
	}
	fs[0]=[];
	fs[0].ptnSH=ptnSH;
	let regExs=m.arrayRegExs(ptnSH);
	for (let i=0;i<list.length;i++) {
	if (regExs.length>0) {
		let txt=list[i].txt;
		let txtS=txt.splitted;
		regExs[0].lastIndex=0;
		let exec=regExs[0].exec(txtS);
		let matched=(exec!==null);
		let indices=[];
		if (matched) {
			indices[0]={start:exec.index, end:regExs[0].lastIndex};
		}
		for (let j=1;matched&&(j<regExs.length);j++) {
			regExs[j].lastIndex=regExs[j-1].lastIndex;
			exec=regExs[j].exec(txtS);
			matched=(exec!==null);
			if (matched) {
				indices[j]={start:exec.index, end:regExs[j].lastIndex};
			}
		}
		if (matched) {
			let maxMatchScore=m.matchScoreFromIndices(txt, ptnSH, indices);
			let indicesMMS=[]; // indices of max match score
			for (let p=0;p<indices.length;p++) {
				indicesMMS[p]=indices[p]; // hard copy of indices
			}
			for (let k=indices.length-2;k>=0;) {
				regExs[k].lastIndex=indices[k].start+1;
				exec=regExs[k].exec(txtS);
				matched=(exec!==null);
				if (matched) {
					indices[k]={start:exec.index, end:regExs[k].lastIndex};
				}
				for (let j=k+1;matched&&(j<regExs.length);j++) {
					regExs[j].lastIndex=regExs[j-1].lastIndex;
					exec=regExs[j].exec(txtS);
					matched=(exec!==null);
					if (matched) {
						indices[j]={start:exec.index, end:regExs[j].lastIndex};
					}
				}
				if (matched) {
					let matchScore=m.matchScoreFromIndices(txt, ptnSH, indices);
					if (matchScore>maxMatchScore) {
						maxMatchScore=matchScore;
						for (let p=0;p<indices.length;p++) {
							indicesMMS[p]=indices[p]; // hard copy of indices
						}
					}
					k=indices.length-2;
				} else {
					k--;
				}
			}
			fs[0].push({i:list[i].i, maxMatchScore:maxMatchScore, highlight:m.highlightStrFromIndices(txt, indicesMMS)});
		}
	} else {
		fs[0].push({i:list[i].i, maxMatchScore:0});
	}}
	let sorted=fs[0].sorted=[];
	for (let i=0;i<fs[0].length;i++) {
		if (listIsFullList&&fs.desc) {
			sorted[i]=fs[0].length-1-i;
		} else {
			sorted[i]=i;
		}
	}
	for (let i=1;i<sorted.length;i++) {
		let temp=sorted[i];
		let j=i;
		for (;(j>0) && (fs[0][sorted[j-1]].maxMatchScore<fs[0][temp].maxMatchScore);j--)
			sorted[j]=sorted[j-1];
		sorted[j]=temp;
	}
};

/* CatList */
////////////////////////////////////////////////////
// CatList rendering
////////////////////////////////////////////////////
m.pathOfCat=function (cat, mode) {
	return m.pathName+"?cat="+(cat?m.escapeAMP(cat):"")+(mode&&mode==="multireco"?"&mode=multireco":(mode&&mode==="neighbors"?"&mode=neighbors":""));
};
m.getDepthOfTabs=function (str) {
	let n=0;
	while (n<str.length&&str.charAt(n)==='\t') { n++; }
	return n;
};
m.getSuperCat=function (cat) {
	if (cat&&cat.constructor===String) {
		let i=cat.lastIndexOf("--");
		if (i!=-1) {
			return cat.substring(0,i);
		}
	}
	return null;
};
m.strCatListToJSON=function (strCatList, catList) {
	let list=strCatList.trim().split("\n");
	if (strCatList.length===0) {
		list=[];
	}
	list.unshift("");
	if (catList===undefined||catList===null) {
		if (m.catList) {
			catList=m.catList;
		} else {
			catList=m.catList=[];
		}
	}
	let superCats=[];
	for (let i=0;i<list.length;i++) {
		let baseCat=list[i].trim();
		let depth=m.getDepthOfTabs(list[i]);
		superCats.splice(depth, superCats.length-depth, baseCat);
		let cat=superCats[0];
		for (let j=1;j<=depth;j++) {
			cat+="--"+superCats[j];
		}
		if (catList[cat]) {
			catList[cat].i=i;
			catList[i]=catList[cat];
		} else {
			catList[i]=catList[cat]={i:i, cat:cat, baseCat:baseCat, depth:depth};
		}
	}
};
m.catListToHTML=function () {
	let cL=m.catList;
	let catListHTML='<div class="cat" id="cat-0" style="margin-left:'+cL[0].depth+'em"><span class="noEC"></span><a href="'+m.pathOfCat("")+'" class="baseCat" onclick="return m.openCat(m.catList[0].cat, event)">[--Uncategorized--]</a></div>';
	let i=1;
	for (;i<cL.length-1;i++) {
		let beforeDepth=cL[i-1].depth;
		let currentDepth=cL[i].depth;
		let afterDepth=cL[i+1].depth;
		if (beforeDepth<currentDepth) { // open subCat
			catListHTML+='<div class="subCat" style="display:none">';
		} else {
			for (let j=currentDepth;j<beforeDepth;j++) { // close subCats
				catListHTML+='</div>';
			}
		}
		catListHTML+='<div class="cat" id="cat-'+i+'" style="margin-left:'+cL[i].depth+'em">';
		if (currentDepth<afterDepth) {
			catListHTML+='<span class="EC" onclick="m.ExpCol(this,m.catList['+i+'])">▶</span>';
		} else {
			catListHTML+='<span class="noEC"></span>';
		}
		catListHTML+='<a href="'+m.pathOfCat(cL[i].cat)+'" class="baseCat" onclick="return m.openCat(m.catList['+i+'].cat, event)">'+m.escapeHTML(cL[i].baseCat)+'</a>'+'</div>';
	}
	if (cL.length>1) {
		let beforeDepth=cL[i-1].depth;
		let currentDepth=cL[i].depth;
		if (beforeDepth<currentDepth) { // open subCat
			catListHTML+='<div class="subCat" style="display:none">';
		} else {
			for (let j=currentDepth;j<beforeDepth;j++) { // close subCats
				catListHTML+='</div>';
			}
		}
		catListHTML+='<div class="cat" id="cat-'+i+'" style="margin-left:'+cL[i].depth+'em">'
			+'<span class="noEC"></span>'
			+'<a href="'+m.pathOfCat(cL[i].cat)+'" class="baseCat" onclick="return m.openCat(m.catList['+i+'].cat, event)">'+m.escapeHTML( cL[i].baseCat )+'</a>'
		+'</div>';
		for (let j=0;j<currentDepth;j++) { // close subCats
			catListHTML+='</div>';
		}
	}
	$catList.html(catListHTML);
};
if (m.myIndex) { m.strCatListToJSON(m.unescapeHTML($data_myCatList.html()), m.myCatList); }
if (!m.myPage) { m.strCatListToJSON(m.unescapeHTML($data_CatList.html())); }
m.catListToHTML();
let $catECs=$catList.find(".cat:has(>.EC)");
for (let i=$catECs.length-1;i>=0;i--) {
	m.catList[Number($catECs.eq(i).attr("id").substring(4))].subCatExpanded=false;
}
m.catsToA=function (cats) {
	if (!cats||cats.constructor!==String||cats.trim().length===0) {
		return '<a href="'+m.pathOfCat("")+'" onclick="return m.openCat(m.catList[0].cat, event)"'+(m.currentCat===""?' class="currentCat"':'')+'>[--Uncategorized--]</a>';
	}
	let arrayHTML=[];
	let list=cats.split(";");
	for (let i=0;i<list.length;i++) {
		let cat=list[i];
		arrayHTML.push('<a href="'+m.pathOfCat(cat)+'" onclick="return m.openCat(m.catList['+m.catList[cat].i+'].cat, event)"'+(m.currentCat===cat?' class="currentCat"':'')+'>'+m.escapeHTML(cat)+'</a>');
	}
	return arrayHTML.join(" ; ");
};
m.getCatListChanged=function () {
	$change_catList_order_ok.hide();
	$change_catList_order_cancel.hide();
	let $cats=$("#catList .cat").not("#cat-0");
	$cats.removeClass("edit");
	$cats.find('.edit-bar').remove();
	let catListChanged="\n";
	for (let i=0;i<$cats.length;i++) {
		let catI=Number($cats.eq(i).attr("id").substring(4));
		for (let j=0;j<m.catList[catI].depth;j++) {
			catListChanged+="\t";
		}
		catListChanged+=m.catList[catI].baseCat+"\n";
	}
	return catListChanged;
};

//////////////////////////////////////
// CatList order
//////////////////////////////////////
$change_catList_order_ok.hide();
$change_catList_order_cancel.hide();
$change_catList_order.on("click", function (e) {
	$change_catList_order.hide();
	$change_catList_order_ok.show();
	$change_catList_order_cancel.show();
	let $cats=$("#catList .cat").not("#cat-0");
	$cats.addClass("edit");
	$cats.prepend('<div class="edit-bar"></div>');
	$cats.append('<div class="edit-bar"></div>');
	$("#catList .edit-bar").on("mousedown touchstart", function (e) {
		let $catM=$(this).parent(); // cat-moving
		let $catSiblings=$catM.siblings(".cat").not("#cat-0");
		if ($catSiblings.exists()) {
			let touch0=(e.type==='touchstart')?e.originalEvent.touches[0]:e;
			let relativeX=touch0.clientX-Math.round($catM.offset().left)+$window.scrollLeft();
			let relativeY=touch0.clientY-Math.round($catM.offset().top)+$window.scrollTop();
			let $subCat=$catM.next(".subCat");
			let subCatIsVisible=false;
			if ($subCat.exists()&&$subCat.is(":visible")) {
				$subCat.hide();
				subCatIsVisible=true;
			}
			let $lastSibling=$catSiblings.last();
			let $lastSubCat=$lastSibling.next(".subCat");
			if ($lastSubCat.exists()&&$lastSubCat.is(":visible")) { $lastSibling=$lastSubCat; }
			$catM.css({width:$catM.outerWidth()});
			$catM.addClass("move");
			let catI=Number($catM.attr("id").substring(4));
			let $catTo=$('<div id="cat-to-here" style="margin-left:'+(m.catList[catI].depth+0.5)+'em"></div>');
			$catM.before($catTo);
			let catTo=-1;
			$html.on("mousemove.mdInEB touchmove.mdInEB", function (e) {
				window.getSelection().removeAllRanges();
				e.preventDefault();
				e.stopPropagation();
				let touch0=(e.type==='touchmove')?e.originalEvent.touches[0]:e;
				$catM.css({left:touch0.clientX-relativeX, top:touch0.clientY-relativeY});
				let wST=$window.scrollTop();
				let sidebarTop=$sidebar.offset().top-wST;
				let sidebarBottom=sidebarTop+$sidebar.outerHeight();
				let scrollPad=20;
				if (sidebarTop<0?touch0.clientY<scrollPad:touch0.clientY<sidebarTop+scrollPad) {
					if (sidebarTop<0) {
						$window.scrollTop(wST+touch0.clientY-scrollPad);
					} else {
						$sidebar.scrollTop($sidebar.scrollTop()+touch0.clientY-sidebarTop-scrollPad);
					}
				} else if (sidebarBottom>$window.outerHeight()?touch0.clientY>$window.outerHeight()-scrollPad:touch0.clientY>sidebarBottom-scrollPad) {
					if (sidebarBottom>$window.outerHeight()) {
						$window.scrollTop(wST+touch0.clientY-$window.outerHeight()+scrollPad);
					} else {
						$sidebar.scrollTop($sidebar.scrollTop()+touch0.clientY-sidebarBottom+scrollPad);
					}
				}
				let tops=[];
				for (let i=1;i<$catSiblings.length;i++) {
					tops.push(($catSiblings.eq(i-1).offset().top-wST+$catSiblings.eq(i).offset().top-wST)/2);
				}
				tops.push(($catSiblings.last().offset().top-wST+$lastSibling.offset().top+$lastSibling.outerHeight()-wST)/2);
				let k=0;
				for (;k<tops.length;k++) {
					if (touch0.clientY<tops[k]) { break; }
				}
				if (catTo!==k) {
					if (k<tops.length) {
						$catSiblings.eq(k).before($catTo);
					} else {
						$lastSibling.after($catTo);
					}
					catTo=k;
				}
			});
			$html.on("mouseup.mdInEB touchend.mdInEB", function (e) {
				$html.off("mouseup.mdInEB touchend.mdInEB mousemove.mdInEB touchmove.mdInEB");
				$catM.removeClass("move");
				$catM.css({width:'', left:'', top:''});
				$catTo.replaceWith($catM);
				if ($subCat.exists()) {
					$catM.after($subCat);
					if (subCatIsVisible) { $subCat.show(); }
				}
			});
		} else { // if $catSiblings doesn't exist.
			$catM.css({"border-color":"rgb(230,120,120)"});
			$html.on("mousemove.mdInEB touchmove.mdInEB", function (e) {
				window.getSelection().removeAllRanges();
				e.preventDefault();
				e.stopPropagation();
			});
			$html.on("mouseup.mdInEB touchend.mdInEB", function (e) {
				$html.off("mouseup.mdInEB touchend.mdInEB mousemove.mdInEB touchmove.mdInEB");
				$catM.css({"border-color":""});
			});
		}
	});
});
m.change_catList_order_do=function (args, err) {
	if (err) {
		console.log(err);
		$data_myCatList.html(m.escapeHTML(args));
		m.updateCatFS();
		$change_catList_order.show();
	} else {
		$.ajax({
			type:"POST", url:"/changeOrders/CatList", data:args
			, dataType:"text"
		}).fail(function () {
			console.log("Changing CatList order has failed.");
		}).done(function (resp) {
			console.log(resp);
		}).always(function () {
			$data_myCatList.html(m.escapeHTML(args));
			m.updateCatFS();
			$change_catList_order.show();
		});
	}
};
$change_catList_order_ok.on("click", function (e) {
	let catListChanged=m.getCatListChanged();
	if (catListChanged!==m.unescapeHTML($data_CatList.html())) {
		if (m.myPage) {
			m.rmb_me(m.change_catList_order_do, catListChanged);
		} else {
			$data_CatList.html(m.escapeHTML(catListChanged));
			$change_catList_order.show();
		}
	} else {
		$change_catList_order.show();
	}
});
$change_catList_order_cancel.on("click", function (e) {
	let catListChanged=m.getCatListChanged();
	let catList=m.unescapeHTML($data_CatList.html());
	if (catListChanged!==catList) {
		let $catSelected=$catList.find(".cat.selected");
		let selected=[];
		for (let i=0;i<$catSelected.length;i++) {
			selected.push(m.catList[Number($catSelected.eq(i).attr("id").substring(4))].cat);
		}
		m.strCatListToJSON(catList);
		m.catListToHTML();
		for (let i=0;i<selected.length;i++) {
			$("#cat-"+m.catList[selected[i]].i).addClass("selected");
		}
		for (let i=m.catList.length-1;i>=0;i--) {
			if (m.catList[i].subCatExpanded) {
				$("#cat-"+i+">.EC").trigger("click");
			}
		}
	}
	$change_catList_order.show();
});

//////////////////////////////////////
// Fuzzy search on Cat
//////////////////////////////////////
m.putCatToFSFullList=function (i, cat) {
	if (m.fsCat.fullList[cat]) {
		m.fsCat.fullList[i]=m.fsCat.fullList[cat];
	} else {
		m.fsCat.fullList[i]=m.fsCat.fullList[cat]={txt:m.splitHangul(cat), cat:cat, html:m.escapeHTML(cat)};
	}
};
m.updateCatFS=function () {
	m.fsCat.fullList.splice(0, m.fsCat.fullList.length);
	if (!m.myPage) {
		m.strCatListToJSON(m.unescapeHTML($data_myCatList.html()), m.myCatList);
	}
	for (let i=0;i<m.myCatList.length;i++) {
		m.putCatToFSFullList(i, m.myCatList[i].cat);
	}
};
m.updateCatFS();
m.chooseCat=function (elem, j) {
	let $elem=$(elem);
	let fs=m.fsCat;
	if ($elem.hasClass("selected")) {
		// fs.$fs.trigger({type:"keydown", keyCode:27}); // keyCode:27=ESC
	} else {
		fs.$fsLis.removeClass("selected");
		$elem.addClass("selected");
		let k=fs.k;
		fs.listOfCats[k]=fs.fullList[j].cat;
		fs.$fs[0].value=fs.listOfCats.join(";");
		let sStart=0;
		for (let i=0;i<k;i++) {
			sStart+=fs.listOfCats[i].length+1;
		}
		let sEnd=sStart+fs.listOfCats[k].length;
		fs.$fs.focus();
		fs.$fs[0].setSelectionRange(sEnd,sEnd);
	}
};
m.chooseMRCat=function (elem, j) {
	let $elem=$(elem);
	let fs=m.fsCat;
	if ($elem.hasClass("selected")) {
		// fs.$fs.trigger({type:"keydown", keyCode:27}); // keyCode:27=ESC
	} else {
		fs.$fsLis.removeClass("selected");
		$elem.addClass("selected");
		let k=fs.k;
		fs.listOfCats[k]=fs.fullList[j].cat;
		$multireco_input_cats[0].value=fs.listOfCats.join(";");
		let sStart=0;
		for (let i=0;i<k;i++) {
			sStart+=fs.listOfCats[i].length+1;
		}
		let sEnd=sStart+fs.listOfCats[k].length;
		$multireco_input_cats.focus();
		$multireco_input_cats[0].setSelectionRange(sEnd,sEnd);
	}
};
m.doFSCat=function (fs) {
	let catsTxt=fs.$fs[0].value;
	let sEnd=fs.$fs[0].selectionEnd;
	let listOfCats=fs.listOfCats=catsTxt.split(";");
	let l=catsTxt.length;
	fs.k=0;
	for (let i=listOfCats.length-1;i>=0;i--) {
		l-=listOfCats[i].length+1;
		if (l<sEnd) {
			fs.k=i;
			break;
		}
	}
	let fsCatSH=m.splitHangul(listOfCats[fs.k]);
	m.fuzzySearch(fsCatSH, fs);
	let str="";
	for (let i=0;i<fs[0].length;i++) {
		let k=fs[0][fs[0].sorted[i]];
		str+='<div class="list-item" onclick="m.chooseCat(this,'+k.i+')">'
				+'<div class="list-index">'+i+'</div>'
				+fs.fullList[k.i].html
				+(k.highlight!==undefined?
				'<div class="highlighted">'+'<span class="maxMatchScore">'+k.maxMatchScore+'</span> :: '+k.highlight+'</div>':'')
			+'</div>';
	}
	$cat_fs_list.html(str);
	fs.$fsLis=fs.$fsl.find(".list-item");
};
m.doMRFSCat=function (fs) {
	let catsTxt=$multireco_input_cats[0].value;
	let sEnd=$multireco_input_cats[0].selectionEnd;
	let listOfCats=fs.listOfCats=catsTxt.split(";");
	let l=catsTxt.length;
	fs.k=0;
	for (let i=listOfCats.length-1;i>=0;i--) {
		l-=listOfCats[i].length+1;
		if (l<sEnd) {
			fs.k=i;
			break;
		}
	}
	let fsCatSH=m.splitHangul(listOfCats[fs.k]);
	m.fuzzySearch(fsCatSH, fs);
	let str="";
	for (let i=0;i<fs[0].length;i++) {
		let k=fs[0][fs[0].sorted[i]];
		str+='<div class="list-item" onclick="m.chooseMRCat(this,'+k.i+')">'
				+'<div class="list-index">'+i+'</div>'
				+fs.fullList[k.i].html
				+(k.highlight!==undefined?
				'<div class="highlighted">'+'<span class="maxMatchScore">'+k.maxMatchScore+'</span> :: '+k.highlight+'</div>':'')
			+'</div>';
	}
	$multireco_cat_fs_list.html(str);
	fs.$fsLis=$multireco_cat_fs_list.find(".list-item");
};
m.fsCatOn=function () {
	let now=Date.now();
	let passed=now-m.previous;
	if (passed>m.wait) {
		m.previous=now;
		m.doFSCat(m.fsCat);
	} else {
		$input_cats.off("input.fs keyup.fs cut.fs paste.fs click.fs");
		setTimeout(function () {
			$input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsCatOn);
			m.previous=Date.now();
			m.doFSCat(m.fsCat);
		}, m.wait*1.1-passed);
	}
};
m.fsMRCatOn=function () {
	let now=Date.now();
	let passed=now-m.previous;
	if (passed>m.wait) {
		m.previous=now;
		m.doMRFSCat(m.fsCat);
	} else {
		$multireco_input_cats.off("input.fs keyup.fs cut.fs paste.fs click.fs");
		setTimeout(function () {
			$multireco_input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsMRCatOn);
			m.previous=Date.now();
			m.doMRFSCat(m.fsCat);
		}, m.wait*1.1-passed);
	}
};
$input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsCatOn);
$multireco_input_cats.on("input.fs keyup.fs cut.fs paste.fs click.fs", m.fsMRCatOn);
$input_cats.on("keydown.fs", function (e) {
	e.stopPropagation();
	switch (e.keyCode) {
	// case 9: // Tab=9
	// 	e.preventDefault();
	// 	m.fsTitle.$fsLis.eq(0).trigger("click");
	// 	break;
	case 27: // ESC=27
		e.preventDefault();
		$cat_fs_container.hide();
		break;
	// case 38: // up=38
	// case 40: // down=40
	// 	e.preventDefault();
	// 	let $fsl=$cat_fs_list;
	// 	let $lis=$fsl.find(".list-item");
	// 	let $liSelected=$fsl.find(".list-item.selected").eq(0);
	// 	let $liTo=null;
	// 	if ($liSelected.exists()) {
	// 		if (e.keyCode===38) {
	// 			$liTo=$liSelected.prev();
	// 		} else {
	// 			$liTo=$liSelected.next();
	// 		}
	// 		if ($liTo.exists()) {
	// 			$liTo.eq(0).trigger("click");
	// 			if ($liTo.offset().top<$fsl.offset().top+2) { // $liTo at upside of scroll.
	// 				$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top-$fsl.offset().top-2);
	// 			} else if ($liTo.offset().top+$liTo.outerHeight()>$fsl.offset().top+$fsl.height()+2) { // $liTo at downside of scroll.
	// 				$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top+$liTo.outerHeight()-$fsl.offset().top-$fsl.height()-2);
	// 			}
	// 		}
	// 	} else {
	// 		if ($lis.exists()) {
	// 			if (e.keyCode===38) {
	// 				$liTo=$lis.last();
	// 				$fsl.scrollTop($fsl[0].scrollHeight);
	// 			} else {
	// 				$liTo=$lis.first();
	// 				$fsl.scrollTop(0);
	// 			}
	// 			$liTo.eq(0).trigger("click");
	// 		}
	// 	}
	// 	break;
	}
});
if (m.myIndex) {
	for (let i=0;i<m.myCatList.length;i++) {
		let cat=m.myCatList[i].cat;
		m.fsCat.fullList[i]={i:i, txt:m.splitHangul(cat), cat:cat, html:m.escapeHTML(cat)};
	}
}
$input_cats.trigger("keyup");
$input_cats.on("focus", function () {
	$cat_fs_container.show();
});

$multireco_input_cats.on("focus", function () {
	$multireco_cat_fs_container.show();
});

//////////////////////////////////////
// Put/Delete/Change Cats
//////////////////////////////////////
m.putCat=function (cat) {
	let res=false;
	if (cat===null||cat.length===0) { return res; }
	let fullCats=m.unescapeHTML($data_myCatList.html());
	let levels=cat.split("--");
	let pre="\n";
	let start=0;
	let end=fullCats.length;
	for (let j=0;j<levels.length;j++) {
		let subStr=fullCats.substring(start,end);
		let toFind=pre+levels[j]+"\n";
		let i=subStr.indexOf(toFind);
		if (i!=-1) {
			let ptnEnd=new RegExp(pre.replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"[^\\t\\n]", "g");
			ptnEnd.lastIndex=i+toFind.length-1;
			let matchEnd=ptnEnd.exec(subStr);
			if (matchEnd!==null) {
				end=start+matchEnd.index+1;
			}
			start+=i+toFind.length-1;
			pre+="\t";
		} else {
			let toPut="";
			for (;j<levels.length;j++) {
				toPut+=pre+levels[j];
				pre+="\t";
			}
			fullCats=fullCats.substring(0,end-1)+toPut+"\n"+fullCats.substring(end);
			res=true;
		}
	}
	if (res) { $data_myCatList.html(m.escapeHTML(fullCats)); }
	return res;
};
m.deleteCat=function (cat) {
	let res=false;
	if (cat===null||cat.length===0) { return res; }
	let fullCats=m.unescapeHTML($data_myCatList.html());
	let levels=cat.split("--");
	let pre="\n";
	let start0=0;
	let start=0;
	let end=fullCats.length;
	let subStr="";
	for (let j=0;j<levels.length;j++) {
		subStr=fullCats.substring(start,end);
		let toFind=pre+levels[j]+"\n";
		let i=subStr.indexOf(toFind);
		if (i===-1) {
			return res;
		} else {
			let ptnEnd=new RegExp(pre.replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"[^\\t\\n]", "g");
			ptnEnd.lastIndex=i+toFind.length-1;
			let matchEnd=ptnEnd.exec(subStr);
			if (matchEnd!==null) {
				end=start+matchEnd.index+1;
			}
			start0=start+i;
			start+=i+toFind.length-1;
			pre+="\t";
		}
	}
	subStr=fullCats.substring(start+1,end);
		// subStr=subCats+"\n"
		// if no subCats, this is empty.
	if (subStr.length===0) {
		fullCats=fullCats.substring(0,start0+1)+fullCats.substring(end); // delete a cat if there is no subCat.
		res=true;
	}
	if (res) { $data_myCatList.html(m.escapeHTML(fullCats)); }
	return res;
};
m.putCats_UriToLists=function (cats, uri) {
	let catSplit=cats.split(";");
	let catIsPut=false;
	for (let i=0;i<catSplit.length;i++) {
		let cat=catSplit[i];
		if (m.myPage) {
			if (m.catUriList[cat]) {
				if (m.catUriList[cat].has) {
					m.catUriList[cat]["UriList"]=uri+"\n"+m.catUriList[cat]["UriList"];
				}
			} else {
				catIsPut=m.putCat(cat)||catIsPut;
				m.catUriList[cat]={cat:cat, down:true, has:true, UriList:uri};
			}
		} else {
			catIsPut=m.putCat(cat)||catIsPut;
		}
	}
	if (catIsPut) {
		if (m.myPage) { $change_catList_order_cancel.trigger("click"); }
		m.updateCatFS();
	}
};
m.delCats_UriFromLists=function (cats, uri) {
if (m.myPage) {
	let catSplit=cats.split(";");
	let catIsDeleted=false;
	for (let i=0;i<catSplit.length;i++) {
		let cat=catSplit[i];
		if (m.catUriList[cat]&&m.catUriList[cat].has) {
			let fullURIs="\n"+m.catUriList[cat]["UriList"]+"\n";
			let k=fullURIs.indexOf("\n"+uri+"\n");
			if (k!==-1) {
				m.catUriList[cat]["UriList"]=(fullURIs.substring(0,k)+fullURIs.substring(k+uri.length+1)).trim();
			}
			if (m.catUriList[cat]["UriList"].length===0) {
				let c=true;
				while (cat!==null&&c) {
					c=false;
					if (m.catUriList[cat].has&&m.catUriList[cat]["UriList"].length===0) {
						c=m.deleteCat(cat);
						catIsDeleted=catIsDeleted||c;
					}
					cat=m.getSuperCat(cat);
				}
			}
		}
	}
	if (catIsDeleted) {
		$change_catList_order_cancel.trigger("click");
		// Intentionally no m.updateCatFS();
	}
}};
m.catsChangedOnUri=function (oldCats, newCats, uri) {
if (uri&&uri.constructor===String&&oldCats!==null&&oldCats!==undefined&&oldCats.constructor===String&&newCats!==null&&newCats!==undefined&&newCats.constructor===String) {
	let oldCatSplit=oldCats.split(";");
	let newCatSplit=newCats.split(";");
	let o=[];
	let n=[];
	for (let i=0;i<oldCatSplit.length;i++) {
		o[oldCatSplit[i]]=true;
	}
	newCats="";
	for (let i=0;i<newCatSplit.length;i++) {
		if (o[newCatSplit[i]]) {
			o[newCatSplit[i]]=false;
			n[newCatSplit[i]]=false;
		} else {
			newCats+=newCatSplit[i]+";";
			n[newCatSplit[i]]=true;
		}
	}
	oldCats="";
	for (let p in o) {
		if (o[p]) { oldCats+=p+";"; }
	}
	if (oldCats.length>0) {
		m.delCats_UriFromLists(oldCats.substring(0,oldCats.length-1), uri);
	}
	if (newCats.length>0) {
		m.putCats_UriToLists(newCats.substring(0,newCats.length-1), uri);
	}
}};



/* Renderings */
////////////////////////////////////////////////////
// URI rendering :: http link itself, videos, images, maps.
////////////////////////////////////////////////////
m.uriToA=function (uri) {
	if (!uri||uri.constructor!==String) { return ""; }
	let exec=m.ptnURL.exec(uri);
	if (exec!==null) {
		return '<a target="_blank" href="'+exec[0]+'">'+m.escapeHTML(decodeURIComponent(uri))+'</a>';
	} else {
		return m.escapeHTML(uri);
	}
};
m.zIndex=10000;
m.togglePosition=function (elem) {
	let $elem=$(elem);
	let $parent=$elem.parent().parent();
	if ($parent.hasClass("fixed")) {
		$parent.removeClass("fixed");
		$parent.css("z-index", 0);
		window.scrollTo(0, $parent.offset().top);
		$elem.text("▲ [--stick to the left top--]");
	} else {
		$parent.addClass("fixed");
		$parent.css("z-index", m.zIndex--);
		window.scrollBy(0, -$parent.height());
		$elem.text("▲ [--return to the original position--]");
	}
};
m.rC=function (elemStr, pb) {
	if (pb&&pb.constructor===Number) {
		if (pb>200) {
			pb=200;
		} else if (pb<20) {
			pb=20;
		}
	} else {
		pb=null;
	}
	return '<div class="rC">'
		+'<div class="rSC"'+(pb?' style="padding-bottom:'+pb+'%"':'')+'>'
			+elemStr
		+'</div>'
		+(pb&&pb>70?'':'<div class="pc"><span onclick="m.togglePosition(this)">▲ [--stick to the left top--]</span></div>')
	+'</div>';
};
m.uriRendering=function (uri, toA) {
	if (uri&&uri.constructor===String) {
		if (uri.substring(0,4).toLowerCase()==="http") {
			let k=4;
			if (uri.charAt(k).toLowerCase()==='s') {
				k++;
			}
			if (uri.substring(k,k+3)==="://") {
				k+=3;
				let l=uri.indexOf('/',k);
				let uriHost=null;
				let uriRest='';
				if (l===-1) {
					uriHost=uri.substring(k);
				} else {
					uriHost=uri.substring(k,l);
					uriRest=uri.substring(l+1);
				}
				if (m.ptnURI[uriHost]) {
					let result=m.ptnURI[uriHost].toIframe(uriRest);
					if (result) { return result; }
				}
			}
		}
		for (let i=0;i<m.ptnURI.length;i++) {
			let result=m.ptnURI[i].toIframe(uri);
			if (result) { return result; }
		}
	}
	return {html:(toA?m.uriToA(uri):"")};
};

m.YTiframe=function (v, vars) {
	return m.rC('<iframe delayed-src="https://www.youtube.com/embed/'+v+'" frameborder="0" allowfullscreen=""></iframe>');
};

let ptnURI;
ptnURI=m.ptnURI["www.youtube.com"]={};
ptnURI.regEx=/^(?:watch|embed\/([\w-]+))(\?\S+)?/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["www.youtube.com"].regEx.exec(uriRest);
	if (exec!==null) {
		let vars=null;
		if (exec[2]) { vars=m.getSearchVars(exec[2]); }
		let v=null;
		if (exec[1]) {
			v=exec[1];
		} else if (vars&&vars.v) {
			v=vars.v.val;
		}
		if (v) {
			return {html:m.YTiframe(v,vars), from:"youtube", videoId:v};
		}
	}
	return false;
};

ptnURI=m.ptnURI["youtube.com"]={};
ptnURI.regEx=/^shorts\/([\w-]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["youtube.com"].regEx.exec(uriRest);
	if (exec!==null) {
		let v=exec[1];
		if (v) {
			return {html:m.YTiframe(v,null), from:"youtube", videoId:v};
		}
	}
	return false;
};

ptnURI=m.ptnURI["youtu.be"]={};
ptnURI.regEx=/^([\w-]+)(\?\S+)?/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["youtu.be"].regEx.exec(uriRest);
	if (exec!==null) {
		let vars=null;
		if (exec[2]) {
			vars=m.getSearchVars(exec[2]);
		}
		return {html:m.YTiframe(exec[1],vars), from:"youtube", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["m.youtube.com"]={};
ptnURI.regEx=/^watch(\?\S+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["m.youtube.com"].regEx.exec(uriRest);
	if (exec!==null) {
		let vars=m.getSearchVars(exec[1]);
		if (vars.v&&vars.v.val) {
			return {html:m.YTiframe(vars.v.val,vars), from:"youtube", videoId:vars.v.val};
		}
	}
	return false;
};

ptnURI=m.ptnURI["tv.naver.com"]={};
ptnURI.regEx=/^(?:v|embed)\/([0-9]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["tv.naver.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC(`<iframe delayed-src="https://tv.naver.com/embed/${exec[1]}?autoPlay=false" frameborder='no' scrolling='no' marginwidth='0' marginheight='0' allowfullscreen></iframe>`), from:"naver", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["www.vlive.tv"]={};
ptnURI.regEx=/^(?:video|embed)\/([0-9]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["www.vlive.tv"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC(`<iframe src='https://vlive.tv/embed/${exec[1]}?autoPlay=false' frameborder='no' scrolling='no' marginwidth='0' marginheight='0' allowfullscreen></iframe>`), from:"vlive", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["vlive.tv"]={};
ptnURI.regEx=/^(?:video|embed)\/([0-9]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["vlive.tv"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC(`<iframe src='https://vlive.tv/embed/${exec[1]}?autoPlay=false' frameborder='no' scrolling='no' marginwidth='0' marginheight='0' allowfullscreen></iframe>`), from:"vlive", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["tv.kakao.com"]={};
ptnURI.regEx=/(?:v|cliplink)\/([0-9]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["tv.kakao.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="https://play-tv.kakao.com/embed/player/cliplink/'+exec[1]+'" frameborder="0" scrolling="no" allowfullscreen></iframe>'), from:"kakao", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["entertain.daum.net"]={};
ptnURI.regEx=/video\/([0-9]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["entertain.daum.net"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="https://play-tv.kakao.com/embed/player/cliplink/'+exec[1]+'" frameborder="0" scrolling="no" allowfullscreen></iframe>'), from:"kakao", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["tvpot.daum.net"]={};
ptnURI.regEx=/^v\/([\w-]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["tvpot.daum.net"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="http://videofarm.daum.net/controller/video/viewer/Video.html?vid='+exec[1]+(exec[1].length<15?'$':'')+'&play_loc=undefined" frameborder="0" scrolling="no"></iframe>'), from:"daum", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["videofarm.daum.net"]={};
ptnURI.regEx=/^controller\/video\/viewer\/Video\.html(\?\S+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["videofarm.daum.net"].regEx.exec(uriRest);
	if (exec!==null) {
		let vars=m.getSearchVars(exec[1]);
		return {html:m.rC('<iframe delayed-src="http://videofarm.daum.net/controller/video/viewer/Video.html?vid='+vars.vid.val+'&play_loc='+vars.play_loc.val+'" frameborder="0" scrolling="no"></iframe>'), from:"daum", videoId:vars.vid.val};
	}
	return false;
};

ptnURI=m.ptnURI["vimeo.com"]={};
ptnURI.regEx=/^([0-9]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["vimeo.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="http://player.vimeo.com/video/'+exec[1]+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>'), from:"vimeo", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["www.dailymotion.com"]={};
ptnURI.regEx=/video\/(\w+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["www.dailymotion.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="http://www.dailymotion.com/embed/video/'+exec[1]+'" frameborder="0" allowfullscreen></iframe>'), from:"dailymotion", videoId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI["www.ted.com"]={};
ptnURI.regEx=/^talks\//i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["www.ted.com"].regEx.exec(uriRest);
	if (exec!==null) {
		uriRest=uriRest.substring(6);
		let k=uriRest.indexOf("?");
		let vars=null;
		if (k!==-1) {
			vars=m.getSearchVars(uriRest.substring(k));
			uriRest=uriRest.substring(0,k);
		}
		let v=uriRest;
		if (vars&&vars.language) {
			uriRest="lang/"+vars.language.val+"/"+uriRest;
		}
		return {html:m.rC(`<iframe delayed-src="https://embed.ted.com/talks/${uriRest}" frameborder="0" scrolling="no" allowfullscreen></iframe>`), from:"ted", videoId:v};
	}
	return false;
};

ptnURI=m.ptnURI["embed.ted.com"]={};
ptnURI.regEx=/^talks\//i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["embed.ted.com"].regEx.exec(uriRest);
	if (exec!==null) {
		uriRest=uriRest.substring(6);
		let v=uriRest.replace(/^lang\/\w+\//i,"").replace(/\.html$/i,"");
		return {html:m.rC(`<iframe delayed-src="https://embed.ted.com/talks/${uriRest}" frameborder="0" scrolling="no" allowfullscreen></iframe>`), from:"ted", videoId:v};
	}
	return false;
};

ptnURI=m.ptnURI["w.soundcloud.com"]={};
ptnURI.regEx=/^player\/(\?\S+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["w.soundcloud.com"].regEx.exec(uriRest);
	if (exec!==null) {
		let vars=m.getSearchVars(exec[1]);
		let lastPath="player/?";
		for (let i=0;i<vars.length;i++) {
			if (vars[i].key==="auto_play") {
				lastPath+="auto_play=false&";
			} else {
				lastPath+=vars[i].key+"="+vars[i].val+"&";
			}
		}
		return {html:m.rC('<iframe delayed-src="https://w.soundcloud.com/'+lastPath.substring(0,lastPath.length-1)+'" scrolling="no" frameborder="no"></iframe>',40), from:"soundcloud", videoId:vars.url&&vars.url.val};
	}
	return false;
};

ptnURI=m.ptnURI["instagram.com"]=m.ptnURI["www.instagram.com"]={};
ptnURI.regEx=/^(?:p|tv)\/([\w-]+)/i;
ptnURI.toIframe=function (uriRest) {
	let exec=m.ptnURI["instagram.com"].regEx.exec(uriRest);
	if (exec!==null) {
		return {html:m.rC('<iframe delayed-src="https://instagram.com/p/'+exec[1]+'/embed" frameborder="0" scrolling="no" allowtransparency="true"></iframe>', 130), from:"insta", imgId:exec[1]};
	}
	return false;
};

ptnURI=m.ptnURI[0]={};
ptnURI.regEx=/^https?:\/\/\S+\.(?:jpg|jpeg|bmp|gif|png|webp|svg|tif)(?=$|\?|\s)/i;
ptnURI.toIframe=function (uri) {
	let exec=m.ptnURI[0].regEx.exec(uri);
	if (exec!==null) {
		return {html:'<div class="center"><img delayed-src="'+exec[0]+'"/></div>'};
	}
	return false;
};

ptnURI=m.ptnURI[1]={};
ptnURI.regEx=/^https?:\/\/\S+\.(?:mp4|ogg|webm)(?=$|\?|\s)/i;
ptnURI.toIframe=function (uri) {
	let exec=m.ptnURI[1].regEx.exec(uri);
	if (exec!==null) {
		return {html:m.rC('<video controls preload="auto" delayed-src="'+exec[0]+'"></video>'), from:'video', src:exec[0]};
	}
	return false;
};

////////////////////////////////////////////////////
// desc and cmt rendering
////////////////////////////////////////////////////
m.slideToggle=function (elem) {
	let $elem=$(elem);
	$elem.addClass("disabled");
	$elem.parent().next().slideToggle(1000);
	setTimeout(function () {
		$elem.removeClass("disabled");
	}, 1000);
};
m.slideUp=function (elem) {
	let $elem=$(elem).parent().parent();
	$elem.slideUp(1000);
	window.scrollBy(0,-$elem.outerHeight());
	// $body.animate({scrollTop:'-='+$elem.height()}, 1000);
};
m.renderStrDescCmt=function (str) {
	let res=[];
	str=str.trim();
	let key="#";
	let i=0;
	let start=0;
	let exec;
	while ((exec=m.ptnDescCmt.exec(str))!==null) {
		res[i++]=key;
		res[key]=str.substring(start, exec.index).trim();
		start=m.ptnDescCmt.lastIndex;
		key=exec[1];
	}
	res[i++]=key;
	res[key]=str.substring(start).trim();
	return res;
};



/* Points */
////////////////////////////////////////////////////
// val, points, stars
////////////////////////////////////////////////////
m.val=function (val) {
	let res={};
	res.str=val;
	if (val.length===0) {
		res.valid=true;
		res.val=-1;
	} else {
		let exec=m.ptnVal.exec(val);
		if (exec!==null) {
			res.num=Number(exec[1]);
			res.divisor=Number(exec[2])
			res.valid=(res.num>=0&&res.num<=res.divisor);
			if (res.valid) {
				res.val=res.num/res.divisor;
			} else {
				res.val=-1;
			}
		}
	}
	return res;
};
{
	let r=12; // outer radius of star
	let r0=6; // inner radius of star
	let pad=1; // padding of star
	let pad0=9; // left/right pad
	let thetas=[];
	let coss=[];
	let sins=[];
	for (let i=0;i<10;i++) {
		thetas.push(-Math.PI/2+2*Math.PI/10*i);
		coss.push(Math.cos(thetas[i]));
		sins.push(Math.sin(thetas[i]));
	}
	let str=pad0+',0 ';
	let yc=pad+r;
	let xc=pad0+pad+r;
	for (let k=0;k<5;k++,xc+=2*r+pad) {
		str+=xc+',0 ';
		for (let i=0;i<10;i++) {
			let rp=(i%2==0)?r:r0;
			str+=(xc+rp*coss[i]).toFixed(1)+','+(yc+rp*sins[i]).toFixed(1)+' ';
		}
		str+=xc+','+pad+' '+xc+',0 ';
	}
	xc-=r;
	yc+=r*sins[4]+pad;
	str+=xc+',0 '+xc+','+yc.toFixed(1)+' '+pad0+','+yc.toFixed(1);
	m["5stars-pre"]='<div class="stars-container" style="width:'+(xc+pad0)+'px; height:'+yc.toFixed(1)+'px"><div class="bar" style="left:'+(pad0+1)+'px; width:';
	m["5stars-width"]=xc-pad0-2;
	m["5stars-pad0+1"]=pad0+1;
	m["5stars-post"]='px"></div><svg class="out-stars">'
			+'<polygon points="'+str+'"/>'
		+'</svg></div>';
	m["5stars"]=function (val) {
		if (val<0) { val=0; }
		else if (val>1) { val=1; }
		return m["5stars-pre"]+(m["5stars-width"]*val).toFixed(1)+m["5stars-post"];
	}
}

////////////////////////////////////////////////////
// Point range
////////////////////////////////////////////////////
$show_recos_without_points.on("click", function (e) {
	if ($show_recos_without_points.hasClass("enabled")) {
		$show_recos_without_points.removeClass("enabled");
		m.showRWOP=false;
	} else {
		$show_recos_without_points.addClass("enabled");
		m.showRWOP=true;
	}
	clearTimeout(m.timeOutRange);
	m.timeOutRange=setTimeout(function () {
		m.getUriListAndShowRecosOnCat(m.currentCat);
	}, 500);
});
m.PRtoFixed=function (w) {
	return (m.PRmax*(w-15)/(m.PRw-30)).toFixed(1);
};
m.mmInPR=function (e) {
	window.getSelection().removeAllRanges();
	e.preventDefault();
	e.stopPropagation();
	let x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
	let w=x-$point_range.offset().left+$window.scrollLeft();
	w=(w>15)?w:15;
	w=(w<m.PRw-15)?w:m.PRw-15;
	let changed=false;
	if (m.mdInPRL) {
		if (w>m.PRRw) { w=m.PRRw; }
		if (m.PRLw!==w) {
			$point_range_left.css({left:w-15});
			$point_range_bar.css({left:w});
			m.PRLw=w;
			changed=true;
		}
	} else {
		if (w<m.PRLw) { w=m.PRLw; }
		if (m.PRRw!==w) {
			$point_range_right.css({left:w-5});
			$point_range_bar.css({right:m.PRw-w});
			m.PRRw=w;
			changed=true;
		}
	}
	if (changed) {
		let PRL=m.PRtoFixed(m.PRLw);
		let PRR=m.PRtoFixed(m.PRRw);
		$point_range_result.html(PRL+"~"+PRR+" / "+m.PRmax);
		PRL=Number(PRL)/m.PRmax;
		PRR=Number(PRR)/m.PRmax;
		if (m.ptsRangeFrom!==PRL||m.ptsRangeTo!==PRR) {
			m.ptsRangeFrom=PRL;
			m.ptsRangeTo=PRR;
			m.docCookies.setItem("PRL", PRL, Infinity, "/");
			m.docCookies.setItem("PRR", PRR, Infinity, "/");
			clearTimeout(m.timeOutRange);
			m.timeOutRange=setTimeout(function () {
				m.getUriListAndShowRecosOnCat(m.currentCat);
			}, 1024);
		}
	}
};
$point_range_left.on("mousedown touchstart", function (e) {
	m.mdInPRL=true;
	$html.on("mousemove.mdInPR touchmove.mdInPR", m.mmInPR);
	$html.on("mouseup.mdInPR touchend.mdInPR", function (e) {
		m.mdInPRL=false;
		$html.off("mouseup.mdInPR touchend.mdInPR mousemove.mdInPR touchmove.mdInPR");
	});
});
$point_range_right.on("mousedown touchstart", function (e) {
	m.mdInPRR=true;
	$html.on("mousemove.mdInPR touchmove.mdInPR", m.mmInPR);
	$html.on("mouseup.mdInPR touchend.mdInPR", function (e) {
		m.mdInPRR=false;
		$html.off("mouseup.mdInPR touchend.mdInPR mousemove.mdInPR touchmove.mdInPR");
	});
});

////////////////////////////////////////////////////
// Show recos
////////////////////////////////////////////////////
m.recoHTML=function (r, uriRenderDisable, inRange) {
	let res="";
	if (r&&r["has"]) {
		res+=`<div class="reco${inRange?'':' none'}">`
			+'<a class="SNS-img" style="background-image:url(\'/icon-Twitter.png\')" target="_blank" href="https://twitter.com/intent/tweet?text='+encodeURIComponent(r.title)+'&url='+encodeURIComponent(r.uri)+'"></a><a class="SNS-img" style="background-image:url(\'/icon-Facebook.png\')" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(r.uri)+'"></a>'
			+(m.myIndex?'<div class="button edit fRight" onclick="m.editOrRecoToMine(this)">'+(m.myPage?'Edit':'Reco to mine')+'</div>':'')
			+'<div class="textURI">'+m.escapeHTML(r.uri)+'</div>'
			+'<div class="uri cBoth">'+m.uriToA(r.uri)+'</div>'
			+'<div class="title">'+m.escapeHTML(r.title)+'</div>'
			+'<div class="cats">'+m.catsToA(r.cats)+'</div>'
			+(uriRenderDisable?"":m.uriRendering(r.uri).html);
		if (r["desc"]) {
			let descR=r["descR"];
			res+='<div class="desc">';
			for (let l=0;l<descR.length;l++) {
				let key=m.escapeHTML( descR[l] );
				let value=m.escapeHTML( descR[descR[l]] );
				switch (key.toLowerCase()) {
				case "#" : case "" :
					res+='<div class="value">'+value.replace(/\n/g,"<br>")+'</div>';
					break;
				case "lyrics" : case "lyric" : case "가사" :
					res+='<div class="value"><div class="center"><div class="button" onclick="m.slideToggle(this)">▼ Toggle lyrics</div></div>'
						+'<div class="lyricsC" style="display:none">'
							+'<div class="lyricsArrow"></div>'
							+'<div class="lyrics">'+value.replace(/\n/g,"<br>")+'</div>'
							+'<div class="right"><div class="button" onclick="m.slideUp(this)">▲ Hide lyrics</div></div>'
						+'</div></div>';
					break;
				case "related" :
					res+='<div class="value"><span class="key">#'+key+'</span>';
					let relateds=value.split("\n");
					for (let p=0;p<relateds.length;p++) {
						res+='<br>'+m.uriRendering(m.formatURI(relateds[p]),true).html;
					}
					res+='</div>';
					break;
				default :
					res+='<div class="value"><span class="key">#'+key+' </span>'+value.replace(/\n/g,"<br>")+'</div>';
				}
			}
			res+='</div>';
		}
		res+=(r["cmt"].length!==0?('<div class="cmt">'+m.escapeHTML( r["cmt"] ).replace(/\n/g,"<br>")+'</div>'):"");
		if (r["val"].str) {
			res+='<div class="val">'+m["5stars"]( r["val"].val )+' <span class="str">'+m.escapeHTML( r["val"].str )+'</span></div>';
		}
		res+='<div class="tFirst">Firstly Recoed at '+r.tFirst+'</div><div class="cBoth"></div>';
		if (r.tFirst!==r.tLast) {
			res+='<div class="tLast">Lastly Editted at '+r.tLast+'</div><div class="cBoth"></div>';
		}
		if (m.myPage) {
			res+='<div class="my-point">'+m["5stars"]( r["val"].val )+' <span class="str">'+m.escapeHTML( r["val"].str )+'</span></div>';
		} else if (m.myRecos[r.uri]) {
			let mR=m.myRecos[r.uri];
			if (mR.has) {
				res+='<div class="my-point">'+m["5stars"]( mR["val"].val )+' <span class="str">'+m.escapeHTML( mR["val"].str )+'</span></div>';
			} else {
				res+='<div class="my-point">'+m["5stars"](0)+' <span class="str"> </span></div>';
			}
		}
		res+='</div>';
	} else {
		res+='<div class="reco">No Reco</div>';
	}
	return res;
};
m.reco_pointChange_do=function (args, err) {
	if (err) {
		return;
	}
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).fail(function (resp) {
		// $error.html("Failed change. You may not be logged-in. "+resp);
	}).done(function (resp) {
		let res=m.strToJSON(resp);
		let uri=args.uri;
		if (res[1]&&res[1]["result"]==="changed") {
			let val=m.myRecos[uri].val=m.val(args.valStr);
			let fs=m.fsTitle;
			if (m.myPage&&val.valid&&fs.fullList[uri].$listI) {
				fs.fullList[uri].$listI.find(".val .bar").css({width:m["5stars-width"]*val.val});
			}
		}
	});
};
m.showRecosOnCat=function (elem, from) {
	let fs=m.fsTitle;
	let l=fs.fullList.length;
	let strHTML="";
	if (l<=0) {
		let nOfRecos='No reco on cat='+m.escapeHTML(m.currentCat)+'.';
		$numbers_of_recos.html(nOfRecos);
		strHTML='<div class="numbers-of-recos">'+nOfRecos+'</div>';
		$contents.html(strHTML);
	} else {
		if (elem===undefined||elem===null) {
			from=l-1;
			let nHiden=0, nShown=0;
			for (let k=0;k<l;k++) {
				let fsFLk=fs.fullList[k];
				let uri=fsFLk.uri;
				let r=fsFLk.reco;
				let val=r.val.val;
				let titleSH=m.splitHangul(r.title);
				fsFLk.txt=titleSH;
				fsFLk.html=m.escapeHTML(r.title);
				if (val===undefined||val===-1) {
					if (m.showRWOP) {
						fsFLk.inRange=true;
						nShown++;
					} else {
						fsFLk.inRange=false;
						nHiden++
					}
				} else {
					if (m.ptsRangeFrom<=val&&val<=m.ptsRangeTo) {
						fsFLk.inRange=true;
						nShown++;
					} else {
						fsFLk.inRange=false;
						nHiden++;
					}
				}
			}
			if (!m.myPage&&$hide_recoed_ones.hasClass("enabled")) {
				for (let k=0;k<l;k++) {
					let fsFLk=fs.fullList[k];
					let uri=fsFLk.uri;
					if (m.myRecos[uri].has) {
						if (fsFLk.inRange) {
							nShown--;
							nHiden++;
						}
						fsFLk.inRange=false;
					}
				}
			}
			let nOfRecos='You have '+l+' recos ('+nShown+' to be shown, and '+nHiden+' hiden.) on cat='+m.escapeHTML(m.currentCat)+'.';
			$numbers_of_recos.html(nOfRecos);
			strHTML+='<div class="numbers-of-recos">'+nOfRecos+'</div>';
			for (let i=from, k=0;i>=0;i-=m.maxShowReco, k++) {
				strHTML+=`<div id="load-recos-${k}" class="button to-be-executed" onclick="m.showRecosOnCat(this,${i})">Load more... <span class="from">${i}</span> to <span class="to">${i-m.maxShowReco+1>=0?i-m.maxShowReco+1:0}</span></div>`;
			}
			$contents.html(strHTML);
		} else {
			if (from!==undefined&&from!==null&&from.constructor===Number) {
				for (let i=from, k=0;i>=0&&k<m.maxShowReco;i--, k++) {
					let fsFLi=fs.fullList[i];
					let r=fsFLi.reco;
					strHTML+=m.recoHTML(r, false, fsFLi.inRange);
				}
			}
			$(elem).replaceWith(strHTML);
			let $stars=$contents.find(".my-point>.stars-container");
			$stars.on("mousedown.mdInStars touchstart.mdInStars", function (e) {
				let $target=$(e.target);
				if (!$target.hasClass("stars-container")) {
					$target=$target.parents(".stars-container");
				}
				let uri=m.unescapeHTML($target.parents(".reco").find(".textURI").html());
				clearTimeout(m.timeout[uri]);
				let $bar=$target.find(".bar");
				let barW=$bar.width();
				let $str=$target.siblings(".str");
				$html.on("mousemove.mdInStars touchmove.mdInStars", function (e) {
					window.getSelection().removeAllRanges();
					e.preventDefault();
					e.stopPropagation();
					let x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
					let w=x-$bar.offset().left+$window.scrollLeft();
					if (w<-15) {
						w=-1;
					} else if (w<0) {
						w=0;
					} else if (w>m["5stars-width"]) {
						w=m["5stars-width"];
					}
					if (w!==barW) {
						barW=w;
						if (w<0) {
							$str.html("");
							w=0;
						} else {
							$str.html(m.escapeHTML((w/m["5stars-width"]*m.fullPts).toFixed(1)+"/"+m.fullPts));
						}
						$bar.css({width:w});
					}
				});
				$html.on("mouseup.mdInStars touchend.mdInStars", function (e) {
					$html.off("mouseup.mdInStars touchend.mdInStars mousemove.mdInStars touchmove.mdInStars");
					m.timeout[uri]=setTimeout(function () {
						let valStr=$str.html();
						if (m.myPage) {
							if (!(m.myRecos[uri].val&&m.myRecos[uri].val.str===valStr)) {
								let strHeads="do\turi\tval";
								let strContents="change\t"+m.encloseStr(uri)+"\t"+m.encloseStr(valStr);
								m.rmb_me(m.reco_pointChange_do, {strHeads, strContents, uri, valStr});
							}
						} else {
							if (m.myRecos[uri]&&m.myRecos[uri].has) {
								if (!(m.myRecos[uri].val&&m.myRecos[uri].val.str===valStr)) {
									let strHeads="do\turi\tval";
									let strContents="change\t"+m.encloseStr(uri)+"\t"+m.encloseStr(valStr);
									m.rmb_me(m.reco_pointChange_do, {strHeads, strContents, uri, valStr});
								}
							} else {
								let strHeads="do\turi";
								let strContents="reco\t"+m.encloseStr(uri);
								strHeads+="\tval";
								strContents+="\t"+valStr;
								let uR=m.userRecos[uri];
								if (uR.title) {
									strHeads+="\ttitle";
									strContents+="\t"+m.encloseStr(uR.title);
								}
								if (uR.desc) {
									strHeads+="\tdesc";
									strContents+="\t"+m.encloseStr(uR.desc);
								}
								strHeads+="\tcats";
								strContents+="\t"+m.encloseStr(m.formatCats($multireco_input_cats[0].value.trim()));
								let strRecoDo=strHeads+"\n"+strContents;
								m.rmb_me(m.reco_do, {strRecoDo, uri});
							}
						}
					}, 5000);
				});
			});
		}
	}
	let $recos=$contents.find(".reco");
	for (let i=0;i<$recos.length;i++) {
		let uri=m.unescapeHTML($recos.eq(i).find(".textURI").html());
		if (!fs.fullList[uri]) {
			fs.fullList[uri]={};
		}
		fs.fullList[uri].$listI=$recos.eq(i);
	}
	m.delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
	$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
	$window.trigger("scroll.delayedLoad");
	m.fdList=$("#sidebar, #head, #contents .reco, #foot");
	fs[0].ptnSH=m.splitHangul("$!@#");
	fs.$fs.trigger("keyup");
};
m.editOrRecoToMine=function (elem) {
	let $reco=$(elem).parent(".reco");
	let uri=m.unescapeHTML($reco.find(".textURI").html());
	let r=m.userRecos[uri];
	$input_uri[0].value=r["uri"];
	$input_uri[0].disabled=true;
	$new_reco.show();
	if (uri.length!==0&&uri!==m.lastURI) {
		m.getAndShowDefsAndReco(true);
	}
	m.wST=$window.scrollTop();
	$window.on("scroll.stop", function (e) {
		$window.scrollTop(m.wST);
	});
};
m.recoDowned=function (urisStr, recos) {
	let uris=urisStr.split("\n");
	for (k=0;k<uris.length;k++) {
		let uri=uris[k];
		let p=recos[uri];
		if (!p) { p=recos[uri]={}; }
		p.down=true;
	}
};
m.recoToEve=function (resp, recos) {
	resp=m.strToJSON(resp);
	for (let k=1;k<resp.length;k++) {
		let recoK=resp[k];
		let uri=recoK["uri"];
		let p=recos[uri];
		if (!p) { p=recos[uri]={}; }
		p["has"]=true;
		for (let prop in recoK) {
			if (isNaN(prop)) {
				p[prop]=recoK[prop];
			}
		}
		if (p.desc!==undefined) {
			p.descR=m.renderStrDescCmt(p.desc); // R for rendered.
		}
		if (p.cmt!==undefined) {
			p.cmtR=m.renderStrDescCmt(p.cmt); // R for rendered.
		}
		if (p.val!==undefined) {
			p.val=m.val(p.val);
		}
	}
};
m.getAndShowRecosOnCat=function (cat) {
	let uriList=(m.catUriList[cat].has?m.catUriList[cat].UriList:"").trim();
	let uris=[];
	if (uriList.length!==0) { uris=uriList.split("\n"); }
	let getRecosStr="uri";
	let getRecosN=0;
	let fs=m.fsTitle;
	let fs1=m.fsToRs;
	let fsFL=fs.fullList=[];
	let fs1FL=fs1.fullList=[];
	fsFL.cat=cat;
	fs1FL.cat=cat;
	for (let i=0;i<uris.length;i++) {
		let uri=uris[i];
		let r=m.userRecos[uri];
		if (!r) { r=m.userRecos[uri]={}; }
		fsFL[uris.length-1-i]=fsFL[uri]
		=fs1FL[uris.length-1-i]=fs1FL[uri]
		={i:uris.length-1-i, uri:uri, reco:r};
		if (!r.down) {
			getRecosStr+="\n"+uri;
			getRecosN++;
		}
	}
	if (getRecosN>0) {
		$.ajax({
			type:"POST", url:m.pathName+"/get-Recos", data:getRecosStr
			, dataType:"text"
		}).done(function (resp) {
			m.recoDowned(getRecosStr.substring(4), m.userRecos);
			m.recoToEve(resp, m.userRecos);
			m.showRecosOnCat();
			m.fsToRs.prepareRecoListPlay();
			fs[1]=null;
			fs[0].ptnSH=m.splitHangul("$!@#");
			fs.$fs.trigger("keyup");
			fs1[1]=null;
			fs1[0].ptnSH=m.splitHangul("$!@#");
			fs1.$fs.trigger("keyup");
		});
	} else {
		m.showRecosOnCat();
		m.fsToRs.prepareRecoListPlay();
		fs[1]=null;
		fs[0].ptnSH=m.splitHangul("$!@#");
		fs.$fs.trigger("keyup");
		fs1[1]=null;
		fs1[0].ptnSH=m.splitHangul("$!@#");
		fs1.$fs.trigger("keyup");
	}
};
m.getUriListAndShowRecosOnCat=function (cat) {
	$contents.html("Loading recos in cat="+m.escapeHTML(cat)+"...");
	let catList=m.catList[cat];
	if (catList) {
		$catList.find(".cat").removeClass("selected");
		let $cat=$("#cat-"+catList.i);
		$cat.addClass("selected");
		let $parents=$cat.parents(".subCat");
		for (let i=$parents.length-1;i>=0;i--) {
			if (!$parents.eq(i).is(":visible")) {
				$parents.eq(i).prev().find(">.EC").trigger("click");
			}
		}
		let catUriList=m.catUriList[cat];
		if (!catUriList) { catUriList=m.catUriList[cat]={}; }
		if (catUriList.down) {
			m.getAndShowRecosOnCat(cat);
		} else {
			let getUriListStr="cat\n"+(cat===""?"\tp":cat);
			$.ajax({
				type:"POST", url:m.pathName+"/get-UriList", data:getUriListStr
				, dataType:"text"
			}).fail(function () {
				$contents.html("get-UriList on "+m.escapeHTML(cat)+" has failed..");
			}).done(function (resp) {
				catUriList.down=true;
				resp=m.strToJSON(resp);
				for (let i=1;i<resp.length;i++) {
					let catUL=m.catUriList[resp[i].cat];
					catUL.down=true;
					catUL.has=true;
					for (let p in resp[i]) {
						if (isNaN(p)) {
							catUL[p]=resp[i][p];
						}
					}
				}
				m.getAndShowRecosOnCat(cat);
			});
		}
	} else {
		$contents.html("Category \""+m.escapeHTML(cat)+"\" does not exist.");
	}
};
m.refresh=function (cats, option, uri) {
	let currentCat=m.getSearchVars(window.location.search).cat;
	if (currentCat) { currentCat=currentCat.val; }
	let c=cats.split(";");
	let k=0;
	if (currentCat!==undefined) {
		for (k=c.length-1;k>0;k--) {
			if (c[k]===currentCat) {break;}
		}
	}
	m.currentCat=c[k];
	if (c[k]!==currentCat) {
		m.getUriListAndShowRecosOnCat(c[k]);
		window.history.pushState({cat:c[k]}, null, m.pathOfCat(c[k]));
		$a_log_in.attr("href", "/account/log-in?goto="+escape(m.pathOfCat(c[k])));
	} else {
		switch (option) {
		case "recoed" :
			let $newReco=$( m.recoHTML( m.userRecos[uri], false, true ) );
			$contents.prepend( $newReco );
			m.delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
			$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
			$window.trigger("scroll.delayedLoad");
			m.fdList=m.fdList.add( $newReco );
			break;
		case "changed" : case "deleted" :
			if (uri===m.unescapeHTML($reco_playing.find(".reco>.textURI").html())) {
				if (option==="changed") {
					$reco_playing.html(m.recoHTML(m.userRecos[uri], true, true));
					m.delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
					$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
					$window.trigger("scroll.delayedLoad");
				} else if (option==="deleted") {
					$reco_playing.html('');
				}
			}
			let $recos=$contents.find(">.reco");
			for (let i=0;i<$recos.length;i++) {
				let $reco=$recos.eq(i);
				let recoUri=m.unescapeHTML($reco.find(">.textURI").html());
				if (recoUri===uri) {
					if (option==="changed") {
						let $newReco=$( m.recoHTML( m.userRecos[uri], false, true ) );
						$reco.replaceWith($newReco);
						m.delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
						$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
						$window.trigger("scroll.delayedLoad");
						m.fdList=m.fdList.add( $newReco );
					} else if (option==="deleted") {
						$reco.remove();
					}
					break;
				}
			}
			break;
		default :
			m.getUriListAndShowRecosOnCat(c[k]);
		}
	}
};

m.ExpCol=function (elem, catEC) {
	let $elem=$(elem);
	let $next=$elem.parent().next();
	if ($next.is(":visible")) {
		$next.hide();
		$elem.html("▶");
		catEC.subCatExpanded=false;
	} else {
		$next.show();
		$elem.html("▼");
		catEC.subCatExpanded=true;
	}
};

/////////////////////////////////////////
// Open Cat
/////////////////////////////////////////
m.openCat=function (cat, e) {
	if (e&&e.which===2) {
		return true;
	} else {
		if (window.history.state&&window.history.state.cat===cat) { return false; }
		m.currentCat=cat;
		m.getUriListAndShowRecosOnCat(cat);
		window.history.pushState({cat:cat}, null, m.pathOfCat(cat));
		$a_log_in.attr("href", "/account/log-in?goto="+escape(m.pathOfCat(cat)));
		return false;
	}
};

for (let i=0;i<m.catList.length;i++) {
	let cat=m.catList[i].cat;
	m.catUriList[cat]={cat:cat, down:false};
}

window.onpopstate=function (e) {
	if (e.state&&e.state.cat!==undefined) {
		m.getUriListAndShowRecosOnCat(e.state.cat);
		$a_log_in.attr("href", "/account/log-in?goto="+escape(m.pathOfCat(cat)));
	}
};
m.getSearchVars=function (searchStr) {
	let vars=[];
	if (searchStr!==null&&searchStr!==undefined&&searchStr.length!==0) {
		if (searchStr.substring(0,1)==="?") { searchStr=searchStr.substring(1); }
		let j=searchStr.indexOf("#");
		if (j!==-1) { searchStr=searchStr.substring(0,j); }
		let splits=searchStr.replace(/&amp;/ig,"&").split("&");
		for (let i=0;i<splits.length;i++) {
			let key=splits[i];
			let value="";
			let k=key.indexOf("=");
			if (k!==-1) {
				value=decodeURIComponent(key.substring(k+1));
				key=key.substring(0,k);
			}
			key=decodeURIComponent(key);
			vars[i]=vars[key]={key:key, val:value};
		}
	}
	return vars;
};

////////////////////////////////////////////////////
// New Reco or Edit
////////////////////////////////////////////////////
m.getUTF8Length=function (s) {
	let len=0;
	for (let i=0;i<s.length;i++) {
		let code=s.charCodeAt(i);
		if (code<=0x7f) {
			len+=1;
		} else if (code<=0x7ff) {
			len+=2;
		} else if (code>=0xd800&&code<=0xdfff) {
			// Surrogate pair: These take 4 bytes in UTF-8 and 2 chars in UCS-2
			// (Assume next char is the other [valid] half and just skip it)
			len+=4; i++;
		} else if (code<0xffff) {
			len+=3;
		} else {
			len+=4;
		}
	}
	return len;
};
m.formatURI=function (uri) {
	uri=uri.trim().replace(/[\t\n]/g," ");
	let exec=m.ptnTag.exec(uri);
	if (exec!==null) {
		try {
			let $uri=$(uri);
			let src=$uri.attr("src");
			if (src) {
				uri=src;
			} else {
				src=$uri.find("[src]").attr("src");
				if (src) { uri=src; }
			}
		} catch (err) { console.log(err); }
	}
	return uri.replace(/&amp;/ig,"&").trim();
};
m.formatTitle=function (title) {
	return title.trim().replace(/[\t\r\n]/g," ");
};
m.formatCats=function (cats) {
	if (!cats||cats.constructor!==String||cats.trim().length===0) {
		return "";
	}
	cats=cats.trim().replace(/[\t\r\n]/g," ");
	let list=cats.split(";");
	for (let i=0;i<list.length;i++) {
		let levels=list[i].split("--");
		for (let j=0;j<levels.length;j++) {
			levels[j]=levels[j].replace(/^[\s-]+/,"").replace(/[\s-]+$/,"");
		}
		list[i]="";
		let k=0;
		for (;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]=levels[k];
				break;
			}
		}
		for (k++;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]+="--"+levels[k];
			}
		}
	}
	let catsMap={};
	catsMap[list[0]]=true;
	cats=list[0];
	for (let i=1;i<list.length;i++) {
		if (catsMap[list[i]]) {
		} else {
			catsMap[list[i]]=true;
			cats+=";"+list[i];
		}
	}
	return cats;
};

m.userRecos[""]={
	has:false, down:true, defs:true, title:"", cats:"", desc:"", cmt:"", val:m.val(""), "def-titles":"", "def-cats":""
};
m.showMyReco=function (r) {
	if (r["has"]) {
		$button_reco.hide();
		$button_edit.show();
		$button_del.show();
	} else {
		$button_reco.show();
		$button_edit.hide();
		$button_del.hide();
	}
	let $mR=$("#my-reco");
	$mR.html( m.recoHTML(r, true, true) ); // need to be edit.
	if (r["has"]) {
		let $edit=$mR.find(".button.edit");
		$edit.html("Edit mine");
		$edit.on("click", function (e) {
			$input_title[0].value=r["title"];
			$input_cats[0].value=r["cats"];
			$input_desc[0].value=r["desc"];
			$input_cmt[0].value=r["cmt"];
			$input_val[0].value=r["val"].str;
			$input_val.trigger("keyup");
		});
	}
};
m.showReco=function (r) {
	if (r["has"]) {
		$input_title[0].value=r.title;
		$input_cats[0].value=r.cats;
		$input_desc[0].value=r.desc;
		if (m.myPage) {
			$input_cmt[0].value=r.cmt;
			$input_val[0].value=r.val.str;
		} else {
			$input_cmt[0].value="";
			$input_val[0].value="";
		}
		$input_val.trigger("keyup");
	}
	if (m.myPage) {
		if (r["has"]) {
			$button_reco.hide();
			$button_edit.show();
			$button_del.show();
			$button_back.show();
		} else {
			$button_reco.show();
			$button_edit.hide();
			$button_del.hide();
			$button_back.hide();
		}
	}
};
m.emptifyReco=function () {
	$input_uri[0].value="";
	$input_title[0].value="";
	$input_cats[0].value="";
	$input_desc[0].value="";
	$input_cmt[0].value="";
	$input_val[0].value="";
	$input_val.trigger("keyup");
	m.getAndShowDefsAndReco();
};
m.showDefs=function (r) {
	let defTitles=r["def-titles"].trim().split("\n");
	let defTitlesHTML="";
	for (let i=0;i<defTitles.length;i++) {
		let title=defTitles[i].trim();
		if (title.length!==0) {
			defTitlesHTML+='<div class="def-title">'+m.escapeHTML(title)+'</div>';
		}
	}
	$def_titles.html(defTitlesHTML);
	let $defTitle=$def_titles.find(".def-title");
	$defTitle.on("click", function (e) {
		$defTitle.removeClass("selected");
		let $this=$(this);
		$this.addClass("selected");
		$input_title[0].value=m.unescapeHTML($this.html());
	});

	let defCats=r["def-cats"].trim().split("\n");
	let defCatsHTML='<div class="def-cat">[--Indifferent--]</div> <div class="def-cat">[--Later--]</div> <div id="add-cat" class="def-cat">;</div> <div id="sub-cat" class="def-cat">--</div><br>';
	for (let i=0;i<defCats.length;i++) {
		let cat=defCats[i].trim();
		if (cat.length!==0) {
			defCatsHTML+='<div class="def-cat">'+m.escapeHTML(cat)+'</div> ';
		}
	}
	$def_cats.html(defCatsHTML);
	let $defCat=$def_cats.find(".def-cat");
	$defCat.on("click", function (e) {
		$defCat.removeClass("selected");
		let $this=$(this);
		$this.addClass("selected");
		let cursor=$input_cats[0].selectionStart;
		let val=$input_cats[0].value;
		let inserted=m.unescapeHTML($this.html());
		$input_cats[0].value=`${val.substring(0,cursor)}${inserted}${val.substring(cursor)}`;
		let l=$input_cats[0].value.length;
		$input_cats.focus();
		$input_cats[0].setSelectionRange(cursor+inserted.length,cursor+inserted.length);
	});
};
let $defCat=$multireco_def_cats.find(".def-cat");
$defCat.on("click", function (e) {
	$defCat.removeClass("selected");
	let $this=$(this);
	$this.addClass("selected");
	let cursor=$multireco_input_cats[0].selectionStart;
	let val=$multireco_input_cats[0].value;
	let inserted=m.unescapeHTML($this.html());
	$multireco_input_cats[0].value=`${val.substring(0,cursor)}${inserted}${val.substring(cursor)}`;
	let l=$multireco_input_cats[0].value.length;
	$multireco_input_cats.focus();
	$multireco_input_cats[0].setSelectionRange(cursor+inserted.length,cursor+inserted.length);
});
m.getAndShowDefsAndReco=function (noFormatURI) {
	let elem=$input_uri[0];
	let uri=m.lastURI=noFormatURI?elem.value:m.formatURI(elem.value);
	if (elem.value!==uri) { elem.value=uri; }
	let uriRendered=m.uriRendering(uri,true);
	if (uriRendered.from==="youtube") {
		m.lastURI=uri;
		uri=elem.value=`https://www.youtube.com/watch?v=${uriRendered.videoId}`;
	} else if (uriRendered.from==="insta") {
		m.lastURI=uri;
		uri=elem.value=`https://www.instagram.com/p/${uriRendered.imgId}/`;
	} else if (uriRendered.from==="naver") {
		m.lastURI=uri;
		uri=elem.value=`https://tv.naver.com/v/${uriRendered.videoId}`;
	} else if (uriRendered.from==="vlive") {
		m.lastURI=uri;
		uri=elem.value=`https://www.vlive.tv/video/${uriRendered.videoId}`;
	} else if (uriRendered.from==="kakao") {
		m.lastURI=uri;
		uri=elem.value=`https://tv.kakao.com/v/${uriRendered.videoId}`;
	} else if (uriRendered.from==="ted") {
		m.lastURI=uri;
		uri=elem.value=`https://www.ted.com/talks/${uriRendered.videoId}`;
	} else if (uriRendered.from==="dailymotion") {
		m.lastURI=uri;
		uri=elem.value=`https://www.dailymotion.com/video/${uriRendered.videoId}`;
	}
	$("#show-URI").html(uriRendered.html.replace(/delayed-src/gi,"src"));
	let r=m.userRecos[uri];
	if (!r) { r=m.userRecos[uri]={}; }
	if (r.down) {
		m.showReco(r);
	} else {
		let getRecosStr="uri"+"\n"+uri;
		$.ajax({
			type:"POST", url:m.pathName+"/get-Recos", data:getRecosStr
			, dataType:"text"
		}).done(function (resp) { // User reco 가 없으면 head 만 보냄.
			m.recoDowned(uri, m.userRecos);
			m.recoToEve(resp, m.userRecos);
			m.showReco(r);
		});
	}
	if (r.defs) {
		m.showDefs(r);
	} else {
		m.showDefs({"def-titles":"", "def-cats":""});
		$.ajax({
			type:"POST", url:"/reco/infos", data:uri
			, dataType:"text"
		}).done(function (resp) {
			let defs=m.strToJSON(resp);
			r.defs=true;
			if (defs[1]) {
				r["def-cats"]=defs[1]["def-cats"];
				r["def-titles"]=defs[1]["def-titles"];
				m.showDefs(r);
			}
		});
	}
	if (m.myPage||uri==="") {
		$error.html("");
	} else {
		$error.html("Be careful! This is not your page. On this URI, you have");
		let mR=m.myRecos[uri];
		if (!mR) { mR=m.myRecos[uri]={}; }
		if (mR.down) {
			m.showMyReco(mR);
		} else {
			let getRecosStr="uri"+"\n"+uri;
			$.ajax({
				type:"POST", url:"/user/"+m.myId+"/get-Recos", data:getRecosStr
				, dataType:"text"
			}).done(function (resp) { // User reco 가 없으면 head 만 보냄.
				m.recoDowned(uri, m.myRecos);
				m.recoToEve(resp, m.myRecos);
				m.showMyReco(mR);
			});
		}
	}
};
$new_reco.find("input, textarea").on("keydown.common", function (e) {
	if (e.keyCode===27) { // ESC
		$out_focus.focus();
		$button_close.trigger("click");
	} else if (e.ctrlKey&&e.keyCode===13) { // Ctrl+Enter
		let r=m.myRecos[$input_uri[0].value];
		if (r["has"]) {
			$button_edit.trigger("click");
		} else {
			$button_reco.trigger("click");
		}
	}
});
$input_cats.off("keydown.common");
$input_uri.on("input.rd keyup.rd cut.rd paste.rd click.rd", function (e) {
	let uri=this.value;
	if (uri!==m.lastURI) {
		m.lastURI=uri;
		clearTimeout(m.timeOutGetInfos);
		m.timeOutGetInfos=setTimeout(m.getAndShowDefsAndReco, 1000);
	}
});

m.lastVal=m.val("");
$input_val.after($(m["5stars"](0)).attr({id:"input-val-stars"}));
$input_val_stars=$("#input-val-stars");
$input_val_stars.on("mousedown.mdInStars touchstart.mdInStars", function (e) {
	let $bar=$input_val_stars.find(".bar");
	let barW=$bar.width();
	let $val=$input_val[0];
	$html.on("mousemove.mdInStars touchmove.mdInStars", function (e) {
		window.getSelection().removeAllRanges();
		e.preventDefault();
		e.stopPropagation();
		let x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
		let w=x-$bar.offset().left+$window.scrollLeft();
		if (w<-15) {
			w=-1;
		} else if (w<0) {
			w=0;
		} else if (w>m["5stars-width"]) {
			w=m["5stars-width"];
		}
		if (w!==barW) {
			barW=w;
			if (w<0) {
				$val.value="";
				w=0;
			} else {
				$val.value=(w/m["5stars-width"]*m.fullPts).toFixed(1)+"/"+m.fullPts;
			}
			$bar.css({width:w});
			m.lastVal=m.val($val.value);
		}
	});
	$html.on("mouseup.mdInStars touchend.mdInStars", function (e) {
		$html.off("mouseup.mdInStars touchend.mdInStars mousemove.mdInStars touchmove.mdInStars");
	});
});
$input_val_stars.on("click", function (e) {
	let $bar=$(this).find(".bar");
	let barW=$bar.width();
	let $val=$input_val[0];
	let w=e.clientX-$bar.offset().left+$window.scrollLeft();
	if (w<0) {
		w=0;
	} else if (w>m["5stars-width"]) {
		w=m["5stars-width"];
	}
	if (w!==barW) {
		$bar.css({width:w});
		$val.value=(w/m["5stars-width"]*m.fullPts).toFixed(1)+"/"+m.fullPts;
		m.lastVal=m.val($val.value);
	}
});
$input_val.on("keyup", function (e) {
	if (this.value!==m.lastVal.str) {
		let val=m.val(this.value);
		let $bar=$("#input-val-stars .bar");
		if (val.valid&&val.str.length!==0) {
			m.fullPts=val.divisor;
			$bar.css({width:m["5stars-width"]*val.val});
		} else {
			$bar.css({width:0});
		}
		m.lastVal=val;
	}
});

$button_new_reco.on("click", function (e) {
	$input_uri[0].disabled=false;
	$new_reco.show();
	let cat=m.getSearchVars(window.location.search).cat;
	if (cat) { cat=cat.val; }
	if (cat&&($input_cats[0].value===""||$input_title[0].value===""||$input_uri[0].value==="")) {
		$input_cats[0].value=cat;
	}
	m.wST=$window.scrollTop();
	$window.on("scroll.stop", function (e) {
		$window.scrollTop(m.wST);
	});
	$input_uri.focus();
	$input_uri.trigger("keyup");
});
$button_close.on("click", function (e) {
	$new_reco.hide();
	$window.off("scroll.stop");
});
$button_back.on("click", function (e) {
	let r=m.userRecos[$input_uri[0].value];
	m.showReco(r);
});

m.reco_do=function (args, err) {
	if (err) {
		$error.html("Reco failed. You may be not logged-in. "+err);
		$button_reco.removeClass("disabled");
		return;
	}
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strRecoDo
		, dataType:"text"
	}).fail(function () {
		$error.html("Reco failed. You may be not logged-in.");
		$button_reco.removeClass("disabled");
	}).done(function (resp) {
		let res=m.strToJSON(resp);
		if (res[1]["result"]==="recoed") {
			$error.html("Recoed");
			m.recoDowned(args.uri, m.myRecos);
			m.recoToEve(args.strRecoDo, m.myRecos);
			let cats=m.myRecos[args.uri]["cats"];
			m.putCats_UriToLists(cats, args.uri);
			if (m.myPage) {
				m.refresh(cats, "recoed", args.uri);
			}
			setTimeout(function () {
				m.emptifyReco();
				$button_close.trigger("click");
			}, 1000);
		} else {
			$error.html(res[1]["result"]);
		}
	}).always(function () {
		$button_reco.removeClass("disabled");
	});
};
$button_reco.on("click", function (e) {
	$button_reco.addClass("disabled");
	let uri=m.formatURI($input_uri[0].value);
	let val=m.val($input_val[0].value.trim());
	let errorMsg="";
	let valid=true;
	if (uri.length===0) {
		valid=false;
		errorMsg="URI is required.";
	} else if (m.getUTF8Length(uri)>255) {
		valid=false;
		errorMsg="URI (Length "+m.getUTF8Length(uri)+" &gt; maxUTF8Length 255) is too long.";
	} else if (!val.valid) {
		valid=false;
		errorMsg="Points is of invalid form.";
	}
	if (valid) {
		let strHeads="do\turi";
		let strContents="reco\t"+m.encloseStr(uri);
		strHeads+="\ttitle";
		strContents+="\t"+m.encloseStr(m.formatTitle($input_title[0].value.trim()));
		strHeads+="\tcats";
		strContents+="\t"+m.encloseStr(m.formatCats($input_cats[0].value.trim()));
		strHeads+="\tdesc";
		strContents+="\t"+m.encloseStr($input_desc[0].value.trim());
		strHeads+="\tcmt";
		strContents+="\t"+m.encloseStr($input_cmt[0].value.trim());
		strHeads+="\tval";
		strContents+="\t"+m.encloseStr(val.str);
		let strRecoDo=strHeads+"\n"+strContents;
		$error.html("Being recoed.");
		m.rmb_me(m.reco_do, {strRecoDo, uri});
	} else {
		$error.html(errorMsg);
		$button_reco.removeClass("disabled");
	}
});
m.reco_change_do=function (args, err) {
	if (err) {
		$error.html("Failed change. You may not be logged-in. "+err);
		$button_edit.removeClass("disabled");
		return;
	}
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).fail(function (resp) {
		$error.html("Failed change. You may not be logged-in. "+resp);
	}).done(function (resp) {
		let res=m.strToJSON(resp);
		if (res[1]) {
			if (res[1]["result"]==="changed") {
				$error.html("Changed");
				if (args.cats!==args.r["cats"]) {
					m.catsChangedOnUri(args.r.cats, args.cats, args.uri);
					args.r["cats"]=args.cats;
				}
				if (args.title!==args.r["title"]) { args.r["title"]=args.title; }
				if (args.desc!==args.r["desc"]) {
					args.r["desc"]=args.desc;
					args.r["descR"]=m.renderStrDescCmt(args.desc);
				}
				if (args.cmt!==args.r["cmt"]) {
					args.r["cmt"]=args.cmt;
					args.r["cmtR"]=m.renderStrDescCmt(args.cmt);
				}
				if (args.val.str!==args.r["val"].str) { args.r["val"]=args.val; }
				if (m.myPage) { m.refresh(args.cats, "changed", args.uri); }
				setTimeout(function () {
					m.emptifyReco();
					$button_close.trigger("click");
				}, 1000);
			} else {
				$error.html(res[1]["result"]);
			}
		}
	}).always(function () {
		$button_edit.removeClass("disabled");
	});
};
$button_edit.on("click", function (e) {
	$button_edit.addClass("disabled");
	let uri=$input_uri[0].value;
	let val=m.val($input_val[0].value.trim());
	let r=m.myRecos[uri];
	if (uri.length!==0&&val.valid&&r) {
		let strHeads="do"+"\t"+"uri";
		let strContents="change"+"\t"+m.encloseStr(uri);
		let changed=false;
		let title=m.formatTitle($input_title[0].value.trim());
		if (title!==r["title"]) {
			changed=true;
			strHeads+="\t"+"title";
			strContents+="\t"+m.encloseStr(title);
		}
		let cats=m.formatCats($input_cats[0].value.trim());
		if (cats!==r["cats"]) {
			changed=true;
			strHeads+="\t"+"cats";
			strContents+="\t"+m.encloseStr(cats);
		}
		let desc=$input_desc[0].value.trim();
		if (desc!==r["desc"]) {
			changed=true;
			strHeads+="\t"+"desc";
			strContents+="\t"+m.encloseStr(desc);
		}
		let cmt=$input_cmt[0].value.trim();
		if (cmt!==r["cmt"]) {
			changed=true;
			strHeads+="\t"+"cmt";
			strContents+="\t"+m.encloseStr(cmt);
		}
		if (val.str!==r["val"].str) {
			changed=true;
			strHeads+="\t"+"val";
			strContents+="\t"+m.encloseStr(val.str);
		}
		if (changed) {
			$error.html("Being changed.");
			m.rmb_me(m.reco_change_do, {strHeads:strHeads, strContents:strContents, cats:cats, r:r, uri:uri, title:title, desc:desc, cmt:cmt, val:val});
		} else {
			$error.html("You have made no change.");
			$button_edit.removeClass("disabled");
		}
	} else {
		let errorMsg="";
		if (uri.length===0) {
			errorMsg="URI is required.";
		} else if (!val.valid) {
			errorMsg="Points is of invalid form.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_edit.removeClass("disabled");
	}
});
m.reco_delete_do=function (args, err) {
	if (err) {
		$error.html("Failed delete. You may not be logged-in.");
		$button_del.removeClass("disabled");
		return;
	}
	$.ajax({
		type:"POST", url:"/reco/do", data:args.strHeads+"\n"+args.strContents
		, dataType:"text"
	}).done(function (resp) {
		let res=m.strToJSON(resp);
		if (res[1]["result"]==="deleted") {
			$error.html("Deleted");
			let cats=args.r["cats"];
			delete m.myRecos[args.uri];
			m.delCats_UriFromLists(cats, args.uri);
			if (m.myPage) {
				m.refresh(cats, "deleted", args.uri);
			}
			setTimeout(function () {
				$button_close.trigger("click");
			}, 1000);
		} else {
			$error.html(res[1]["result"]);
		}
	}).always(function () {
		$button_del.removeClass("disabled");
	});
};
$button_del.on("click", function (e) {
	$button_del.addClass("disabled");
	let uri=$input_uri[0].value;
	let r=m.myRecos[uri];
	if (uri.length!==0&&r) {
		let strHeads="do"+"\t"+"uri";
		let strContents="delete"+"\t"+m.encloseStr(uri);
		m.rmb_me(m.reco_delete_do, {strHeads:strHeads, strContents:strContents, r:r, uri:uri});
	} else {
		let errorMsg="";
		if (uri.length==0) {
			errorMsg="URI is required.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_del.removeClass("disabled");
	}
});


///////////////////////////////////////////
// Fuzzy search on Titles
///////////////////////////////////////////
$fuzzy_search.on("keydown", function (e) {
	e.stopPropagation();
	switch (e.keyCode) {
	case 27: // ESC=27
		e.preventDefault();
		$window.trigger({type:"keydown", keyCode:71});
		break;
	case 38: // up=38
	case 40: // down=40
		e.preventDefault();
		let $fsl=$fuzzy_search_list;
		let $lis=$fsl.find(".list-item");
		let $liSelected=$fsl.find(".list-item.selected").eq(0);
		let $liTo=null;
		if ($liSelected.exists()) {
			if (e.keyCode===38) {
				$liTo=$liSelected.prev();
			} else {
				$liTo=$liSelected.next();
			}
			if ($liTo.exists()) {
				$liTo.eq(0).trigger("click");
				if ($liTo.offset().top<$fsl.offset().top+2) { // $liTo at upside of scroll.
					$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top-$fsl.offset().top-2);
				} else if ($liTo.offset().top+$liTo.outerHeight()>$fsl.offset().top+$fsl.height()+2) { // $liTo at downside of scroll.
					$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top+$liTo.outerHeight()-$fsl.offset().top-$fsl.height()-2);
				}
			}
		} else {
			if ($lis.exists()) {
				if (e.keyCode===38) {
					$liTo=$lis.last();
					$fsl.scrollTop($fsl[0].scrollHeight);
				} else {
					$liTo=$lis.first();
					$fsl.scrollTop(0);
				}
				$liTo.eq(0).trigger("click");
			}
		}
		break;
	}
});
m.gotoLi=function (e, elem, k, fs) {
if (e&&e.srcElement&&e.srcElement.nodeName=="A") {
} else {
	let $elem=$(elem);
	let uri=fs.fullList[k].uri;
	if ($elem.hasClass("selected")) {
		fs.$fs.trigger({type:"keydown", keyCode:27}); // keyCode:27=ESC
	} else {
		fs.$fsLis.removeClass("selected");
		$elem.addClass("selected");
	}
	let $listI=fs.fullList[k].$listI;
	if ($listI) {
		$window.scrollTop($listI.offset().top);
	} else {
		let i=Math.floor((fs.fullList.length-1-k)/m.maxShowReco);
		$(`#load-recos-${i}`).trigger("click");
		setTimeout(function () {
			$window.scrollTop(fs.fullList[k].$listI.offset().top);
		}, 256);
	}
}};
m.doFSTitle=function (fs) {
	let fsPtnSH=m.splitHangul(fs.$fs.text());
	if (fs[0].ptnSH.splitted!==fsPtnSH.splitted) {
		m.fuzzySearch(fsPtnSH, fs);
		let res=fs[0];
		let sorted=res.sorted;
		let str="";
		for (let i=0;i<sorted.length;i++) {
			let k=res[sorted[i]].i;
			let fsFLk=fs.fullList[k];
			if (fsFLk.inRange) {
				let uri=fsFLk.uri;
				str+=`<div class="list-item" onclick="m.gotoLi(event,this,${k},m.fsTitle)">`
						+fs.fullList[k].html
						+((res[sorted[i]].highlight!==undefined)?
						'<div class="highlighted">'+'<span class="maxMatchScore">'+res[sorted[i]].maxMatchScore+'</span> :: '+res[sorted[i]].highlight+'</div>':'')
					+'</div>';
			}
		}
		fs.$fsl.html(str);
		fs.$fsLis=fs.$fsl.find(".list-item");
	}
};
m.fsTitleOn=function () {
	let now=Date.now();
	let passed=now-m.previous;
	if (passed>m.wait) {
		m.previous=now;
		m.doFSTitle(m.fsTitle);
	} else {
		$fuzzy_search.off("input.fs keyup.fs cut.fs paste.fs");
		setTimeout(function () {
			$fuzzy_search.on("input.fs keyup.fs cut.fs paste.fs", m.fsTitleOn);
			m.previous=Date.now();
			m.doFSTitle(m.fsTitle);
		}, m.wait*1.1-passed);
	}
};
$fuzzy_search.on("input.fs keyup.fs cut.fs paste.fs", m.fsTitleOn);
$fuzzy_search.trigger("keyup");

///////////////////////////////////////////
// Fuzzy search on Table of Recos
///////////////////////////////////////////
m.playLi=function (e, elem, k, fs) {
if (e&&e.srcElement&&e.srcElement.nodeName=="A") {
} else {
	let $elem=$(elem);
	// let uri=fs.fullList[k].uri;
	if ($elem.hasClass("selected")) {
		fs.$fs.trigger({type:"keydown", keyCode:27}); // keyCode:27=ESC
	} else {
		fs.currentIndex=k;
		fs.getAndPlayVideo();
	}
}};
m.doFSToRs=function (fs, shuffle) {
	let fsPtnSH=m.splitHangul(fs.$fs.text());
	if (shuffle||fs[0].ptnSH.splitted!==fsPtnSH.splitted) {
		m.fuzzySearch(fsPtnSH, fs);
		let res=fs[0];
		let sorted=res.sorted;
		let str="";
		let shuffled=fs.shuffled=[];
		if (shuffle) {
			for (let i=0;i<sorted.length;i++) {
				shuffled[i]={i:i, randomN:Math.random()};
			}
			for (let i=1;i<shuffled.length;i++) {
				let temp=shuffled[i];
				let j=i;
				for (;(j>0)&&(shuffled[j-1].randomN<temp.randomN);j--) {
					shuffled[j]=shuffled[j-1];
				}
				shuffled[j]=temp;
			}
		}
		for (let i=0;i<sorted.length;i++) {
			let k=shuffle?res[sorted[shuffled[i].i]].i:res[sorted[i]].i;
			let fsFLk=fs.fullList[k];
			if (fsFLk.inRange) {
				let uri=fsFLk.uri;
				str+=`<div id="toR-${k}" class="list-item" onclick="m.playLi(event,this,${k},m.fsToRs)">`
						+fs.fullList[k].html
						+((res[sorted[i]].highlight!==undefined)?
						'<div class="highlighted">'+'<span class="maxMatchScore">'+res[sorted[i]].maxMatchScore+'</span> :: '+res[sorted[i]].highlight+'</div>':'')
					+'</div>';
			}
		}
		fs.$fsl.html(str);
		fs.$fsLis=fs.$fsl.find(".list-item");
	}
};
m.fsToRsOn=function () {
	let now=Date.now();
	let passed=now-m.previous;
	if (passed>m.wait) {
		m.previous=now;
		m.doFSToRs(m.fsToRs);
	} else {
		$table_of_recos.off("input.fs keyup.fs cut.fs paste.fs");
		setTimeout(function () {
			$table_of_recos.on("input.fs keyup.fs cut.fs paste.fs", m.fsToRsOn);
			m.previous=Date.now();
			m.doFSToRs(m.fsToRs);
		}, m.wait*1.1-passed);
	}
};
$table_of_recos.on("input.fs keyup.fs cut.fs paste.fs", m.fsToRsOn);
$table_of_recos.trigger("keyup");
$table_of_recos.on("keydown", function (e) {
	e.stopPropagation();
	switch (e.keyCode) {
	case 27: // ESC=27
		e.preventDefault();
		$window.trigger({type:"keydown", keyCode:84});
		break;
	}
});

////////////////////////////////////////////////////
// Language/언어/語言
////////////////////////////////////////////////////
m.changeLang=function (lang, e, elem) {
	let search=window.location.search;
	let href=m.pathName+(search?search+"&":"?")+"lang="+lang+window.location.hash;
	if (e&&e.which===2) {
		$(elem).attr({"href":href});
		return true;
	} else {
		window.location.href=href;
		return false;
	}
};
let dataLang=m.strToJSON( $data_lang.html().trim() );
let htmlLang='<div>';
for (let i=0;i<dataLang[0].length;i++) {
	htmlLang+='<a href="'+m.pathName+"?lang="+dataLang[0][i]+'" onclick="return m.changeLang(\''+dataLang[0][i]+'\',event,this)">'+dataLang[1][i]+'</a><br>';
}
htmlLang+='</div>';
$data_lang.after(htmlLang);

////////////////////////////////////////////////
// Lang : set cookie, Cat : get ans show recos
////////////////////////////////////////////////
let vars=m.getSearchVars(window.location.search);
if (vars.lang!==undefined) {
	m.docCookies.setItem("lang", vars.lang.val, Infinity, "/");
}
if (vars.cat!==undefined) {
	let cat=vars.cat.val;
	m.currentCat=cat;
	if (vars.mode===undefined) {
		m.getUriListAndShowRecosOnCat(cat);
		window.history.pushState({cat:cat}, null, m.pathOfCat(cat));
		$a_log_in.attr("href", "/account/log-in?goto="+escape(m.pathOfCat(cat)));
	} else if (vars.mode&&vars.mode.val==="multireco") {
		m.getUriListAndShowRecosOnCat(cat);
		$button_multireco_mode.trigger("click");
	} else if (vars.mode&&vars.mode.val==="neighbors") {
		$button_neighbors_page.trigger("click");
	}
}
if (vars.title!==undefined) {
	let title=vars.title.val;
	$input_title[0].value=title;
}
if (vars.uri!==undefined) {
	$new_reco.show();
	let uri=vars.uri.val;
	$input_uri[0].value=uri;
	$input_uri.trigger("input.rd");
}
if (window.location.pathname==="/reco") {
	$new_reco.show();
}

////////////////////////////////////////////////////
// SNS Sharing
////////////////////////////////////////////////////
m.shareSNS=function (elem, service) {
	let $reco=$(elem).parent(".reco");
	let uri=encodeURIComponent(m.unescapeHTML($reco.find(".textURI").html()));
	let title=encodeURIComponent( $reco.find(".title").text() );
	// encodeURIComponent(window.location.href);
	let open="";
	switch (service) {
		case 'twitter':
			open="https://twitter.com/intent/tweet"+"?text="+title+"&url="+uri;
			break;
		case 'facebook':
			open="https://www.facebook.com/sharer/sharer.php"+"?u="+uri;
			break;
	}
	window.open(open);
};

////////////////////////////////////////////////////
// ShortKeys
////////////////////////////////////////////////////
m.fdList=$("#sidebar, #head, #contents .reco, #foot"); // Ordered automatically by jQuery.
m.processShortKey=function (e) {
	if (e.altKey||e.ctrlKey||e.metaKey) { return; }
	switch (e.target.nodeName) {
		case "INPUT": case "SELECT": case "TEXTAREA": return;
	}
	switch (e.keyCode) {
		case 71: // G=71
			e.preventDefault();
			if ($fuzzy_search_container.is(":visible")) {
				$fuzzy_search_container.hide();
				$out_focus.focus();
				$button_Go.removeClass("enabled");
			} else {
				$fuzzy_search_container.show();
				$fuzzy_search.focus();
				$button_Go.addClass("enabled");
			}
			break;
		case 84: // T=84
			e.preventDefault();
			if ($table_of_recos_container.is(":visible")) {
				$table_of_recos_container.hide();
				$out_focus.focus();
				$button_ToR.removeClass("enabled");
			} else {
				$table_of_recos_container.show();
				$table_of_recos.focus();
				$button_ToR.addClass("enabled");

			}
			break;
		case 78: // N=78
			e.preventDefault();
			$button_new_reco.trigger("click");
			break;
		case 70: //F=70
		case 68: //D=68
			let scrollTop=$window.scrollTop();
			let i, k=m.fdList.length;
			let hI;
			if (e.keyCode===70) {
				scrollTop+=10;
				for (i=0;i<k;i++) {
					hI=m.fdList.eq(i);
					if (hI.is(":visible")&&scrollTop<hI.offset().top) { break; }
				}
				if (i===k) {
					// hI=m.fdList.eq(0);
					// alert("This is the last section.");
					return;
				}
			} else{
				scrollTop-=10;
				for (i=k-1;i>=0;i--) {
					hI=m.fdList.eq(i);
					if (hI.is(":visible")&&scrollTop>hI.offset().top) { break; }
				}
				if (i===-1) {
					// hI=m.fdList.eq(k-1);
					// alert("This is the first section.");
					return;
				}
			}
			$window.scrollTop(hI.offset().top);
			break;
		default:
	}
}
$window.on("keydown", m.processShortKey);
let $shortkeyDesc=$("ul#shortkeys");
if ($shortkeyDesc.exists()) {
	$shortkeyDesc.prepend(
		"<li>G: [--Fuzzy Search--] (Go)</li>"
		+"<li>T: Table of Recos</li>"
		+"<li>F: Forward [--Reco--]</li>"
		+"<li>D: Previous [--Reco--]</li>"
		+"<li>N: New [--Reco--]</li>"
	);
}

////////////////////////////////////////////////////
// YouTube API
////////////////////////////////////////////////////
m.fsToRs.Preceding=function () {
	m.fsToRs.playNext(1);
};
m.fsToRs.Following=function () {
	m.fsToRs.playNext();
};
m.fsToRs.shuffle=function () {
	let fs=m.fsToRs;
	m.doFSToRs(fs,true);
	fs.playNext(-1,true,true);
};
m.fsToRs.toggleLoop=function (elem) {
	let $elem=$(elem);
	if ($elem.hasClass("enabled")) {
		$elem.removeClass("enabled");
		m.fsToRs.loop=false;
	} else {
		$elem.addClass("enabled");
		m.fsToRs.loop=true;
	}
};
m.fsToRs.toggleOneLoop=function (elem) {
	let $elem=$(elem);
	if ($elem.hasClass("enabled")) {
		$elem.removeClass("enabled");
		m.fsToRs.oneLoop=false;
	} else {
		$elem.addClass("enabled");
		m.fsToRs.oneLoop=true;
	}
};
m.fsToRs.getAndPlayVideo=function (cue) {
	let fs=m.fsToRs;
	fs.pauseVideo();
	let i=fs.currentIndex;
	if (0<=i&&i<fs.fullList.length) {
		fs.$fsLis.removeClass("selected");
		$(`#toR-${i}`).addClass("selected");
		let r=fs.fullList[i].reco;
		$reco_playing.html(m.recoHTML(r, true, true));
		let uriRendered=m.uriRendering(r.uri);
		if (uriRendered.from==="youtube") {
			$uri_rendered.html('');
			$video.html('');
			$rC_video_uri_rendered.hide();
			$rC_youtube_uri_rendered.show();
			if (m.YtPlayer) {
				if (cue) {
					m.YtPlayer.cueVideoById(uriRendered.videoId);
				} else {
					m.YtPlayer.loadVideoById(uriRendered.videoId);
				}
			} else if (YT!==undefined&&YT.Player) {
				m.YtPlayer=new YT.Player('youtube', {videoId:uriRendered.videoId
					, events:{
						'onError':function (e) {
							m.playListSetTimeout=setTimeout(function () {
								fs.playNext();
							}, 7000);
						}, 'onStateChange':function (e) {
							if (e.data===YT.PlayerState.ENDED) {
								if (fs.oneLoop) {
									m.YtPlayer.seekTo(0,true);
								} else {
									fs.playNext();
								}
							}
						}
					}}
				);
			}
		} else if (uriRendered.from==="video") {
			$uri_rendered.html('');
			$rC_youtube_uri_rendered.hide();
			$rC_video_uri_rendered.show();

			$video.replaceWith($('<video id="video" controls '+(fs.oneLoop?'loop ':'')+'preload="auto" src="'+uriRendered.src+'"></video>'));
			$video=$("#video");
			$video.on("ended", function () {
				if (fs.oneLoop) {
					$video[0].play();
				} else {
					fs.playNext();
				}
			});
			if (!cue) {
				$video[0].play();
			}
		} else {
			$uri_rendered.html(uriRendered.html);
			$video.html('');
			$rC_video_uri_rendered.hide();
			$rC_youtube_uri_rendered.hide();
		}
	} else {
		$reco_playing.html('');
		$uri_rendered.html('');
		$video.html('');
		$rC_video_uri_rendered.hide();
		$rC_youtube_uri_rendered.hide();
	}
	m.delayedElems=$("[delayed-src], [delayed-bgimage], .to-be-executed");
	$window.on("scroll.delayedLoad", m.delayedLoadByScroll);
	$window.trigger("scroll.delayedLoad");
};
m.fsToRs.pauseVideo=function () {
	if ($video&&$video[0]&&$video[0].tagName=="VIDEO") {
		$video[0].pause();
	}
	if (m.YtPlayer) {
		m.YtPlayer.pauseVideo();
	}
};
m.fsToRs.playNext=function (increment, cue, first) {
	clearTimeout(m.playListSetTimeout);
	let fs=m.fsToRs;
	if (increment===undefined||increment===null||increment.constructor!==Number) { increment=-1; }
	if (first) {
		let $li=fs.$fsLis.eq(0);
		if ($li.exists()) {
			fs.currentIndex=Number($li.attr("id").match(/toR-(\d+)/)[1]);
			fs.getAndPlayVideo(cue);
			return;
		}
	}
	let $selected=fs.$fsLis.filter(".selected");
	if ($selected.exists()) {
		if (increment<0) {
			let $next=$selected.next();
			if ($next.exists()) {
				$next.trigger("click");
				fs.$fsl.viewAndScroll($next);
			} else if (fs.loop) {
				$next=fs.$fsLis.eq(0);
				if ($next.exists()) {
					$next.trigger("click");
					fs.$fsl.viewAndScroll($next);
				}
			}
		} else {
			let $prev=$selected.prev();
			if ($prev.exists()) {
				$prev.trigger("click");
				fs.$fsl.viewAndScroll($prev);
			} else if (fs.loop) {
				$prev=fs.$fsLis.last();
				if ($prev.exists()) {
					$prev.trigger("click");
					fs.$fsl.viewAndScroll($prev);
				}
			}
		}
	} else {
		$next=fs.$fsLis.eq(0);
		if ($next.exists()) {
			$next.trigger("click");
			fs.$fsl.viewAndScroll($next);
		}
	}
};
m.fsToRs.prepareRecoListPlay=function () {
	let fs=m.fsToRs;
	let YtAPINeeded=false;
	if (!m.YtAPILoaded) {
		for (let i=0;i<fs.fullList.length;i++) {
			let r=fs.fullList[i].reco;
			let uriRendered=m.uriRendering(r.uri);
			if (uriRendered.from==="youtube") {
				YtAPINeeded=true;
				break;
			}
		}
		if (YtAPINeeded) {
			let ytAPI=document.createElement('script');
			ytAPI.src="http://www.youtube.com/player_api";
			$scripts.append(ytAPI);
			m.YtAPILoaded=true;
		}
	}
	if (!YtAPINeeded||(YT!==undefined&&YT.Player)) {
		m.doFSToRs(fs);
		fs.playNext(-1,true,true);
	} else {
		setTimeout(function () {
			fs.prepareRecoListPlay();
		}, 1000);
	}
};
m.fsToRs.toggleRecoListPlay=function () {
	if ($playlist_container.is(":visible")) {
		$playlist_container.hide();
		$toggle_reco_list_play.removeClass("enabled");
	} else {
		$playlist_container.show();
		$toggle_reco_list_play.addClass("enabled");
	}
};
})(window.m, jQuery);
</script>
</html>