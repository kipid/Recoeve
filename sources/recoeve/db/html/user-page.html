<!DOCTYPE html>
<html>
<head>
<script>
(function(eve, undefined) {
	eve.myIndex="{--myIndex--}";
	eve.myId="{--myId--}";
	var pathname=window.location.pathname;
	if (pathname.substring(0,6)!=="/user/") {
		pathname="/user/"+eve.myId;
		window.history.replaceState(null, null, pathname+window.location.search+window.location.hash);
	}
	eve.userId="";
	if (pathname.substring(0,6)==="/user/") {
		eve.userId=pathname.substring(6);
	}
	eve.myPage=(eve.myId===eve.userId);
})(window.eve=window.eve||{});
</script>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=3, user-scalable=yes"/>
	<title>Recoeve.net</title>
<style>
body {margin:0; padding:0; overflow-wrap:break-word; word-wrap:break-word; word-break:break-word; background:rgb(150,150,150)}

div, form, input, textarea {-webkit-box-sizing:border-box; -moz-box-sizing:border-box; box-sizing:border-box; max-width:100%}
data {display:none}
.none {display:none}
.center {text-align:center}
.right {text-align:right}
.fLeft {float:left}
.fRight {float:right}
.cBoth {clear:both}
img {min-width:1em; min-height:1em; max-width:100%}

.button {display:inline-block; cursor:pointer; padding:.2em .5em; border:.15em solid rgb(50,50,50); background:rgb(110,110,110);}
.button.disabled {pointer-events:none; background:rgb(25,25,25); color:rgb(120,120,120)}
.button.left {float:left; margin-right:.5em}
.button:active {background:rgb(0,80,80)}
.button.enabled {background:rgb(50,130,50)}
.button.enabled:active {background:rgb(70,70,70)}

a {text-decoration:none}
a:link {color:rgb(190,190,235)}
a:visited {color:rgb(170,170,215)}
a:active {color:rgb(100,215,215)}
a:hover {color:rgb(170,215,170); text-decoration:underline}

::-webkit-scrollbar {width:7px; height:7px}
::-webkit-scrollbar-track {-webkit-border-radius:5px; border-radius:5px}
::-webkit-scrollbar-thumb {-webkit-border-radius:5px; border-radius:5px; background:rgb(0,120,120); -webkit-box-shadow:inset 0 0 3px rgb(0,0,0)}
::-webkit-scrollbar-corner {background:transparent}

#container {line-height:1.6; font-family:'Malgun Gothic', '맑은 고딕', 나눔고딕, NanumGothic, 'MS Mincho', Tahoma, Sans-serif; background:rgb(250,250,250); color:black; font-size:15px}
	#container.dark {background:rgb(75,75,75); color:white}
#sidebar {margin-bottom:1em; padding:.5em; background:rgb(230,230,230); color:black}
	.dark #sidebar {background:rgb(35,35,35); color:white}
.side2 {padding:0}

#user-noti {padding:.3em .2em; font-size:1.1em; color:rgb(150,150,240)}

#catList {margin-bottom:1em}
#catList .cat {border:1px solid transparent; margin-bottom:.15em}
#cat-to-here {border:1px solid rgb(130,130,130); margin:.5em}
#catList .cat.edit {position:relative; border:1px solid rgb(150,150,225); padding:0 1.3em}
#catList .cat.edit.move {position:fixed; z-index:101}
#catList .cat.edit>.edit-bar {position:absolute; width:1.3em; top:0; bottom:0; background:rgb(150,150,225)}
#catList .cat.edit>.edit-bar:first-child {left:0}
#catList .cat.edit>.edit-bar:last-child {right:0}
#catList .cat.selected {border:1px solid black}
	.dark #catList .cat.selected {border-color:white}
#catList .cat>.baseCat, #catList .cat>.EC {cursor:pointer}
#catList .cat.selected>.baseCat {pointer-events:none; color:rgb(255,230,230)}
#catList .cat>.noEC, #catList .cat>.EC {display:inline-block; font-size:.5em; margin-top:-.5em; width:2em; text-align:center; vertical-align:middle}

#cat-fs-container {
	position:relative;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#cat-fs-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#cat-fs-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#cat-fs-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#cat-fs-list .list-item .list-index {display:none}
#cat-fs-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#cat-fs-list .list-item .cat {font-size:.9em;}
#cat-fs-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#cat-fs-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}

#fuzzy-search-container {
	position:fixed; left:0; top:0;
	z-index:100;
	width:25em; max-width:100%;
	height:auto;
	text-align:left;
}
#fuzzy-search {
	height:2em; max-height:5em; overflow-y:auto;
	font:inherit; font-size:1.3em; color:black;
	width:100%;
	padding:.1em 2em 0 .2em;
	border:.15em gray solid;
	background:white;
}
#fuzzy-search-list {
	height:auto; min-height:2em; max-height:15em; overflow-y:auto;
	border:.15em gray solid;
	background:rgb(20,20,20);
}
#fuzzy-search-list .list-item {
	background:black; color:white;
	padding:.2em .5em .4em;
}
#fuzzy-search-list .list-item.selected {border:.15em solid rgb(210,150,150)}
#fuzzy-search-list .list-item .list-index {display:none}
#fuzzy-search-list .list-item:nth-child(2n) {
	background:rgb(40,40,40);
}
#fuzzy-search-list .list-item .cat {font-size:.9em;}
#fuzzy-search-list .list-item .highlighted {
	font-size:.5em; color:rgb(150,150,150);
}
#fuzzy-search-list .list-item .highlighted .bold {
	color:rgb(170,250,170);
}
.exit {
	z-index:100;
	position:absolute; display:inline-block;
	right:0; top:0;
	margin:0;
	width:1.8em; height:1.8em; line-height:1.0;
	text-align:center;
	/*border-radius:.4em;*/
	cursor:pointer;
	border:.15em rgb(80, 80, 80) solid;
	background-color:rgb(30,30,30); color:white;
}
.exit>svg {
	width:100%; height:100%;
	font-size:1.8em; line-height:1.0;
}

#new-reco {z-index:100; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.8); overflow:auto}
#new-reco form {position:relative; width:40em; max-width:100%; margin:1em auto; padding:1em; background:black; border:.2em solid rgb(120,120,130); text-align:left}
#new-reco label {display:inline-block; font-weight:bold; margin:.9em 0 .4em}
#new-reco label:first-child {margin-top:0}
#new-reco label>.desc {font-size:.8em}
#new-reco input, #new-reco textarea {display:block; max-width:100%; width:100%; font:inherit; font-weight:bold; overflow-x:hidden; overflow-y:auto; padding:.2em .3em; background:white; color:rgb(50,50,50)}
textarea.single-line {min-height:2.2em; height:2.2em}
textarea.multi-line {font-size:.9em; min-height:10em}
#new-reco input#input-val {display:inline-block; width:8.5em}
#new-reco .def-title {margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-title.selected {border-color:rgb(255,180,180)}
#new-reco .def-cat {display:inline-block; margin:.2em 0; border:1px solid rgb(130,130,130); padding:1px .5em; font-size:.9em}
#new-reco .def-cat.selected {border-color:rgb(255,180,180)}
#input-val-stars {margin:0 .5em -.4em 0}
#new-reco .buttons {margin-top:1em; text-align:right}
#new-reco #error-msg {margin:0}

#point-range {position:relative; display:inline-block; width:300px; height:30px; background:rgb(200,100,100)}
#point-range-bar {position:absolute; left:15px; right:15px; height:100%; background:rgb(100,200,100)}
#point-range-left, #point-range-right {position:absolute; width:20px; top:0; bottom:10px; background:rgba(150,150,150,0.9); border:.15em solid rgb(50,50,50)}
#point-range-left {left:0}
#point-range-right {right:0}
#point-range-result {border:.15em solid black; padding:.1em .5em; vertical-align:top}
	.dark #point-range-result {border-color:white}

.reco.outRange {display:none}
.reco {margin:0 0 1em; border-bottom:.15em solid black}
	.dark .reco {border-color:rgb(100,100,100); background:black}
.reco:last-child {margin:0}
.reco .SNS-img {display:inline-block; float:left; width:2em; height:2em; border:.15em gray solid; border-left:0; cursor:pointer}
.reco .SNS-img:first-child {border-left:.15em gray solid}
.reco>.textURI, .reco>.YTVideoId {display:none}
.reco>.uri {font-size:.8em; border:.15em solid rgb(100,100,150); border-bottom:0; padding:.2em .5em}
.reco>.title {font-size:1.1em; border:.15em solid rgb(150,100,100); padding:.2em .5em}
.reco>.cats {font-size:.8em; border:.15em solid rgb(100,150,100); border-top:0; padding:.2em .5em}
.reco>.desc {margin:.5em 0; padding:.5em}
.reco>.cmt {margin:.5em 0; padding:.5em; background:rgb(30,30,30); border-left:.3em solid rgb(10,80,80)}
.stars-container {position:relative; display:inline-block; cursor:text}
.stars-container>div.bar {position:absolute; top:1px; bottom:1px; background:rgb(232,242,80)}
.stars-container>svg.out-stars {position:absolute; left:0; top:0; width:100%; height:100%}
.stars-container>svg.out-stars>polygon {fill:rgb(50,50,50);stroke-width:0;fill-rule:evenodd}
.reco>.val {margin:.5em 0 .3em}
.reco>.val>.str {border:.15em solid black; padding:.1em .5em; vertical-align:top}
	.dark .reco>.val>.str {border-color:white}

.lyricsC {}
.lyricsArrow {width:0; height:0; padding:0; margin:0 auto; border-color:transparent transparent rgb(0,30,0); border-style:solid; border-width:0.5em}
.lyrics {border:0.3em solid rgb(0,30,0); padding:1em .5em; margin-top:-1px}

.rC {margin:1em 0}
.rC.fixed {position:fixed; z-index:100; top:0; right:0; width:100%; max-width:100%; margin:0; padding:1px; background:white; border-bottom:.15em solid black}
	.dark .rC.fixed {background:black; border-color:white}
.rC>.rSC {box-sizing:content-box; -moz-box-sizing:content-box; position:relative; height:3em; padding-bottom:60%}
.rC>.rSC>* {position:absolute; width:100%; height:100%; left:0; top:0}
.pc {text-align:center; font-size:.6em} /* position change */

#foot {clear:both; margin-top:1em; border-top:.15em solid white; padding:1em .5em}

@media all and (min-width:701px) {
	#container {margin-left:14.9em}
	#sidebar {margin:0; position:fixed; left:0; top:0; bottom:0; width:15em; overflow:auto}
	.side2 {padding:.5em}
	.rC.fixed {width:646px; border-left:.15em solid black}
	::-webkit-scrollbar {width:11px; height:11px}
}
@media all and (min-width:901px) {
	#container {margin-left:19.9em}
	#sidebar {width:20em}
}
@media all and (min-height:500px) {
	#fuzzy-search-list {max-height:430px;}
}
</style>
</head>
<body>
<data id="data-CatList">{--CatList--}</data>
<div id="container" class="dark">
<div id="sidebar">
	<div id="user-noti"></div>
	<div id="catList"></div>
	<div class="right">
		<div class="button" id="change-catList-order">[--Change orders--]</div>
		<div class="button" id="change-catList-order-ok">[--OK--]</div>
		<div class="button" id="change-catList-order-cancel">[--Cancel--]</div>
	</div>
</div><!-- div#sidebar -->
<div id="fuzzy-search-container" style="display:none">
	<div id="fuzzy-search" contenteditable="true"></div>
	<div id="fuzzy-search-list"></div>
	<div class="exit" onclick="$(this).parent().hide()"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
</div><!-- div#fuzzy-search-container -->
<div id="new-reco" style="display:none">
	<form>
	<label for="uri">URI <span class="desc">(required)</span></label>
		<textarea id="input-uri" class="single-line" name="uri" placeholder="Uniform Resource Indentifier: like http-URL" type="text" tabindex="1"></textarea>
		<div id="show-URI"></div>
	<label for="title">[--Title--]</label>
		<div id="def-titles"></div>
		<textarea id="input-title" class="single-line" name="title" placeholder="Title" type="text" tabindex="2"></textarea>
	<label for="cats">[--Categories--]</label>
		<div id="def-cats"><div class="def-cat">[--Indifferent--]</div> <div class="def-cat">[--Later--]</div></div>
		<textarea id="input-cats" class="single-line" name="cats" placeholder="Category--Sub category--Subsub category ; Another category ; ..." type="text" tabindex="3"></textarea>
		<div id="cat-fs-container" class="fs-container" style="display:none">
			<div id="cat-fs-list"></div>
			<div class="exit" onclick="$(this).parent().hide()"><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
		</div>
	<label for="desc">[--Description--]</label>
		<textarea id="input-desc" class="multi-line" name="desc" placeholder="Objective Description: you can refer a good description of others. In other words, you can provide a good description to the others." tabindex="4"></textarea>
	<label for="cmt">[--Comment--]</label>
		<textarea id="input-cmt" class="multi-line" name="cmt" placeholder="Comment: your personal description or opinion on this URI." tabindex="5"></textarea>
	<label for="val">[--Points--]</label>
		<input id="input-val" name="val" placeholder="Points (ex: 3/5)" type="text" tabindex="6"/>
	<div id="error-msg"></div>
	<div class="buttons">
		<div class="button" id="button-reco" tabindex="7">[--Reco--]</div>
		<div class="button" id="button-edit" tabindex="8">[--Edit--]</div>
		<div class="button" id="button-del" tabindex="11">[--Del--]</div>
		<div class="button left" id="button-close" tabindex="9">[--Close--]</div>
		<div class="button left" id="button-back" tabindex="10">[--Back--]</div>
		<div class="cBoth"></div>
	</div>
	<div id="my-reco"></div>
	<div class="exit" style="margin:-1em -.2em 0 0" onclick='$button_close.trigger("click")'><svg><g style="stroke:white;stroke-width:23%"><line x1="20%" y1="20%" x2="80%" y2="80%"></line><line x1="80%" y1="20%" x2="20%" y2="80%"></line></g>✖</svg></div>
	</form>
</div><!-- div#new-reco -->
<div class="side2" id="head">
	<div class="button" id="my-id"></div>
	head : <a href="/account/log-out">[--Log out--]</a>
	<div class="button" onclick="$('#container').toggleClass('dark')">[--Toggle style--]</div>
	<div class="button" id="out-focus" onclick='$fuzzy_search_container.show(); $fuzzy_search.focus();'>[--Fuzzy Search--]</div>
	<div class="button" id="button-new-reco">[--New Reco--]</div>
	<div>
		[--Short Keys--]
		<ul id="shortkeys"></ul>
	</div>
	<div id="point-range">
		<div id="point-range-bar"></div><div id="point-range-right"></div><div id="point-range-left"></div>
	</div><br>
	<span id="point-range-result"></span><br><br>
	<div class="button enabled" id="show-recos-without-points">Show recos without points</div>
</div><!-- div#head -->
<div class="side2" id="head2" style="display:none">
	<div class="rC">
		<div class="rSC">
			<div id="youtube-playlist"></div>
		</div>
		<div class="button" onclick="eve.playlist.setShuffle(true)">[--Shuffle--]</div>
		<div class="button" onclick="eve.playlist.toggleLoop(this)">[--Loop--]</div>
		<div class="button" onclick="eve.playlist.toggleOneLoop(this)">[--One-loop--]</div>
		<div class="pc"><span onclick="eve.togglePosition(this)">▲ [--stick to the right top--]</span></div>
	</div>
</div><!-- div#head2 -->
<div class="side2" id="contents"></div><!-- div#contents -->
<div class="side2" id="foot">[--version--] [--foot--]<br><a href="http://kipid.tistory.com/entry/Introducing-what-we-are-making-Recoevenet">Introducing what we are making : Recoeve.net</a><br><br>
	<div>Language/언어/語言
		<data id="data-lang">English/영어/en	en
Korean/한국어/kr	kr
Japanese/일본어/jp	jp
Chinese/중국어/cn	cn</data></div>
</div><!-- div#foot -->
</div><!-- div#container -->
</body>
<div id="scripts"></div>
<script src="/jquery.min.js"></script>
<script>
(function(eve, $, undefined) {
/////////////////////////////////////////////
// Variables
/////////////////////////////////////////////
$data_CatList=$("#data-CatList");

$user_noti=$("#user-noti");
$my_id=$("#my-id");
$button_new_reco=$("#button-new-reco");

$sidebar=$("#sidebar");
$catList=$("#catList");
$change_catList_order=$("#change-catList-order");
$change_catList_order_ok=$("#change-catList-order-ok");
$change_catList_order_cancel=$("#change-catList-order-cancel");

$new_reco=$("#new-reco");

$head2=$("#head2"); // youtube playlist

$input_uri=$("#input-uri");
$def_titles=$("#def-titles");
$input_title=$("#input-title");
$def_cats=$("#def-cats");
$input_cats=$("#input-cats");
$input_desc=$("#input-desc");
$input_cmt=$("#input-cmt");
$input_val=$("#input-val");

$error=$("#error-msg");

$button_reco=$("#button-reco");
$button_edit=$("#button-edit");
$button_del=$("#button-del");
$button_back=$("#button-back");
$button_close=$("#button-close");

$out_focus=$("#out-focus");
$fuzzy_search_container=$("#fuzzy-search-container");
$fuzzy_search=$("#fuzzy-search");
$fuzzy_search_list=$("#fuzzy-search-list");

$cat_fs_container=$("#cat-fs-container");
$cat_fs_list=$("#cat-fs-list");

$test_5stars=$("#test-5stars");
$point_range=$("#point-range");
$point_range_bar=$("#point-range-bar");
$point_range_left=$("#point-range-left");
$point_range_right=$("#point-range-right");
$point_range_result=$("#point-range-result");
$show_recos_without_points=$("#show-recos-without-points");
eve.showRWOP=true;

$contents=$("#contents");
$scripts=$("#scripts");

$window=$(window);
$html=$("html");
$body=$("body");
$.fn.exists=function() { return this.length!==0; };

$("title").html(eve.userId+" on Recoeve.net");
$user_noti.html(eve.userId+"'s recos");
if (eve.myId) {
	$my_id.html(eve.myId+" ▾");
} else {
	$my_id.hide();
	$button_new_reco.remove();
}

////////////////////////////////////////////////////
// Delayed Loading.
////////////////////////////////////////////////////
eve.delayPad=eve.delayPad||0;
eve.wait=eve.wait||200;
eve.delayedElems=[];
eve.previous=Date.now();
$.fn.inView=function(delayPad) {
	delayPad=delayPad||0;
	var $elem=$(this);
	if ($elem.is(":visible")) {
		var viewportHeight=window.innerHeight;
		var scrollTop=$window.scrollTop();
		var elemTop=$elem.offset().top-delayPad;
		var elemBottom=elemTop+$elem.height()+delayPad*2;
		return (scrollTop+viewportHeight>elemTop) && (scrollTop<elemBottom);
	} else {
		return false;
	}
};
$.fn.delayedLoad=function(delayPad) {
	var $elem=$(this);
	var done=false;
	if ($elem.inView(delayPad)) {
		// divs with background-image
		if ($elem.attr("delayed-bgimage")) {
			$elem.css("background-image", "url("+$elem.attr("delayed-bgimage")+")");
			$elem.removeAttr("delayed-bgimage");
			done=true;
		} 
		// iframes or images
		if ($elem.attr("delayed-src")) {
			$elem.attr("src", $elem.attr("delayed-src"));
			$elem.removeAttr("delayed-src");
			done=true;
		}
		// MathJax Process
		if (typeof MathJax!=='undefined'&&$elem.is(".MathJax_Preview")) {
			MathJax.Hub.Queue(["Process", MathJax.Hub, $elem.next()[0]]);
			done=true;
		}
	}
	return done;
};
eve.delayedLoadAll=function() {
	if (eve.delayedElems.length===0) {
		$window.off("scroll.delayedLoad");
	} else {
		eve.delayedElems.each(function() {
			if ($(this).delayedLoad(eve.delayPad)) {
				eve.delayedElems=eve.delayedElems.not(this);
			}
		});
	}
}
eve.delayedLoadByScroll=function delayedLoadByScroll() {
	var now=Date.now();
	var passed=now-eve.previous;
	if (passed>eve.wait) {
		eve.delayedLoadAll();
		eve.previous=now;
	} else {
		$window.off("scroll.delayedLoad");
		setTimeout(function() {
			eve.delayedLoadAll();
			eve.previous=Date.now();
			$window.on("scroll.delayedLoad", delayedLoadByScroll);
		}, eve.wait*1.1-passed);
	}
};

eve.delayedElems=$("[delayed-src], [delayed-bgimage]");
$window.on("scroll.delayedLoad", eve.delayedLoadByScroll);
$window.trigger("scroll.delayedLoad");

////////////////////////////////////////////////////
// String to Array (This is the up-to-date. in user-page.html)
////////////////////////////////////////////////////
eve.encloseStr=function(str) {
	if (str===undefined||str===null||str.constructor!==String) { return ""; }
	if (str.charAt(0)==="\""||/[\n\t]/.test(str)) {
		return '"'+str.replace(/"/g,'""')+'"';
	} else {
		return str;
	}
};
eve.strToJSON=function(str, colMap, rowMap) {
	if (str===undefined||str===null||str.constructor!==String) { return []; }
	if (colMap===undefined||colMap===null) { colMap=true; }
	// str=str.trim()+"\n";
	if (str.charAt(str.length-1)!=="\n") {
		str+="\n";
	}
	var ret=[];
	var delimiter=/([^\t\n]*)([\t\n])/g;
	var lastQuote=/[^"](?:"")*"([\t\n])/g;
	var exec;
	var start=0;
	var row=-1, col=-1, delim="\n";
	var strElem="";
	function increseRC(str) {
		if (str==='\t') {
			col++; return true;
		} else if (str==='\n') {
			row++; col=0; ret.push([]); return true;
		} return false;
	}
	while (start<str.length&&increseRC(delim)) {
		if ((str.substring(start, start+1))==='"') {
			lastQuote.lastIndex=start+1;
			if ((exec=lastQuote.exec(str))!==null) {
				strElem=str.substring(start+1, lastQuote.lastIndex-2);
				delim=exec[1];
				start=delimiter.lastIndex=lastQuote.lastIndex;
			} else {
				strElem=str.substring(start+1);
				delim="";
				start=str.length;
			}
			strElem=strElem.replace(/""/g,'"');
		} else {
			if ((exec=delimiter.exec(str))!==null) {
				strElem=exec[1];
				delim=exec[2];
				start=delimiter.lastIndex;
			} else {
				strElem=str.substring(start);
				delim="";
				start=str.length;
			}
		}
		ret[row][col]=strElem;
	}
	if (colMap) {
		var firstColSize=ret[0].length;
		for (var i=0;i<ret.length;i++) {
			var jMax=ret[i].length;
			if (jMax>firstColSize) { jMax=firstColSize; }
			for (var j=0;j<jMax;j++) {
				var key=ret[0][j];
				if (key!==undefined) {
					ret[i][key]=ret[i][j];
				}
			}
		}
	}
	if (rowMap) {
		for (var i=0;i<ret.length;i++) {
			var key=ret[i][0];
			if (key!==undefined) {
				ret[key]=ret[i];
			}
		}
	}
	return ret;
};

var $dataLang=$("#data-lang");
var dataLang=eve.strToJSON( $dataLang.html().trim() );
var href=window.location.href.replace(/\?\S*$/, "")+"?lang=";
var htmlLang='<div class="p">';
for (var i=0;i<dataLang.length;i++) {
	htmlLang+='<a href="'+href+dataLang[i][1]+'">'+dataLang[i][0]+'</a><br>';
}
htmlLang+='</div>';
$dataLang.after(htmlLang);

////////////////////////////////////////////////////
// Escape and Unescape HTML string.
////////////////////////////////////////////////////
eve.escapeHTML=function(str) {
	if (str===undefined||str===null||str.constructor!==String) { return ""; }
	return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
};
eve.unescapeHTML=function(str) {
	if (str===undefined||str===null||str.constructor!==String) { return ""; }
	return str.replace(/&gt;/g,'>').replace(/&lt;/g,'<').replace(/&amp;/g,'&');
};
eve.escapeAMP=function(str) {
	if (str===undefined||str===null||str.constructor!==String) { return ""; }
	return str.replace(/%/g,'%25').replace(/&/g,'%26').replace(/#/g,'%23');
};
eve.unescapeAMP=function(str) {
	if (str===undefined||str===null||str.constructor!==String) { return ""; }
	return str.replace(/%23/g,'#').replace(/%26/g,'&').replace(/%25/g,'%');
};

////////////////////////////////////////////////////
// YouTube API
////////////////////////////////////////////////////
eve.cueYTCount=0;
eve.YTNotLoaded=true;
eve.cueYoutubePlaylist=function(list) {
	if (eve.playlist&&eve.playlist.cuePlaylist) {
		if (list.length>0) {
			$head2.show();
			eve.playlist.cuePlaylist(list);
		} else {
			$head2.hide();
			eve.playlist.stopVideo();
		}
	} else {
		if (eve.YTNotLoaded) {
			var ytAPI=document.createElement('script');
			ytAPI.src="http://www.youtube.com/player_api";
			$scripts.append(ytAPI);
			eve.YTNotLoaded=false;
		}
		if (++eve.cueYTCount<100) { // Trying until YT API is loaded.
			setTimeout(function() {
				eve.cueYoutubePlaylist(list);
			}, 1000);
		}
	}
};

////////////////////////////////////////////////////
// RegEx URI :: URL of videos, images, maps
////////////////////////////////////////////////////
eve.togglePosition=function(elem) {
	var $elem=$(elem);
	var $parent=$elem.parent().parent();
	if ($parent.hasClass("fixed")) {
		$parent.removeClass("fixed");
		window.scrollTo(0, $parent.offset().top);
		$elem.text("▲ [--stick to the right top--]");
	} else {
		$parent.addClass("fixed");
		window.scrollBy(0, -$parent.height());
		$elem.text("▲ [--return to the original position--]");
	}
};
eve.rC=function(iframeStr) {
	return '<div class="rC">'
		+'<div class="rSC">'
			+iframeStr
		+'</div>'
		+'<div class="pc"><span onclick="eve.togglePosition(this)">▲ [--stick to the right top--]</span></div>'
	+'</div>';
};
eve.ptnURI={};
eve.videoRendering=function(uri) {
	if (uri&&uri.constructor===String) {
		for (var p in eve.ptnURI) {
			var result=eve.ptnURI[p].toIframe(uri);
			if (result) { return result; }
		}
		return {html:""};
	}
	return {html:""};
};
var ptnURI;
ptnURI=eve.ptnURI.youtubeURL={};
ptnURI.regEx=/^https?:\/\/www\.youtube\.com\/watch\?.*(?:v=)([\w-]+)/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.youtubeURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="https://www.youtube.com/embed/'+exec[1]+'" frameborder="0" allowfullscreen=""></iframe>')
			, from:"youtube", videoId:exec[1]};
	}
	return false;
};
ptnURI=eve.ptnURI.youtuURL={};
ptnURI.regEx=/^https?:\/\/youtu\.be\/([\w-]+)/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.youtuURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="https://www.youtube.com/embed/'+exec[1]+'" frameborder="0" allowfullscreen=""></iframe>')
			, from:"youtube", videoId:exec[1]};
	}
	return false;
};
ptnURI=eve.ptnURI.mYoutubeURL={};
ptnURI.regEx=/^https?:\/\/m\.youtube\.com\/watch\?.*(?:v=)([\w-]+)/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.mYoutubeURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="https://www.youtube.com/embed/'+exec[1]+'" frameborder="0" allowfullscreen=""></iframe>')
			, from:"youtube", videoId:exec[1]};
	}
	return false;
};
ptnURI=eve.ptnURI.youtubeEmbedURL={};
ptnURI.regEx=/^https?:\/\/www\.youtube\.com\/embed\/([\w-]+)/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.youtubeEmbedURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="https://www.youtube.com/embed/'+exec[1]+'" frameborder="0" allowfullscreen=""></iframe>')
			, from:"youtube", videoId:exec[1]};
	}
	return false;
};
ptnURI=eve.ptnURI.tvpotURL={};
ptnURI.regEx=/^https?:\/\/tvpot\.daum\.net\/v\/([\w-]+)/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.tvpotURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="http://videofarm.daum.net/controller/video/viewer/Video.html?vid='+exec[1]+(exec[1].length<15?'$':'')+'&play_loc=undefined" frameborder="0" scrolling="no"></iframe>')
			, from:"daum", videoId:exec[1]};
	}
	return false;
};
ptnURI=eve.ptnURI.daumVideo={};
ptnURI.regEx=/^https?:\/\/videofarm\.daum\.net\/controller\/video\/viewer\/Video\.html\?\S+$/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.daumVideo.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="'+exec[0]+'" frameborder="0" scrolling="no"></iframe>')
			, from:"daum"};
	}
	return false;
};
ptnURI=eve.ptnURI.naverVideo={};
ptnURI.regEx=/^https?:\/\/serviceapi\.rmcnmv\.naver\.com\/flash\/outKeyPlayer\.nhn\?\S+$/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.naverVideo.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="'+exec[0]+'" frameborder="0" scrolling="no"></iframe>')
			, from:"naver"};
	}
	return false;
};
ptnURI=eve.ptnURI.vimeoURL={};
ptnURI.regEx=/^https?:\/\/vimeo.com\/([0-9]+)/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.vimeoURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="http://player.vimeo.com/video/'+exec[1]+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>')
			, from:"vimeo", videoId:exec[1]};
	}
	return false;
};
ptnURI=eve.ptnURI.dmURL={};
ptnURI.regEx=/^https?:\/\/www\.dailymotion\.com\/video\/([0-9a-zA-Z]+)/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.dmURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="http://www.dailymotion.com/embed/video/'+exec[1]+'" frameborder="0" allowfullscreen></iframe>')
			, from:"dailymotion", videoId:exec[1]};
	}
	return false;
};
ptnURI=eve.ptnURI.videoURL={};
ptnURI.regEx=/^(https?:\/\/\S+\.(?:mp4|ogg|webm))/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.videoURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<video controls preload="auto" delayed-src="'+exec[1]+'"></video>')};
	}
	return false;
};
ptnURI=eve.ptnURI.imgURL={};
ptnURI.regEx=/^https?:\/\/\S+\.(?:jpg|jpeg|bmp|gif|png|webp|svg|tif)$/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.imgURL.regEx.exec(url);
	if (exec!==null) {
		return {html:'<div class="center"><img delayed-src="'+url+'"/></div>'};
	}
	return false;
};
ptnURI=eve.ptnURI.appSurpriseURL={};
ptnURI.regEx=/^https?:\/\/appsurprise\.co\.kr\/\S*$/i;
ptnURI.toIframe=function(url) {
	var exec=eve.ptnURI.appSurpriseURL.regEx.exec(url);
	if (exec!==null) {
		return {html:eve.rC('<iframe delayed-src="'+url+'" frameborder="0"></iframe>')};
	}
	return false;
};

////////////////////////////////////////////////////
// desc and cmt rendering
////////////////////////////////////////////////////
eve.regExDescCmt=/^#([\w-]+)/mg; // \w=[A-Za-z0-9_]
eve.renderStrDescCmt=function(str) {
	var res=[];
	str=str.trim();
	var key="#";
	var i=0;
	var start=0;
	var exec;
	while ((exec=eve.regExDescCmt.exec(str))!==null) {
		res[i++]=key;
		res[key]=str.substring(start, exec.index).trim();
		start=eve.regExDescCmt.lastIndex;
		key=exec[1];
	}
	res[i++]=key;
	res[key]=str.substring(start).trim();
	return res;
};

////////////////////////////////////////////////////
// uri to a href
////////////////////////////////////////////////////
eve.regexURL=/^https?:\/\/\S+/i;
eve.uriToA=function(uri) {
	if (uri===undefined||uri===null||uri.constructor!==String) { return ""; }
	var exec=eve.regexURL.exec(uri);
	if (exec!==null) {
		return '<a href="'+uri+'">'+eve.escapeHTML(decodeURIComponent(uri))+'</a>';
	} else {
		return uri;
	}
};

////////////////////////////////////////////////////
// val
////////////////////////////////////////////////////
eve.regexVal=/^([0-9]+(?:\.[0-9]+)?)\/([0-9]+(?:\.[0-9]+)?)$/;
eve.val=function(val) {
	var res={};
	res.str=val;
	if (val.length===0) {
		res.valid=true;
		res.val=-1;
	} else {
		var exec=eve.regexVal.exec(val);
		if (exec!==null) {
			res.num=Number(exec[1]);
			res.divisor=Number(exec[2])
			res.valid=(res.num<=res.divisor);
			if (res.valid) {
				res.val=res.num/res.divisor;
			} else {
				res.val=-1;
			}
		}
	}
	return res;
};
{
	var r=12; // outer radius of star
	var r0=6; // inner radius of star
	var pad=1; // padding of star
	var pad0=9; // left/right pad
	var thetas=[];
	var coss=[];
	var sins=[];
	for (var i=0;i<10;i++) {
		thetas.push(-Math.PI/2+2*Math.PI/10*i);
		coss.push(Math.cos(thetas[i]));
		sins.push(Math.sin(thetas[i]));
	}
	var str=pad0+',0 ';
	var yc=pad+r;
	var xc=pad0+pad+r;
	for (var k=0;k<5;k++,xc+=2*r+pad) {
		str+=xc+',0 ';
		for (var i=0;i<10;i++) {
			var rp=(i%2==0)?r:r0;
			str+=(xc+rp*coss[i]).toFixed(1)+','+(yc+rp*sins[i]).toFixed(1)+' ';
		}
		str+=xc+','+pad+' '+xc+',0 ';
	}
	xc-=r;
	yc+=r*sins[4]+pad;
	str+=xc+',0 '+xc+','+yc.toFixed(1)+' '+pad0+','+yc.toFixed(1);
	eve["5stars-pre"]='<div class="stars-container" style="width:'+(xc+pad0)+'px; height:'+yc.toFixed(1)+'px"><div class="bar" style="left:'+(pad0+1)+'px; width:';
	eve["5stars-width"]=xc-pad0-2;
	eve["5stars-pad0+1"]=pad0+1;
	eve["5stars-post"]='px"></div><svg class="out-stars">'
			+'<polygon points="'+str+'"/>'
		+'</svg></div>';
	eve["5stars"]=function(val) {
		if (val<0) { val=0; }
		else if (val>1) { val=1; }
		return eve["5stars-pre"]+(eve["5stars-width"]*val).toFixed(1)+eve["5stars-post"];
	}
}
$test_5stars.html(eve["5stars"](0.4));

////////////////////////////////////////////////////
// Point range
////////////////////////////////////////////////////
$show_recos_without_points.on("click", function(e) {
	if ($show_recos_without_points.hasClass("enabled")) {
		$show_recos_without_points.removeClass("enabled");
		eve.showRWOP=false;
	} else {
		$show_recos_without_points.addClass("enabled");
		eve.showRWOP=true;
	}
	clearTimeout(eve.timeOutRange);
	eve.timeOutRange=setTimeout(eve.processOutRange, 500);
});
eve.ptsRangeFrom=0; // from <= pts <= to
eve.ptsRangeTo=1;
eve.mdInPRL=false; // mouse down in Point Range Left
eve.mdInPRR=false; // mouse down in Point Range Right
eve.PRmax=10;
eve.PRLw=15;
eve.PRw=$point_range.width();
eve.PRRw=eve.PRw-15;
eve.PRtoFixed=function(w) {
	return (eve.PRmax*(w-15)/(eve.PRw-30)).toFixed(1);
};
eve.mmInPR=function(e) {
	window.getSelection().removeAllRanges();
	e.preventDefault();
	e.stopPropagation();
	var x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
	var w=x-$point_range.offset().left+$window.scrollLeft();
	w=(w>15)?w:15;
	w=(w<eve.PRw-15)?w:eve.PRw-15;
	var changed=false;
	if (eve.mdInPRL) {
		if (w>eve.PRRw) { w=eve.PRRw; }
		if (eve.PRLw!==w) {
			$point_range_left.css({left:w-15});
			$point_range_bar.css({left:w});
			eve.PRLw=w;
			changed=true;
		}
	} else {
		if (w<eve.PRLw) { w=eve.PRLw; }
		if (eve.PRRw!==w) {
			$point_range_right.css({left:w-5});
			$point_range_bar.css({right:eve.PRw-w});
			eve.PRRw=w;
			changed=true;
		}
	}
	if (changed) {
		var PRL=eve.PRtoFixed(eve.PRLw);
		var PRR=eve.PRtoFixed(eve.PRRw);
		$point_range_result.html(PRL+"~"+PRR+" / "+eve.PRmax);
		PRL=Number(PRL)/eve.PRmax;
		PRR=Number(PRR)/eve.PRmax;
		if (eve.ptsRangeFrom!==PRL||eve.ptsRangeTo!==PRR) {
			eve.ptsRangeFrom=PRL;
			eve.ptsRangeTo=PRR;
			clearTimeout(eve.timeOutRange);
			eve.timeOutRange=setTimeout(eve.processOutRange, 800);
		}
	}
};
$point_range_left.on("mousedown touchstart", function(e) {
	eve.mdInPRL=true;
	$html.on("mousemove.mdInPR touchmove.mdInPR", eve.mmInPR);
	$html.on("mouseup.mdInPR touchend.mdInPR", function(e) {
		eve.mdInPRL=false;
		$html.off("mouseup.mdInPR touchend.mdInPR mousemove.mdInPR touchmove.mdInPR");
	});
});
$point_range_right.on("mousedown touchstart", function(e) {
	eve.mdInPRR=true;
	$html.on("mousemove.mdInPR touchmove.mdInPR", eve.mmInPR);
	$html.on("mouseup.mdInPR touchend.mdInPR", function(e) {
		eve.mdInPRR=false;
		$html.off("mouseup.mdInPR touchend.mdInPR mousemove.mdInPR touchmove.mdInPR");
	});
});

eve.YTPlaylist=[];
eve.processOutRange=function() {
	var $recos=$(".reco");
	var list=[];
	eve.fsFullList=[];
	for (var i=0;i<$recos.length;i++) {
		var $recoI=$recos.eq(i);
		var recoI=eve.userRecos[eve.unescapeHTML($recoI.find(">.textURI").eq(0).html())];
		if (recoI!==undefined) {
			var val=recoI.val.val;
			if (val===-1) {
				if (eve.showRWOP) {
					$recoI.removeClass("outRange");
				} else {
					$recoI.addClass("outRange");
				}
			} else {
				if (eve.ptsRangeFrom<=val&&val<=eve.ptsRangeTo) {
					$recoI.removeClass("outRange");
				} else {
					$recoI.addClass("outRange");
				}
			}
		} else {
			console.log("undefined reco!");
		}
		if (!$recoI.hasClass("outRange")) {
			var $YTVideoId=$recoI.find(">.YTVideoId");
			if ($YTVideoId.exists()) {
				list.push($YTVideoId.html());
			}
			var $title=$recoI.find(">.title");
			if ($title.exists()) {
				var txt=$title.text();
				if (txt.length!==0) {
					var txtSplitted=eve.splitHangul(txt);
					txt="";
					for (var k=0;k<txtSplitted.length;k++) {
						txt+=txtSplitted[k]["splitted"];
					}
					eve.fsFullList.push({"txt":txt, "txtSplitted":txtSplitted, "html":$title.html(), "$reco":$recoI});
				}
			}
		}
	}
	eve.fsLastTxt+="$!@#";
	$fuzzy_search.trigger("keyup");
	var YTPlaylistChanged=(eve.YTPlaylist.length!==list.length);
	if (!YTPlaylistChanged) {
		for (var i=0;i<list.length;i++) {
			if (eve.YTPlaylist[i]!==list[i]) {
				YTPlaylistChanged=true;
				break;
			}
		}
	}
	if (YTPlaylistChanged) {
		eve.YTPlaylist=list;
		eve.cueYoutubePlaylist(list);
	}
};

////////////////////////////////////////////////////
// CatList rendering
////////////////////////////////////////////////////
eve.userRecos={};
eve.myRecos=(eve.myPage)?eve.userRecos:{};
eve.getDepthOfTabs=function(str) {
	var n=0;
	while (n<str.length&&str.charAt(n)==='\t') { n++; }
	return n;
};
eve.renderStrCatList=function(strCatList, catList) {
	var list=strCatList.trim().split("\n");
	if (strCatList.length===0) {
		list=[];
	}
	list.unshift("");
	if (catList===undefined||catList===null) {
		if (eve.catList) {
			catList=eve.catList;
		} else {
			catList=eve.catList=[];
		}
	}
	var superCats=[];
	for (var i=0;i<list.length;i++) {
		var baseCat=list[i].trim();
		var depth=eve.getDepthOfTabs(list[i]);
		superCats.splice(depth, superCats.length-depth, baseCat);
		var cat=superCats[0];
		for (var j=1;j<=depth;j++) {
			cat+="--"+superCats[j];
		}
		if (catList[cat]) {
			catList[cat].i=i;
			catList[i]=catList[cat];
		} else {
			catList[i]=catList[cat]={i:i, cat:cat, baseCat:baseCat, depth:depth};
		}
	}
};
eve.slideToggle=function(elem) {
	var $elem=$(elem);
	$elem.addClass("disabled");
	$elem.parent().next().slideToggle(1000);
	setTimeout(function() {
		$elem.removeClass("disabled");
	}, 1000);
};
eve.slideUp=function(elem) {
	var $elem=$(elem).parent().parent();
	$elem.slideUp(1000);
	$body.animate({scrollTop:'-='+$elem.height()}, 1000);
};
eve.recoHTML=function(r) {
	var res="";
	if (r&&r["has"]) {
		var uriEscaped=eve.escapeHTML( r["uri"] );
		res+='<div class="reco">'
			+'<img class="SNS-img" src="http://cfs.tistory.com/custom/blog/146/1468360/skin/images/icon-Twitter.png" onclick="eve.shareSNS(this, \'twitter\')"/><img class="SNS-img" src="http://cfs.tistory.com/custom/blog/146/1468360/skin/images/icon-Facebook.png" onclick="eve.shareSNS(this, \'facebook\')"/>'
			+(eve.myId?'<div class="button edit fRight" onclick="eve.editOrRecoToMine(this)">'+((eve.myPage)?'Edit':'Reco to mine')+'</div>':'')
			+'<div class="textURI">'+uriEscaped+'</div>';
		var video=eve.videoRendering( r["uri"] );
		if (video.from==="youtube") {
			res+='<div class="YTVideoId">'+video.videoId+'</div>';
		}
		res+='<div class="uri cBoth">'+eve.uriToA( uriEscaped )+'</div>'
			+'<div class="title">'+eve.escapeHTML( r["title"] )+'</div>'
			+'<div class="cats">'+eve.escapeHTML( r["cats"] )+'</div>'
			+video.html;
		if (r["desc"]) {
			var descR=r["descR"];
			res+='<div class="desc">';
			for (var l=0;l<descR.length;l++) {
				var key=eve.escapeHTML( descR[l] );
				var value=eve.escapeHTML( descR[descR[l]] );
				switch (key.toLowerCase()) {
				case "#" :
					res+='<div class="value">'+value.replace(/\n/g,"<br>")+'</div>';
					break;
				case "lyrics" :
					res+='<div class="value"><div class="center"><div class="button" onclick="eve.slideToggle(this)">▼ Toggle lyrics</div></div>'
						+'<div class="lyricsC" style="display:none">'
							+'<div class="lyricsArrow"></div>'
							+'<div class="lyrics">'+value.replace(/\n/g,"<br>")+'</div>'
							+'<div class="right"><div class="button" onclick="eve.slideUp(this)">▲ Hide lyrics</div></div>'
						+'</div></div>';
					break;
				case "related" :
					res+='<div class="value"><span class="key">'+key+' : </span>';
					var relateds=value.split("\n");
					for (var m=0;m<relateds.length;m++) {
						res+='<br>'+eve.uriToA( relateds[m] )+eve.videoRendering( relateds[m] ).html;
					}
					res+='</div>';
					break;
				default :
					res+='<div class="value"><span class="key">#'+key+' : </span>'+value.replace(/\n/g,"<br>")+'</div>';
				}
			}
			res+='</div>';
		}
		res+=(r["cmt"].length!==0?('<div class="cmt">'+eve.escapeHTML( r["cmt"] ).replace(/\n/g,"<br>")+'</div>'):"");
		if (r["val"].str) {
			res+='<div class="val">'+eve["5stars"]( r["val"].val )+' <span class="str">'+eve.escapeHTML( r["val"].str )+'</span></div>';
		}
		res+='</div>';
	} else {
		res+='<div class="reco">No Reco</div>';
	}
	return res;
};
eve.editOrRecoToMine=function(elem) {
	var $reco=$(elem).parent(".reco");
	var uri=eve.unescapeHTML($reco.find(".textURI").html());
	var r=eve.userRecos[uri];
	$input_uri[0].value=r["uri"];
	$input_uri[0].disabled=true;
	$new_reco.show();
	if (uri.length!==0&&uri!==eve.lastURI) {
		eve.lastURI=uri;
		eve.getAndShowDefsAndReco();
	}
	eve.wST=$window.scrollTop();
	$window.on("scroll.stop", function(e) {
		$window.scrollTop(eve.wST);
	});
};
eve.showContents=function(uris) {
	var strHTML="";
	if (uris.length>0) { for (var k=0;k<uris.length;k++) {
		strHTML+=eve.recoHTML( eve.userRecos[uris[k]] );
	}} else {
		strHTML+="No reco.";
	}
	$contents.html(strHTML);
	eve.delayedElems=$("[delayed-src], [delayed-bgimage]");
	eve.processOutRange();
	$window.on("scroll.delayedLoad", eve.delayedLoadByScroll);
	$window.trigger("scroll.delayedLoad");
	eve.fdList=$("#sidebar, #head, #contents .reco, #foot");
};

eve.recoDowned=function(urisStr, recos) {
	var uris=urisStr.split("\n");
	for (k=0;k<uris.length;k++) {
		var uri=uris[k];
		var p=recos[uri];
		if (!p) { p=recos[uri]={}; }
		p.down=true;
	}
};
eve.recoToEve=function(resp, recos) {
	var resp=eve.strToJSON(resp);
	for (var k=1;k<resp.length;k++) {
		var recoK=resp[k];
		var uri=recoK["uri"];
		var p=recos[uri];
		if (!p) { p=recos[uri]={}; }
		p["has"]=true;
		p["uri"]=uri;
		p["title"]=recoK["title"];
		p["cats"]=recoK["cats"];
		p["desc"]=recoK["desc"];
		p["descR"]=eve.renderStrDescCmt(recoK["desc"]); // R for rendered.
		p["cmt"]=recoK["cmt"];
		p["cmtR"]=eve.renderStrDescCmt(recoK["cmt"]); // R for rendered.
		p["val"]=eve.val( recoK["val"] );
		// p["tFirst"]=recoK["tFirst"];
		// p["tLast"]=recoK["tLast"];
	}
};
eve.getAndShowRecosOnUris=function(uriList) {
	uriList=uriList.trim();
	var uris=[];
	if (uriList.length!==0) { uris=uriList.split("\n"); }
	var getRecosStr="uri";
	var getRecosN=0;
	for (var j=0;j<uris.length;j++) {
		var uri=uris[j];
		var r=eve.userRecos[uri];
		if (!r) { r=eve.userRecos[uri]={}; }
		if (!r.down) {
			getRecosStr+="\n"+uri;
			getRecosN++;
		}
	}
	if (getRecosN>0) {
		$.ajax({
			type:"POST", url:"/user/"+eve.userId+"/get-Recos", data:getRecosStr
			, dataType:"text"
		}).done(function(resp) {
			eve.recoDowned(getRecosStr.substring(4), eve.userRecos);
			eve.recoToEve(resp, eve.userRecos);
			eve.showContents(uris);
		});
	} else {
		eve.showContents(uris);
	}
};
eve.getAndShowRecosOnCat=function(cat) {
	$contents.html("Loading recos in cat="+eve.escapeHTML(cat)+"...");
	var catList=eve.catList[cat];
	if (catList) {
		$catList.find(".cat").removeClass("selected");
		var $cat=$("#cat-"+catList.i);
		$cat.addClass("selected");
		var $parents=$cat.parents(".subCat");
		for (var i=$parents.length-1;i>=0;i--) {
			if (!$parents.eq(i).is(":visible")) {
				$parents.eq(i).prev().find(">.EC").trigger("click");
			}
		}
		var catUriList=eve.catUriList[cat];
		if (!catUriList) { catUriList=eve.catUriList[cat]={}; }
		if (catUriList.down) {
			eve.getAndShowRecosOnUris(catUriList.has?catUriList.UriList:"");
		} else {
			var getUriListStr="cat\n"+(cat===""?"\n$#@!":cat);
			$.ajax({
				type:"POST", url:"/user/"+eve.userId+"/get-UriList", data:getUriListStr
				, dataType:"text"
			}).fail(function() {
				$contents.html("get-UriList on "+eve.escapeHTML(cat)+" has failed..");
			}).done(function(resp) {
				catUriList.down=true;
				var resp=eve.strToJSON(resp);
				for (var i=1;i<resp.length;i++) {
					var catUL=eve.catUriList[resp[i].cat];
					catUL.down=true;
					catUL.has=true;
					catUL.UriList=resp[i].UriList;
				}
				eve.getAndShowRecosOnUris(catUriList.has?catUriList.UriList:"");
			});
		}
	} else {
		$contents.html("Category \""+eve.escapeHTML(cat)+"\" does not exist.");
	}
};
eve.refresh=function(cats, option, uri) {
	var currentCat=eve.getSearchVars().cat;
	var c=cats.split(";");
	var k=0;
	if (currentCat!==undefined) {
		for (k=c.length-1;k>0;k--) {
			if (c[k]===currentCat) {break;}
		}
	}
	if (c[k]!==currentCat) {
		window.history.pushState({cat:c[k]}, null, "/user/"+eve.userId+"?cat="+eve.escapeAMP(c[k]));
		eve.getAndShowRecosOnCat(c[k]);
	} else {
		if (option===undefined||option===null) {
			eve.getAndShowRecosOnCat(c[k]);
		} else if (option==="recoed") {
			var $newReco=$( eve.recoHTML( eve.userRecos[uri] ) );
			$contents.prepend( $newReco );
			eve.delayedElems=eve.delayedElems.add( $newReco.find("[delayed-src], [delayed-bgimage]") );
			$window.on("scroll.delayedLoad", eve.delayedLoadByScroll);
			$window.trigger("scroll.delayedLoad");
			eve.fdList=eve.fdList.add( $newReco );
		} else if (option==="changed"||option==="deleted") {
			var $recos=$contents.find(">.reco");
			for (var i=0;i<$recos.length;i++) {
				var $reco=$recos.eq(i);
				var recoUri=eve.unescapeHTML($reco.find(">.textURI").html());
				if (recoUri===uri) {
					if (option==="changed") {
						var $newReco=$( eve.recoHTML( eve.userRecos[uri] ) );
						$reco.replaceWith($newReco);
						eve.delayedElems=eve.delayedElems.add( $newReco.find("[delayed-src], [delayed-bgimage]") );
						$window.on("scroll.delayedLoad", eve.delayedLoadByScroll);
						$window.trigger("scroll.delayedLoad");
						eve.fdList=eve.fdList.add( $newReco );
					} else if (option==="deleted") {
						$reco.remove();
					}
					break;
				}
			}
		} else {
			eve.getAndShowRecosOnCat(c[k]);
		}
	}
};

eve.ExpCol=function(elem, catEC) {
	var $elem=$(elem);
	var $next=$elem.parent().next();
	if ($next.is(":visible")) {
		$next.hide();
		$elem.html("▶");
		catEC.subCatCollapsed=true;
	} else {
		$next.show();
		$elem.html("▼");
		catEC.subCatCollapsed=false;
	}
};
eve.openCat=function(cat) {
	eve.getAndShowRecosOnCat(cat);
	window.history.pushState({cat:cat}, null, "/user/"+eve.userId+"?cat="+eve.escapeAMP(cat));
};
eve.renderCatListHTML=function(catList) {
	var catListHTML='<div class="cat" id="cat-0" style="margin-left:'+eve.catList[0].depth+'em"><span class="noEC"></span><span class="baseCat" onclick="eve.openCat(eve.catList[0].cat)">[--Uncategorized--]</span></div>';
	var i=1;
	for (;i<eve.catList.length-1;i++) {
		var beforeDepth=eve.catList[i-1].depth;
		var currentDepth=eve.catList[i].depth;
		var afterDepth=eve.catList[i+1].depth;
		if (beforeDepth<currentDepth) { // open subCat
			catListHTML+='<div class="subCat">';
		} else {
			for (var j=currentDepth;j<beforeDepth;j++) { // close subCats
				catListHTML+='</div>';
			}
		}
		catListHTML+='<div class="cat" id="cat-'+i+'" style="margin-left:'+eve.catList[i].depth+'em">';
		if (currentDepth<afterDepth) {
			catListHTML+='<span class="EC" onclick="eve.ExpCol(this,eve.catList['+i+'])">▼</span>';
		} else {
			catListHTML+='<span class="noEC"></span>';
		}
		catListHTML+='<span class="baseCat" onclick="eve.openCat(eve.catList['+i+'].cat)">'+eve.escapeHTML( eve.catList[i].baseCat )+'</span>'+'</div>';
	}
	if (eve.catList.length>1) {
		var beforeDepth=eve.catList[i-1].depth;
		var currentDepth=eve.catList[i].depth;
		if (beforeDepth<currentDepth) { // open subCat
			catListHTML+='<div class="subCat">';
		} else {
			for (var j=currentDepth;j<beforeDepth;j++) { // close subCats
				catListHTML+='</div>';
			}
		}
		catListHTML+='<div class="cat" id="cat-'+i+'" style="margin-left:'+eve.catList[i].depth+'em">'
			+'<span class="noEC"></span>'
			+'<span class="baseCat" onclick="eve.openCat(eve.catList['+i+'].cat)">'+eve.escapeHTML( eve.catList[i].baseCat )+'</span>'
		+'</div>';
		for (var j=0;j<currentDepth;j++) { // close subCats
			catListHTML+='</div>';
		}
	}
	$catList.html(catListHTML);
};
eve.renderStrCatList(eve.unescapeHTML($data_CatList.html()));
eve.renderCatListHTML(eve.catList);
var $catECs=$catList.find(">.cat:has(>.EC)"); // Only the 1-level subCats.
for (var i=$catECs.length-1;i>=0;i--) {
	eve.catList[eve.catList[Number($catECs.eq(i).attr("id").substring(4))].cat].subCatCollapsed=true;
}
$catECs.find(">.EC").trigger("click");

eve.catUriList=[]; // eve.catUriList[cat]={cat:"cat", UriList:"uri1\nuri2", down:true, has:true};
for (var i=0;i<eve.catList.length;i++) {
	var cat=eve.catList[i].cat;
	eve.catUriList[cat]={cat:cat, down:false};
}

window.onpopstate=function(e) {
	if (e.state&&e.state.cat!==undefined) {
		eve.getAndShowRecosOnCat(e.state.cat);
	}
};
eve.getSearchVars=function() {
	var searchStr=window.location.search;
	var vars={};
	if (searchStr!==0) {
		if (searchStr.substring(0,1)==="?") {
			searchStr=searchStr.substring(1);
		}
		var splits=searchStr.split("&");
		for (var i=0;i<splits.length;i++) {
			var key=splits[i];
			var value="";
			var k=splits[i].indexOf("=");
			if (k!==-1) {
				key=splits[i].substring(0,k);
				value=decodeURIComponent(splits[i].substring(k+1));
			}
			vars[key]=value;
		}
	}
	return vars;
};
/*  :: cookies.js :: Slightly edited by kipid at 2014-09-03.
|*|
|*|  A complete cookies reader/writer framework with full unicode support.
|*|
|*|  https://developer.mozilla.org/en-US/docs/DOM/document.cookie
|*|
|*|  This framework is released under the GNU Public License, version 3 or later.
|*|  http://www.gnu.org/licenses/gpl-3.0-standalone.html
|*|
|*|  Syntaxes:
|*|
|*|  * docCookies.setItem(name, value[, end[, path[, domain[, secure]]]])
|*|  * docCookies.getItem(name)
|*|  * docCookies.removeItem(name[, path], domain)
|*|  * docCookies.hasItem(name)
|*|  * docCookies.keys()
*/
eve.docCookies={
  getItem: function (sKey) {
    return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(sKey).replace(/[\-\.\+\*]/g, "\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
  },
  setItem: function (sKey, sValue, vEnd, sPath, sDomain, bSecure) {
    if (!sKey || /^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
    var sExpires = "";
    if (vEnd) {
      switch (vEnd.constructor) {
        case Number:
          sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; max-age="+vEnd;
          break;
        case String:
          sExpires = "; expires="+vEnd;
          break;
        case Date:
          sExpires = "; expires="+vEnd.toUTCString();
          break;
      }
    }
    document.cookie = encodeURIComponent(sKey)+"="+encodeURIComponent(sValue) + sExpires + (sDomain ? "; domain="+sDomain : "") + (sPath ? "; path="+sPath : "") + (bSecure ? "; secure" : "");
    return true;
  },
  removeItem: function (sKey, sPath, sDomain, bSecure) {
    if (!sKey || /^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)/* || !this.hasItem(sKey)*/) { return false; }
    document.cookie = encodeURIComponent(sKey)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT" + (sDomain ? "; domain="+sDomain : "") + (sPath ? "; path="+sPath : "") + (bSecure ? "; secure" : "");
    return true;
  },
  hasItem: function (sKey) {
    return (new RegExp("(?:^|;\\s*)"+encodeURIComponent(sKey).replace(/[\-\.\+\*]/g, "\\$&")+"\\s*\\=")).test(document.cookie);
  },
  keys: /* optional method: you can safely remove it! */ function () {
    var aKeys = document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g, "").split(/\s*(?:\=[^;]*)?;\s*/);
    for (var nIdx = 0; nIdx < aKeys.length; nIdx++) { aKeys[nIdx] = decodeURIComponent(aKeys[nIdx]); }
    return aKeys;
  }
};
var vars=eve.getSearchVars();
if (vars.lang!==undefined) {
	eve.docCookies.setItem("lang", vars.lang, Infinity, "/");
}
if (vars.cat!==undefined) {
	eve.getAndShowRecosOnCat(vars.cat);
	window.history.pushState({cat:vars.cat}, null, "/user/"+eve.userId+"?cat="+eve.escapeAMP(vars.cat));
}

//////////////////////////////////////
// CatList edit
//////////////////////////////////////
eve.getSuperCat=function(cat) {
	if (cat!=null) {
		var i=cat.lastIndexOf("--");
		if (i!=-1) {
			return cat.substring(0,i);
		}
	}
	return null;
}
eve.putCatsUriToList=function(cats, uri) {
	var catSplit=cats.split(";");
	for (var i=0;i<catSplit.length;i++) {
		var cat=catSplit[i];
		if (eve.catUriList[cat]) {
			eve.catUriList[cat]["UriList"]=uri+"\n"+eve.catUriList[cat]["UriList"];
		} else {
			eve.putCat(cat);
			eve.catUriList[cat]={
				cat:cat
				, UriList:uri
			};
		}
	}
};
eve.deleteCatsUriFromList=function(cats, uri) {
	var catSplit=cats.split(";");
	for (var i=0;i<catSplit.length;i++) {
		var cat=catSplit[i];
		if (eve.catUriList[cat]) {
			var fullURIs="\n"+eve.catUriList[cat]["UriList"]+"\n";
			var k=fullURIs.indexOf("\n"+uri+"\n");
			if (k!==-1) {
				eve.catUriList[cat]["UriList"]=(fullURIs.substring(0,k)+fullURIs.substring(k+uri.length+1)).trim();
			}
			if (eve.catUriList[cat]["UriList"].length===0) {
				while (cat!==null&&(!eve.catUriList[cat]||eve.catUriList[cat]["UriList"].length===0)&&eve.deleteCat(cat)) {
					cat=eve.getSuperCat(cat);
				}
			}
		}
	}
};
eve.putCat=function(cat) {
	var res=false;
	if (cat===null||cat.length===0) { return res; }
	var fullCats=eve.unescapeHTML($data_CatList.html());
	var levels=cat.split("--");
	var pre="\n";
	var start=0;
	var end=fullCats.length;
	for (var j=0;j<levels.length;j++) {
		var subStr=fullCats.substring(start,end);
		var toFind=pre+levels[j]+"\n";
		var i=subStr.indexOf(toFind);
		if (i!=-1) {
			var ptnEnd=new RegExp(pre.replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"[^\\t\\n]", "g");
			ptnEnd.lastIndex=i+toFind.length-1;
			var matchEnd=ptnEnd.exec(subStr);
			if (matchEnd!==null) {
				end=start+matchEnd.index+1;
			}
			start+=i+toFind.length-1;
			pre+="\t";
		} else {
			var toPut="";
			for (;j<levels.length;j++) {
				toPut+=pre+levels[j];
				pre+="\t";
			}
			fullCats=fullCats.substring(0,end-1)+toPut+"\n"+fullCats.substring(end);
			res=true;
		}
	}
	if (res) {
		$data_CatList.html(eve.escapeHTML(fullCats));
		$change_catList_order_cancel.trigger("click");
		eve.updateCatFS();
	}
	return res;
};
eve.deleteCat=function(cat) {
	var res=false;
	if (cat===null||cat.length===0) { return res; }
	var fullCats=eve.unescapeHTML($data_CatList.html());
	var levels=cat.split("--");
	var pre="\n";
	var start0=0;
	var start=0;
	var end=fullCats.length;
	var subStr="";
	for (var j=0;j<levels.length;j++) {
		subStr=fullCats.substring(start,end);
		var toFind=pre+levels[j]+"\n";
		var i=subStr.indexOf(toFind);
		if (i===-1) {
			return res;
		} else {
			var ptnEnd=new RegExp(pre.replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"[^\\t\\n]", "g");
			ptnEnd.lastIndex=i+toFind.length-1;
			var matchEnd=ptnEnd.exec(subStr);
			if (matchEnd!==null) {
				end=start+matchEnd.index+1;
			}
			start0=start+i;
			start+=i+toFind.length-1;
			pre+="\t";
		}
	}
	subStr=fullCats.substring(start+1,end);
		// subStr=subCats+"\n"
		// if no subCats, this is empty.
	if (subStr.length===0) {
		fullCats=fullCats.substring(0,start0+1)+fullCats.substring(end); // delete a cat if there is no subCat.
		res=true;
	}
	if (res) {
		$data_CatList.html(eve.escapeHTML(fullCats));
		$change_catList_order_cancel.trigger("click");
	}
	return res;
};

$change_catList_order_ok.hide();
$change_catList_order_cancel.hide();
$change_catList_order.on("click", function(e) {
	$change_catList_order.hide();
	$change_catList_order_ok.show();
	$change_catList_order_cancel.show();
	var $cats=$("#catList .cat").not("#cat-0");
	$cats.addClass("edit");
	$cats.prepend('<div class="edit-bar"></div>');
	$cats.append('<div class="edit-bar"></div>');
	$("#catList .edit-bar").on("mousedown touchstart", function(e) {
		var $catM=$(this).parent(); // cat-moving
		var $catSiblings=$catM.siblings(".cat").not("#cat-0");
		if ($catSiblings.exists()) {
			var relativeX=((e.type=='touchstart')?e.originalEvent.touches[0].clientX:e.clientX)-Math.round($catM.offset().left)+$window.scrollLeft();
			var relativeY=((e.type=='touchstart')?e.originalEvent.touches[0].clientY:e.clientY)-Math.round($catM.offset().top)+$window.scrollTop();
			var $subCat=$catM.next(".subCat");
			var subCatIsVisible=false;
			if ($subCat.exists()&&$subCat.is(":visible")) {
				$subCat.hide();
				subCatIsVisible=true;
			}
			var $lastSibling=$catSiblings.last();
			var $lastSubCat=$lastSibling.next(".subCat");
			if ($lastSubCat.exists()&&$lastSubCat.is(":visible")) { $lastSibling=$lastSubCat; }
			$catM.css({width:$catM.outerWidth()});
			$catM.addClass("move");
			var catI=Number($catM.attr("id").substring(4));
			var $catTo=$('<div id="cat-to-here" style="margin-left:'+(eve.catList[catI].depth+0.5)+'em"></div>');
			$catM.before($catTo);
			var catTo=-1;
			$html.on("mousemove.mdInEB touchmove.mdInEB", function(e) {
				window.getSelection().removeAllRanges();
				e.preventDefault();
				e.stopPropagation();
				$catM.css({left:((e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX)-relativeX, top:((e.type=='touchmove')?e.originalEvent.touches[0].clientY:e.clientY)-relativeY});
				var wST=$window.scrollTop();
				var sidebarTop=$sidebar.offset().top-wST;
				var sidebarBottom=sidebarTop+$sidebar.outerHeight();
				var scrollPad=20;
				if (sidebarTop<0?e.clientY<scrollPad:e.clientY<sidebarTop+scrollPad) {
					if (sidebarTop<0) {
						$window.scrollTop(wST+e.clientY-scrollPad);
					} else {
						$sidebar.scrollTop($sidebar.scrollTop()+e.clientY-sidebarTop-scrollPad);
					}
				} else if (sidebarBottom>$window.outerHeight()?e.clientY>$window.outerHeight()-scrollPad:e.clientY>sidebarBottom-scrollPad) {
					if (sidebarBottom>$window.outerHeight()) {
						$window.scrollTop(wST+e.clientY-$window.outerHeight()+scrollPad);
					} else {
						$sidebar.scrollTop($sidebar.scrollTop()+e.clientY-sidebarBottom+scrollPad);
					}
				}
				var tops=[];
				for (var i=1;i<$catSiblings.length;i++) {
					tops.push(($catSiblings.eq(i-1).offset().top-wST+$catSiblings.eq(i).offset().top-wST)/2);
				}
				tops.push(($catSiblings.last().offset().top-wST+$lastSibling.offset().top+$lastSibling.outerHeight()-wST)/2);
				var k=0;
				for (;k<tops.length;k++) {
					if (e.clientY<tops[k]) { break; }
				}
				if (catTo!==k) {
					if (k<tops.length) {
						$catSiblings.eq(k).before($catTo);
					} else {
						$lastSibling.after($catTo);
					}
					catTo=k;
				}
			});
			$html.on("mouseup.mdInEB touchend.mdInEB", function(e) {
				$html.off("mouseup.mdInEB touchend.mdInEB mousemove.mdInEB touchmove.mdInEB");
				$catM.removeClass("move");
				$catM.css({width:'', left:'', top:''});
				$catTo.replaceWith($catM);
				if ($subCat.exists()) {
					$catM.after($subCat);
					if (subCatIsVisible) { $subCat.show(); }
				}
			});
		} else { // if $catSiblings doesn't exist.
			$catM.css({"border-color":"rgb(230,120,120)"});
			$html.on("mousemove.mdInEB touchmove.mdInEB", function(e) {
				window.getSelection().removeAllRanges();
				e.preventDefault();
				e.stopPropagation();
			});
			$html.on("mouseup.mdInEB touchend.mdInEB", function(e) {
				$html.off("mouseup.mdInEB touchend.mdInEB mousemove.mdInEB touchmove.mdInEB");
				$catM.css({"border-color":""});
			});
		}
	});
});
eve.getCatListChanged=function() {
	$change_catList_order_ok.hide();
	$change_catList_order_cancel.hide();
	var $cats=$("#catList .cat").not("#cat-0");
	$cats.removeClass("edit");
	$cats.find('.edit-bar').remove();
	var catListChanged="\n";
	for (var i=0;i<$cats.length;i++) {
		var catI=Number($cats.eq(i).attr("id").substring(4));
		for (var j=0;j<eve.catList[catI].depth;j++) {
			catListChanged+="\t";
		}
		catListChanged+=eve.catList[catI].baseCat+"\n";
	}
	return catListChanged;
};
$change_catList_order_ok.on("click", function(e) {
	var catListChanged=eve.getCatListChanged();
	if (catListChanged!==eve.unescapeHTML($data_CatList.html())) {
		if (eve.myPage) {
			$.ajax({
				type:"POST", url:"/changeOrders/CatList", data:catListChanged
				, dataType:"text"
			}).fail(function() {
				console.log("Changing CatList order has failed.");
			}).done(function(resp) {
				console.log(resp);
			}).always(function() {
				$data_CatList.html(eve.escapeHTML(catListChanged));
				eve.updateCatFS();
				$change_catList_order.show();
			});
		} else {
			$data_CatList.html(eve.escapeHTML(catListChanged));
			eve.updateCatFS();
			$change_catList_order.show();
		}
	} else {
		$change_catList_order.show();
	}
});
$change_catList_order_cancel.on("click", function(e) {
	var catListChanged=eve.getCatListChanged();
	var catList=eve.unescapeHTML($data_CatList.html());
	if (catListChanged!==catList) {
		eve.renderStrCatList(catList);
		eve.renderCatListHTML(eve.catList);
		for (var i=eve.catList.length-1;i>=0;i--) {
			if (eve.catList[i].subCatCollapsed) {
				$("#cat-"+i+">.EC").trigger("click");
			}
		}
	}
	$change_catList_order.show();
});

////////////////////////////////////////////////////
// SNS Sharing
////////////////////////////////////////////////////
eve.shareSNS=function(elem, service) {
	var $reco=$(elem).parent(".reco");
	var uri=encodeURIComponent(eve.unescapeHTML($reco.find(".textURI").html()));
	var title=encodeURIComponent( $reco.find(".title").text() );
	// encodeURIComponent(window.location.href);
	var open="";
	switch (service) {
		case 'twitter':
			open="https://twitter.com/intent/tweet"+"?text="+title+"&url="+uri;
			break;
		case 'facebook':
			open="https://www.facebook.com/sharer/sharer.php"+"?u="+uri;
			break;
	}
	window.open(open);
};

////////////////////////////////////////////////////
// Hangul (Korean) split and map to English
////////////////////////////////////////////////////
eve.jamoKE = ["ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄷㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
eve.jamo = ["ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄸ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅃ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ", "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

eve.mapKE = {"q":"ㅂ", "Q":"ㅃ", "w":"ㅈ", "W":"ㅉ", "e":"ㄷ", "E":"ㄸ", "r":"ㄱ", "R":"ㄲ", "t":"ㅅ", "T":"ㅆ", "y":"ㅛ", "Y":"ㅛ", "u":"ㅕ", "U":"ㅕ", "i":"ㅑ", "I":"ㅑ", "o":"ㅐ", "O":"ㅒ", "p":"ㅔ", "P":"ㅖ", "a":"ㅁ", "A":"ㅁ", "s":"ㄴ", "S":"ㄴ", "d":"ㅇ", "D":"ㅇ", "f":"ㄹ", "F":"ㄹ", "g":"ㅎ", "G":"ㅎ", "h":"ㅗ", "H":"ㅗ", "j":"ㅓ", "J":"ㅓ", "k":"ㅏ", "K":"ㅏ", "l":"ㅣ", "L":"ㅣ", "z":"ㅋ", "Z":"ㅋ", "x":"ㅌ", "X":"ㅌ", "c":"ㅊ", "C":"ㅊ", "v":"ㅍ", "V":"ㅍ", "b":"ㅠ", "B":"ㅠ", "n":"ㅜ", "N":"ㅜ", "m":"ㅡ", "M":"ㅡ"};
for (var p in eve.mapKE) {
	eve.mapKE[eve.mapKE[p]]=p;
}

eve.rChoKE = ["ㄱ", "ㄱㄱ", "ㄴ", "ㄷ", "ㄷㄷ", "ㄹ", "ㅁ", "ㅂ", "ㅂㅂ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅈㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
eve.rCho = ["ㄱ", "ㄲ", "ㄴ", "ㄷ", "ㄸ", "ㄹ", "ㅁ", "ㅂ", "ㅃ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

eve.rJungKE = ["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅗㅏ", "ㅗㅐ", "ㅗㅣ", "ㅛ", "ㅜ", "ㅜㅓ", "ㅜㅔ", "ㅜㅣ", "ㅠ", "ㅡ", "ㅡㅣ", "ㅣ"];
eve.rJung = ["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];

eve.rJongKE = ["", "ㄱ", "ㄱㄱ", "ㄱㅅ", "ㄴ", "ㄴㅈ", "ㄴㅎ", "ㄷ", "ㄹ", "ㄹㄱ", "ㄹㅁ", "ㄹㅂ", "ㄹㅅ", "ㄹㅌ", "ㄹㅍ", "ㄹㅎ", "ㅁ", "ㅂ", "ㅂㅅ", "ㅅ", "ㅅㅅ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
eve.rJong = ["", "ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

eve.splitHangul=function(str) {
	var res=[];
	var cho, jung, jong;
	for (var i=0;i<str.length;i++) {
		var c=str.charAt(i)
		var n=str.charCodeAt(i);
		if (n>=0x3131&&n<=0x3163) {
			n-=0x3131;
			res.push({
				"char":c, "n":n
				, "splitted":eve.jamoKE[n]
			});
		} else if (n>=0xAC00&&n<=0xD7A3) {
			n-=0xAC00;
			jong=n%28;
			jung=( (n-jong)/28 )%21;
			cho=( ((n-jong)/28)-jung )/21;
			res.push({
				"char":c, "n":[cho,jung,jong]
				, "splitted3":eve.rCho[cho]+eve.rJung[jung]+eve.rJong[jong]
				, "splitted":eve.rChoKE[cho]+eve.rJungKE[jung]+eve.rJongKE[jong]
			});
		} else {
			res.push({"char":c, "splitted":c});
		}
	}
	return res;
};

////////////////////////////////////////////////////
// Fuzzy search
////////////////////////////////////////////////////
RegExp.quote=function(str) {
	return str.replace(/[.?*+^$[\]\\{}()|-]/g, "\\$&").replace(/\s/g, "[\\s\\S]");
};
eve.arrayFuzzyRegExs=function(fuzzyStr) {
	var res=[];
	for (var i=0;i<fuzzyStr.length;i++) {
		var c=fuzzyStr.charAt(i);
		var mapKE=eve.mapKE[c];
		if (mapKE) {
			res.push( new RegExp("["+c+mapKE+"]", "ig") );
		} else {
			res.push( new RegExp(RegExp.quote(c), "ig") );
		}
	}
	return res;
};
eve.highlightStrFromIndices=function(str, strSplitted, indices) {
	var res="";
	for (var i=0, j=1, k=0, p1=0, p2=0;j<=indices.length;i=j,j++) {
		while (j<indices.length&&indices[j-1].end===indices[j].start) {
			j++;
		}
		for (;k<strSplitted.length;k++) {
			p1=p2;
			p2=p1+strSplitted[k]["splitted"].length;
			if (p2<=indices[i].start) {
				strSplitted[k]["matched"]=false;
			} else if (p1<indices[j-1].end) {
				strSplitted[k]["matched"]=true;
			} else {
				if (j===indices.length) {
					for (;k<strSplitted.length;k++) {
						strSplitted[k]["matched"]=false;
					}
				}
				p2=p1;
				break;
			}
		}
	}
	for (var i=0;i<strSplitted.length;) {
		if (strSplitted[i]["matched"]) {
			res+='<span class="bold">';
			while (i<strSplitted.length&&strSplitted[i]["matched"]) {
				res+=eve.escapeHTML(strSplitted[i]["char"]);
				i++;
			}
			res+='</span>';
		} else {
			while (i<strSplitted.length&&!strSplitted[i]["matched"]) {
				res+=eve.escapeHTML(strSplitted[i]["char"]);
				i++;
			}
		}
	}
	return res;
};
eve.fuzzySearch=function(fuzzyStr, list) {
	var listSelected=[];
	var regExs=eve.arrayFuzzyRegExs(fuzzyStr);
	for (var i=0;i<list.length;i++) {
		if (regExs.length>0) {
			var txt=list[i]["txt"];
			var txtSplitted=list[i]["txtSplitted"];
			regExs[0].lastIndex=0;
			var exec=regExs[0].exec(txt);
			var matched=(exec!==null);
			var indices=[];
			if (matched) {
				indices.push({start:exec.index, end:regExs[0].lastIndex});
			}
			for (var j=1;matched&&(j<regExs.length);j++) {
				regExs[j].lastIndex=regExs[j-1].lastIndex;
				exec=regExs[j].exec(txt);
				matched=(exec!==null);
				if (matched) {
					indices.push({start:exec.index, end:regExs[j].lastIndex});
				}
			}
			if (matched) {
				list[i]["highlighted"]=eve.highlightStrFromIndices(txt, txtSplitted, indices);
				listSelected.push(list[i]);
			}
		} else {
			delete list[i]["highlighted"];
			listSelected.push(list[i]);
		}
	}
	return listSelected;
};

$fuzzy_search.on("keydown", function(e) {
	e.stopPropagation();
	switch (e.keyCode) {
	case 27: // ESC = 27
		e.preventDefault();
		$out_focus.focus();
		$fuzzy_search_container.hide();
		break;
	case 38: // up = 38
	case 40: // down = 40
		e.preventDefault();
		var $fsl=$fuzzy_search_list;
		var $lis=$fsl.find(".list-item");
		var $liSelected=$fsl.find(".list-item.selected").eq(0);
		var $liTo=null;
		if ($liSelected.exists()) {
			if (e.keyCode===38) {
				$liTo=$liSelected.prev();
			} else {
				$liTo=$liSelected.next();
			}
			if ($liTo.exists()) {
				$liTo.eq(0).trigger("click");
				if ($liTo.offset().top<$fsl.offset().top+2) { // $liTo at upside of scroll.
					$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top-$fsl.offset().top-2);
				} else if ($liTo.offset().top+$liTo.outerHeight()>$fsl.offset().top+$fsl.height()+2) { // $liTo at downside of scroll.
					$fsl.scrollTop($fsl.scrollTop()+$liTo.offset().top+$liTo.outerHeight()-$fsl.offset().top-$fsl.height()-2);
				}
			}
		} else {
			if ($lis.exists()) {
				if (e.keyCode===38) {
					$liTo=$lis.last();
					$fsl.scrollTop($fsl[0].scrollHeight);
				} else {
					$liTo=$lis.first();
					$fsl.scrollTop(0);
				}
				$liTo.eq(0).trigger("click");
			}
		}
		break;
	}
});
eve.fsFullList=[]; // initialize
eve.fsLastTxt="$!@#";
$fuzzy_search.on("keyup", function(e) {
	var fsTxt=$fuzzy_search.text();
	var fsTxtSplitted=eve.splitHangul(fsTxt);
	fsTxt="";
	for (var i=0;i<fsTxtSplitted.length;i++) {
		fsTxt+=fsTxtSplitted[i]["splitted"];
	}
	if (eve.fsLastTxt!==fsTxt) {
		if (fsTxt.indexOf(eve.fsLastTxt)===0) {
			eve.fsList=eve.fuzzySearch(fsTxt, eve.fsList);
		} else {
			eve.fsList=eve.fuzzySearch(fsTxt, eve.fsFullList);
		}
		var str="";
		for (var i=0;i<eve.fsList.length;i++) {
			str+='<div class="list-item">'
					+'<div class="list-index">'+i+'</div>'
					+eve.fsList[i]["html"]
					+((eve.fsList[i]["highlighted"]!==undefined)?
					'<div class="highlighted">'+eve.fsList[i]["highlighted"]+'</div>':'')
				+'</div>';
		}
		$fuzzy_search_list.html(str);
		var $fsLis=$fuzzy_search_list.find(".list-item");
		$fsLis.on("click", function(e) {
			$fsLis.removeClass("selected");
			var $this=$(this);
			$this.addClass("selected");
			var i=Number($this.find(".list-index").html());
			$window.scrollTop(eve.fsList[i]["$reco"].offset().top);
		});
		eve.fsLastTxt=fsTxt;
	}
});
$fuzzy_search.trigger("keyup");

eve.updateCatFS=function() {
	if (eve.catFSFullList) {
		eve.catFSFullList.splice(0, eve.catFSFullList.length);
	} else {
		eve.catFSFullList=[];
	}
	var $cats=$("#catList .cat").not("#cat-0");
	for (var i=0;i<$cats.length;i++) {
		var cat=eve.catList[Number($cats.eq(i).attr("id").substring(4))].cat;
		if (eve.catFSFullList[cat]) {
			eve.catFSFullList[i]=eve.catFSFullList[cat];
		} else {
			var txtSplitted=eve.splitHangul(cat);
			var txt="";
			for (var k=0;k<txtSplitted.length;k++) {
				txt+=txtSplitted[k]["splitted"];
			}
			eve.catFSFullList[i]=eve.catFSFullList[cat]={"txt":txt, "txtSplitted":txtSplitted, "cat":cat, "html":eve.escapeHTML(cat)};
		}
	}
	eve.catFSLastTxt="$!@#";
	eve.catFSLastK=-1;
};
eve.updateCatFS();
$input_cats.on("keyup click", function(e) {
	var catsTxt=this.value;
	var sEnd=this.selectionEnd;
	var list=catsTxt.split(";");
	var l=catsTxt.length;
	var k=0;
	for (var i=list.length-1;i>=0;i--) {
		l-=list[i].length+1;
		if (l<sEnd) {
			k=i;
			break;
		}
	}
	var fsTxt=list[k];
	var fsTxtSplitted=eve.splitHangul(fsTxt);
	fsTxt="";
	for (var i=0;i<fsTxtSplitted.length;i++) {
		fsTxt+=fsTxtSplitted[i]["splitted"];
	}
	if (eve.catFSLastTxt!==fsTxt||eve.catFSLastK!==k) {
		if (fsTxt.indexOf(eve.catFSLastTxt)===0) {
			eve.catFSList=eve.fuzzySearch(fsTxt, eve.catFSList);
		} else {
			eve.catFSList=eve.fuzzySearch(fsTxt, eve.catFSFullList);
		}
		var str="";
		for (var i=0;i<eve.catFSList.length;i++) {
			str+='<div class="list-item">'
					+'<div class="list-index">'+i+'</div>'
					+eve.catFSList[i]["html"]
					+((eve.catFSList[i]["highlighted"]!==undefined)?
					'<div class="highlighted">'+eve.catFSList[i]["highlighted"]+'</div>':'')
				+'</div>';
		}
		$cat_fs_list.html(str);
		var $fsLis=$cat_fs_list.find(".list-item");
		var $input=$input_cats;
		$fsLis.on("click", function(e) {
			$fsLis.removeClass("selected");
			var $this=$(this);
			$this.addClass("selected");
			var j=Number($this.find(".list-index").html());
			list[k]=eve.catFSList[j].cat;
			$input[0].value=list.join(";");
			$input.focus();
			var sStart=0;
			for (var i=0;i<k;i++) {
				sStart+=list[i].length+1;
			}
			var sEnd=sStart+list[k].length;
			$input[0].setSelectionRange(sEnd,sEnd);
		});
		eve.catFSLastTxt=fsTxt;
		eve.catFSLastK=k;
	}
});
$input_cats.trigger("keyup");
$input_cats.on("focus", function() {
	$cat_fs_container.show();
});
// $input_cats.on("focusout", function() {
// 	$cat_fs_container.hide();
// });

////////////////////////////////////////////////////
// New Reco or Edit
////////////////////////////////////////////////////
eve.getUTF8Length=function(s) {
	var len=0;
	for (var i=0;i<s.length;i++) {
		var code=s.charCodeAt(i);
		if (code<=0x7f) {
			len+=1;
		} else if (code<=0x7ff) {
			len+=2;
		} else if (code>=0xd800&&code<=0xdfff) {
			// Surrogate pair: These take 4 bytes in UTF-8 and 2 chars in UCS-2
			// (Assume next char is the other [valid] half and just skip it)
			len+=4; i++;
		} else if (code<0xffff) {
			len+=3;
		} else {
			len+=4;
		}
	}
	return len;
};
eve.formatURI=function(uri) {
	return uri.trim().replace(/[\t\n]/g," ");
};
eve.formatTitle=function(title) {
	return title.trim().replace(/[\t\n]/g," ");
};
eve.formatCats=function(cats) {
	if (cats.constructor!==String||cats.trim().length===0) {
		return "";
	}
	cats=cats.trim().replace(/[\t\r\n]/g," ");
	var list=cats.split(";");
	for (var i=0;i<list.length;i++) {
		var levels=list[i].split("--");
		for (var j=0;j<levels.length;j++) {
			levels[j]=levels[j].replace(/^[\s-]+/,"").replace(/[\s-]+$/,"");
		}
		list[i]="";
		var k=0;
		for (;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]=levels[k];
				break;
			}
		}
		for (k++;k<levels.length;k++) {
			if (levels[k].length!==0) {
				list[i]+="--"+levels[k];
			}
		}
	}
	var catsMap={};
	catsMap[list[0]]=true;
	cats=list[0];
	for (var i=1;i<list.length;i++) {
		if (catsMap[list[i]]) {
		} else {
			catsMap[list[i]]=true;
			cats+=";"+list[i];
		}
	}
	return cats;
};

eve.showMyReco=function(r) {
	if (r["has"]) {
		$button_reco.hide();
		$button_edit.show();
		$button_del.show();
	} else {
		$button_reco.show();
		$button_edit.hide();
		$button_del.hide();
	}
	var $mR=$("#my-reco");
	$mR.html( eve.recoHTML(r) );
	if (r["has"]) {
		var $edit=$mR.find(".button.edit");
		$edit.html("Edit mine");
		$edit.on("click", function(e) {
			$input_title[0].value=r["title"];
			$input_cats[0].value=r["cats"];
			$input_desc[0].value=r["desc"];
			$input_cmt[0].value=r["cmt"];
			$input_val[0].value=r["val"].str;
			$input_val.trigger("keyup");
		});
	}
};
eve.showReco=function(r) {
	if (r["has"]) {
		$input_title[0].value=r["title"];
		$input_cats[0].value=r["cats"];
		$input_desc[0].value=r["desc"];
		if (eve.myPage) {
			$input_cmt[0].value=r["cmt"];
			$input_val[0].value=r["val"].str;
		} else {
			$input_cmt[0].value="";
			$input_val[0].value="";
		}
		$input_val.trigger("keyup");
	}
	if (eve.myPage) {
		if (r["has"]) {
			$button_reco.hide();
			$button_edit.show();
			$button_del.show();
			$button_back.show();
		} else {
			$button_reco.show();
			$button_edit.hide();
			$button_del.hide();
			$button_back.hide();
		}
	}
};
eve.emptifyReco=function() {
	$error.html("");
	$input_uri[0].value=eve.lastURI="";
	eve.getAndShowDefsAndReco();
};
eve.showDefs=function(r) {
	var defTitles=r["def-titles"].trim().split("\n");
	var defTitlesHTML="";
	for (var i=0;i<defTitles.length;i++) {
		var title=defTitles[i].trim();
		if (title.length!==0) {
			defTitlesHTML+='<div class="def-title">'+eve.escapeHTML(title)+'</div>';
		}
	}
	$def_titles.html(defTitlesHTML);
	var $defTitle=$def_titles.find(".def-title");
	$defTitle.on("click", function(e) {
		$defTitle.removeClass("selected");
		var $this=$(this);
		$this.addClass("selected");
		$input_title[0].value=eve.unescapeHTML($this.html());
	});
	
	var defCats=r["def-cats"].trim().split("\n");
	var defCatsHTML='<div class="def-cat">[--Indifferent--]</div> <div class="def-cat">[--Later--]</div><br>';
	for (var i=0;i<defCats.length;i++) {
		var cat=defCats[i].trim();
		if (cat.length!==0) {
			defCatsHTML+='<div class="def-cat">'+eve.escapeHTML(cat)+'</div> ';
		}
	}
	$def_cats.html(defCatsHTML);
	var $defCat=$def_cats.find(".def-cat");
	$defCat.on("click", function(e) {
		$defCat.removeClass("selected");
		var $this=$(this);
		$this.addClass("selected");
		$input_cats[0].value=eve.unescapeHTML($this.html());
	});
};
eve.lastURI="";
eve.userRecos[""]={
	has:true, down:true, defs:true, title:"", cats:"", desc:"", cmt:"", val:eve.val(""), "def-titles":"", "def-cats":""
};
eve.getAndShowDefsAndReco=function() {
	var elem=$input_uri[0];
	var uri=eve.formatURI(elem.value);
	if (elem.value!==uri) { elem.value=uri; }
	$("#show-URI").html(eve.videoRendering(uri).html.replace(/delayed-src/gi,"src"));
	var r=eve.userRecos[uri];
	if (!r) { r=eve.userRecos[uri]={}; }
	if (r.down) {
		eve.showReco(r);
	} else {
		var getRecosStr="uri"+"\n"+uri;
		$.ajax({
			type:"POST", url:"/user/"+eve.userId+"/get-Recos", data:getRecosStr
			, dataType:"text"
		}).done(function(resp) { // User reco 가 없으면 head 만 보냄.
			eve.recoDowned(uri, eve.userRecos);
			eve.recoToEve(resp, eve.userRecos);
			eve.showReco(r);
		});
	}
	if (r.defs) {
		eve.showDefs(r);
	} else {
		eve.showDefs({"def-titles":"", "def-cats":""});
		$.ajax({
			type:"POST", url:"/reco/infos", data:uri
			, dataType:"text"
		}).done(function(resp) {
			var defs=eve.strToJSON(resp);
			r.defs=true;
			r["def-cats"]=defs[1]["def-cats"];
			r["def-titles"]=defs[1]["def-titles"];
			eve.showDefs(r);
		});
	}
	if (eve.myPage||uri==="") {
		$error.html("");
	} else {
		$error.html("Be careful! This is not your page. On this URI, you have");
		var mR=eve.myRecos[uri];
		if (!mR) { mR=eve.myRecos[uri]={}; }
		if (mR.down) {
			eve.showMyReco(mR);
		} else {
			var getRecosStr="uri"+"\n"+uri;
			$.ajax({
				type:"POST", url:"/user/"+eve.myId+"/get-Recos", data:getRecosStr
				, dataType:"text"
			}).done(function(resp) { // User reco 가 없으면 head 만 보냄.
				eve.recoDowned(uri, eve.myRecos);
				eve.recoToEve(resp, eve.myRecos);
				eve.showMyReco(mR);
			});
		}
	}
};
$new_reco.find("input, textarea").on("keydown.common", function(e) {
	if (e.keyCode===27) { // ESC
		$out_focus.focus();
		$button_close.trigger("click");
	} else if (e.ctrlKey&&e.keyCode===13) { // Ctrl+Enter
		var r=eve.myRecos[$input_uri[0].value];
		if (r["has"]) {
			$button_edit.trigger("click");
		} else {
			$button_reco.trigger("click");
		}
	}
});
$input_uri.on("keyup", function(e) {
	var uri=eve.formatURI(this.value);
	if (uri!==eve.lastURI) {
		if (uri==="") {
			eve.lastURI=uri;
		} else {
			clearTimeout(eve.timeOutGetInfos);
			eve.timeOutGetInfos=setTimeout(function() {
				$input_uri[0].value=eve.lastURI=uri;
				eve.getAndShowDefsAndReco();
			}, 1000);
		}
	}
});

eve.fullPts=10;
eve.lastVal=eve.val("");
$input_val.before($(eve["5stars"](0)).attr({id:"input-val-stars"}));
$input_val_stars=$("#input-val-stars");
$input_val_stars.on("mousedown.mdInStars touchstart.mdInStars", function(e) {
	var $bar=$input_val_stars.find(".bar");
	var barW=$bar.width();
	var $val=$input_val[0];
	$html.on("mousemove.mdInStars touchmove.mdInStars", function(e) {
		window.getSelection().removeAllRanges();
		e.preventDefault();
		e.stopPropagation();
		var x=(e.type=='touchmove')?e.originalEvent.touches[0].clientX:e.clientX;
		var w=x-$bar.offset().left+$window.scrollLeft();
		if (w<-15) {
			w=-1;
		} else if (w<0) {
			w=0;
		} else if (w>eve["5stars-width"]) {
			w=eve["5stars-width"];
		}
		if (w!==barW) {
			barW=w;
			if (w<0) {
				$val.value="";
				w=0;
			} else {
				$val.value=(w/eve["5stars-width"]*eve.fullPts).toFixed(1)+"/"+eve.fullPts;
			}
			$bar.css({width:w});
			eve.lastVal=eve.val($val.value);
		}
	});
	$html.on("mouseup.mdInStars touchend.mdInStars", function(e) {
		$html.off("mouseup.mdInStars touchend.mdInStars mousemove.mdInStars touchmove.mdInStars");
	});
});
$input_val_stars.on("click", function(e) {
	var $bar=$(this).find(".bar");
	var barW=$bar.width();
	var $val=$input_val[0];
	var w=e.clientX-$bar.offset().left+$window.scrollLeft();
	if (w<0) {
		w=0;
	} else if (w>eve["5stars-width"]) {
		w=eve["5stars-width"];
	}
	if (w!==barW) {
		$bar.css({width:w});
		$val.value=(w/eve["5stars-width"]*eve.fullPts).toFixed(1)+"/"+eve.fullPts;
		eve.lastVal=eve.val($val.value);
	}
});
$input_val.on("keyup", function(e) {
	if (this.value!==eve.lastVal.str) {
		var val=eve.val(this.value);
		var $bar=$("#input-val-stars .bar");
		if (val.valid&&val.str.length!==0) {
			eve.fullPts=val.divisor;
			$bar.css({width:eve["5stars-width"]*val.val});
		} else {
			$bar.css({width:0});
		}
		eve.lastVal=val;
	}
});

$button_new_reco.on("click", function(e) {
	$input_uri[0].disabled=false;
	$new_reco.show();
	var cat=eve.getSearchVars().cat;
	if (cat&&($input_cats[0].value===""||$input_title[0].value===""||$input_uri[0].value==="")) {
		$input_cats[0].value=cat;
	}
	eve.wST=$window.scrollTop();
	$window.on("scroll.stop", function(e) {
		$window.scrollTop(eve.wST);
	});
});
$button_close.on("click", function(e) {
	$new_reco.hide();
	$window.off("scroll.stop");
});
$button_back.on("click", function(e) {
	var r=eve.userRecos[$input_uri[0].value];
	eve.showReco(r);
});

$button_reco.on("click", function(e) {
	$button_reco.addClass("disabled");
	var uri=eve.formatURI($input_uri[0].value);
	var val=eve.val($input_val[0].value.trim());
	var errorMsg="";
	var valid=true;
	if (uri.length===0) {
		valid=false;
		errorMsg="URI is required.";
	} else if (eve.getUTF8Length(uri)>255) {
		valid=false;
		errorMsg="URI (Length "+eve.getUTF8Length(uri)+" &gt; maxUTF8Length 255) is too long.";
	} else if (!val.valid) {
		valid=false;
		errorMsg="Points is of invalid form.";
	}
	if (valid) {
		var strHeads="do"+"\t"+"uri";
		var strContents="reco"+"\t"+eve.encloseStr(uri);
		strHeads+="\t"+"title";
		strContents+="\t"+eve.encloseStr(eve.formatTitle($input_title[0].value.trim()));
		strHeads+="\t"+"cats";
		strContents+="\t"+eve.encloseStr(eve.formatCats($input_cats[0].value.trim()));
		strHeads+="\t"+"desc";
		strContents+="\t"+eve.encloseStr($input_desc[0].value.trim());
		strHeads+="\t"+"cmt";
		strContents+="\t"+eve.encloseStr($input_cmt[0].value.trim());
		strHeads+="\t"+"val";
		strContents+="\t"+eve.encloseStr(val.str);
		var strRecoDo=strHeads+"\n"+strContents;
		$error.html("Being recoed.");
		$.ajax({
			type:"POST", url:"/reco/do", data:strRecoDo
			, dataType:"text"
		}).fail(function() {
			$error.html("Reco failed. You may be not logged-in.");
			$button_reco.removeClass("disabled");
		}).done(function(resp) {
			var res=eve.strToJSON(resp);
			if (res[1]["result"]==="recoed") {
				$error.html("Recoed");
				eve.recoDowned(uri, eve.myRecos);
				eve.recoToEve(strRecoDo, eve.myRecos);
				if (eve.myPage) {
					var cats=eve.myRecos[uri]["cats"];
					eve.putCatsUriToList(cats, uri);
					eve.refresh(cats, "recoed", uri);
				}
				setTimeout(function() {
					eve.emptifyReco();
					$button_reco.removeClass("disabled");
					$button_close.trigger("click");
				}, 1000);
			} else {
				$error.html(res[1]["result"]);
				$button_reco.removeClass("disabled");
			}
		});
	} else {
		$error.html(errorMsg);
		$button_reco.removeClass("disabled");
	}
});
$button_edit.on("click", function(e) {
	$button_edit.addClass("disabled");
	var uri=eve.formatURI($input_uri[0].value);
	var val=eve.val($input_val[0].value.trim());
	var r=eve.myRecos[uri];
	if (uri.length!==0&&val.valid&&r) {
		var strHeads="do"+"\t"+"uri";
		var strContents="change"+"\t"+eve.encloseStr(uri);
		var changed=false;
		var title=eve.formatTitle($input_title[0].value.trim());
		if (title!==r["title"]) {
			changed=true;
			strHeads+="\t"+"title";
			strContents+="\t"+eve.encloseStr(title);
		}
		var cats=eve.formatCats($input_cats[0].value.trim());
		if (cats!==r["cats"]) {
			changed=true;
			strHeads+="\t"+"cats";
			strContents+="\t"+eve.encloseStr(cats);
		}
		var desc=$input_desc[0].value.trim();
		if (desc!==r["desc"]) {
			changed=true;
			strHeads+="\t"+"desc";
			strContents+="\t"+eve.encloseStr(desc);
		}
		var cmt=$input_cmt[0].value.trim();
		if (cmt!==r["cmt"]) {
			changed=true;
			strHeads+="\t"+"cmt";
			strContents+="\t"+eve.encloseStr(cmt);
		}
		if (val.str!==r["val"].str) {
			changed=true;
			strHeads+="\t"+"val";
			strContents+="\t"+eve.encloseStr(val.str);
		}
		if (changed) {
			$error.html("Being changed.");
			$.ajax({
				type:"POST", url:"/reco/do", data:strHeads+"\n"+strContents
				, dataType:"text"
			}).fail(function() {
				$error.html("Failed change. You may not be logged-in.");
				$button_edit.removeClass("disabled");
			}).done(function(resp) {
				var res=eve.strToJSON(resp);
				if (res[1]["result"]==="changed") {
					$error.html("Changed");
					if (cats!==r["cats"]) {
						if (eve.myPage) {
							eve.deleteCatsUriFromList(r["cats"], uri);
							eve.putCatsUriToList(cats, uri);
						}
						r["cats"]=cats;
					}
					if (title!==r["title"]) { r["title"]=title; }
					if (desc!==r["desc"]) {
						r["desc"]=desc;
						r["descR"]=eve.renderStrDescCmt(desc);
					}
					if (cmt!==r["cmt"]) {
						r["cmt"]=cmt;
						r["cmtR"]=eve.renderStrDescCmt(cmt);
					}
					if (val.str!==r["val"].str) { r["val"]=val; }
					if (eve.myPage) { eve.refresh(cats, "changed", uri); }
					setTimeout(function() {
						eve.emptifyReco();
						$button_edit.removeClass("disabled");
						$button_close.trigger("click");
					}, 1000);
				} else {
					$error.html(res[1]["result"]);
					$button_edit.removeClass("disabled");
				}
			});
		} else {
			$error.html("You have made no change.");
			$button_edit.removeClass("disabled");
		}
	} else {
		var errorMsg="";
		if (uri.length===0) {
			errorMsg="URI is required.";
		} else if (!val.valid) {
			errorMsg="Points is of invalid form.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_edit.removeClass("disabled");
	}
});
$button_del.on("click", function(e) {
	$button_del.addClass("disabled");
	var uri=eve.formatURI($input_uri[0].value);
	var r=eve.myRecos[uri];
	if (uri.length!==0&&r) {
		var strHeads="do"+"\t"+"uri";
		var strContents="delete"+"\t"+eve.encloseStr(uri);
		$.ajax({
			type:"POST", url:"/reco/do", data:strHeads+"\n"+strContents
			, dataType:"text"
		}).done(function(resp) {
			console.log(resp);
			var res=eve.strToJSON(resp);
			if (res[1]["result"]==="deleted") {
				$error.html("Deleted");
				var cats=r["cats"];
				delete eve.myRecos[uri];
				if (eve.myPage) {
					eve.deleteCatsUriFromList(cats, uri);
					eve.refresh(cats, "deleted", uri);
				}
				setTimeout(function() {
					$button_del.removeClass("disabled");
					$button_close.trigger("click");
				})
			} else {
				$error.html(res[1]["result"]);
				$button_del.removeClass("disabled");
			}
		});
	} else {
		var errorMsg="";
		if (uri.length==0) {
			errorMsg="URI is required.";
		} else {
			errorMsg="You have no reco on this URI.";
		}
		$error.html(errorMsg);
		$button_del.removeClass("disabled");
	}
});

////////////////////////////////////////////////////
// ShortKeys
////////////////////////////////////////////////////
eve.fdList=$("#sidebar, #head, #contents .reco, #foot"); // Ordered automatically by jQuery.
eve.processShortKey=function(e) {
	if (e.altKey||e.ctrlKey||e.metaKey) { return; }
	switch (e.target.nodeName) {
		case "INPUT": case "SELECT": case "TEXTAREA": return;
	}
	switch (e.keyCode) {
		case 71: case 84: // G = 71, T = 84
			e.preventDefault();
			$fuzzy_search_container.show();
			$fuzzy_search.focus();
			break;
		case 78: // N = 78
			$button_new_reco.trigger("click");
			break;
		case 70: //F = 70
		case 68: //D = 68
			var scrollTop=$window.scrollTop();
			var i, k=eve.fdList.length;
			var hI;
			
			if (e.keyCode===70) {
				scrollTop+=10;
				for (i=0;i<k;i++) {
					hI=eve.fdList.eq(i);
					if (hI.is(":visible")&&scrollTop<hI.offset().top) { break; }
				}
				if (i===k) {
					// hI=eve.fdList.eq(0);
					// alert("This is the last section.");
					return;
				}
			} else{
				scrollTop-=10;
				for (i=k-1;i>=0;i--) {
					hI=eve.fdList.eq(i);
					if (hI.is(":visible")&&scrollTop>hI.offset().top) { break; }
				}
				if (i===-1) {
					// hI=eve.fdList.eq(k-1);
					// alert("This is the first section.");
					return;
				}
			}
			$window.scrollTop(hI.offset().top);
			break;
		default:
	}
}
$window.on("keydown", eve.processShortKey);
var $shortkeyDesc=$("ul#shortkeys");
if ($shortkeyDesc.exists()) {
	$shortkeyDesc.prepend(
		"<li>G,T: [--Fuzzy Search--] (Go), or Table of Recos</li>"
		+"<li>F: Forward [--Reco--]</li>"
		+"<li>D: Previous [--Reco--]</li>"
		+"<li>N: New [--Reco--]</li>"
	);
}
})(window.eve=window.eve||{}, jQuery);

function onYouTubeIframeAPIReady() {
	eve.playlist=new YT.Player('youtube-playlist', {events:{
		'onError':function(e) {
			setTimeout(function() {
				e.target.nextVideo();
			}, 2000);
		}, 'onStateChange':function(e) {
			if (eve.playlist.oneLoop&&e.data===YT.PlayerState.ENDED) {
				e.target.playVideoAt(eve.playlist.currentIndex);
			} else if (e.data===YT.PlayerState.PLAYING) {
				eve.playlist.currentIndex=e.target.getPlaylistIndex();
			}
		}}
	});
	eve.playlist.oneLoop=false;
	eve.playlist.toggleLoop=function(elem) {
		var $elem=$(elem);
		if ($elem.hasClass("enabled")) {
			$elem.removeClass("enabled");
			eve.playlist.setLoop(false);
		} else {
			$elem.addClass("enabled");
			eve.playlist.setLoop(true);
		}
	};
	eve.playlist.toggleOneLoop=function(elem) {
		var $elem=$(elem);
		if ($elem.hasClass("enabled")) {
			$elem.removeClass("enabled");
			eve.playlist.oneLoop=false;
		} else {
			$elem.addClass("enabled");
			eve.playlist.oneLoop=true;
		}
	};
}
</script>
</html>